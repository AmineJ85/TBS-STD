<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <link rel="icon" href="{{ url_for('static', filename='images/TBS_favicon.png') }}" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='myCSS/styles3.css') }}">
 
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Student Portal</h2>
            <div class="profile-container">
                {% if session.student.profile_picture %}
                    <img src="data:image/jpeg;base64,{{ session.student.profile_picture }}" class="profile-picture" alt="Profile Picture">
                {% else %}
                    <img src="{{ url_for('static', filename='images/default-profile.jpg') }}" class="profile-picture" alt="Profile Picture">
                {% endif %}
                <div class="student-info">
                    <div class="student-name">{{ session.student.first_name }} {{ session.student.last_name }}</div>
                    <div class="student-level">{{ session.student.level }}</div>
                </div>
            </div>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" data-section="course-registration" class="active">
                <i class="fas fa-book"></i> Course Enrollment
            </a></li>
            <li><a href="#" data-section="enrollment-history">
                <i class="fas fa-history"></i> Enrollment History
            </a></li>
            <li><a href="#" data-section="major-minor">
                <i class="fas fa-graduation-cap"></i> Major/Minor
            </a></li>
            <li><a href="#" data-section="schedule">
                <i class="fas fa-calendar-alt"></i> Schedule
            </a></li>
            <li id="makeup-session-menu-item" style="display: none;"><a href="#" data-section="makeup-session">
                <i class="fas fa-sync-alt"></i> Makeup Session
            </a></li>
            <li class="logout-item">
                <a href="{{ url_for('login_bp.logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </div>
    
    <div class="main-content">
        <div class="content-header">
            <h1 id="content-title">Welcome to Student Dashboard</h1>
        </div>
        <div id="dynamic-content">
            <p>Please select an option from the sidebar to continue.</p>
        </div>
    </div>

    <!-- Main Script -->
    <script>
        // Main script for student portal - handles general functionality

document.addEventListener('DOMContentLoaded', function() {
    let currentSection = window.location.hash ? window.location.hash.substring(1) : 'course-registration';
    
    // Check for makeup session eligibility
    checkMakeupSessionAvailability();
    
    // Check if registration is open and show enrollment confirmation if needed
    checkRegistrationAndShowEnrollment();
    
    // Check for board decision restriction immediately on page load
    fetch('/student/course-registration')
        .then(response => {
            if (!response.ok && response.status === 403) {
                return response.json().then(data => {
                    if (data.code === 'AWAITING_BOARD_DECISION') {
                        showError(data.message, data.code);
                        // Disable all navigation except logout
                        document.querySelectorAll('.sidebar-menu a:not(.logout-item a)').forEach(link => {
                            link.classList.add('disabled');
                            link.style.pointerEvents = 'none';
                            link.style.opacity = '0.6';
                        });
                        throw new Error('ACCESS_RESTRICTED');
                    }
                    return data;
                });
            }
            return response.json();
        })
        .then(data => {
            if (!data.success && data.code === 'AWAITING_BOARD_DECISION') {
                throw new Error('ACCESS_RESTRICTED');
            }
            
            // Only proceed with normal page load if not restricted
            // Set initial active link
            setActiveLink(document.querySelector(`a[data-section="${currentSection}"]`));
            
            // Load initial section
            loadSection(currentSection);
        })
        .catch(error => {
            if (error.message !== 'ACCESS_RESTRICTED') {
                // If it's not the restriction error we already handled, load the page normally
                setActiveLink(document.querySelector(`a[data-section="${currentSection}"]`));
                loadSection(currentSection);
            }
        });
    
    // Handle sidebar menu clicks
    document.querySelector('.sidebar-menu').addEventListener('click', function(e) {
        const link = e.target.closest('a[data-section]');
        if (!link) return;
        
        e.preventDefault();
        currentSection = link.getAttribute('data-section');
        window.location.hash = currentSection;
        loadSection(currentSection);
        setActiveLink(link);
    });
    
    // Update the active link in the sidebar
    function setActiveLink(activeLink) {
        document.querySelectorAll('.sidebar-menu a').forEach(a => {
            a.classList.remove('active');
        });
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
    
    // Load a section
    function loadSection(section) {
        if (section === 'course-registration') {
            loadCourseRegistration();
        } else if (section === 'enrollment-history') {
            loadEnrollmentHistory();
        } else if (section === 'major-minor') {
            loadMajorMinor();
        } else if (section === 'schedule') {
            loadSchedule();
        } else if (section === 'makeup-session') {
            loadMakeupSession();
        } else {
            document.getElementById('content-title').textContent = 
                section.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            document.getElementById('dynamic-content').innerHTML = `
                <div class="content-card">
                    <h3>${section.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                    <p>This section will contain ${section.replace('-', ' ')} content.</p>
                </div>
            `;
        }
    }
    
    function getSemesterName(semesterNumber) {
        switch(parseInt(semesterNumber)) {
            case 1: return 'Fall';
            case 2: return 'Spring';
        }
    }
    
    // Show error message
    function showError(message, code) {
        console.log(`Showing error: ${message}, code: ${code}`);
        
        // Update page title to reflect error
        document.getElementById('content-title').textContent = 
            code === 'AWAITING_BOARD_DECISION' ? 'Access Restricted' : 'Error';
        
        let errorHtml = `
            <div class="content-card error">
                <h3>Error Loading Content</h3>
                <p>${message}</p>
        `;
        
        // Special handling for board decision restriction
        if (code === 'AWAITING_BOARD_DECISION') {
            errorHtml = `
                <div class="content-card board-decision-restriction">
                    <div class="board-decision-icon">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <h3>Access Restricted</h3>
                    <p>${message}</p>
                    <p class="board-decision-note">Your account has been temporarily restricted due to academic probation limits. Please contact the administration for more information.</p>
                </div>
            `;
            
            // Also disable all sidebar links immediately
            document.querySelectorAll('.sidebar-menu a:not(.logout-item a)').forEach(link => {
                link.classList.add('disabled');
                link.style.pointerEvents = 'none';
                link.style.opacity = '0.6';
            });
        } else {
            errorHtml += `
                <button onclick="loadSection('${currentSection}')" class="btn-primary retry-button">
                    <i class="fas fa-sync-alt"></i> Try Again
                </button>
            `;
        }
        
        errorHtml += `</div>`;
        document.getElementById('dynamic-content').innerHTML = errorHtml;
    }
    
    // Function to check registration status and show enrollment confirmation if needed
function checkRegistrationAndShowEnrollment() {
    // Only run this check if we're on the course registration page or just loaded the page
    if (currentSection === 'course-registration' || !currentSection) {
        console.log('Checking registration status for enrollment confirmation...');
        
        // Wait a bit to ensure the page is fully loaded
        setTimeout(() => {
            // Check registration status
            fetch('/admin/registration-config/current')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch registration config');
                    }
                    return response.json();
                })
                .then(configData => {
                    console.log('Registration config:', configData);
                    if (configData && configData.status === 'open') {
                        // If registration is open, get current enrollment
                        return Promise.all([
                            fetch('/student/course-registration'),
                            fetch('/admin/academic-calendar/current')
                        ]);
                    }
                    return Promise.reject('Registration not open');
                })
                .then(([registrationResponse, calendarResponse]) => {
                    if (!registrationResponse.ok || !calendarResponse.ok) {
                        throw new Error('Failed to fetch registration or calendar data');
                    }
                    return Promise.all([
                        registrationResponse.json(),
                        calendarResponse.json()
                    ]);
                })
                .then(([registrationData, calendarData]) => {
                    console.log('Registration data:', registrationData);
                    console.log('Calendar data:', calendarData);
                    
                    if (registrationData.success && 
                        registrationData.data && 
                        registrationData.data.enrolled_courses && 
                        registrationData.data.enrolled_courses.length > 0) {
                        
                        const semesterName = getSemesterName(calendarData.semester);
                        console.log(`Showing enrollment confirmation for ${registrationData.data.enrolled_courses.length} courses in ${semesterName} semester`);
                        showEnrollmentConfirmation(registrationData.data.enrolled_courses, semesterName);
                    } else {
                        console.log('No enrolled courses found or empty data');
                    }
                })
                .catch(error => {
                    // Silently fail - no need to show errors for this check
                    console.log('Registration check error:', error);
                });
        }, 500);
    }
}
    
});
    </script> 






<!--------------------- Major-Minor Section ------------------------->
<script>
let majorOptions = {};
let minorOptions = {};
let selectedChoices = {
    major: null,
    second_major: null,
    minor: null
};
let rejectedCombinations = [];
function loadMajorMinor() {
    // First load the options
    fetchMajorMinorOptions().then(() => {
        document.getElementById('content-title').textContent = 'Major/Minor';
        
        // Create the main container structure
        document.getElementById('dynamic-content').innerHTML = `
            <div class="content-card">
                <div class="major-gpa-container">
                    <div class="gpa-cards" id="major-gpa-cards">
                        <div class="loading-message">
                            <i class="fas fa-spinner fa-spin"></i> Loading Major GPA Data...
                        </div>
                    </div>
                </div>
                
                <div id="selection-container" class="selection-container">
                    <div id="eligibility-status"></div>
                    <div id="selection-window-status" class="selection-window-status-container"></div>
                    <div id="rejected-combinations-container" class="rejected-combinations-container"></div>
                    <div id="selection-interface-wrapper" class="selection-interface-wrapper">
                        <div id="selection-interface"></div>
                    </div>
                </div>
            </div>
        `;
        
        // Fetch rejected combinations
        fetchRejectedCombinations();
        
        // First check for existing selections to get current choices
    fetch('/student/major_minor/current')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.choices) {
                    // Store selections globally
                    selectedChoices = {
                        major: data.choices.major || null,
                        second_major: data.choices.second_major || null,
                        minor: data.choices.minor || null,
                        status: data.choices.status,
                        submission_date: data.choices.submission_date
                    };
                    
                    // Log the loaded selections for debugging
                    console.log('Loaded existing selections:', selectedChoices);
                }
                
                // Then check selection window status
                return checkSelectionWindowStatus();
            })
            .then(() => {
                // After checking window status, fetch GPA data
                return fetchMajorGPA();
            })
            .then((data) => {
                // After loading GPA data, handle the interface based on selections and window status
                const isSelectionOpen = window.selectionWindowStatus && window.selectionWindowStatus.is_open;
                
                if (selectedChoices.major || selectedChoices.minor) {
                    if (!isSelectionOpen) {
                        // If window is closed, just show confirmation popup without interface
                        const interfaceDiv = document.getElementById('selection-interface');
                        if (interfaceDiv) {
                            interfaceDiv.innerHTML = '';
                        }
                        
                        setTimeout(() => {
                            showConfirmationPopup(selectedChoices);
                        }, 100);
                    } else {
                        // If window is open, always rebuild interface regardless of status
                        // This allows changes even if status is accepted or rejected
                        rebuildInterfaceWithSelections(selectedChoices);
                    }
                } else {
                    // No existing selections, render based on eligibility
                    renderSelectionInterface(data.data);
                }
            })
            .catch(error => {
                console.error('Error in loadMajorMinor:', error);
                
                // Check if this is a 403 error (might be board decision restriction)
                if (error.message && error.message.includes('403')) {
                    // Try to fetch the actual error message
                    fetch('/student/course-registration')
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 'AWAITING_BOARD_DECISION') {
                                showError(data.message, data.code);
                            } else {
                                showError('Access restricted. Please contact administration.', 'ACCESS_RESTRICTED');
                            }
                        })
                        .catch(() => {
                            // If that fails too, show a generic board decision message
                            showError('Awaiting Scientific Board decision whether to grant an extension semester or not', 'AWAITING_BOARD_DECISION');
                        });
                } else if (error.code === 'AWAITING_BOARD_DECISION') {
                    showError(error.message, error.code);
                }
            });
    });
}

function checkSelectionWindowStatus() {
    return fetch('/student/major_minor/selection_status')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to check selection status');
            
            const statusDiv = document.getElementById('selection-window-status');
            
            if (data.is_open) {
                // Selection window is open - show countdown
                const endDate = new Date(data.end_date);
                statusDiv.innerHTML = `
                    <div class="selection-window-status open">
                        <i class="fas fa-clock"></i>
                        <span>Selection window is open! Closes on ${formatDate(data.end_date)}</span>
                        <div id="selection-countdown" class="selection-countdown"></div>
                        <div class="selection-note">Note: The administration may close the selection period earlier if needed.</div>
                    </div>
                `;
                startSelectionCountdown(endDate);
            } else if (data.is_scheduled) {
                // Selection window is scheduled - show start date
                statusDiv.innerHTML = `
                    <div class="selection-window-status scheduled">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Selection window will open on ${formatDate(data.start_date)}</span>
                    </div>
                `;
            } else {
                // Selection window is closed - use neutral style
                statusDiv.innerHTML = `
                    <div class="selection-window-status neutral">
                        <i class="fas fa-info-circle"></i>
                        <span>Major/Minor selection is currently closed.</span>
                    </div>
                `;
            }
            
            // Store window status globally
            window.selectionWindowStatus = {
                is_open: data.is_open,
                is_scheduled: data.is_scheduled,
                start_date: data.start_date,
                end_date: data.end_date
            };
            
            return data;
        })
        .catch(error => {
            console.error('Error checking selection window status:', error);
            const statusDiv = document.getElementById('selection-window-status');
            if (statusDiv) {
                statusDiv.innerHTML = `
                    <div class="selection-window-status error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Error checking selection status: ${error.message}</span>
                    </div>
                `;
            }
            throw error;
        });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function startSelectionCountdown(endDate) {
    const countdownElement = document.getElementById('selection-countdown');
    if (!countdownElement) return;
    
    // Update countdown every second
    const countdownInterval = setInterval(function() {
        const now = new Date().getTime();
        const distance = endDate.getTime() - now;
        
        // Time calculations
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        // Display countdown
        countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        
        // If countdown is finished, clear interval and refresh status
        if (distance < 0) {
            clearInterval(countdownInterval);
            countdownElement.innerHTML = "Selection period has ended";
            setTimeout(checkSelectionWindowStatus, 1000);
        }
    }, 1000);
}

// This function has been integrated into loadMajorMinor

function rebuildInterfaceWithSelections(choices) {
    const interfaceDiv = document.getElementById('selection-interface');
    interfaceDiv.innerHTML = ''; // clear previous buttons

    // Check if selection window is open
    const isSelectionOpen = window.selectionWindowStatus && window.selectionWindowStatus.is_open;
    
    // Always show the confirmation popup, but still allow changes during open selection window
    // regardless of status (pending, accepted, or rejected)
    setTimeout(() => {
        showConfirmationPopup(choices);
    }, 100);
    
    // If selection window is closed, don't show the interface
    if (!isSelectionOpen) {
        return;
    }

    console.log('Rebuilding interface with selections:', choices);

    // Fetch eligible majors from the server again to ensure we're using the correct list
    fetch('/student/major_minor/major_requirements')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data && data.data.eligible_majors) {
                // Re-render the major selection cards with only eligible majors
                renderMajorSelection(data.data.eligible_majors, isSelectionOpen);
                
                // After rendering the major selection, continue with the rest of the selections
                continueWithSelections(choices, isSelectionOpen);
            } else {
                // Fallback to showing only the selected major if we couldn't get eligible majors
                const selectedMajors = choices.major ? [choices.major] : [];
                renderMajorSelection(selectedMajors, isSelectionOpen);
                
                // After rendering the major selection, continue with the rest of the selections
                continueWithSelections(choices, isSelectionOpen);
            }
        })
        .catch(error => {
            console.error('Error fetching eligible majors:', error);
            // Fallback to showing only the selected major
            const selectedMajors = choices.major ? [choices.major] : [];
            renderMajorSelection(selectedMajors, isSelectionOpen);
            
            // After rendering the major selection, continue with the rest of the selections
            continueWithSelections(choices, isSelectionOpen);
        });
}

// Helper function to continue building the interface after major selection is rendered
function continueWithSelections(choices, isSelectionOpen) {
    const interfaceDiv = document.getElementById('selection-interface');
    
    // Highlight selected major
    if (choices.major) {
        const majorCard = document.querySelector(`#major-selection .option-card[data-value="${choices.major}"]`);
        if (majorCard) majorCard.classList.add('selected');
    }

    if (choices.major && choices.major !== 'NONE') {
        // Show major-level buttons only if selection is open
        if (isSelectionOpen) {
            interfaceDiv.innerHTML += `
                <div class="action-buttons" id="main-buttons">
                    <button class="btn-primary" onclick="showSecondMajorOptions()">
                        <i class="fas fa-graduation-cap"></i> Pick a Second Major
                    </button>
                    <button class="btn-primary" onclick="showMinorOptions()">
                        <i class="fas fa-book"></i> Pick a Minor
                    </button>
                </div>
            `;
        }

        // Show second major if it exists
        if (choices.second_major) {
            showSecondMajorOptions(isSelectionOpen);
            setTimeout(() => {
                const secondMajorCard = document.querySelector(`#second-major-selection .option-card[data-value="${choices.second_major}"]`);
                if (secondMajorCard) {
                    secondMajorCard.classList.add('selected');
                    // Call handleSecondMajorSelection to add the confirm button
                    handleSecondMajorSelection(choices.second_major);
                }
            }, 150);
        }

        // Show minor if it exists
        else if (choices.minor) {
            showMinorOptions(isSelectionOpen);
            setTimeout(() => {
                const minorCard = document.querySelector(`#minor-selection .option-card[data-value="${choices.minor}"]`);
                if (minorCard) {
                    minorCard.classList.add('selected');
                    // Call handleMinorSelection to add the confirm button
                    handleMinorSelection(choices.minor);
                }
            }, 150);
        }

        // Delay final button injection to wait for everything else to render
        setTimeout(() => {
            const confirmExists = document.querySelector('.final-action');
            if (!confirmExists && isSelectionOpen) {
                interfaceDiv.innerHTML += `
                    <div class="action-buttons final-action">
                        <button class="btn-primary" onclick="submitChoices()">
                            <i class="fas fa-sync-alt"></i> Update Choices
                        </button>
                    </div>
                `;
            }
            // Don't show confirmation popup again - it's already shown at the beginning of this function
        }, 300); // delay long enough for all sections

    } else if (choices.major === 'NONE') {
        const noneCard = document.querySelector(`#major-selection .option-card[data-value="NONE"]`);
        if (noneCard) noneCard.classList.add('selected');

        if (isSelectionOpen) {
            interfaceDiv.innerHTML += `
                <div class="action-buttons final-action">
                    <button class="btn-primary" onclick="submitChoices()">
                        <i class="fas fa-check"></i> Update Choices
                    </button>
                </div>
            `;
        }
        
        // Don't show confirmation popup again - it's already shown at the beginning of this function
     }
}


function fetchMajorGPA() {
    // First fetch the major requirements data
    return fetch('/student/major_minor/major_requirements')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to load major GPA data');
            
            // Then fetch specialized GPAs from the database
            return fetch('/student/major_minor/specialized_gpas')
                .then(response => {
                    if (!response.ok) {
                        // If specialized GPAs are not available, just use the calculated values
                        console.log('Specialized GPAs not available in database, using calculated values');
                        renderMajorGPAs(data.data);
                        return data;
                    }
                    return response.json().then(gpaData => {
                        if (gpaData.success && gpaData.specialized_gpas) {
                            // Update the major data with specialized GPAs from the database
                            for (const [majorCode, gpa] of Object.entries(gpaData.specialized_gpas)) {
                                if (data.data.major_data[majorCode] && gpa !== null) {
                                    console.log(`Updating ${majorCode} GPA from ${data.data.major_data[majorCode].gpa} to ${gpa}`);
                                    data.data.major_data[majorCode].gpa = gpa;
                                }
                            }
                        }
                        renderMajorGPAs(data.data);
                        return data;
                    });
                })
                .catch(error => {
                    // If there's an error fetching specialized GPAs, just use the calculated values
                    console.error('Error fetching specialized GPAs:', error);
                    renderMajorGPAs(data.data);
                    return data;
                });
        })
        .catch(error => {
            console.error('Error loading major GPAs:', error);
            document.getElementById('major-gpa-cards').innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> Failed to load major GPA data
                    <p>${error.message}</p>
                    <button onclick="fetchMajorGPA()" class="btn-primary">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>
            `;
            throw error; // Re-throw the error for chaining
        });
}

function renderMajorGPAs(data) {
    const container = document.getElementById('major-gpa-cards');
    
    // Create header with cumulative GPA and credit status
    let html = `
        <div class="student-summary">
            <div class="eligibility-note eligibility-note-flex">
                <p><i class="fas fa-info-circle"></i> To be eligible for any major, you must meet <b>all THREE</b> requirements:</p>
                <ol>
                    <li>Cumulative GPA â‰¥ ${data.min_cumulative_gpa.toFixed(2)}</li>
                    <li>Earned ALL of Freshman-Sophomore credits</li>
                    <li>Specialized GPA â‰¥ Minimum Specialized GPA for that major</li>
                </ol>
            </div>
            <div class="summary-card summary-card-flex ${data.meets_cumulative_gpa ? 'eligible' : 'ineligible'}">
                <h4><i class="fas fa-graduation-cap"></i> Cumulative GPA</h4>
                <div class="summary-value">${data.cumulative_gpa ? data.cumulative_gpa.toFixed(2) : '--'}/${data.min_cumulative_gpa ? data.min_cumulative_gpa.toFixed(2) : '--'}</div>
                <div class="summary-status">
                    ${data.meets_cumulative_gpa ? 
                        '<i class="fas fa-check-circle"></i> Requirement met' : 
                        '<i class="fas fa-exclamation-circle"></i> Requirement not met'}
                </div>
            </div>
            <div class="summary-card summary-card-flex ${data.credit_status.meets_requirement ? 'eligible' : 'ineligible'}">
                <h4><i class="fas fa-book"></i> Earned Credits</h4>
                <div class="summary-value">
                    ${data.credit_status.earned_credits}/${data.credit_status.total_weights}
                </div>
                <div class="summary-status">
                    ${data.credit_status.meets_requirement ? 
                        '<i class="fas fa-check-circle"></i> Requirement met' : 
                        '<i class="fas fa-exclamation-circle"></i> Requirement not met'}
                </div>  
            </div>
        </div>
        <h3><i class="fas fa-clipboard-check"></i> Specialized GPA by Major</h3>
        <div class="major-gpa-grid">
    `;
    
    const majorsOrder = data.majors_order;

    majorsOrder.forEach((majorCode, index) => {
        const majorInfo = data.major_data[majorCode];
        if (!majorInfo) return;
        
        const majorName = majorInfo.full_name || majorCode;
        const isEligible = majorInfo.is_eligible;
        const boxClass = majorInfo.meets_specialized_reqs ? 'eligible' : 'ineligible';
        const gpaDisplay = majorInfo.gpa !== null ? majorInfo.gpa.toFixed(2) : '--';
        const requiredGpa = majorInfo.required_gpa.toFixed(2);
        
        const totalWeight = majorInfo.requirements.reduce((sum, course) => sum + course.weight, 0);
        const totalContribution = majorInfo.requirements.reduce((sum, course) => {
            return sum + (course.weighted_grade !== null ? course.weighted_grade : 0);
        }, 0);
        
        const gridClasses = [];
        if (index === 3) gridClasses.push('grid-item-second-row-first');
        if (index === 4) gridClasses.push('grid-item-second-row-last');
        
        html += `
            <div class="major-gpa-box ${boxClass} ${gridClasses.join(' ')}">
                <div class="major-header">
                    <h4>${majorName}</h4>
                    <div class="gpa-badge">${gpaDisplay}/${requiredGpa}</div>
                </div>
                
                <div class="course-breakdown">
                    <table>
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th class="grade-header">Letter Grade</th>
                                <th>Weight</th>
                                <th>Contribution</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${majorInfo.requirements.map(course => {
                                const belowMinimum = course.meets_minimum === false;
                                const gradeDisplay = course.letter_grade || '--';
                                const tooltipIcon = (course.minimum_grade_point !== null && course.minimum_grade_point !== undefined) ? 
                                    `<span class="min-grade-tooltip" title="Minimum grade: ${course.minimum_grade_point.toFixed(2)}">
                                        <i class="fas fa-info-circle"></i>
                                    </span>` : '';
                                const weightedDisplay = course.weighted_grade !== null ? course.weighted_grade.toFixed(2) : '--';
                                
                                return `
                                    <tr${belowMinimum ? ' class="row-below-minimum"' : ''}>
                                        <td>${course.course_code}</td>
                                        <td class="grade-cell">
                                            ${gradeDisplay}
                                            ${tooltipIcon}
                                        </td>
                                        <td>${course.weight}</td>
                                        <td>${weightedDisplay}</td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr class="total-divider">
                                <td></td>
                                <td></td>
                                <td colspan="2"></td>
                            </tr>
                            <tr class="total-row-alt">
                                <td></td>
                                <td></td>
                                <td><strong>${totalWeight}</strong></td>
                                <td><strong>${totalContribution.toFixed(2)}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    renderSelectionInterface(data);
}
    
function fetchRejectedCombinations() {
    return fetch('/student/major_minor/rejected_combinations')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to load rejected combinations');
            rejectedCombinations = data.rejected_combinations || [];
            displayRejectedCombinations();
        })
        .catch(error => {
            console.error('Error loading rejected combinations:', error);
            rejectedCombinations = [];
        });
}

function displayRejectedCombinations() {
    const container = document.getElementById('rejected-combinations-container');
    if (!container) return;
    
    if (rejectedCombinations.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    let html = `
        <div class="rejected-combinations">
            <h3><i class="fas fa-ban"></i> Rejected Combinations</h3>
            <p class="info-text">The administration does not permit the following combinations:</p>
            <div class="combinations-list">
    `;
    
    rejectedCombinations.forEach(combo => {
        html += `<div class="rejected-combo">`;
        
        // Display major
        if (combo.major) {
            html += `<span class="combo-item">
                <span class="combo-label">Major:</span> 
                <span class="combo-value">${majorOptions[combo.major] || combo.major}</span>
            </span>`;
        }
        
        // Display second major if exists
        if (combo.second_major) {
            html += `<span class="combo-item">
                <span class="combo-label">Second Major:</span> 
                <span class="combo-value">${majorOptions[combo.second_major] || combo.second_major}</span>
            </span>`;
        }
        
        // Display minor if exists
        if (combo.minor) {
            html += `<span class="combo-item">
                <span class="combo-label">Minor:</span> 
                <span class="combo-value">${minorOptions[combo.minor] || combo.minor}</span>
            </span>`;
        }
        
        // Second minor option has been removed
        
        html += `</div>`;
    });
    
    html += `
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function fetchMajorMinorOptions() {
    return fetch('/student/major_minor/options')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (!data.success) throw new Error(data.message || 'Failed to load options');
            majorOptions = data.majors;
            minorOptions = data.minors;
        })
        .catch(error => {
            console.error('Error loading major/minor options:', error);
            // Fallback to empty objects
            majorOptions = {};
            minorOptions = {};
        });
}

function renderSelectionInterface(data) {
    const eligibilityDiv = document.getElementById('eligibility-status');
    const interfaceDiv = document.getElementById('selection-interface');
    const interfaceWrapper = document.getElementById('selection-interface-wrapper');
    const selectionContainer = document.getElementById('selection-container');
    
    // Only reset if we don't have existing selections
    if (!selectedChoices.major && !selectedChoices.minor) {
        selectedChoices = {
            major: null,
            second_major: null,
            minor: null
        };
    }
    
    if (!data.eligible_majors || data.eligible_majors.length === 0) {
        eligibilityDiv.innerHTML = `
            <div class="eligibility-message not-eligible">
                <i class="fas fa-exclamation-circle"></i>
                You are not eligible to choose a major, yet.
            </div>
        `;
        interfaceDiv.innerHTML = '';
        
        // Add class to selection container to help with CSS targeting
        if (selectionContainer) {
            selectionContainer.classList.add('student-not-eligible');
        }
        return;
    }
    
    // Remove not-eligible class if it exists
    if (selectionContainer && selectionContainer.classList.contains('student-not-eligible')) {
        selectionContainer.classList.remove('student-not-eligible');
    }
    
    eligibilityDiv.innerHTML = `
        <div class="eligibility-message eligible">
            <i class="fas fa-check-circle"></i>
            You are eligible to select a major.
        </div>
    `;
    
    // Check if selection window is open
    const isSelectionOpen = window.selectionWindowStatus && window.selectionWindowStatus.is_open;
    
    // If selection window is closed, hide the selection interface completely
    if (!isSelectionOpen) {
        interfaceDiv.innerHTML = '';
        // If user has no selections at all and window is closed, just return
        if (!selectedChoices.major && !selectedChoices.minor) {
            return;
        }
        // Otherwise, show confirmation popup with existing selections
        setTimeout(() => {
            showConfirmationPopup(selectedChoices);
        }, 100);
        return;
    }
    
    // Always show confirmation popup if there are existing selections
    // regardless of status (pending, accepted, rejected)
    if (selectedChoices.major || selectedChoices.minor) {
        setTimeout(() => {
            showConfirmationPopup(selectedChoices);
        }, 100);
    }
    
    // Only render fresh interface if we don't have existing selections
    if (!selectedChoices.major && !selectedChoices.minor) {
        // Pass ONLY the eligible majors to renderMajorSelection
        renderMajorSelection(data.eligible_majors, isSelectionOpen);
    }
}

function renderMajorSelection(eligibleMajors, isSelectionOpen = true) {
    const interfaceDiv = document.getElementById('selection-interface');
    
    // Clear current selection
    interfaceDiv.innerHTML = '';
    
    // Check if student is eligible for all majors (then we don't show "None")
    const showNoneOption = eligibleMajors.length < Object.keys(majorOptions).length;
    
    let html = `
        <div class="selection-step" id="major-selection">
            <h3><i class="fas fa-tasks"></i> Select Major</h3>
            <div class="options-grid${!isSelectionOpen ? ' disabled' : ''}">
    `;
    
    // Add ONLY eligible major options
    Object.keys(majorOptions).forEach(major => {
        // Only show majors that are in the eligibleMajors array
        if (eligibleMajors.includes(major)) {
            const isSelected = selectedChoices.major === major;
            html += `
                <div class="option-card ${isSelected ? 'selected' : ''}${!isSelectionOpen ? ' disabled' : ''}" 
                     data-value="${major}" 
                     onclick="${isSelectionOpen ? `handleMajorSelectionClick(this, '${major}')` : ''}">
                    <h4>${majorOptions[major] || major}</h4>
                    <div class="option-check"><i class="fas fa-check"></i></div>
                    ${!isSelectionOpen ? '<div class="disabled-overlay"><i class="fas fa-lock"></i></div>' : ''}
                </div>
            `;
        }
    });
    
    // Add "None" option if needed
    if (showNoneOption) {
        const isSelected = selectedChoices.major === 'NONE';
        html += `
            <div class="option-card ${isSelected ? 'selected' : ''}${!isSelectionOpen ? ' disabled' : ''}" 
                 data-value="NONE" 
                 onclick="${isSelectionOpen ? `handleMajorSelectionClick(this, 'NONE')` : ''}">
                <h4>None</h4>
                <div class="option-check"><i class="fas fa-check"></i></div>
                ${!isSelectionOpen ? '<div class="disabled-overlay"><i class="fas fa-lock"></i></div>' : ''}
            </div>
        `;
    }
    
    html += `</div></div>`;
    interfaceDiv.innerHTML = html;
    
    // If selection is not open and there are existing selections, show them
    if (!isSelectionOpen && selectedChoices.major) {
        rebuildInterfaceWithSelections(selectedChoices);
    }
}

function handleMajorSelectionClick(element, value) {
    // Check if this is a double-click on the already selected option
    if (selectedChoices.major === value) {
        // Reset all dependent selections
        selectedChoices = {
            major: null,
            second_major: null,
            minor: null
        };
        renderMajorSelection(Object.keys(majorOptions).filter(m => 
            document.querySelector(`#major-selection .option-card[data-value="${m}"]`)
        ));
        return;
    }
    
    // Update selected choice
    selectedChoices.major = value;
    selectedChoices.second_major = null;
    selectedChoices.minor = null;
    
    // Highlight selected option
    document.querySelectorAll(`#major-selection .option-card`).forEach(card => {
        card.classList.remove('selected');
    });
    element.classList.add('selected');
    
    // Handle next steps based on selection
    handleMajorSelection(value);
}

function handleMajorSelection(selectedMajor) {
    const interfaceDiv = document.getElementById('selection-interface');
    
    // Remove any existing selection steps after the major selection
    const majorSelectionDiv = document.getElementById('major-selection');
    if (majorSelectionDiv) {
        let nextSibling = majorSelectionDiv.nextElementSibling;
        while (nextSibling) {
            interfaceDiv.removeChild(nextSibling);
            nextSibling = majorSelectionDiv.nextElementSibling;
        }
    }
    
    if (selectedMajor === 'NONE') {
        // Case 5: Selected "None" - show confirm button immediately
        interfaceDiv.innerHTML += `
            <div class="action-buttons">
                <button class="btn-primary confirm-choice-btn" onclick="submitChoices()">
                    <i class="fas fa-check"></i> Confirm Choice
                </button>
            </div>
        `;
        return;
    }
    
    // Case 2: Show second major and minor buttons
    let html = `
        <div class="action-buttons">
    `;
    
    // Check if eligible for second major (has more than one eligible major)
    const eligibleMajors = Object.keys(majorOptions).filter(m => 
        document.querySelector(`#major-selection .option-card[data-value="${m}"]`)
    );
    const canSecondMajor = eligibleMajors.length > 1;
    
    html += `
        <button class="btn-primary ${!canSecondMajor ? 'disabled' : ''}" 
                onclick="showSecondMajorOptions()" ${!canSecondMajor ? 'disabled' : ''}>
            <i class="fas fa-graduation-cap"></i> Pick a Second Major
        </button>
        <button class="btn-primary" onclick="showMinorOptions()">
            <i class="fas fa-book"></i> Pick a Minor
        </button>
    `;
    
    interfaceDiv.innerHTML += html;
    
    // Note: No confirm button is added here - user must pick a second major or minor
}

function showSecondMajorOptions(isSelectionOpen = true) {
    const interfaceDiv = document.getElementById('selection-interface');

    // Remove any existing second major selection if present
    const existingSecondMajor = document.getElementById('second-major-selection');
    if (existingSecondMajor) {
        interfaceDiv.removeChild(existingSecondMajor);
    }

    // ðŸ§¼ Remove minor selection if present (prevent stacking)
    const existingMinor = document.getElementById('minor-selection');
    if (existingMinor) {
        interfaceDiv.removeChild(existingMinor);
    }

    // Remove any action buttons that might follow the first one
    const actionButtons = document.querySelectorAll('.action-buttons');
    if (actionButtons.length > 1) {
        for (let i = 1; i < actionButtons.length; i++) {
            interfaceDiv.removeChild(actionButtons[i]);
        }
    }
    
    // Remove any confirm buttons from the first action buttons
    const confirmButtons = document.querySelectorAll('.action-buttons .confirm-choice-btn');
    confirmButtons.forEach(btn => btn.remove());

    // Get eligible majors excluding the first selected one
    // Only consider majors that are actually in the DOM (which means they're eligible)
    const eligibleMajors = [];
    document.querySelectorAll('#major-selection .option-card').forEach(card => {
        const majorValue = card.getAttribute('data-value');
        if (majorValue && majorValue !== 'NONE' && majorValue !== selectedChoices.major) {
            eligibleMajors.push(majorValue);
        }
    });

    let html = `
        <div class="selection-step" id="second-major-selection">
            <h3><i class="fas fa-tasks"></i> Select Second Major</h3>
            <div class="options-grid${!isSelectionOpen ? ' disabled' : ''}">
    `;

    eligibleMajors.forEach(major => {
        const isSelected = selectedChoices.second_major === major;
        html += `
            <div class="option-card ${isSelected ? 'selected' : ''}${!isSelectionOpen ? ' disabled' : ''}" 
                 data-value="${major}" 
                 onclick="${isSelectionOpen ? `selectOption(this, 'second_major')` : ''}">
                <h4>${majorOptions[major] || major}</h4>
                <div class="option-check"><i class="fas fa-check"></i></div>
                ${!isSelectionOpen ? '<div class="disabled-overlay"><i class="fas fa-lock"></i></div>' : ''}
            </div>
        `;
    });

    html += `</div></div>`;
    interfaceDiv.innerHTML += html;
    
    // No confirm button is added here - it will only appear after a selection is made
}



function showMinorOptions(isSelectionOpen = true) {
    const interfaceDiv = document.getElementById('selection-interface');

    // Remove any existing minor selection if present
    const existingMinor = document.getElementById('minor-selection');
    if (existingMinor) {
        interfaceDiv.removeChild(existingMinor);
    }

    // ðŸ§¼ Remove second major selection if present (prevent stacking)
    const existingSecondMajor = document.getElementById('second-major-selection');
    if (existingSecondMajor) {
        interfaceDiv.removeChild(existingSecondMajor);
    }

    // Remove any existing second minor selection if present
    const existingSecondMinor = document.getElementById('second-minor-selection');
    if (existingSecondMinor) {
        interfaceDiv.removeChild(existingSecondMinor);
    }

    // Remove any action buttons that might follow the first one
    const actionButtons = document.querySelectorAll('.action-buttons');
    if (actionButtons.length > 1) {
        for (let i = 1; i < actionButtons.length; i++) {
            interfaceDiv.removeChild(actionButtons[i]);
        }
    }
    
    // Remove any confirm buttons from the first action buttons
    const confirmButtons = document.querySelectorAll('.action-buttons .confirm-choice-btn');
    confirmButtons.forEach(btn => btn.remove());

    // Get minors excluding the selected major (if any)
    const availableMinors = Object.keys(minorOptions).filter(m =>
        m !== selectedChoices.major
    );

    let html = `
        <div class="selection-step" id="minor-selection">
            <h3><i class="fas fa-book"></i> Select Minor</h3>
            <div class="options-grid${!isSelectionOpen ? ' disabled' : ''}">
    `;

    availableMinors.forEach(minor => {
        const isSelected = selectedChoices.minor === minor;
        html += `
            <div class="option-card ${isSelected ? 'selected' : ''}${!isSelectionOpen ? ' disabled' : ''}" 
                 data-value="${minor}" 
                 onclick="${isSelectionOpen ? `selectOption(this, 'minor')` : ''}">
                <h4>${minorOptions[minor] || minor}</h4>
                <div class="option-check"><i class="fas fa-check"></i></div>
                ${!isSelectionOpen ? '<div class="disabled-overlay"><i class="fas fa-lock"></i></div>' : ''}
            </div>
        `;
    });

    html += `</div></div>`;
    interfaceDiv.innerHTML += html;
    
    // No confirm button is added here - it will only appear after a selection is made
}




// This function has been removed as second minors are no longer supported


function selectOption(element, type) {
    const value = element.getAttribute('data-value');
    
    // Check if this is a double-click on the already selected option
    if (selectedChoices[type] === value) {
        // Reset this selection and any dependent selections
        if (type === 'major') {
            selectedChoices = {
                major: null,
                second_major: null,
                minor: null
            };
            // Re-fetch eligible majors to ensure we're showing the correct list
            fetch('/student/major_minor/major_requirements')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data && data.data.eligible_majors) {
                        renderMajorSelection(data.data.eligible_majors, true);
                    }
                })
                .catch(error => {
                    console.error('Error fetching eligible majors:', error);
                    // Fallback to showing majors in the DOM
                    const majorsInDom = [];
                    document.querySelectorAll('#major-selection .option-card').forEach(card => {
                        const majorValue = card.getAttribute('data-value');
                        if (majorValue && majorValue !== 'NONE') {
                            majorsInDom.push(majorValue);
                        }
                    });
                    renderMajorSelection(majorsInDom, true);
                });
        } else if (type === 'second_major') {
            selectedChoices.second_major = null;
            document.querySelectorAll('#second-major-selection .option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Remove any confirm buttons when deselecting
            const confirmButtons = document.querySelectorAll('.confirm-choice-btn');
            confirmButtons.forEach(btn => {
                if (btn.closest('.action-buttons')) {
                    btn.closest('.action-buttons').remove();
                }
            });
            
            handleMajorSelection(selectedChoices.major);
        } else if (type === 'minor') {
            selectedChoices.minor = null;
            document.querySelectorAll('#minor-selection .option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Remove any confirm buttons when deselecting
            const confirmButtons = document.querySelectorAll('.confirm-choice-btn');
            confirmButtons.forEach(btn => {
                if (btn.closest('.action-buttons')) {
                    btn.closest('.action-buttons').remove();
                }
            });
            
            handleMajorSelection(selectedChoices.major);
        }
        return;
    }
    
    // Update selected choice
    selectedChoices[type] = value;
    console.log(`Selected ${type}: ${value}`);
    console.log('Current selections:', selectedChoices);
    
    // Reset any dependent selections
    if (type === 'major') {
        selectedChoices.second_major = null;
        selectedChoices.minor = null;
    } else if (type === 'second_major') {
        // If selecting a second major, clear any minor selection
        selectedChoices.minor = null;
    } else if (type === 'minor') {
        // If selecting a minor, clear any second major selection
        selectedChoices.second_major = null;
    }
    
    // Highlight selected option
    document.querySelectorAll(`#${type.replace('_', '-')}-selection .option-card`).forEach(card => {
        card.classList.remove('selected');
    });
    element.classList.add('selected');
    
    // Handle next steps based on selection type
    if (type === 'major') {
        handleMajorSelection(value);
    } else if (type === 'second_major') {
        handleSecondMajorSelection(value);
    } else if (type === 'minor') {
        handleMinorSelection(value);
    }
}

function handleSecondMajorSelection(selectedSecondMajor) {
    const interfaceDiv = document.getElementById('selection-interface');
    // Clear any minor selections
    selectedChoices.minor = null;
    
    // Remove any existing action buttons after the first one
    const actionButtons = document.querySelectorAll('.action-buttons');
    if (actionButtons.length > 1) {
        for (let i = 1; i < actionButtons.length; i++) {
            interfaceDiv.removeChild(actionButtons[i]);
        }
    }
    
    // Show confirm button
    interfaceDiv.innerHTML += `
        <div class="action-buttons final-action">
            <button class="btn-primary confirm-choice-btn" onclick="submitChoices()">
                <i class="fas fa-check"></i> Confirm Choice
            </button>
        </div>
    `;
}

function handleMinorSelection(selectedMinor) {
    const interfaceDiv = document.getElementById('selection-interface');
    selectedChoices.second_major = null;
    
    // Remove any existing second minor selection
    const existingSecondMinor = document.getElementById('second-minor-selection');
    if (existingSecondMinor) {
        interfaceDiv.removeChild(existingSecondMinor);
    }

    // Remove only extra action buttons (keep the first one)
    const actionButtons = document.querySelectorAll('.action-buttons');
    if (actionButtons.length > 1) {
        for (let i = 1; i < actionButtons.length; i++) {
            interfaceDiv.removeChild(actionButtons[i]);
        }
    }

    // Add a new confirm button block
    const newActions = document.createElement('div');
    newActions.className = 'action-buttons final-action';

    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'btn-primary confirm-choice-btn';
    confirmBtn.innerHTML = `<i class="fas fa-check"></i> Confirm Choice`;
    confirmBtn.onclick = submitChoices;

    newActions.appendChild(confirmBtn);
    interfaceDiv.appendChild(newActions);
}




// This function has been removed as second minors are no longer supported




function submitChoices() {
    // Check if selection window is open
    if (window.selectionWindowStatus && !window.selectionWindowStatus.is_open) {
        showErrorMessage('Major/Minor selection is currently closed. Please wait for the selection window to open.');
        return;
    }
    
    // Filter out null values
    const payload = Object.fromEntries(
        Object.entries(selectedChoices).filter(([_, v]) => v !== null && !['status', 'submission_date'].includes(_))
    );
    
    // Validate that user has selected either a second major or a minor when major is not NONE
    if (payload.major && payload.major !== 'NONE' && !payload.second_major && !payload.minor) {
        showErrorMessage('You must select either a second major or a minor to complete your selection.');
        return;
    }
    
    // Check if the current selection is in the rejected combinations list
    const isRejected = checkIfRejectedCombination(payload);
    if (isRejected) {
        showErrorMessage('This combination has been rejected by the administration and cannot be selected.');
        return;
    }
    
    fetch('/student/major_minor/select', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ choices: payload })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                if (data.code === 'REJECTED_COMBINATION') {
                    // Refresh rejected combinations list
                    fetchRejectedCombinations();
                }
                throw new Error(data.message || 'Submission failed');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Change button text to "Update Choices"
            const confirmButtons = document.querySelectorAll('.action-buttons .btn-primary');
            confirmButtons.forEach(button => {
                if (button.textContent.includes('Confirm') || button.textContent.includes('Update')) {
                    button.innerHTML = '<i class="fas fa-sync-alt"></i> Update Choices';
                }
            });
            
            // Update the status in the selectedChoices to the returned status (should be 'pending')
            selectedChoices.status = data.status || 'pending';
            
            // Update submission date
            selectedChoices.submission_date = new Date().toISOString().split('T')[0]; // Today's date in YYYY-MM-DD format
            
            // Show confirmation popup with updated status
            const updatedPayload = {
                ...payload, 
                status: selectedChoices.status,
                submission_date: selectedChoices.submission_date
            };
            showConfirmationPopup(updatedPayload);
            
            // Refresh current choices to ensure we have the latest status
            setTimeout(() => {
                fetch('/student/major_minor/current')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.choices) {
                            // Update global selectedChoices with fresh data
                            selectedChoices = data.choices;
                        }
                    })
                    .catch(err => console.error('Error refreshing choices:', err));
            }, 500);
        } else {
            throw new Error(data.message || 'Submission failed');
        }
    })
    .catch(error => {
        showErrorMessage(`Failed to submit selection: ${error.message}`);
    });
}

function checkIfRejectedCombination(choices) {
    if (!rejectedCombinations || rejectedCombinations.length === 0) {
        return false;
    }
    
    // Check if current selection matches any rejected combination
    return rejectedCombinations.some(combo => {
        // Check major
        if (combo.major !== choices.major) {
            return false;
        }
        
        // Check second major
        if ((combo.second_major && !choices.second_major) || 
            (!combo.second_major && choices.second_major) ||
            (combo.second_major && choices.second_major && combo.second_major !== choices.second_major)) {
            return false;
        }
        
        // Check minor
        if ((combo.minor && !choices.minor) || 
            (!combo.minor && choices.minor) ||
            (combo.minor && choices.minor && combo.minor !== choices.minor)) {
            return false;
        }
        
        // Second minor option has been removed
        
        // If we got here, all fields match
        return true;
    });
}

function showConfirmationPopup(choices) {
    const wrapper = document.getElementById('selection-interface-wrapper');
    if (!wrapper) return;
    
    // Check if selection window is open
    const isSelectionOpen = window.selectionWindowStatus && window.selectionWindowStatus.is_open;
    
    // Remove any existing overlay
    const existingOverlay = wrapper.querySelector('.confirmation-overlay');
    if (existingOverlay) {
        wrapper.removeChild(existingOverlay);
    }
    
    const overlay = document.createElement('div');
    overlay.className = 'confirmation-overlay';
    
    // If selection is closed, add a class to position the popup lower
    if (!isSelectionOpen) {
        overlay.classList.add('lower-position');
    }
    
    // Status display
    const status = choices.status || 'pending';
    let statusClass, statusIcon, statusText;
    
    if (status === 'approved' || status === 'accepted') {
        statusClass = 'status-approved';
        statusIcon = 'fa-check-circle';
        statusText = 'APPROVED';
    } else if (status === 'rejected') {
        statusClass = 'status-rejected';
        statusIcon = 'fa-times-circle';
        statusText = 'REJECTED';
    } else {
        statusClass = 'status-pending';
        statusIcon = 'fa-clock';
        statusText = 'PENDING';
    }
    
    // Don't add status class to the overlay - keep it transparent
    
    // Always make it dismissible if the selection window is open
    // Regardless of status (pending, accepted, rejected)
    if (isSelectionOpen) {
        overlay.onclick = () => wrapper.removeChild(overlay);
    }
    
    // Customize message based on status
    let headerMessage, headerIcon;
    
    if (status === 'approved' || status === 'accepted') {
        headerMessage = "Your Major/Minor selection has been approved";
        headerIcon = "fa-check-circle";
    } else if (status === 'rejected') {
        headerMessage = "Your Major/Minor selection has been rejected";
        headerIcon = "fa-times-circle";
    } else {
        headerMessage = "Your Major/Minor selection request has been sent";
        headerIcon = "fa-paper-plane";
    }
    
    let html = `
        <div class="confirmation-box" onclick="event.stopPropagation()">
            <h3><i class="fas ${headerIcon}"></i> ${headerMessage}</h3>
            
            <div class="status-badge ${statusClass}">
                <i class="fas ${statusIcon}"></i> ${statusText}
                ${choices.submission_date ? `<span class="submission-date">Submitted: ${choices.submission_date}</span>` : ''}
            </div>
    `;
    
    if (choices.major && choices.major !== 'NONE') {
        html += `
            <div class="selection-item">
                <div class="selection-label">Primary Major</div>
                <div class="selection-value">${majorOptions[choices.major] || choices.major}</div>
            </div>
        `;
    } else if (choices.major === 'NONE') {
        html += `
            <div class="selection-item">
                <div class="selection-label">Primary Major</div>
                <div class="selection-value">None selected</div>
            </div>
        `;
    }
    
    if (choices.second_major) {
        html += `
            <div class="selection-item">
                <div class="selection-label">Second Major</div>
                <div class="selection-value">${majorOptions[choices.second_major] || choices.second_major}</div>
            </div>
        `;
    }
    
    if (choices.minor) {
        html += `
            <div class="selection-item">
                <div class="selection-label">Primary Minor</div>
                <div class="selection-value">${minorOptions[choices.minor] || choices.minor}</div>
            </div>
        `;
    }
    
    // Second minor option has been removed
    
    if (isSelectionOpen) {
        html += `
            <div class="confirmation-note">
                Click anywhere outside this box to make changes
            </div>
        `;
    }
    
    html += `</div>`;
    
    overlay.innerHTML = html;
    wrapper.appendChild(overlay);
}

// Show success message
function showSuccessMessage(message) {
    const successMsg = document.createElement('div');
    
    // Check if this is an error message (starts with "Error:")
    if (message.startsWith('Error:')) {
        // Remove the "Error:" prefix and show as a notification
        successMsg.className = 'notification';
        successMsg.textContent = message.substring(7).trim(); // Remove "Error: " prefix
    } else {
        successMsg.className = 'success-message';
        // Check if message contains HTML
        if (message.includes('<br>') || message.includes('<strong>')) {
            successMsg.innerHTML = message;
            successMsg.style.textAlign = 'left';
            successMsg.style.whiteSpace = 'pre-line';
            successMsg.style.maxWidth = '600px';
            successMsg.style.width = '80%';
        } else {
            successMsg.textContent = message;
        }
    }
    
    document.body.appendChild(successMsg);
    
    // For debug messages with HTML, show longer
    const timeout = message.includes('<br>') ? 10000 : 4000;
    
    setTimeout(() => {
        successMsg.remove();
    }, timeout);
}

function showErrorMessage(message) {
    const interfaceDiv = document.getElementById('selection-interface');
    
    // Remove any existing error messages first
    const existingErrors = interfaceDiv.querySelectorAll('.error-message');
    existingErrors.forEach(error => error.remove());
    
    // Create a new error message element
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        ${message}
    `;
    
    // Insert at the beginning of the interface div
    if (interfaceDiv.firstChild) {
        interfaceDiv.insertBefore(errorDiv, interfaceDiv.firstChild);
    } else {
        interfaceDiv.appendChild(errorDiv);
    }
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (errorDiv.parentNode === interfaceDiv) {
            interfaceDiv.removeChild(errorDiv);
        }
    }, 5000);
}

// Add styles for selection window status and disabled option cards
document.addEventListener('DOMContentLoaded', function() {
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        /* Forgiveness Counter Styles */
        .forgiveness-counter {
            font-size: 14px;
            font-weight: normal;
            color: #6c757d;
            margin-left: 10px;
            padding: 2px 8px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .forgiveness-counter.limit-exceeded {
            color: #fff;
            background-color: #dc3545;
            border-color: #dc3545;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Rejected Combinations Styles */
        .rejected-combinations-container {
            margin: 20px 0;
        }
        
        .rejected-combinations {
            background-color: #fff9f9;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .rejected-combinations h3 {
            color: #721c24;
            margin-top: 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            font-size: 18px;
        }
        
        .rejected-combinations h3 i {
            margin-right: 8px;
            color: #dc3545;
        }
        
        .rejected-combinations .info-text {
            color: #721c24;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .combinations-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #f1aeb5;
            border-radius: 4px;
            background-color: #fff;
        }
        
        .rejected-combo {
            padding: 10px;
            border-bottom: 1px solid #f1aeb5;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .rejected-combo:last-child {
            border-bottom: none;
        }
        
        .combo-item {
            background-color: #f8d7da;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
        }
        
        .combo-label {
            font-weight: bold;
            margin-right: 4px;
            color: #721c24;
        }
        
        .combo-value {
            color: #721c24;
        }
        /* Selection Window Status Styles */
        .selection-window-status-container {
            margin-bottom: 20px;
            position: relative;
            z-index: 15; /* Higher than the confirmation overlay */
        }
        
        .selection-window-status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .selection-window-status i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .selection-window-status.open {
            background-color: #FFFFFF;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .selection-window-status.scheduled {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }

        .selection-window-status.neutral {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #6c757d;
        }

        .selection-window-status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .selection-countdown {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
        }

        .selection-note {
            font-size: 12px;
            margin-top: 10px;
            font-style: italic;
        }

        /* Disabled Option Cards */
        .options-grid.disabled {
            opacity: 0.8;
            pointer-events: none;
        }

        .option-card.disabled {
            position: relative;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .disabled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }

        .disabled-overlay i {
            font-size: 24px;
            color: #721c24;
        }
        
        /* Confirmation Overlay - Enhanced for closed selection period */
        .confirmation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Half-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        /* Position the popup lower when selection window is closed */
        .confirmation-overlay.lower-position {
            align-items: flex-start;
            padding-top: 0px; /* Push the popup down */
        }
        
        .selection-interface-wrapper {
            position: relative;
            min-height: 300px;
            margin-top: 20px;
        }
        
        .confirmation-box {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        
        /* Status-specific styling for the confirmation box */
        .confirmation-box {
            border-left: 5px solid #ddd;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 10px 0 20px;
            font-weight: bold;
        }
        
        .status-badge.status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .status-badge.status-approved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-badge.status-rejected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .submission-date {
            display: block;
            font-size: 12px;
            font-weight: normal;
            margin-top: 5px;
        }
        
        .confirmation-box h3 {
            margin-top: 0;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .selection-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .selection-label {
            font-weight: bold;
            color: #555;
        }
        
        .selection-value {
            color: #2c3e50;
        }
        
        .confirmation-note {
            margin-top: 20px;
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }
    `;
    document.head.appendChild(styleElement);
});
</script>





    <!-- Course Registration Script -->
    <script>
    // Global variables
    let selectedCourses = new Set();
    let maxCourses = 0;
    let currentSemester = '';
    let currentYear = '';
    let eligibleCurrentCourses = [];
    let registrationStatus = 'closed';
    let registrationStartDate = null;
    let registrationEndDate = null;
    let countdownInterval = null;
    let courseTooltipElement = null;
    let nonDroppableCourses = {}; // Changed to an object to store course codes and reasons
    let electiveGroups = {}; // Store elective group data
    
    // Course Registration specific functionality
    function loadCourseRegistration() {
        document.getElementById('content-title').textContent = 'Course Registration';
        
        // Show loading state
        document.getElementById('dynamic-content').innerHTML = `
            <div class="content-card loading-message">
                <h3><i class="fas fa-spinner fa-spin"></i> Loading Course Enrollment</h3>
                <p>Please wait while we load your available courses</p>
            </div>
        `;
    }

    // Show success message
    function showSuccessMessage(message) {
        const successMsg = document.createElement('div');
        
        // Check if this is an error message (starts with "Error:")
        if (message.startsWith('Error:')) {
            // Remove the "Error:" prefix and show as a notification
            successMsg.className = 'notification';
            successMsg.textContent = message.substring(7).trim(); // Remove "Error: " prefix
        } else {
        successMsg.className = 'success-message';
        successMsg.textContent = message;
        }
        
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
            successMsg.remove();
        }, 4000);
    }

    // Helper function to get semester name
    function getSemesterName(semesterNumber) {
        switch(parseInt(semesterNumber)) {
            case 1: return 'Fall';
            case 2: return 'Spring';
        }
    }

    // Function to check if a course can be dropped
    function canDropCourse(courseCode) {
        // If the course is in the nonDroppableCourses object, it cannot be dropped
        return !nonDroppableCourses.hasOwnProperty(courseCode);
    }

    // Function to get the reason why a course can't be dropped
    function getNonDroppableReason(courseCode) {
        return nonDroppableCourses[courseCode] || "This course cannot be dropped";
    }

    // Add this new function to fetch drop requests directly
    function loadDropRequests() {
        console.log("Loading drop course requests directly");
        
        // Make a direct API call to get drop requests
        fetch('/student/get-drop-requests')
            .then(response => response.json())
            .then(data => {
                console.log("Drop requests response:", data);
                if (data.success && data.requests) {
                    // Process each request and update the UI
                    Object.keys(data.requests).forEach(courseCode => {
                        const request = data.requests[courseCode];
                        console.log(`Drop request found for ${courseCode}:`, request);
                        
                        // Find the course item
                        const courseItem = document.querySelector(`.enrolled-course-item[data-course-code="${courseCode}"]:not(.non-droppable)`);
                        if (courseItem) {
                            console.log(`Found course item for ${courseCode}`, courseItem);
                            
                            // Add pending-drop class
                            courseItem.classList.add('pending-drop');
                            
                            // Replace the drop button with cancel request button
                            const actionsDiv = courseItem.querySelector('.course-actions');
                            if (actionsDiv) {
                                actionsDiv.innerHTML = `
                                    <div style="display: flex; align-items: center;">
                                        <div style="background-color: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 10px;">
                                            <i class="fas fa-clock"></i> DROP PENDING
                                        </div>
                                        <button onclick="cancelDropRequest(event, ${request.id})" 
                                                title="Undo drop request"
                                                class="undo-request-btn">
                                            <i class="fas fa-undo-alt"></i>
                                        </button>
                                    </div>
                                `;
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error("Error loading drop requests:", error);
            });
    }

    // Modify loadCourseRegistration to call loadDropRequests after rendering
    function loadCourseRegistration() {
        document.getElementById('content-title').textContent = 'Course Enrollment';
        // Show loading state
        document.getElementById('dynamic-content').innerHTML = `
            <div class="content-card loading-message">
                <h3><i class="fas fa-spinner fa-spin"></i> Loading Course Information</h3>
                <p>Please wait while we load your course options</p>
            </div>
        `;

        fetch('/student/course-registration')
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        // Create a custom error object with code
                        const error = new Error(errData.message || `Server error: ${response.status}`);
                        error.code = errData.code;
                        throw error;
                    }).catch(parseError => {
                        if (parseError.code) {
                            throw parseError; // Rethrow our custom error with code
                        }
                        throw new Error(`Server returned ${response.status} ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    const error = new Error(data.message || 'Failed to load course data');
                    error.code = data.code;
                    throw error;
                }
                
                // Check if there's no active semester
                if (!data.data.current_semester || !data.data.current_year) {
                    document.getElementById('dynamic-content').innerHTML = `
                        <div class="content-card no-semester-message">
                            <div class="fun-message">
                                <img src="{{ url_for('static', filename='images/warrior.png') }}" class="fun-gif">
                                <h3>No assignments. No deadlines. For now...</h3>
                                <p>Enjoy your break! Course registration will be available when the next semester starts.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Store registration status and dates
                registrationStatus = data.data.registration_status;
                registrationStartDate = data.data.registration_start_date ? new Date(data.data.registration_start_date) : null;
                registrationEndDate = data.data.registration_end_date ? new Date(data.data.registration_end_date) : null;
                
                // Store non-droppable courses if available
                nonDroppableCourses = {};
                if (data.data.non_droppable_courses) {
                    // Check if it's an array (old format) or an object (new format with reasons)
                    if (Array.isArray(data.data.non_droppable_courses)) {
                        // Convert array to object with default reason
                        data.data.non_droppable_courses.forEach(courseCode => {
                            nonDroppableCourses[courseCode] = "This course cannot be dropped";
                        });
                    } else {
                        // It's already an object with reasons
                        nonDroppableCourses = data.data.non_droppable_courses;
                    }
                }
                
                // Debug logging
                console.log('Registration Data:', {
                    status: registrationStatus,
                    startDate: data.data.registration_start_date,
                    endDate: data.data.registration_end_date,
                    parsedStartDate: registrationStartDate,
                    parsedEndDate: registrationEndDate,
                    nonDroppableCourses: nonDroppableCourses
                });
                
                // Render based on registration status
                if (registrationStatus === 'scheduled') {
                    console.log('Rendering SCHEDULED registration view');
                    renderScheduledRegistration(data.data);
                } else if (registrationStatus === 'open') {
                    console.log('Rendering OPEN registration view');
                    renderOpenRegistration(data.data);
                } else {
                    console.log('Rendering CLOSED registration view');
                    renderClosedRegistration(data.data);
                    
                    // After rendering, load drop requests separately
                    setTimeout(loadDropRequests, 500);
                }
            })
            .catch(error => {
                console.error('Failed to load courses:', error);
                
                // Check specifically for board decision restriction
                if (error.code === 'AWAITING_BOARD_DECISION') {
                    console.warn('Student is awaiting board decision - restricting access');
                    showError(error.message, error.code);
                    
                    // Disable all navigation except logout
                    document.querySelectorAll('.sidebar-menu a:not(.logout-item a)').forEach(link => {
                        link.classList.add('disabled');
                        link.style.pointerEvents = 'none';
                        link.style.opacity = '0.6';
                    });
                    
                    return; // Stop execution here
                }
                
                // Handle other errors
                showError(error.message, error.code);
            });
    }

    // Render scheduled registration view with countdown
    function renderScheduledRegistration(data) {
        currentSemester = data.current_semester;
        currentYear = data.current_year;
        
        // Get semester name
        const semesterName = getSemesterName(currentSemester);
        
        // Create content
        let html = `
            <div class="content-card registration-scheduled">
                <div class="scheduled-header">
                    <h3><i class="fas fa-clock"></i> Course Registration Opens Soon</h3>
                    <p>Course registration for ${semesterName} will open soon.</p>
                </div>
                
                <div class="countdown-container">
                    <div class="countdown-message">Registration opens in:</div>
                    <div id="registration-countdown" class="countdown-timer">--:--:--</div>
                </div>
        `;
        
        // If student has enrolled courses, display them
        if (data.enrolled_courses && data.enrolled_courses.length > 0) {
            html += `
                <div class="enrolled-courses-container">
                    <h4>Your current course selections</h4>
                    <p>These courses will be available for changes once registration opens:</p>
                    <div class="enrolled-courses-list">
            `;
            
            data.enrolled_courses.forEach(course => {
                html += `
                    <div class="enrolled-course-item" 
                         data-course-code="${course.course_code}"
                         onmousemove="showTooltip(event, '${course.course_code}')"
                         onmouseleave="hideTooltip()">
                        <div class="course-info">
                            <span class="course-code">${course.course_code}</span>
                            <span class="course-name">${course.course_name}</span>
                        </div>
                        <div class="course-credits">${course.credits} credits</div>
                        ${course.study_group ? `<div class="course-group">Group: ${course.study_group}</div>` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        html += `</div>`;
        
        // Set the content
        document.getElementById('dynamic-content').innerHTML = html;
        
        // Start the countdown
        startCountdown(registrationStartDate, 'registration-countdown', 'Registration opens now!', 'opening');
        
        // Create course tooltip element if it doesn't exist
        setupCourseTooltip();
    }

    // Render open registration with a countdown to closing
    function renderOpenRegistration(data) {
        // Clear any existing countdown
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        // Show the normal course registration
        renderCourseRegistration(data);
        
        // Add countdown to closing if end date is available
        if (registrationEndDate) {
            // Find the course registration container
            const container = document.querySelector('.course-registration-container');
            
            if (container) {
                // Create countdown element
                const countdownElement = document.createElement('div');
                countdownElement.className = 'registration-closing-countdown';
                countdownElement.innerHTML = `
                    <div class="countdown-message">Registration closes in:</div>
                    <div id="closing-countdown" class="countdown-timer">--:--:--</div>
                `;
                
                // Insert at the top of the container
                container.insertBefore(countdownElement, container.firstChild);
                
                // Start the countdown
                startCountdown(registrationEndDate, 'closing-countdown', 'Registration is now closed!', 'closing');
            }
        }
        
        // Create course tooltip element if it doesn't exist
        setupCourseTooltip();
    }

    // Render closed registration view (show enrolled courses only)
    function renderClosedRegistration(data) {
        // Clear any existing countdown
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        currentSemester = data.current_semester;
        currentYear = data.current_year;
        
        // Get semester name
        const semesterName = getSemesterName(currentSemester);
        
        // Debug data received from the server
        console.log("renderClosedRegistration - Full data:", data);
        console.log("Drop requests structure:", data.drop_requests);
        console.log("Non-droppable courses:", nonDroppableCourses);
        
        // Create content
        let html = `
            <div class="content-card registration-closed">
                <div class="closed-header">
                    <h3><i class="fas fa-lock"></i> Course Registration Closed</h3>
                    <p>Course registration for ${semesterName} is closed.</p>
                </div>
    `;
        
        // If student has enrolled courses, display them
        if (data.enrolled_courses && data.enrolled_courses.length > 0) {
            html += `
                <div class="enrolled-courses-container">
                    <h4>Your enrolled courses for ${semesterName}</h4>
                    <div class="enrolled-courses-list">
            `;
            
            // Get drop requests if any (ensure it's an object, not undefined)
            const dropRequests = data.drop_requests || {};
            console.log("Drop requests object keys:", Object.keys(dropRequests));
            
            // Separate courses into droppable and non-droppable
            const droppableCourses = [];
            const nonDroppableCoursesList = [];
            
            data.enrolled_courses.forEach(course => {
                const courseCode = course.course_code;
                const canDrop = !nonDroppableCourses.hasOwnProperty(courseCode);
                
                if (canDrop) {
                    droppableCourses.push(course);
                } else {
                    nonDroppableCoursesList.push(course);
                }
            });
            
            console.log(`Droppable courses: ${droppableCourses.length}, Non-droppable: ${nonDroppableCoursesList.length}`);
            
            // First render non-droppable courses (with no drop buttons)
            if (nonDroppableCoursesList.length > 0) {
                html += `
                    <div class="courses-section">
                        <h5>Required Courses (Cannot Be Dropped)</h5>
                        <div class="required-courses-list">
                `;
                
                nonDroppableCoursesList.forEach(course => {
                    const courseCode = course.course_code;
                    
                    html += `
                        <div class="enrolled-course-item non-droppable" data-course-code="${courseCode}">
                            <div class="course-info">
                                <span class="course-code">${courseCode}</span>
                                <span class="course-name">${course.course_name}</span>
                            </div>
                            <div class="course-credits">${course.credits} credits</div>
                            ${course.study_group ? `<div class="course-group">Group: ${course.study_group}</div>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Then render droppable courses (with drop buttons)
            if (droppableCourses.length > 0) {
                html += `
                    <div class="courses-section">
                        ${nonDroppableCoursesList.length > 0 ? '<h5>Optional Courses (Can Be Dropped)</h5>' : ''}
                        <div class="optional-courses-list">
                `;
                
                droppableCourses.forEach(course => {
                    const courseCode = course.course_code;
                
                // Check if this course has a pending drop request
                if (dropRequests[courseCode]) {
                    const requestId = dropRequests[courseCode].id;
                    
                        html += `
                        <div class="enrolled-course-item pending-drop" data-course-code="${courseCode}">
                            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <div><strong>${courseCode}</strong> - ${course.course_name}</div>
                                    <div style="font-size: 0.9rem; color: #666;">${course.credits} credits ${course.study_group ? ` | Group: ${course.study_group}` : ''}</div>
                                </div>
                                <div style="background-color: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; white-space: nowrap;">
                                    <i class="fas fa-clock"></i> DROP PENDING
                                </div>
                            </div>
                            <div>
                                <button onclick="cancelDropRequest(event, ${requestId})" 
                                        title="Undo drop request"
                                        class="undo-request-btn">
                                        <i class="fas fa-undo-alt"></i>
                                    </button>
                            </div>
                        </div>
                    `;
                } else {
                        html += `
                        <div class="enrolled-course-item droppable" data-course-code="${courseCode}">
                        <div class="course-info">
                            <span class="course-code">${courseCode}</span>
                            <span class="course-name">${course.course_name}</span>
                        </div>
                        <div class="course-credits">${course.credits} credits</div>
                        ${course.study_group ? `<div class="course-group">Group: ${course.study_group}</div>` : ''}
                        <div class="course-actions">
                            <button class="drop-course-btn" 
                                    onclick="showDropCourseModal(event, '${courseCode}', '${course.course_name}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        });
        
            html += `
                    </div>
                </div>
            `;
        }
        
        // Close the container divs
        html += `
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="no-courses-message">
                <i class="fas fa-info-circle"></i>
                <p>You don't have any enrolled courses for this semester.</p>
            </div>
        `;
    }
    
    html += `</div>`;
    
    // Add drop course modal
    html += `
        <div id="drop-course-modal" class="drop-course-modal">
            <div class="drop-course-modal-content">
                <div class="drop-course-modal-header">
                    <h3>Drop Course Request</h3>
                </div>
                <div class="drop-course-modal-body">
                    <div class="course-details">
                        <div class="course-title" id="modal-course-code" style="font-weight: bold;"></div>
                        <div class="course-subtitle" id="modal-course-name"></div>
                    </div>
                    <p>Once submitted, your request will be reviewed by the administration. Once accepted, this course will be successfully dropped, else it stays.</p>
                    <div class="drop-course-confirmation">
                        <label for="drop-confirmation">Type "YES" to confirm:</label>
                        <input type="text" id="drop-confirmation" placeholder="YES" oninput="updateConfirmButton()">
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    </div>
                </div>
                <div class="drop-course-modal-footer">
                    <button class="cancel-btn" onclick="hideDropCourseModal()">Cancel</button>
                    <button class="confirm-btn" id="confirm-drop-btn" disabled>Submit Request</button>
                </div>
            </div>
        </div>
    `;
    
    // Set the content
    document.getElementById('dynamic-content').innerHTML = html;
    
    // Create course tooltip element if it doesn't exist
    setupCourseTooltip();
}

// Show drop course modal
function showDropCourseModal(event, courseCode, courseName) {
    event.stopPropagation();
    
    console.log("Opening drop course modal for:", { courseCode, courseName });
    
    const modal = document.getElementById('drop-course-modal');
    const courseCodeElement = document.getElementById('modal-course-code');
    const courseNameElement = document.getElementById('modal-course-name');
    const debugCourseCode = document.getElementById('debug-course-code');
    const confirmBtn = document.getElementById('confirm-drop-btn');
    const confirmInput = document.getElementById('drop-confirmation');
    
    // Set course details
    courseCodeElement.textContent = courseCode;
    courseNameElement.textContent = courseName;
    
    // Set debug course code
    if (debugCourseCode) {
        debugCourseCode.textContent = courseCode;
    }
    
    // Clear confirmation input
    confirmInput.value = '';
    confirmBtn.disabled = true;
    
    // Set up confirm button action with a cleaner approach
    confirmBtn.onclick = function() {
        // Get the course code from the debug element to ensure consistency
        const finalCourseCode = debugCourseCode ? debugCourseCode.textContent : courseCodeElement.textContent;
        console.log("Submitting drop request with final course code:", finalCourseCode);
        submitDropRequest(finalCourseCode);
    };
    
    // Show modal
    modal.classList.add('active');
}

// Hide drop course modal
function hideDropCourseModal() {
    const modal = document.getElementById('drop-course-modal');
    modal.classList.remove('active');
}

// Update confirm button state based on input
function updateConfirmButton() {
    const confirmInput = document.getElementById('drop-confirmation');
    const confirmBtn = document.getElementById('confirm-drop-btn');
    
    confirmBtn.disabled = confirmInput.value !== 'YES';
}

// Submit drop course request
function submitDropRequest(courseCode) {
    const confirmInput = document.getElementById('drop-confirmation');
    const confirmBtn = document.getElementById('confirm-drop-btn');
    
    // Ensure we have the course code
    if (!courseCode || courseCode.trim() === '') {
        console.error("Missing course code in drop request");
        showSuccessMessage("Error: Missing course information");
        return;
    }
    
    // Trim the course code to ensure no whitespace
    courseCode = courseCode.trim();
    
    console.log("Submitting drop request for course:", courseCode);
    
    // Disable button and show loading state
    confirmBtn.disabled = true;
    const originalText = confirmBtn.textContent;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    // Prepare request data
    const requestData = {
        course_code: courseCode,
        confirmation: confirmInput.value
    };
    
    console.log("Request payload:", requestData);
    
    fetch('/student/drop-course-request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log("Response status:", response.status);
        return response.json();
    })
    .then(data => {
        console.log("Response data:", data);
        if (data.success) {
            showSuccessMessage('Drop course request submitted successfully');
            hideDropCourseModal();
            
            // Refresh course registration view
            loadCourseRegistration();
        } else {
            showSuccessMessage(`Error: ${data.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText; // Reset button text
        }
    })
    .catch(error => {
        console.error('Error submitting drop request:', error);
        showSuccessMessage('Error: An error occurred while submitting your request');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText; // Reset button text
    });
}

// Cancel drop course request
function cancelDropRequest(event, requestId) {
    event.stopPropagation();
    
    // Get the course item
    const button = event.currentTarget;
    const courseItem = button.closest('.enrolled-course-item');
    const courseCode = courseItem ? courseItem.getAttribute('data-course-code') : '';
    const courseName = courseItem ? courseItem.querySelector('.course-name').textContent : '';
    
    // Show in-page confirmation dialog
    showCancelConfirmation(requestId, courseCode, courseName);
}

// Function to show in-page confirmation dialog
function showCancelConfirmation(requestId, courseCode, courseName) {
    // Create confirmation dialog if it doesn't exist
    if (!document.getElementById('cancel-confirm-dialog')) {
        const dialog = document.createElement('div');
        dialog.id = 'cancel-confirm-dialog';
        dialog.className = 'drop-course-modal';
        dialog.innerHTML = `
            <div class="drop-course-modal-content" style="max-width: 400px;">
                <div class="drop-course-modal-header">
                    <h3><i class="fas fa-undo-alt"></i> Cancel Drop Request</h3>
                    <p>Are you sure you want to cancel this drop request?</p>
                </div>
                <div class="drop-course-modal-body">
                    <div class="course-details">
                        <div class="course-title" id="cancel-course-code"></div>
                        <div class="course-subtitle" id="cancel-course-name"></div>
                    </div>
                    <p>Canceling this request means you will remain enrolled in this course.</p>
                </div>
                <div class="drop-course-modal-footer">
                    <button class="cancel-btn" onclick="hideCancelConfirmation()">No, Keep Request</button>
                    <button class="confirm-btn" id="confirm-cancel-btn">Yes, Cancel Request</button>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
    }
    
    // Set course details
    document.getElementById('cancel-course-code').textContent = courseCode;
    document.getElementById('cancel-course-name').textContent = courseName;
    
    // Set up confirm button action
    const confirmBtn = document.getElementById('confirm-cancel-btn');
    confirmBtn.onclick = function() {
        processCancelRequest(requestId);
    };
    
    // Show the dialog
    document.getElementById('cancel-confirm-dialog').classList.add('active');
}

// Hide cancel confirmation dialog
function hideCancelConfirmation() {
    const dialog = document.getElementById('cancel-confirm-dialog');
    if (dialog) {
        dialog.classList.remove('active');
    }
}

// Process the cancel request
function processCancelRequest(requestId) {
    const confirmBtn = document.getElementById('confirm-cancel-btn');
    const originalText = confirmBtn.textContent;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    confirmBtn.disabled = true;
    
    fetch(`/student/drop-course-request/${requestId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Drop course request canceled successfully');
            hideCancelConfirmation();
            
            // Refresh course registration view
            loadCourseRegistration();
        } else {
            showSuccessMessage(`${data.message}`);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error canceling drop request:', error);
        showSuccessMessage('Error: An error occurred while canceling your request');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText;
    });
}

// Setup course tooltip
function setupCourseTooltip() {
    // Check if tooltip already exists
    if (!document.getElementById('course-tooltip')) {
        // Create tooltip element
        courseTooltipElement = document.createElement('div');
        courseTooltipElement.id = 'course-tooltip';
        courseTooltipElement.className = 'course-tooltip';
        courseTooltipElement.style.position = 'fixed';
        courseTooltipElement.style.zIndex = '1000';
        courseTooltipElement.style.display = 'none';
        document.body.appendChild(courseTooltipElement);
    }
}

// Start countdown timer
function startCountdown(targetDate, elementId, completionMessage, type) {
    // Clear any existing interval
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    const countdownElement = document.getElementById(elementId);
    if (!countdownElement) return;
    
    console.log(`Starting countdown for ${type}:`, {
        targetDate: targetDate,
        elementId: elementId,
        type: type
    });
    
    if (!targetDate || !(targetDate instanceof Date) || isNaN(targetDate.getTime())) {
        console.error('Invalid target date for countdown:', targetDate);
        countdownElement.textContent = 'Invalid date';
        return;
    }
    
    // Function to update the countdown
    const updateCountdown = () => {
        const now = new Date();
        const diff = targetDate - now;
        
        if (diff <= 0) {
            clearInterval(countdownInterval);
            countdownElement.textContent = completionMessage;
            
            // If registration just opened, refresh the page after a short delay
            if (type === 'opening') {
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
            // If registration just closed, refresh the page after a short delay
            else if (type === 'closing') {
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
            return;
        }
        
        // Calculate days, hours, minutes, seconds
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        // Format the countdown display
        if (days > 0) {
            countdownElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        } else {
            countdownElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    };
    
    // Update immediately, then start interval
    updateCountdown();
    countdownInterval = setInterval(updateCountdown, 1000);
}

// Show course tooltip
// Global course info cache - using localStorage for persistence
const courseInfoCache = (() => {
    try {
        const cached = localStorage.getItem('courseInfoCache');
        return cached ? JSON.parse(cached) : {};
    } catch (e) {
        console.error('Error loading cache from localStorage:', e);
        return {};
    }
})();

// Cache timestamp to check if we need to refresh
const cacheTimestamp = (() => {
    try {
        return parseInt(localStorage.getItem('courseInfoCacheTimestamp') || '0');
    } catch (e) {
        return 0;
    }
})();

// Helper function to save cache to localStorage
function saveCacheToStorage() {
    try {
        localStorage.setItem('courseInfoCache', JSON.stringify(courseInfoCache));
        localStorage.setItem('courseInfoCacheTimestamp', Date.now().toString());
        console.log('Cache saved to localStorage');
    } catch (e) {
        console.error('Error saving cache to localStorage:', e);
    }
}

// Function to preload ALL course data
function preloadAllCourseInfo() {
    // Get all course codes from all possible sections
    const allCourseElements = document.querySelectorAll('.course-item, .enrolled-course-item, .elective-course-item');
    const courseCodes = new Set();
    
    // Extract course codes from all elements
    allCourseElements.forEach(el => {
        // Try data attribute first
        let code = el.getAttribute('data-course-code');
        
        // Try input elements
        if (!code) {
            const input = el.querySelector('input[type="checkbox"][data-course-code]');
            if (input) code = input.getAttribute('data-course-code');
        }
        
        // Try course code elements
        if (!code) {
            const codeEl = el.querySelector('.course-code, .elective-course-code');
            if (codeEl) code = codeEl.textContent.trim();
        }
        
        if (code) courseCodes.add(code);
    });
    
    // Also check all checkboxes directly
    document.querySelectorAll('input[type="checkbox"][data-course-code]').forEach(checkbox => {
        const code = checkbox.getAttribute('data-course-code');
        if (code) courseCodes.add(code);
    });
    
    // Convert to array
    const uniqueCourseCodes = Array.from(courseCodes);
    
    // Check if we need to fetch (cache older than 24 hours or missing courses)
    const needsFetch = Date.now() - cacheTimestamp > 24 * 60 * 60 * 1000 || 
                      uniqueCourseCodes.some(code => !courseInfoCache[code]);
                      
    if (!needsFetch) {
        console.log('Using existing cache, no need to fetch');
        return; // Use existing cache
    }
    
    if (uniqueCourseCodes.length === 0) {
        console.log('No course codes found, skipping fetch');
        return;
    }
    
    console.log(`Preloading info for ${uniqueCourseCodes.length} courses...`);
    
    // Fetch all course info at once
    fetch('/student/course-registration/courses_info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ course_codes: uniqueCourseCodes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.courses_info) {
            // Update cache with new data
            Object.assign(courseInfoCache, data.courses_info);
            saveCacheToStorage();
            console.log(`âœ… Cached info for ${Object.keys(data.courses_info).length} courses`);
        } else {
            console.error('Failed to fetch course info:', data.message);
        }
    })
    .catch(error => {
        console.error('Error fetching course info:', error);
    });
}

// Run preload when page loads (both on initial load and when switching tabs)
document.addEventListener('DOMContentLoaded', () => setTimeout(preloadAllCourseInfo, 1000));
function showTooltip(event, courseCode) {
    event.stopPropagation();
    const tooltip = document.getElementById('course-tooltip');
    if (!tooltip) return;
    
    // Set data attribute for current course
    tooltip.setAttribute('data-current-course', courseCode);
    
    // Position the tooltip at the top right corner with a small margin
    tooltip.style.right = '20px';
    tooltip.style.left = 'auto';
    tooltip.style.top = '20px';
    
    // Check if we have the course info in cache
    if (courseInfoCache[courseCode]) {
        displayTooltipFromCache(tooltip, courseCode);
    } else {
        // Immediately show basic tooltip with what we have
        displayBasicTooltip(tooltip, courseCode, event.target);
        
        // Fetch in background (won't block UI)
        fetchAndCacheCourseInfo(courseCode, tooltip);
    }
}

// Display tooltip using cached data
function displayTooltipFromCache(tooltip, courseCode) {
    const info = courseInfoCache[courseCode];
    
    // Generate components text
    const components = [];
    if (info.has_lecture) components.push('Lecture');
    if (info.has_tutorial) components.push('Tutorial');
    const componentsText = components.length > 0 ? components.join(' + ') : 'No components specified';
    
    // Check prerequisites and required-for status
    const hasPrerequisites = info.prerequisites && info.prerequisites.length > 0;
    const isPrerequisiteForOthers = info.is_prerequisite_for && info.is_prerequisite_for.length > 0;
    
    tooltip.innerHTML = `
        <div class="tooltip-header">
            <h4>${info.course_code || courseCode} - ${info.course_name}</h4>
            <span class="tooltip-credits">${info.coefficient} Credits</span>
        </div>
        <div class="tooltip-body">
            <div class="tooltip-section">
                <strong>Description:</strong>
                <p>${info.description || 'No description available'}</p>
            </div>
            <div class="tooltip-section">
                <strong>Components:</strong>
                <p>${componentsText}</p>
            </div>
            <div class="tooltip-section">
                <strong>Prerequisites:</strong>
                ${hasPrerequisites ? `
                    <ul>
                        ${info.prerequisites.map(prereq => {
                            if (typeof prereq === 'object') {
                                return `<li>${prereq.code}: ${prereq.name}</li>`;
                            } else {
                                return `<li>${prereq}</li>`;
                            }
                        }).join('')}
                    </ul>
                ` : '<p>No prerequisites required for this course</p>'}
            </div>
            <div class="tooltip-section">
                <strong>Required for:</strong>
                ${isPrerequisiteForOthers ? `
                    <ul>
                        ${info.is_prerequisite_for.map(course => {
                            if (typeof course === 'object') {
                                return `<li>${course.code}: ${course.name}</li>`;
                            } else {
                                return `<li>${course}</li>`;
                            }
                        }).join('')}
                    </ul>
                ` : '<p>This course is not a prerequisite for any other course</p>'}
            </div>
        </div>
    `;
    tooltip.style.display = 'block';
}

// Display basic tooltip with information extracted from the DOM
function displayBasicTooltip(tooltip, courseCode, targetElement) {
    // Try to extract info from DOM
    const courseElement = targetElement.closest('.course-item') || 
                          targetElement.closest('.enrolled-course-item') || 
                          targetElement.closest('.elective-course-item');
    
    let courseName = 'Loading...';
    let credits = '?';
    
    if (courseElement) {
        // Try to extract course name
        const nameElement = courseElement.querySelector('.course-name') || 
                            courseElement.querySelector('.elective-course-name');
        if (nameElement) courseName = nameElement.textContent.trim();
        
        // Try to extract credits
        const creditsElement = courseElement.querySelector('.course-credits') || 
                               courseElement.querySelector('.elective-course-credits');
        if (creditsElement) credits = creditsElement.textContent.trim();
    }
    
    tooltip.innerHTML = `
        <div class="tooltip-header">
            <h4>${courseCode} - ${courseName}</h4>
            <span class="tooltip-credits">${credits} Credits</span>
        </div>
        <div class="tooltip-body">
            <div class="tooltip-section">
                <strong>Description:</strong>
                <p><em>Loading detailed information...</em></p>
            </div>
            <div class="tooltip-section">
                <strong>Components:</strong>
                <p><em>Loading...</em></p>
            </div>
            <div class="tooltip-section">
                <strong>Prerequisites:</strong>
                <p><em>Loading...</em></p>
            </div>
            <div class="tooltip-section">
                <strong>Required for:</strong>
                <p><em>Loading...</em></p>
            </div>
        </div>
    `;
    tooltip.style.display = 'block';
}

// Fetch course info and update cache - does not block UI
function fetchAndCacheCourseInfo(courseCode, tooltip) {
    fetch(`/student/course-registration/course_info/${courseCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cache the result
                courseInfoCache[courseCode] = {
                    course_code: data.course_code || data.data.course_code,
                    course_name: data.course_name || data.data.course_name,
                    description: data.description || data.data.description,
                    has_tutorial: data.has_tutorial || data.data.has_tutorial,
                    has_lecture: data.has_lecture || data.data.has_lecture,
                    coefficient: data.coefficient || data.data.coefficient,
                    prerequisites: data.prerequisites || data.data.prerequisites || [],
                    is_prerequisite_for: data.is_prerequisite_for || data.data.is_prerequisite_for || []
                };
                
                // Save to localStorage
                saveCacheToStorage();
                
                // Update tooltip if it's still showing this course
                if (tooltip.getAttribute('data-current-course') === courseCode) {
                    displayTooltipFromCache(tooltip, courseCode);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching course info:', error);
        });
}

// Render course registration form
// Helper function to get ordinal suffix for numbers
function getOrdinalSuffix(num) {
    if (!num) return 'N/A';
    
    num = parseInt(num);
    const j = num % 10,
          k = num % 100;
          
    if (j == 1 && k != 11) {
        return num + "st";
    }
    if (j == 2 && k != 12) {
        return num + "nd";
    }
    if (j == 3 && k != 13) {
        return num + "rd";
    }
    return num + "th";
}

function renderCourseRegistration(data) {
    maxCourses = data.max_courses;
    currentSemester = data.current_semester;
    currentYear = data.current_year;
    
    // We no longer need to store max forgiveness value as there's no limit on retakes
    
    // Initialize selected courses - will be populated after rendering
    selectedCourses.clear(); // Clear the set instead of creating a new one
    
    // Preload all course data after rendering
    setTimeout(preloadAllCourseInfo, 500);
    
    // We'll populate the selectedCourses set after rendering the interface
    // This ensures we only count courses that are actually visible
    
    // Temporarily store which courses should be checked
    const coursesToCheck = new Set();
    
    // Add enrolled courses to be checked
    if (data.enrolled_courses) {
        data.enrolled_courses.forEach(c => coursesToCheck.add(c.course_code));
    }
    
    // Also include auto-checked courses
    if (data.failed_courses) {
        data.failed_courses.forEach(c => coursesToCheck.add(c.course_code));
    }
    
    // Auto-select current courses if:
    // 1. Student has no failed courses AND
    // 2. Student has no not-enrolled courses AND
    // 3. EITHER:
    //    a. Student is not eligible for major selection OR
    //    b. Student has already made a major selection (has major in student table)
    if (!data.has_failed && !data.has_notenrolled && data.eligible_current_courses) {
        // Check if student is ineligible for major selection
        const isIneligibleMessage = data.guidance_message && data.guidance_message.includes("not eligible to choose a Major/Minor");
        
        // Check if student has already selected a major (has_specializations means they have a major in the student table)
        const hasSelectedMajor = data.has_specializations || data.specialization_count > 0;
        
        // Auto-select if either condition is met
        if (isIneligibleMessage || hasSelectedMajor) {
            data.eligible_current_courses.forEach(c => coursesToCheck.add(c.course_code));
        }
    }
    
    // We'll use coursesToCheck when rendering checkboxes, but we'll only
    // add to selectedCourses after rendering when we call updateSelectedCount()
    
    // Include enrolled elective courses in coursesToCheck
    if (data.elective_courses) {
        Object.values(data.elective_courses).forEach(groupData => {
            if (groupData.courses) {
                groupData.courses.forEach(course => {
                    if (course.enrolled) {
                        coursesToCheck.add(course.course_code);
                    }
                });
            }
        });
    }
    
    eligibleCurrentCourses = data.eligible_current_courses || [];
    
    let html = `
        <div class="course-registration-container">
            ${data.probation_counter ? 
                `<div class="probation-warning">
                    <div class="probation-warning-content">
                        <div class="probation-warning-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Academic Probation Warning: You are on your ${data.probation_ordinal} Probation</span>
                            <span class="probation-info-wrapper">
                                <i class="fas fa-question-circle"></i>
                                <span class="probation-tooltip">After the ${getOrdinalSuffix(data.max_probation_board)} probation, the scientific board will decide whether to grant one more semester extension or not. If not, you will be dismissed.</span>
                            </span>
                        </div>
                        <div class="probation-warning-message">
                            Please increase your CGPA above ${data.min_cumulative_gpa ? data.min_cumulative_gpa.toFixed(2) : 'the minimum required GPA'}.
                        </div>
                        <div class="probation-warning-gpa">
                            Your current CGPA is: <strong>${data.current_cumulative_gpa ? data.current_cumulative_gpa.toFixed(2) : 'N/A'}</strong>
                        </div>
                    </div>
                </div>` : ''
            }
            <div class="selection-counter">
                <span id="selected-count">${selectedCourses.size}</span> / ${maxCourses} courses selected
            </div>
    `;
    
    // Add credit requirement warning for year 3+ students who don't meet requirements
    // Check if student meets the percentage requirement for course registration
    // This is different from the major eligibility check which requires ALL credits
    if (data.student_year >= 3 && data.credit_status && 
        data.credit_status.earned_credits < data.credit_status.required_credits) {
        const percentage = data.credit_status.min_percentage ? data.credit_status.min_percentage.toFixed(1) : '0';
        const earnedCredits = data.credit_status.earned_credits ? data.credit_status.earned_credits.toFixed(1) : '0';
        const requiredCredits = data.credit_status.required_credits ? data.credit_status.required_credits.toFixed(1) : '0';
        
        html += `
            <div class="credit-requirement-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <p>You must earn at least ${percentage}% of Freshman & Sophomore credits before taking Junior & Senior courses.</p>
                <p>Your progress: ${earnedCredits} / ${requiredCredits} credits</p>
                <p>Only Freshman & Sophomore courses are available until you meet this requirement.</p>
            </div>
        `;
    }
    
    // Check if student has no specializations but is in year 3+
    if (data.student_year >= 3 && (!data.has_specializations || data.specialization_count === 0) && data.guidance_message) {
        html += `
            <div class="specialization-guidance-message">
                <i class="fas fa-info-circle"></i>
                <p>${data.guidance_message}</p>
            </div>
        `;
    }
    
    // Display message about filtered major courses if applicable
    if (data.filtered_majors && data.filtered_majors.length > 0 && data.student_year >= 3 && !data.has_specializations) {
        html += `
            <div class="specialization-guidance-message filtered-majors-message">
                <i class="fas fa-filter"></i>
                <p>Some courses have been omitted from your available options because your specialized GPA does not meet the eligibility criteria for the following majors: <strong>${data.filtered_majors.join(', ')}</strong>. To view and register for these courses in the future, you will need to improve your specialized GPA in the corresponding areas.</p>
            </div>
        `;
    }
    
    // Helper function to render course sections
    const renderCourseSection = (title, courses, infoMessage = '', isPermanentlyDisabled = false) => {
        if (!courses || courses.length === 0) return '';
        
            // Special handling for Retake Courses title to include counter
    let titleHtml = title;
    if (title === 'Retake Courses' && data.forgiveness_counter !== undefined) {
        // Just show the count without a limit since there's no limit on retakes
        titleHtml = `${title} <span class="forgiveness-counter">(${data.forgiveness_counter})</span>`;
    }
        
        return `
            <div class="course-section ${isPermanentlyDisabled ? 'permanently-disabled' : ''}">
                <h3>${titleHtml}</h3>
                ${infoMessage ? `<p class="section-info">${infoMessage}</p>` : ''}
                <div class="course-list">
                    ${courses.map(course => {
                        const courseYear = getYearFromCourseCode(course.course_code);
                        
                        return `
                            <div class="course-item ${isPermanentlyDisabled ? 'permanently-disabled' : ''}"
                                 data-year="${courseYear}"
                                 onmousemove="showTooltip(event, '${course.course_code}')"
                                 onmouseleave="hideTooltip()">
                                 <label>
                                     <input type="checkbox" 
                                            data-course-code="${course.course_code}"
                                            ${isPermanentlyDisabled ? 'disabled' : ''}
                                            ${coursesToCheck.has(course.course_code) ? 'checked' : ''}>
                                     <div>
                                         <span class="course-code">${course.course_code}</span>
                                         <span class="course-name">${course.course_name}</span>
                                         ${course.letter_grade ? `<span class="course-grade">Previous grade: ${course.letter_grade}</span>` : ''}
                                     </div>
                                 </label>
                             </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    };

    // Function to extract year from course code
    function getYearFromCourseCode(courseCode) {
        // Try to extract the numeric part after the department code
        const match = courseCode.match(/[A-Z]+\s*(\d+)/i);
        if (match && match[1]) {
            const num = parseInt(match[1]);
            if (num < 200) return 1;
            else if (num < 300) return 2;
            else if (num < 400) return 3;
            else return 4;
        }
        return 1; // Default to year 1 if we can't determine
    }

    // Failed courses (always checked and disabled)
    if (data.failed_courses && data.failed_courses.length > 0) {
        html += renderCourseSection(
            'Failed Courses',
            data.failed_courses,
            'Failed courses are selected automatically',
            true
        );
    }
    
    // Current courses (conditionally disabled)
    // Disable course selection if student is not eligible for major selection OR has already selected a major
    const isIneligibleMessage = data.guidance_message && data.guidance_message.includes("not eligible to choose a Major/Minor");
    const hasSelectedMajor = data.has_specializations || data.specialization_count > 0;
    const currentDisabled = !data.has_failed && !data.has_notenrolled && (isIneligibleMessage || hasSelectedMajor);
    
    if (data.eligible_current_courses && data.eligible_current_courses.length > 0) {
        html += renderCourseSection(
            'Current Semester Courses',
            data.eligible_current_courses,
            currentDisabled ? 'All mandatory courses are selected automatically' : '',
            currentDisabled
        );
    }
    
    // Elective courses
    if (data.elective_courses && Object.keys(data.elective_courses).length > 0) {
        html += `
            <div class="elective-section">
                <h3>Elective Courses</h3>
        `;
        
        // Iterate through each elective group
        Object.entries(data.elective_courses).forEach(([groupNumber, groupData]) => {
            const courses = groupData.courses;
            const requiredPicks = groupData.required_picks;
            
            if (courses && courses.length > 0) {
                html += `
                    <div class="elective-group-container" data-group-number="${groupNumber}">
                        <div class="elective-group-header">
                            <div class="elective-group-title">Elective Group</div>
                            <div class="elective-selection-counter" id="elective-counter-${groupNumber}">0/${requiredPicks}</div>
                        </div>
                        <div class="elective-requirement-note">
                            You must select at least ${requiredPicks} course${requiredPicks > 1 ? 's' : ''} from this group
                        </div>
                        <div class="elective-courses-search">
                            <i class="fas fa-search"></i>
                            <input type="text" 
                                   placeholder="Search courses in this group..." 
                                   onkeyup="filterElectiveCourses(${groupNumber}, this.value)"
                                   aria-label="Search elective courses">
                        </div>
                        <div class="elective-courses-list">
                `;
                
                courses.forEach(course => {
                    const isEligible = course.eligible;
                    const isEnrolled = course.enrolled;
                    
                    html += `
                        <div class="elective-course-item ${!isEligible ? 'not-eligible' : ''}"
                             onmousemove="showTooltip(event, '${course.course_code}')"
                             onmouseleave="hideTooltip()">
                            <input type="checkbox" 
                                   class="elective-checkbox"
                                   data-group-number="${groupNumber}"
                                   data-course-code="${course.course_code}"
                                   ${coursesToCheck.has(course.course_code) ? 'checked' : ''}
                                   ${!isEligible ? 'disabled' : ''}>
                            <div class="elective-course-info">
                                <span class="elective-course-code">${course.course_code}</span>
                                <span class="elective-course-name">${course.course_name}</span>
                            </div>
                            <span class="elective-course-credits">${course.coefficient} credits</span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
        });
        
        html += `</div>`;
    }
    
    // Not enrolled courses
    if (data.eligible_notenrolled_courses && data.eligible_notenrolled_courses.length > 0) {
        html += renderCourseSection(
            'Skipped Courses from Previous Years',
            data.eligible_notenrolled_courses,
            'Mandatory to take to graduate'
        );
    }
    
    // Retake courses
    if (data.retake_courses && data.retake_courses.length > 0) {
        html += renderCourseSection(
            'Retake Courses',
            data.retake_courses,
            'You can retake these courses to improve your Cumulative GPA'
        );
    }
    
    // Not met requirements
    if (data.not_met_requirements && data.not_met_requirements.length > 0) {
        html += `
            <div class="course-section not-met">
<h3 style="background-color: white;">Unavailable Courses</h3>
                <p class="section-info">These courses cannot be selected because due to unmet prerequisites</p>
                <div class="course-list">
                    ${data.not_met_requirements.map(course => {
                        const courseYear = getYearFromCourseCode(course.course_code);
                        return `
                            <div class="course-item"
                                 data-year="${courseYear}"
                                 onmousemove="showTooltip(event, '${course.course_code}')"
                                 onmouseleave="hideTooltip()">
                                <div>
                                    <span class="course-code">${course.course_code}</span>
                                    <span class="course-name">${course.course_name}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // Extra courses
    if (data.student_year >= 3 && data.extra_courses && data.extra_courses.length > 0) {
        html += `
            <div class="course-section">
                <h3>Extra Courses</h3>
                <p class="section-info">Additional courses you can take this semester</p>
                <div class="extra-courses-wrapper">
                    <div class="extra-courses-search">
                        <i class="fas fa-search"></i>
                        <input type="text" 
                               placeholder="Search extra courses..." 
                               onkeyup="filterExtraCourses(this.value)"
                               aria-label="Search extra courses">
                    </div>
                    <div class="course-list extra-courses-container">
                        ${data.extra_courses.map(course => {
                            const courseYear = getYearFromCourseCode(course.course_code);
                            return `
                                <div class="course-item"
                                     data-year="${courseYear}"
                                     data-course-code="${course.course_code.toLowerCase()}"
                                     data-course-name="${course.course_name.toLowerCase()}"
                                     onmousemove="showTooltip(event, '${course.course_code}')"
                                     onmouseleave="hideTooltip()">
                                     <label>
                                         <input type="checkbox" 
                                                data-course-code="${course.course_code}"
                                                ${selectedCourses.has(course.course_code) ? 'checked' : ''}>
                                         <div>
                                             <span class="course-code">${course.course_code}</span>
                                             <span class="course-name">${course.course_name}</span>
                                         </div>
                                     </label>
                                 </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Form actions
    html += `
        <div id="scheduling-conflict-message" class="scheduling-conflict-message" style="display:none;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>There is a scheduling conflict between the courses you selected. Please adjust your selection.</p>
        </div>
        <div id="major-warnings" class="scheduling-conflict-message" style="display:none; background-color: #fff3cd; border-color: #ffeeba; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; flex-direction: column; align-items: flex-start;">
            <div style="display: flex; align-items: center; margin-bottom: 10px; width: 100%; cursor: pointer;" onclick="toggleCollapsible('major-warnings-content')">
                <i class="fas fa-exclamation-triangle" style="margin-right: 10px; font-size: 1.2em;"></i>
                <h4 style="margin: 0; font-size: 1.1em;">Specialization Selection Analysis</h4>
                <i class="fas fa-chevron-down" style="margin-left: auto;"></i>
            </div>
            <div id="major-warnings-content" style="width: 100%; display: none;"></div>
        </div>
        <div id="prerequisite-chains" class="scheduling-conflict-message" style="display:none; background-color: #fff3e0; border-left: 4px solid #ff9800; color: #663c00; padding: 15px; border-radius: 8px; margin-bottom: 20px; flex-direction: column; align-items: flex-start; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; margin-bottom: 10px; width: 100%; cursor: pointer;" onclick="toggleCollapsible('prerequisite-chains-content')">
                <i class="fas fa-project-diagram" style="margin-right: 10px; font-size: 1.2em; color: #ff9800;"></i>
                <h4 style="margin: 0; font-size: 1.1em;">Prerequisite Chain Feedback</h4>
                <i class="fas fa-chevron-down" style="margin-left: auto;"></i>
            </div>
            <div id="prerequisite-chains-content" style="width: 100%; display: none;"></div>
        </div>
        
        <div id="probation-analysis" class="scheduling-conflict-message" style="display:none; background-color: #e2f0fb; border-color: #b8daff; color: #004085; padding: 15px; border-radius: 8px; margin-bottom: 20px; flex-direction: column; align-items: flex-start;">
            <div style="display: flex; align-items: center; margin-bottom: 10px; width: 100%; cursor: pointer;" onclick="toggleCollapsible('probation-analysis-content')">
                <i class="fas fa-info-circle" style="margin-right: 10px; font-size: 1.2em;"></i>
                <h4 style="margin: 0; font-size: 1.1em;">Probation Status Analysis</h4>
                <i class="fas fa-chevron-down" style="margin-left: auto;"></i>
            </div>
            <div id="probation-analysis-content" style="width: 100%; display: none;"></div>
        </div>
        <div class="form-actions">
            <button id="run-check" class="btn-primary" ${selectedCourses.size === 0 ? 'disabled' : ''}>
                <i class="fas fa-check-circle"></i> Run Check
            </button>
            <button id="submit-courses" class="btn-primary" ${selectedCourses.size === 0 ? 'disabled' : ''} disabled>
                ${data.has_existing_submissions ? '<i class="fas fa-save"></i> Update Selection' : '<i class="fas fa-paper-plane"></i> Submit Course Selection'}
            </button>
        </div>
    `;
    
    html += `</div>`; // Close container
    
    document.getElementById('dynamic-content').innerHTML = html;
    
    // Now that the interface is rendered, update the selectedCourses set
    // to only include visible checked checkboxes
    updateSelectedCount();
    
    // Initialize elective counters and store elective group data
    if (data.elective_courses) {
        // Store elective group data for later use
        electiveGroups = data.elective_courses;
        
        Object.entries(data.elective_courses).forEach(([groupNumber, groupData]) => {
            updateElectiveCounter(groupNumber, groupData.required_picks);
        });
    }
    
    // Add event listeners for checkboxes
    document.querySelectorAll('.course-list input[type="checkbox"]:not(:disabled)').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const courseCode = this.getAttribute('data-course-code');
            if (this.checked) {
                selectedCourses.add(courseCode);
            } else {
                selectedCourses.delete(courseCode);
            }
            updateSelectedCount();
            
            // Hide scheduling conflict message when selection changes
            const conflictMessage = document.getElementById('scheduling-conflict-message');
            if (conflictMessage) {
                conflictMessage.style.display = 'none';
            }
            
            // Disable submit button when course selection changes
            const submitBtn = document.getElementById('submit-courses');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.removeAttribute('data-check-passed');
            }
        });
    });
    
    // Add event listeners for elective checkboxes
    document.querySelectorAll('.elective-checkbox:not(:disabled)').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const groupNumber = this.getAttribute('data-group-number');
            const courseCode = this.getAttribute('data-course-code');
            const requiredPicks = data.elective_courses[groupNumber].required_picks;
            
            // Update selectedCourses set for total count
            if (this.checked) {
                selectedCourses.add(courseCode);
                console.log(`Added ${courseCode} to selectedCourses. New size: ${selectedCourses.size}`);
            } else {
                selectedCourses.delete(courseCode);
                console.log(`Removed ${courseCode} from selectedCourses. New size: ${selectedCourses.size}`);
            }
            
            // Update overall selected courses counter
            updateSelectedCount();
            
            updateElectiveCounter(groupNumber, requiredPicks);
            console.log(`Updated elective counter for group ${groupNumber}`);
            
            // Hide scheduling conflict message when selection changes
            const conflictMessage = document.getElementById('scheduling-conflict-message');
            if (conflictMessage) {
                conflictMessage.style.display = 'none';
            }
            
            // Disable submit button when course selection changes
            const submitBtn = document.getElementById('submit-courses');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.removeAttribute('data-check-passed');
            }
        });
    });
    
    // Add submit handler
    const submitBtn = document.getElementById('submit-courses');
    if (submitBtn) {
        submitBtn.addEventListener('click', function() {
            submitCourses(data.current_semester, data.current_year, data.not_met_requirements);
        });
    }
    
    // Add run check handler
    const checkBtn = document.getElementById('run-check');
    if (checkBtn) {
        checkBtn.addEventListener('click', function() {
            runCourseCheck();
        });
    }
}

// Run course selection check
function runCourseCheck() {
    // Make sure selectedCourses only contains visible checked courses
    updateSelectedCount();
    
    // Get the check button and show loading state
    const checkBtn = document.getElementById('run-check');
    const originalText = checkBtn.innerHTML;
    checkBtn.disabled = true;
    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    
    // Prepare the data to send
    const requestData = {
        selected_courses: Array.from(selectedCourses)
    };
    
    // Get the submit button
    const submitBtn = document.getElementById('submit-courses');
    
    // Call the API
    fetch('/student/course-registration/check', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.message || 'Check failed');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Reset the button
            checkBtn.disabled = false;
            checkBtn.innerHTML = originalText;
            
            // Enable the submit button after successful check
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.setAttribute('data-check-passed', 'true');
            }
            
            // Clear any previous error message
            const errorDiv = document.getElementById('schedule-conflict-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            // Process warnings and probation analysis
            let hasWarnings = data.warnings && data.warnings.length > 0;
            let hasProbationWarning = data.probation_analysis && data.probation_analysis.on_probation;
            
            if (hasWarnings) {
                displayMajorWarnings(data.warnings);
            } else {
                // Hide warnings if there are none
                const warningsDiv = document.getElementById('major-warnings');
                if (warningsDiv) {
                    warningsDiv.style.display = 'none';
                }
            }
            
            // Display probation analysis if student is on probation
            if (hasProbationWarning) {
                displayProbationAnalysis(data.probation_analysis);
            } else {
                // Hide probation analysis if not on probation
                const probationDiv = document.getElementById('probation-analysis');
                if (probationDiv) {
                    probationDiv.style.display = 'none';
                }
            }
            
            // Check for selected course analysis
            let hasSelectedCourseAnalysis = data.selected_course_analysis && data.selected_course_analysis.length > 0;
            
            if (hasSelectedCourseAnalysis) {
                displaySelectedCourseAnalysis(data.selected_course_analysis);
            } else {
                // Hide selected course analysis if none
                const analysisDiv = document.getElementById('selected-course-analysis');
                if (analysisDiv) {
                    analysisDiv.style.display = 'none';
                }
            }
            
            // Check for prerequisite chains
            let hasPrerequisiteChains = data.prerequisite_chains && data.prerequisite_chains.length > 0;
            
            if (hasPrerequisiteChains) {
                // Store selected course chains in a global variable for access in the displayPrerequisiteChains function
                window.selectedCourseChains = data.selected_course_chains || [];
                displayPrerequisiteChains(data.prerequisite_chains);
            } else {
                // Hide prerequisite chains if none
                const prerequisiteDiv = document.getElementById('prerequisite-chains');
                if (prerequisiteDiv) {
                    prerequisiteDiv.style.display = 'none';
                }
            }
            
            // If no warnings, no probation, no selected course analysis, and no prerequisite chains, show success message
            if (!hasWarnings && !hasProbationWarning && !hasSelectedCourseAnalysis && !hasPrerequisiteChains) {
                // Only show a simple success message, no debug info
                showSuccessMessage('No issues found with your course selection!');
            }
        } else {
            throw new Error(data.message || 'Check failed');
        }
    })
    .catch(error => {
        console.error('Error checking course selection:', error);
        
        // Reset the check button
        checkBtn.disabled = false;
        checkBtn.innerHTML = originalText;
        
        // Make sure submit button stays disabled on error
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.removeAttribute('data-check-passed');
        }
        
        // Handle the specific scheduling conflict error
        if (error.message && error.message.includes('scheduling conflict')) {
            // Create or update the error message above the Run Check button
            let errorDiv = document.getElementById('schedule-conflict-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'schedule-conflict-error';
                errorDiv.style.color = '#dc3545';
                errorDiv.style.marginBottom = '10px';
                errorDiv.style.fontWeight = 'bold';
                
                // Insert before the Run Check button
                const checkBtn = document.getElementById('run-check');
                if (checkBtn && checkBtn.parentNode) {
                    checkBtn.parentNode.insertBefore(errorDiv, checkBtn);
                }
            }
            
            errorDiv.textContent = 'There is a scheduling conflict between the courses you selected. Please adjust your selection.';
        } else {
            showSuccessMessage(`Error: ${error.message}`);
        }
    });
}

// Display major warnings
function displayMajorWarnings(warnings) {
    const warningsDiv = document.getElementById('major-warnings');
    const warningsContent = document.getElementById('major-warnings-content');
    
    if (!warningsDiv || !warningsContent) return;
    
    // Clear previous content
    warningsContent.innerHTML = '';
    
    // Keep content collapsed by default
    warningsContent.style.display = 'none';
    
    // Ensure chevron icon shows down arrow
    const headerElement = warningsContent.previousElementSibling;
    const chevronIcon = headerElement.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (chevronIcon) {
        chevronIcon.classList.remove('fa-chevron-up');
        chevronIcon.classList.add('fa-chevron-down');
    }
    
    // Group warnings by major first, then by course groups
    const majorGroups = {};
    
    warnings.forEach(warning => {
        const majorId = warning.major;
        const majorName = warning.major_name;
        
        // Initialize the major group if it doesn't exist
        if (!majorGroups[majorId]) {
            majorGroups[majorId] = {
                name: majorName,
                courseGroups: {}
            };
        }
        
        // Check if this warning is part of a group
        if (warning.unselected_course_group && warning.unselected_course_group.length > 0) {
            // Create a unique key for this group based on the courses
            const groupKey = warning.unselected_course_group.join('-');
            
            if (!majorGroups[majorId].courseGroups[groupKey]) {
                majorGroups[majorId].courseGroups[groupKey] = {
                    courses: warning.unselected_course_group,
                    warnings: []
                };
            }
            
            // Only add the warning if it's not already in the group
            const alreadyAdded = majorGroups[majorId].courseGroups[groupKey].warnings.some(w => 
                w.course_code === warning.course_code);
                
            if (!alreadyAdded) {
                majorGroups[majorId].courseGroups[groupKey].warnings.push(warning);
            }
        } else {
            // Handle individual course warnings (legacy format)
            const singleKey = warning.course_code;
            
            if (!majorGroups[majorId].courseGroups[singleKey]) {
                majorGroups[majorId].courseGroups[singleKey] = {
                    courses: [warning.course_code],
                    warnings: []
                };
            }
            
            majorGroups[majorId].courseGroups[singleKey].warnings.push(warning);
        }
    });
    
    // Create HTML for each major and its course warnings
    let html = '';
    
    // Add "Unselected Courses" section header
    html += '<div style="margin: 10px 0 10px 0;"><strong><em>Unselected Courses:</em></strong></div>';
    
    // Create a container div for all majors
    html += '<div style="margin-left: 15px;">';
    
    Object.entries(majorGroups).forEach(([majorId, majorData]) => {
        // Add major header
        html += `<div style="margin-bottom: 15px;"><strong>${majorData.name}:</strong>`;
        html += '<ul style="margin: 0 0 10px 20px; padding-left: 0;">';
        
        // Add all course groups for this major
        Object.entries(majorData.courseGroups).forEach(([groupKey, groupData]) => {
            const { courses, warnings } = groupData;
            
            // Only show one warning per group (they all have the same message)
            const warning = warnings[0];
            
            // Get message and remove "This course is required for X major" prefix
            let message = warning.message.replace(/minimum GPA requirement of (\d+\.\d+)0+/g, 'minimum GPA requirement of $1');
            message = message.replace(/This course is required for [^\.]+\. /g, '');
            message = message.replace(/These courses \([^\)]+\) are required for [^\.]+\. /g, '');
            
            // Check for unreasonably high GPA requirements (9999.00) and replace the entire message with a clearer one
            if (message.includes("9999.00")) {
                // Extract the minimum GPA requirement if present in the message
                let minGpaMatch = message.match(/minimum specialized GPA requirement of (\d+(?:\.\d+)?)/);
                let minGpaText = minGpaMatch ? minGpaMatch[1] : "2";
                
                // Check if this is for a single course or multiple courses
                if (message.includes("These courses")) {
                    // For multiple courses
                    let courseCodesMatch = message.match(/These courses \(([^)]+)\)/);
                    let majorNameMatch = message.match(/required for ([^\.]+) major/);
                    
                    let courseCodes = courseCodesMatch ? courseCodesMatch[1] : "";
                    let majorName = majorNameMatch ? majorNameMatch[1] : "";
                    
                    message = `These courses (${courseCodes}) are required for ${majorName} major. If you skip these courses, it will be IMPOSSIBLE to meet the minimum specialized GPA requirement of ${minGpaText} for this major by the end of your second year.`;
                } else {
                    // For a single course
                    let majorNameMatch = message.match(/required for ([^\.]+) major/);
                    let majorName = majorNameMatch ? majorNameMatch[1] : "";
                    
                    message = `This course is required for ${majorName} major. If you skip this course, it will be IMPOSSIBLE to meet the minimum specialized GPA requirement of ${minGpaText} for this major by the end of your second year.`;
                }
            }
            
            // Highlight the min average grade if it exists in the message
            message = message.replace(/at least (\d+\.\d+)/g, 'at least <span style="color: #e74c3c; font-weight: bold;">$1</span>');
            message = message.replace(/average at least (\d+\.\d+)/g, 'average at least <span style="color: #e74c3c; font-weight: bold;">$1</span>');
            message = message.replace(/need to average at least (\d+\.\d+)/g, 'need to average at least <span style="color: #e74c3c; font-weight: bold;">$1</span>');
            message = message.replace(/would need to average at least (\d+\.\d+)/g, 'would need to average at least <span style="color: #e74c3c; font-weight: bold;">$1</span>');
            
            if (courses.length === 1) {
                // Single course warning
                html += `<li style="margin-bottom: 10px;"><strong>${courses[0]}</strong>: ${message}`;
            } else {
                // Multiple courses warning
                const coursesList = courses.join(', ');
                html += `<li style="margin-bottom: 10px;"><strong>${coursesList}</strong>: ${message}`;
            }
            
            // Add minimum grade needed information if not already in the message
            if (warning.min_avg_grade_needed !== undefined) {
                // Convert to number if it's a string (from Decimal in Python)
                const minAvgGradeNeeded = typeof warning.min_avg_grade_needed === 'string' ? 
                    parseFloat(warning.min_avg_grade_needed) : warning.min_avg_grade_needed;
                
                // Only show "already met" message if needed AND this is not the last required course
                // We check if the message doesn't contain "last required course" to determine this
                const isLastRequiredCourse = warning.message && 
                    (warning.message.includes("last required course") || 
                     warning.message.includes("last required courses"));
                
                if (minAvgGradeNeeded <= 0 && !isLastRequiredCourse) {
                    html += `<br><span style="font-size: 0.9em; margin-left: 20px; color: #6c757d;">
                        GPA requirement: <strong>Already met</strong>
                        (You've already met the minimum GPA requirement for this major)
                    </span>`;
                }
            }
            
            html += `</li>`;
        });
        
        html += '</ul></div>';
    });
    
    // Close the container div
    html += '</div>';
    
    // Add the reminder note about eligibility requirements
    html += `<div style="margin-top: 15px; padding: 10px; font-weight: bold;">
        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
        Remember: To be eligible to pick a major, all credits of Freshman and Sophomore courses must be earned.
    </div>`;
    
    // Set the content and show the warnings
    warningsContent.innerHTML = html;
    warningsDiv.style.display = 'flex';
    
    // Scroll to make the warnings visible
    warningsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Display selected course analysis
function displaySelectedCourseAnalysis(analysis) {
    // Group analysis by major and properly handle courses within each major
    const majorGroups = {};
    
    analysis.forEach(item => {
        const majorCode = item.major_code;
        const majorName = item.major_name;
        
        // Initialize the major group if it doesn't exist
        if (!majorGroups[majorCode]) {
            majorGroups[majorCode] = {
                name: majorName,
                courses: {},
                min_required_gpa: item.min_required_gpa,
                current_gpa: item.current_gpa
            };
        }
        
        // Add each course to the major group
        if (item.courses && item.courses.length > 0) {
            item.courses.forEach(courseCode => {
                if (!majorGroups[majorCode].courses[courseCode]) {
                    // Extract course name from the message if possible
                    let courseName = "";
                    const courseMatch = item.message.match(new RegExp(`${courseCode} \\(([^)]+)\\)`));
                    if (courseMatch && courseMatch[1]) {
                        courseName = courseMatch[1];
                    }
                    
                    majorGroups[majorCode].courses[courseCode] = {
                        code: courseCode,
                        name: courseName,
                        min_avg_grade_needed: item.min_avg_grade_needed
                    };
                }
            });
        }
    });
    
    // Get the warnings div to add selected course analysis directly to it
    const warningsDiv = document.getElementById('major-warnings');
    const warningsContent = document.getElementById('major-warnings-content');
    
    if (!warningsDiv || !warningsContent) return;
    
    // Remove any existing "Selected Courses" sections
    const existingSelectedCoursesHeaders = warningsContent.querySelectorAll('div > strong > em');
    existingSelectedCoursesHeaders.forEach(header => {
        if (header.textContent === 'Selected Courses:') {
            // Find the parent div of the header
            const headerDiv = header.parentElement.parentElement;
            // Find the container that follows this header (if any)
            let container = headerDiv.nextElementSibling;
            if (container && container.style.marginLeft === '15px') {
                // Remove the container
                warningsContent.removeChild(container);
            }
            // Remove the header div itself
            warningsContent.removeChild(headerDiv);
        }
    });
    
    // Only add a horizontal line if there's already content in the warnings
    if (warningsContent.innerHTML.trim() !== '') {
        // Add a horizontal line
        const hrElement = document.createElement('hr');
        hrElement.style.width = '100%';
        hrElement.style.margin = '15px 0';
        hrElement.style.border = '0';
        hrElement.style.height = '1px';
        hrElement.style.backgroundColor = '#ddd';
        
        warningsContent.appendChild(hrElement);
    }
    
    // Add "Selected Courses" section header once at the top
    const checkedCoursesHeader = document.createElement('div');
    checkedCoursesHeader.style.margin = '10px 0 10px 0';
    checkedCoursesHeader.innerHTML = '<strong><em>Selected Courses:</em></strong>';
    warningsContent.appendChild(checkedCoursesHeader);
    
    // Create a container for all majors under Selected Courses
    const checkedCoursesContainer = document.createElement('div');
    checkedCoursesContainer.style.marginLeft = '15px';
    warningsContent.appendChild(checkedCoursesContainer);
    
    // Create HTML for each major group
    Object.entries(majorGroups).forEach(([majorCode, majorData]) => {
        // Create a div for this major
        const majorSection = document.createElement('div');
        majorSection.style.marginBottom = '15px';
        
        // Add major header
        const majorHeader = document.createElement('div');
        majorHeader.innerHTML = `<strong>${majorData.name}:</strong>`;
        majorSection.appendChild(majorHeader);
        
        // Add courses for this major
        const majorList = document.createElement('ul');
        majorList.style.margin = '0 0 10px 20px';
        majorList.style.paddingLeft = '0';
        
        // Get all courses for this major
        const courses = Object.values(majorData.courses);
        
        // If there are multiple courses, show a summary message first
        if (courses.length > 1) {
            const summaryItem = document.createElement('li');
            summaryItem.style.marginBottom = '15px';
            
            const minAvgGrade = typeof courses[0].min_avg_grade_needed === 'string' ? 
                parseFloat(courses[0].min_avg_grade_needed) : courses[0].min_avg_grade_needed;
            
            // Get all course codes
            const courseCodes = courses.map(course => course.code).join(', ');
            
            let summaryMessage = '';
            if (minAvgGrade >= 9999) {
                // Impossible to meet
                summaryMessage = `<strong>${courseCodes}</strong>: These are the last required courses for ${majorData.name} major. Even with perfect grades in these courses, you cannot meet the minimum GPA requirement of ${majorData.min_required_gpa}. Consider retaking courses and/or applying for forgiveness policy.`;
            } else {
                // Format the min average grade with color
                summaryMessage = `<strong>${courseCodes}</strong>: These are the last required courses for ${majorData.name} major. You need to achieve at least a <span style="color: #e74c3c; font-weight: bold;">${minAvgGrade.toFixed(2)}</span> average grade in these courses to meet the minimum specialized GPA requirement of ${majorData.min_required_gpa} by the end of your second year.`;
            }
            
            summaryItem.innerHTML = summaryMessage;
            majorList.appendChild(summaryItem);
        }
        
        // Add each course individually only if there's just one course
        // For multiple courses, we've already shown the summary with all course codes
        if (courses.length === 1) {
            courses.forEach(course => {
                const listItem = document.createElement('li');
                listItem.style.marginBottom = '10px';
                
                // Build the message
                let messageHtml = `<strong>${course.code}</strong>`;
                if (course.name) {
                    messageHtml += ` (${course.name})`;
                }
                
                // Add the detailed message for a single course
                const minAvgGrade = typeof course.min_avg_grade_needed === 'string' ? 
                    parseFloat(course.min_avg_grade_needed) : course.min_avg_grade_needed;
                    
                if (minAvgGrade >= 9999) {
                    // Impossible to meet
                    messageHtml += `: This is the last required course for ${majorData.name} major. Even with a perfect grade in this course, you cannot meet the minimum GPA requirement of ${majorData.min_required_gpa}. Consider retaking courses and/or applying for forgiveness policy.`;
                } else {
                    // Format the min average grade with color
                    messageHtml += `: This is the last required course for ${majorData.name} major. You need to achieve at least a <span style="color: #e74c3c; font-weight: bold;">${minAvgGrade.toFixed(2)}</span> grade in this course to meet the minimum specialized GPA requirement of ${majorData.min_required_gpa} by the end of your second year.`;
                }
                
                listItem.innerHTML = messageHtml;
                majorList.appendChild(listItem);
            });
        }
        
        majorSection.appendChild(majorList);
        checkedCoursesContainer.appendChild(majorSection);
    });
    
    // Make sure the warnings div is visible
    warningsDiv.style.display = 'flex';
    
    // Scroll to make the warnings visible
    warningsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Display prerequisite chains
function displayPrerequisiteChains(chains) {
    const prerequisiteDiv = document.getElementById('prerequisite-chains');
    const prerequisiteContent = document.getElementById('prerequisite-chains-content');
    
    if (!prerequisiteDiv || !prerequisiteContent) return;
    
    // Clear previous content
    prerequisiteContent.innerHTML = '';
    
    // Keep content collapsed by default
    prerequisiteContent.style.display = 'none';
    
    // Ensure chevron icon shows down arrow
    const headerElement = prerequisiteContent.previousElementSibling;
    const chevronIcon = headerElement.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (chevronIcon) {
        chevronIcon.classList.remove('fa-chevron-up');
        chevronIcon.classList.add('fa-chevron-down');
    }
    
    // Create HTML content
    let html = '<div style="margin-bottom: 15px;">';
    html += '<strong>Prerequisite Chain Feedback:</strong>';
    html += '<p>Not selecting these courses will prevent you from taking future courses in the curriculum.</p>';
    html += '</div>';
    
    // Helper function to remove year and semester info in parentheses
    function removeYearSemesterInfo(courseText) {
        return courseText.replace(/\s*\([^)]*\)\s*$/, '');
    }
    
    // Group chains by root course
    const courseGroups = {};
    
    chains.forEach(chain => {
        const rootCourse = chain.root_course;
        
        if (!courseGroups[rootCourse]) {
            courseGroups[rootCourse] = [];
        }
        
        courseGroups[rootCourse].push(chain);
    });
    
    // Create HTML for each course group with visual tree structure
    Object.entries(courseGroups).forEach(([rootCourse, courseChains]) => {
        html += `<div style="margin-bottom: 35px; border-left: 3px solid #ff9800; padding-left: 15px;">`;
        html += `<div style="font-weight: bold; font-size: 1.1em; margin-bottom: 15px; color: #663c00;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 8px; color: #ff9800;"></i>
                    Not selecting <span style="color: #ff5722; font-weight: bold;">${rootCourse}</span> blocks these future courses:
                 </div>`;
        
        // Extract the root course details from the first chain
        const firstChain = courseChains[0];
        const firstChainParts = firstChain.chain.split(' --> ');
        const rootCourseDetails = removeYearSemesterInfo(firstChainParts[0]);
        
        // Create a unified tree structure
        html += `<div class="prerequisite-tree">`;
        
        // Root course box (displayed only once) - colored red
        html += `<div style="position: relative; margin-bottom: 20px; display: flex; flex-direction: column; align-items: flex-start;">
                    <span style="padding: 10px 15px; border-radius: 4px; display: inline-block; background-color: #ffebee; 
                          border: 2px solid #f44336; color: #b71c1c; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        ${rootCourseDetails}
                    </span>
                    <div style="width: 2px; height: 20px; background-color: #f44336; margin-left: 20px;"></div>
                 </div>`;
        
        // Create branches container with main vertical line
        html += `<div style="position: relative; margin-left: 30px; margin-top: 10px;">`;
        
        // Add main vertical line to connect all branches - this will extend the full height
        const totalBranches = courseChains.length;
        const lastBranchIndex = courseChains.length - 1;
        
        // Calculate total height needed for the vertical line
        let totalHeight = 0;
        if (totalBranches > 0) {
            // Start with base height for all branches
            totalHeight = totalBranches * 60;
            
            // Add extra height for the last branch's chain length
            const lastChain = courseChains[lastBranchIndex];
            if (lastChain) {
                const lastChainLength = lastChain.chain.split(' --> ').length - 1; // -1 to exclude root
                if (lastChainLength > 1) {
                    // Add extra height for longer chains
                    totalHeight += (lastChainLength - 1) * 20;
                }
            }
        }
        
        // Create the main vertical line
        html += `<div style="position: absolute; left: 0; top: 0; width: 2px; height: ${totalHeight}px; background-color: #f44336;"></div>`;
        
        // Create each branch
        courseChains.forEach((chain, branchIndex) => {
            const chainParts = chain.chain.split(' --> ');
            
            // Get only dependent courses (skip root course) and remove year/semester info
            const dependentParts = chainParts.slice(1).map(part => removeYearSemesterInfo(part));
            
            if (dependentParts.length > 0) {
                html += `<div style="position: relative; margin-bottom: ${branchIndex < courseChains.length - 1 ? '30px' : '0'};">`;
                
                
                // Add horizontal connector from main vertical line to this branch
                html += `<div style="position: absolute; left: -15px; top: 15px; width: 15px; height: 2px; background-color: #f44336;"></div>`;
                
                // For chains with more than 2 courses (more than 1 dependent course), display in a single line
                if (dependentParts.length > 1) {
                    // Create a container that positions all courses in a row
                    html += `<div style="display: flex; align-items: center; flex-wrap: wrap;">`;
                    
                    // Display all dependent courses in a single line with arrows
                    dependentParts.forEach((part, i) => {
                        const isLast = i === dependentParts.length - 1;
                        
                        // All courses have black text with red border
                        const courseStyle = 'background-color: #ffffff; border: 1px solid #f44336; color: #000000;';
                        
                        html += `<span style="padding: 8px 12px; border-radius: 4px; display: inline-block; ${courseStyle}; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                                    ${part}
                                 </span>`;
                        
                        // Add arrow between courses, but not after the last one
                        if (!isLast) {
                            html += `<span style="margin: 0 10px; color: #f44336;"><i class="fas fa-arrow-right"></i></span>`;
                        }
                    });
                    
                    html += `</div>`;
                } else {
                    // For simple chains (just 1 dependent course)
                    dependentParts.forEach(part => {
                        // Create a container with proper positioning
                        html += `<div style="position: relative; padding: 8px 0; z-index: 1;">`;
                        
                        // All courses have black text with red border
                        const courseStyle = 'background-color: #ffffff; border: 1px solid #f44336; color: #000000;';
                        
                        html += `<span style="padding: 8px 12px; border-radius: 4px; display: inline-block; ${courseStyle}; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                                    ${part}
                                 </span>`;
                        
                        html += `</div>`;
                    });
                }
                
                html += `</div>`;
            }
        });
        
        html += `</div>`; // Close branches container
        
        // Add total impact summary
        const totalAffectedCourses = courseChains.reduce((total, chain) => {
            // Count all courses except the root course
            const chainParts = chain.chain.split(' --> ');
            return total + chainParts.length - 1;
        }, 0);
        
        html += `<div style="margin-top: 15px; font-style: italic; color: #795548;">
                    <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                    Not selecting this course might affect ${totalAffectedCourses} future course${totalAffectedCourses !== 1 ? 's' : ''} in your curriculum.
                 </div>`;
        
        html += `</div>`; // Close prerequisite-tree
        
        // Add recommendation after each group
        html += `<div style="margin-top: 10px; font-weight: bold; color: #1b5e20; background-color: #e8f5e9; padding: 8px; border-radius: 4px; border-left: 3px solid #4caf50;">
                    <i class="fas fa-lightbulb" style="margin-right: 8px; color: #4caf50;"></i>
                    Recommendation: Select ${rootCourse} to keep your future course options open.
                 </div>`;
        
        html += `</div>`;
    });
    
    // Add section for selected courses prerequisite chains
    if (window.selectedCourseChains && window.selectedCourseChains.length > 0) {
        html += '<div style="margin-top: 30px; margin-bottom: 15px; border-top: 1px solid #e0e0e0; padding-top: 20px;">';
        html += '<strong>Selected Courses Prerequisite Chains:</strong>';
        html += '<p>Failing these courses will prevent you from taking future courses in the curriculum.</p>';
        html += '</div>';
        
        // Group selected course chains by root course
        const selectedCourseGroups = {};
        
        window.selectedCourseChains.forEach(chain => {
            const rootCourse = chain.root_course;
            
            if (!selectedCourseGroups[rootCourse]) {
                selectedCourseGroups[rootCourse] = [];
            }
            
            selectedCourseGroups[rootCourse].push(chain);
        });
        
        // Create HTML for each selected course group with visual tree structure
        Object.entries(selectedCourseGroups).forEach(([rootCourse, courseChains]) => {
            html += `<div style="margin-bottom: 35px; border-left: 3px solid #2196F3; padding-left: 15px;">`;
            html += `<div style="font-weight: bold; font-size: 1.1em; margin-bottom: 15px; color: #0d47a1;">
                        <i class="fas fa-project-diagram" style="margin-right: 8px; color: #2196F3;"></i>
                        Selected course <span style="color: #0d47a1; font-weight: bold;">${rootCourse}</span> leads to these future courses:
                     </div>`;
            
            // Extract the root course details from the first chain
            const firstChain = courseChains[0];
            const firstChainParts = firstChain.chain.split(' --> ');
            const rootCourseDetails = removeYearSemesterInfo(firstChainParts[0]);
            
            // Create a unified tree structure
            html += `<div class="prerequisite-tree">`;
            
            // Root course box (displayed only once) - colored blue
            html += `<div style="position: relative; margin-bottom: 20px; display: flex; flex-direction: column; align-items: flex-start;">
                        <span style="padding: 10px 15px; border-radius: 4px; display: inline-block; background-color: #e3f2fd; 
                              border: 2px solid #2196F3; color: #0d47a1; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            ${rootCourseDetails}
                        </span>
                        <div style="width: 2px; height: 20px; background-color: #2196F3; margin-left: 20px;"></div>
                     </div>`;
            
            // Create branches container with main vertical line
            html += `<div style="position: relative; margin-left: 30px; margin-top: 10px;">`;
            
            // Add main vertical line to connect all branches - this will extend the full height
            const totalBranches = courseChains.length;
            const lastBranchIndex = courseChains.length - 1;
            
            // Calculate total height needed for the vertical line
            let totalHeight = 0;
            if (totalBranches > 0) {
                // Start with base height for all branches
                totalHeight = totalBranches * 60;
                
                // Add extra height for the last branch's chain length
                const lastChain = courseChains[lastBranchIndex];
                if (lastChain) {
                    const lastChainLength = lastChain.chain.split(' --> ').length - 1; // -1 to exclude root
                    if (lastChainLength > 1) {
                        // Add extra height for longer chains
                        totalHeight += (lastChainLength - 1) * 20;
                    }
                }
            }
            
            // Create the main vertical line
            html += `<div style="position: absolute; left: 0; top: 0; width: 2px; height: ${totalHeight}px; background-color: #2196F3;"></div>`;
            
            // Create each branch
            courseChains.forEach((chain, branchIndex) => {
                const chainParts = chain.chain.split(' --> ');
                
                // Get only dependent courses (skip root course) and remove year/semester info
                const dependentParts = chainParts.slice(1).map(part => removeYearSemesterInfo(part));
                
                if (dependentParts.length > 0) {
                    html += `<div style="position: relative; margin-bottom: ${branchIndex < courseChains.length - 1 ? '30px' : '0'};">`;
                    
                    
                    // Add horizontal connector from main vertical line to this branch
                    html += `<div style="position: absolute; left: -15px; top: 15px; width: 15px; height: 2px; background-color: #2196F3;"></div>`;
                    
                    // For chains with more than 2 courses (more than 1 dependent course), display in a single line
                    if (dependentParts.length > 1) {
                        // Create a container that positions all courses in a row
                        html += `<div style="display: flex; align-items: center; flex-wrap: wrap;">`;
                        
                        // Display all dependent courses in a single line with arrows
                        dependentParts.forEach((part, i) => {
                            const isLast = i === dependentParts.length - 1;
                            
                            // All courses have black text with blue border
                            const courseStyle = 'background-color: #ffffff; border: 1px solid #2196F3; color: #000000;';
                            
                            html += `<span style="padding: 8px 12px; border-radius: 4px; display: inline-block; ${courseStyle}; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                                        ${part}
                                     </span>`;
                            
                            // Add arrow between courses, but not after the last one
                            if (!isLast) {
                                html += `<span style="margin: 0 10px; color: #2196F3;"><i class="fas fa-arrow-right"></i></span>`;
                            }
                        });
                        
                        html += `</div>`;
                    } else {
                        // For simple chains (just 1 dependent course)
                        dependentParts.forEach(part => {
                            // Create a container with proper positioning
                            html += `<div style="position: relative; padding: 8px 0; z-index: 1;">`;
                            
                            // All courses have black text with blue border
                            const courseStyle = 'background-color: #ffffff; border: 1px solid #2196F3; color: #000000;';
                            
                            html += `<span style="padding: 8px 12px; border-radius: 4px; display: inline-block; ${courseStyle}; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                                        ${part}
                                     </span>`;
                            
                            html += `</div>`;
                        });
                    }
                    
                    html += `</div>`;
                }
            });
            
            html += `</div>`; // Close branches container
            
            // Add total impact summary
            const totalAffectedCourses = courseChains.reduce((total, chain) => {
                // Count all courses except the root course
                const chainParts = chain.chain.split(' --> ');
                return total + chainParts.length - 1;
            }, 0);
            
            html += `<div style="margin-top: 15px; font-style: italic; color: #0d47a1;">
                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                        This course is a prerequisite for ${totalAffectedCourses} future course${totalAffectedCourses !== 1 ? 's' : ''} in your curriculum.
                     </div>`;
            
            html += `</div>`; // Close prerequisite-tree
            
            html += `</div>`;
        });
    }
    
    // Set the content and show the prerequisite chains
    prerequisiteContent.innerHTML = html;
    prerequisiteDiv.style.display = 'flex';
    
    // Scroll to make the prerequisite chains visible
    prerequisiteDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Toggle collapsible sections
function toggleCollapsible(contentId) {
    const contentElement = document.getElementById(contentId);
    const headerElement = contentElement.previousElementSibling;
    const chevronIcon = headerElement.querySelector('.fa-chevron-down, .fa-chevron-up');
    
    if (contentElement.style.display === 'none') {
        contentElement.style.display = 'block';
        if (chevronIcon) {
            chevronIcon.classList.remove('fa-chevron-down');
            chevronIcon.classList.add('fa-chevron-up');
        }
    } else {
        contentElement.style.display = 'none';
        if (chevronIcon) {
            chevronIcon.classList.remove('fa-chevron-up');
            chevronIcon.classList.add('fa-chevron-down');
        }
    }
}

// Display probation analysis
function displayProbationAnalysis(analysis) {
    const probationDiv = document.getElementById('probation-analysis');
    const probationContent = document.getElementById('probation-analysis-content');
    
    if (!probationDiv || !probationContent) return;
    
    // Keep content collapsed by default
    probationContent.style.display = 'none';
    
    // Ensure chevron icon shows down arrow
    const headerElement = probationContent.previousElementSibling;
    const chevronIcon = headerElement.querySelector('.fa-chevron-down, .fa-chevron-up');
    if (chevronIcon) {
        chevronIcon.classList.remove('fa-chevron-up');
        chevronIcon.classList.add('fa-chevron-down');
    }
    
    // Set appropriate background color based on whether student can get out of probation
    if (analysis.can_get_out_of_probation) {
        probationDiv.style.backgroundColor = '#d4edda';
        probationDiv.style.borderColor = '#c3e6cb';
        probationDiv.style.color = '#155724';
    } else {
        probationDiv.style.backgroundColor = '#f8d7da';
        probationDiv.style.borderColor = '#f5c6cb';
        probationDiv.style.color = '#721c24';
    }
    
    // Create HTML content
    let html = `<div style="margin-bottom: 10px;">
        <strong>Probation Status:</strong> You are on your ${getOrdinalSuffix(analysis.probation_counter)} probation
    </div>`;
    
    html += `<div style="margin-bottom: 10px;">
        <strong>Current Cumulative GPA:</strong> ${analysis.current_cumulative_gpa.toFixed(2)}
        <br>
        <strong>Required Minimum CGPA:</strong> ${analysis.min_required_gpa.toFixed(2)}
    </div>`;
    
    if (analysis.can_get_out_of_probation) {
        if (analysis.min_term_gpa_needed !== null) {
            // Format the term GPA needed with appropriate styling based on difficulty
            let difficultyClass = '';
            let difficultyText = '';
            
            if (analysis.min_term_gpa_needed > 3.7) {
                difficultyClass = 'color: #dc3545; font-weight: bold;';
                difficultyText = ' (very challenging)';
            } else if (analysis.min_term_gpa_needed > 3.3) {
                difficultyClass = 'color: #fd7e14; font-weight: bold;';
                difficultyText = ' (challenging)';
            } else if (analysis.min_term_gpa_needed > 3.0) {
                difficultyClass = 'color: #ffc107; font-weight: bold;';
                difficultyText = ' (moderate)';
            } else {
                difficultyClass = 'color: #28a745; font-weight: bold;';
                difficultyText = ' (achievable)';
            }
            
            html += `<div style="margin-bottom: 10px;">
                <strong>Required Term GPA:</strong> <span style="${difficultyClass}">${analysis.min_term_gpa_needed.toFixed(2)}</span>${difficultyText}
            </div>`;
        } else {
            html += `<div style="margin-bottom: 10px; color: #dc3545;">
                <strong>Warning:</strong> Your current selection can help you get out of probation, but you would need to achieve a term GPA higher than 4.0, which is not possible. Consider taking more courses or using grade forgiveness if available.
            </div>`;
        }
        
        html += `<div style="margin-top: 10px;">
            <strong>Best Case Scenario:</strong> If you achieve a 4.0 grade in all selected courses, your cumulative GPA would be ${analysis.best_case_new_gpa.toFixed(2)}.
        </div>`;
    } else {
        html += `<div style="margin-bottom: 10px; color: #dc3545;">
            <strong>Warning:</strong> Your current selection is not enough to get you out of probation, even with perfect grades (4.0 GPA).
        </div>
        
        <div style="margin-top: 10px;">
            <strong>Best Case Scenario:</strong> If you achieve a 4.0 grade in all selected courses, your cumulative GPA would be ${analysis.best_case_new_gpa.toFixed(2)}, which is still below the required ${analysis.min_required_gpa.toFixed(2)}.
        </div>
        
        <div style="margin-top: 10px;">
            <strong>Recommendations:</strong>
            <ul style="margin-top: 5px;">
                <li>Consider taking more courses this semester if possible</li>
                <li>Look into grade forgiveness options for previously taken courses</li>
            </ul>
        </div>`;
    }
    
    // Set the content and show the analysis
    probationContent.innerHTML = html;
    probationDiv.style.display = 'flex';
    
    // Scroll to make the analysis visible if it's not already in view
    if (!isElementInViewport(probationDiv)) {
        probationDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Helper function to check if an element is in the viewport
function isElementInViewport(el) {
    const rect = el.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

// Update selected courses counter
function updateSelectedCount() {
    const countElement = document.getElementById('selected-count');
    const submitButton = document.getElementById('submit-courses');
    
    // IMPORTANT: Instead of using the global selectedCourses set size,
    // count only the checkboxes that are currently visible and checked
    const visibleCheckedCourses = document.querySelectorAll('input[type="checkbox"]:checked:not([style*="display: none"])');
    const count = visibleCheckedCourses.length;
    
    // Update the global selectedCourses set to only include visible checked courses
    selectedCourses.clear();
    visibleCheckedCourses.forEach(checkbox => {
        const courseCode = checkbox.getAttribute('data-course-code');
        if (courseCode) {
            selectedCourses.add(courseCode);
        }
    });
    
    console.log(`updateSelectedCount called. Total selected courses: ${count}`);
    console.log(`Selected courses: ${Array.from(selectedCourses).join(', ')}`);
    
    if (countElement) {
        countElement.textContent = count;
        countElement.className = count > maxCourses ? 'error' : '';
    }
    
    // Count selected retake courses
    let retakeCount = 0;
    const retakeSections = document.querySelectorAll('.course-section');
    retakeSections.forEach(section => {
        const sectionTitle = section.querySelector('h3');
        if (sectionTitle && sectionTitle.textContent.includes('Retake Courses')) {
            const checkedBoxes = section.querySelectorAll('input[type="checkbox"]:checked');
            retakeCount = checkedBoxes.length;
        }
    });
    
    // Note: We no longer limit the number of retake courses as the forgiveness logic
    // will be handled separately through requests
    
    // Get the check button as well
    const checkButton = document.getElementById('run-check');
    
    // Determine if buttons should be enabled
    let shouldDisable = false;
    let disableReason = '';
    
    if (count > maxCourses) {
        shouldDisable = true;
        disableReason = `You can't select more than ${maxCourses} courses`;
    } else if (count === 0) {
        shouldDisable = true;
        disableReason = 'Please select at least one course';
    } else {
        // Check if all elective group requirements are met
        let allElectiveRequirementsMet = true;
        const electiveGroups = document.querySelectorAll('.elective-group-container');
        
        electiveGroups.forEach(group => {
            const groupNumber = group.getAttribute('data-group-number');
            const counterElement = document.getElementById(`elective-counter-${groupNumber}`);
            if (counterElement && counterElement.classList.contains('error')) {
                allElectiveRequirementsMet = false;
            }
        });
        
        if (!allElectiveRequirementsMet) {
            shouldDisable = true;
            disableReason = 'Please meet all elective course requirements';
        }
    }
    
    // Update submit button
    if (submitButton) {
        // Always disable the submit button unless it has been explicitly enabled by the "Run Check" function
        // We do this by checking for a data attribute that's set after a successful check
        if (submitButton.hasAttribute('data-check-passed')) {
            submitButton.disabled = shouldDisable;
        } else {
            submitButton.disabled = true;
            disableReason = disableReason || 'Run the "Check" function first';
        }
        submitButton.title = disableReason;
    }
    
    // Update check button - only disable if no courses are selected
    if (checkButton) {
        if (count === 0) {
            checkButton.disabled = true;
            checkButton.title = 'Please select at least one course';
        } else {
            checkButton.disabled = false;
            checkButton.title = '';
        }
    }
    
    // Hide warnings, probation analysis, and prerequisite chains when selection changes
    const warningsDiv = document.getElementById('major-warnings');
    if (warningsDiv) {
        warningsDiv.style.display = 'none';
    }
    
    const probationDiv = document.getElementById('probation-analysis');
    if (probationDiv) {
        probationDiv.style.display = 'none';
    }
    
    const prerequisiteDiv = document.getElementById('prerequisite-chains');
    if (prerequisiteDiv) {
        prerequisiteDiv.style.display = 'none';
    }
    
    // Also clear any schedule conflict error message
    const errorDiv = document.getElementById('schedule-conflict-error');
    if (errorDiv) {
        errorDiv.remove();
    }
    
    // Hide selected course analysis if it exists
    const analysisDiv = document.getElementById('selected-course-analysis');
    if (analysisDiv) {
        analysisDiv.style.display = 'none';
    }
    
    // Update retake counter display if it exists
    const forgivenessSections = document.querySelectorAll('.course-section h3');
    forgivenessSections.forEach(heading => {
        if (heading.textContent.includes('Retake Courses')) {
            const counterSpan = heading.querySelector('.forgiveness-counter');
            if (counterSpan) {
                // Just show the count without a limit since there's no limit on retakes
                counterSpan.textContent = `(${retakeCount})`;
                counterSpan.classList.remove('limit-exceeded');
            }
        }
    });
}

// Update elective course counter
function updateElectiveCounter(groupNumber, requiredPicks) {
    console.log(`updateElectiveCounter called for group ${groupNumber}. selectedCourses:`, selectedCourses);
    
    const counterElement = document.getElementById(`elective-counter-${groupNumber}`);
    if (!counterElement) return;
    
    // Count selected courses in this group that are VISIBLE
    const selectedElectives = document.querySelectorAll(`.elective-checkbox[data-group-number="${groupNumber}"]:checked:not([style*="display: none"])`);
    const count = selectedElectives.length;
    
    console.log(`updateElectiveCounter for group ${groupNumber}. Selected: ${count}/${requiredPicks}`);
    
    // Update counter text
    counterElement.textContent = `${count}/${requiredPicks}`;
    
    // Update counter class based on selection status
    if (count < requiredPicks) {
        counterElement.className = 'elective-selection-counter error';
    } else if (count === requiredPicks) {
        counterElement.className = 'elective-selection-counter success';
    } else {
        counterElement.className = 'elective-selection-counter';
    }
}

// Submit selected courses
function submitCourses(current_semester, current_year, not_met_requirements) {
    const submitButton = document.getElementById('submit-courses');
    const originalText = submitButton.innerHTML;
    
    // Make sure selectedCourses only contains visible checked courses
    updateSelectedCount();
    
    // Count selected retake courses
    let retakeCount = 0;
    const retakeSections = document.querySelectorAll('.course-section');
    retakeSections.forEach(section => {
        const sectionTitle = section.querySelector('h3');
        if (sectionTitle && sectionTitle.textContent.includes('Retake Courses')) {
            // Only count visible checked boxes
            const checkedBoxes = section.querySelectorAll('input[type="checkbox"]:checked:not([style*="display: none"])');
            retakeCount = checkedBoxes.length;
        }
    });
    
    // No limit on retake courses anymore
    // The forgiveness logic will be handled separately through requests
    
    // Check if all elective group requirements are met
    let allElectiveRequirementsMet = true;
    const electiveGroups = document.querySelectorAll('.elective-group-container');
    electiveGroups.forEach(group => {
        const groupNumber = group.getAttribute('data-group-number');
        const counterElement = document.getElementById(`elective-counter-${groupNumber}`);
        if (counterElement && counterElement.classList.contains('error')) {
            allElectiveRequirementsMet = false;
        }
    });
    
    if (!allElectiveRequirementsMet) {
        showSuccessMessage('Error: Please meet all elective course requirements');
        return;
    }
    
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

    // Get all selected retake courses
    const retakeCourses = [];
    const courseSections = document.querySelectorAll('.course-section');
    
    courseSections.forEach(section => {
        const sectionTitle = section.querySelector('h3');
        if (sectionTitle && sectionTitle.textContent.includes('Retake Courses')) {
            const checkboxes = section.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                const courseCode = checkbox.getAttribute('data-course-code');
                const courseItem = checkbox.closest('.course-item');
                
                // More robust way to extract course name
                let courseName = '';
                const courseNameElement = courseItem.querySelector('.course-name');
                
                console.log(`Processing retake course: ${courseCode}`);
                console.log(`Course item HTML: ${courseItem.innerHTML}`);
                
                if (courseNameElement) {
                    courseName = courseNameElement.textContent.trim();
                    console.log(`Found course name element: "${courseName}"`);
                } else {
                    // Fallback to the old method but with better error handling
                    const courseText = courseItem.textContent.trim();
                    console.log(`No course name element found. Using text content: "${courseText}"`);
                    
                    const parts = courseText.split(' - ');
                    if (parts.length > 1) {
                        const secondPart = parts[1];
                        const parenIndex = secondPart.indexOf(' (');
                        courseName = parenIndex > -1 ? secondPart.substring(0, parenIndex) : secondPart;
                    } else {
                        // If all else fails, just use the course code as the name
                        courseName = courseCode;
                    }
                    console.log(`Extracted course name: "${courseName}"`);
                }
                
                retakeCourses.push({
                    course_code: courseCode,
                    course_name: courseName
                });
            });
        }
    });
    
    // Get elective selections grouped by group number
    const electiveSelections = {};
    const electiveCourseCodes = new Set();
    document.querySelectorAll('.elective-checkbox:checked').forEach(checkbox => {
        const groupNumber = checkbox.getAttribute('data-group-number');
        const courseCode = checkbox.getAttribute('data-course-code');
        
        if (!electiveSelections[groupNumber]) {
            electiveSelections[groupNumber] = [];
        }
        
        electiveSelections[groupNumber].push(courseCode);
        electiveCourseCodes.add(courseCode); // Track all elective course codes
    });

    // Prepare the submission data - filter out elective courses from selected_courses
    const submissionData = {
        selected_courses: Array.from(selectedCourses).filter(code => !electiveCourseCodes.has(code)),
        current_semester: current_semester,
        current_year: current_year,
        not_met_courses: not_met_requirements || [],
        eligible_current_courses: eligibleCurrentCourses || [],
        retake_courses: retakeCourses,  // This now contains ONLY selected retake courses
        elective_selections: electiveSelections // Add elective selections
    };

    console.log('Submitting courses with retake info:', submissionData);

    fetch('/student/submit-courses', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(submissionData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errData => {
                // Check specifically for scheduling conflict error
                if (errData.code === 'SCHEDULING_CONFLICT') {
                    // Show the scheduling conflict message above the submit button
                    const conflictMessage = document.getElementById('scheduling-conflict-message');
                    if (conflictMessage) {
                        conflictMessage.style.display = 'flex';
                        // Scroll to make the message visible
                        conflictMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    throw new Error('scheduling_conflict');
                }
                throw new Error(errData.message || `HTTP error! status: ${response.status}`);
            }).catch(e => {
                if (e.message === 'scheduling_conflict') {
                    throw e;
                }
                throw new Error(`Server returned ${response.status} ${response.statusText}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Submission failed');
        }
        
        // Hide any scheduling conflict message if it was showing
        const conflictMessage = document.getElementById('scheduling-conflict-message');
        if (conflictMessage) {
            conflictMessage.style.display = 'none';
        }
        
        showSuccessMessage('Courses submitted successfully!');
        
        // Get current semester name and enrolled courses
        return Promise.all([
            fetch('/student/course-registration'),
            fetch('/admin/academic-calendar/current')
        ]);
    })
    .then(([registrationResponse, calendarResponse]) => {
        if (!registrationResponse.ok) {
            throw new Error('Failed to refresh course data');
        }
        
        return Promise.all([
            registrationResponse.json(),
            calendarResponse.json()
        ]);
    })
    .then(([registrationData, calendarData]) => {
        if (registrationData.success) {
            // Show the enrollment confirmation popup only after course submission
            if (registrationData.data && registrationData.data.enrolled_courses && registrationData.data.enrolled_courses.length > 0) {
                const semesterName = getSemesterName(calendarData.semester);
                showEnrollmentConfirmation(registrationData.data.enrolled_courses, semesterName);
            }
            
            renderCourseRegistration(registrationData.data);
        }
    })
    .catch(error => {
        console.error('Submission error:', error);
        
        // Don't show an error message for scheduling conflicts as we already display it above the submit button
        if (error.message === 'scheduling_conflict') {
            return; // Exit early, don't show the toast message
        }
        
        // Show more detailed error message for other errors
        let errorMessage = `Submission failed: ${error.message}`;
        
        // If there's additional error details in the response
        if (error.response && error.response.error) {
            errorMessage += ` (${error.response.error})`;
        }
        
        showSuccessMessage(errorMessage);
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

// Show enrollment confirmation popup
function showEnrollmentConfirmation(enrolledCourses, semesterName) {
    // Remove any existing overlay first
    const existingOverlay = document.querySelector('.enrollment-confirmation-overlay');
    if (existingOverlay) {
        existingOverlay.parentNode.removeChild(existingOverlay);
    }
    
    // Create the overlay element
    const overlay = document.createElement('div');
    overlay.className = 'enrollment-confirmation-overlay';
    overlay.id = 'enrollment-confirmation-overlay';
    
    // Calculate total credits
    let totalCredits = 0;
    enrolledCourses.forEach(course => {
        totalCredits += parseInt(course.credits || 0);
    });
    
    // Create HTML for the popup
    overlay.innerHTML = `
        <div class="enrollment-confirmation-container" id="enrollment-confirmation-container">
            <div class="enrollment-confirmation-header">
                <h3><i class="fas fa-check-circle"></i> Enrollment Confirmed</h3>
            </div>
            <div class="enrollment-confirmation-body">
                <div class="enrollment-confirmation-message">
                    You have successfully enrolled in the following courses for the ${semesterName} semester:
                </div>
                <div class="enrolled-courses-summary">
                    <div class="enrolled-courses-summary-header">
                        Enrolled Courses (${enrolledCourses.length} courses, ${totalCredits} credits)
                    </div>
                    <div class="enrolled-courses-summary-list">
                        ${enrolledCourses.map(course => `
                            <div class="enrolled-course-summary-item">
                                <div class="enrolled-course-summary-code">${course.course_code}</div>
                                <div class="enrolled-course-summary-name">${course.course_name}</div>
                                <div class="enrolled-course-summary-credits">${course.credits || 0} credits</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="enrollment-confirmation-note">
                    To make adjustments, click anywhere to dismiss this message
                </div>
            </div>
        </div>
    `;
    
    // Add the overlay to the body so it's centered in the viewport
    document.body.appendChild(overlay);
    
    // Center the popup in the current viewport, accounting for sidebar
    const viewportHeight = window.innerHeight;
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    
    // Position the container in the center of the main content area
    const container = overlay.querySelector('.enrollment-confirmation-container');
    if (container) {
        // Apply initial centering based on viewport
        container.style.marginTop = Math.max(20, (viewportHeight - 500) / 2) + 'px';
        // Ensure the container is not too wide
        container.style.maxWidth = '80%';
    }
    
    // Prevent immediate closing due to event bubbling
    setTimeout(() => {
        // Add click event to close the popup
        const addedOverlay = document.getElementById('enrollment-confirmation-overlay');
        if (addedOverlay) {
            addedOverlay.addEventListener('click', function(e) {
                // Only close if clicking outside the content or on the note
                if (e.target === addedOverlay || e.target.closest('.enrollment-confirmation-note')) {
                    document.body.removeChild(addedOverlay);
                }
            });
            
            // Stop event propagation on the container to prevent immediate closing
            const container = document.getElementById('enrollment-confirmation-container');
            if (container) {
                container.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }
    }, 100);
}

  </script> 





    <!-- Enrollment History Script -->
    <script>// Enrollment History specific functionality
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function loadEnrollmentHistory() {
        document.getElementById('content-title').textContent = 'Enrollment History';
        
    // Show loading state
    document.getElementById('dynamic-content').innerHTML = `
        <div class="content-card loading-message">
            <h3><i class="fas fa-spinner fa-spin"></i> Loading Enrollment History</h3>
            <p>Please wait while we load your academic records</p>
        </div>
    `;

    fetch('/student/enrollment-history')
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.message || `Server error: ${response.status}`);
                }).catch(() => {
                    throw new Error(`Server returned ${response.status} ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.message || 'Failed to load enrollment history');
            }
            
            // Store forgiveness status in a global variable for access in rendering functions
            window.forgivenessStatus = data.data.forgiveness_status || {};
            console.log("Forgiveness status loaded:", window.forgivenessStatus);
            
            // Store forgiveness policy limits for later use in the modal
            window.maxForgivenessUses = data.data.max_forgiveness_uses;
            window.remainingForgiveness = data.data.remaining_forgiveness_uses;
            console.log("Remaining forgiveness:", window.remainingForgiveness, "of", window.maxForgivenessUses);
            
            renderEnrollmentHistory(data.data);
        })
        .catch(error => {
            console.error('Failed to load enrollment history:', error);
            
            // Check if this is a 403 error (might be board decision restriction)
            if (error.message && error.message.includes('403')) {
                // Try to fetch the actual error message
                fetch('/student/course-registration')
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 'AWAITING_BOARD_DECISION') {
                            showError(data.message, data.code);
                        } else {
                            showError('Access restricted. Please contact administration.', 'ACCESS_RESTRICTED');
                        }
                    })
                    .catch(() => {
                        // If that fails too, show a generic board decision message
                        showError('Awaiting Scientific Board decision whether to grant an extension semester or not', 'AWAITING_BOARD_DECISION');
                    });
            } else if (error.code === 'AWAITING_BOARD_DECISION') {
                showError(error.message, error.code);
            } else {
                document.getElementById('dynamic-content').innerHTML = `
                    <div class="content-card error-message">
                        <h3>Error Loading Enrollment History</h3>
                        <p>${error.message}</p>
                        <button onclick="loadEnrollmentHistory()" class="btn-primary retry-button">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
            }
        });
}

// Render enrollment history
function renderEnrollmentHistory(data) {
    if (!data || !data.semesters || data.semesters.length === 0) {
        document.getElementById('dynamic-content').innerHTML = `
            <div class="content-card">
                <h3>No Enrollment History Found</h3>
                <p>You don't have any enrollment records yet.</p>
            </div>
        `;
        return;
    }

    let html = '<div class="enrollment-history-container">';
    function getSemesterName(semesterNumber) {
        switch(semesterNumber) {
            case 1: return 'Fall';
            case 2: return 'Spring';            case 3: return 'Makeup Session';
        }
    }

    // Get current date to determine current academic year
    const currentDate = new Date();
    const currentCalendarYear = currentDate.getFullYear();
    
    // If data.current_year is not available, estimate it based on the max year in semesters
    const studentCurrentYear = data.current_year || Math.max(...data.semesters.map(s => s.year));

    // Create a map to track course attempts for forgiveness eligibility
    const courseAttempts = {};
    
    // First pass: build the course attempts map
    data.semesters.forEach(semester => {
        semester.courses.forEach(course => {
            const courseCode = course.course_code;
            if (!courseAttempts[courseCode]) {
                courseAttempts[courseCode] = [];
            }
            
            courseAttempts[courseCode].push({
                year: semester.year,
                semester: semester.semester,
                status: course.status,
                grade: course.letter_grade,
                forgiveness: course.forgiveness
            });
        });
    });
    
    // Sort attempts chronologically for each course
    Object.keys(courseAttempts).forEach(courseCode => {
        courseAttempts[courseCode].sort((a, b) => {
            if (a.year !== b.year) return a.year - b.year;
            return a.semester - b.semester;
        });
    });

    data.semesters.forEach(semester => {
        // Calculate the actual calendar years based on semester and year
        // For academic years, we want to increment forward from a base year
        // For example, if student started in 2020 and is now in year 3 (2022),
        // year 1 would be 2020-2021, year 2 would be 2021-2022, year 3 would be 2022-2023
        
        // Find the base year (when the student started)
        const baseYear = currentCalendarYear - (studentCurrentYear - 1);
        
        // Calculate the start year for this semester
        const startYear = baseYear + (semester.year - 1);
        const endYear = startYear + 1;
        
        // Semester header with actual calendar years
        html += `
            <div class="semester-container">
                <div class="semester-header">
                    <div class="semester-title">
                        ${getSemesterName(semester.semester)} ${startYear}-${endYear}
                    </div>
                </div>
                
                <table class="courses-table">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Course Name</th>
                            <th>Credits</th>
                            <th>Status</th>
                            <th>Letter Grade</th>
                            <th>Grade Point</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Courses for this semester
        semester.courses.forEach(course => {
            const courseCode = course.course_code;
            const attempts = courseAttempts[courseCode];
            
            // Check if this is a retaken course or a passed course after consecutive failures
            let isEligibleForForgiveness = false;
            let forgiveReason = '';
            let isAlreadyForgiven = course.forgiveness === 1;
            
            if (attempts && attempts.length > 1) {
                // Find the index of the current attempt
                const currentAttemptIndex = attempts.findIndex(attempt => 
                    attempt.year === semester.year && 
                    attempt.semester === semester.semester &&
                    attempt.grade === course.letter_grade
                );
                
                if (currentAttemptIndex > 0) {
                    // This is a retake - check if it's eligible for forgiveness
                    if (course.status === 'passed' && !isAlreadyForgiven) {
                        isEligibleForForgiveness = true;
                        forgiveReason = 'This is a retaken course that you passed.';
                    }
                } else if (currentAttemptIndex === attempts.length - 1 && course.status === 'passed') {
                    // This is the latest attempt and it's passed
                    // Check if there were consecutive failures before
                    let consecutiveFailures = 0;
                    for (let i = 0; i < currentAttemptIndex; i++) {
                        if (attempts[i].status === 'failed') {
                            consecutiveFailures++;
                        } else {
                            consecutiveFailures = 0;
                        }
                    }
                    
                    if (consecutiveFailures > 0 && !isAlreadyForgiven) {
                        isEligibleForForgiveness = true;
                        forgiveReason = `You passed this course after ${consecutiveFailures} consecutive failure(s).`;
                    }
                }
            }
            
            // Determine which element to show: forgiveness icon, already forgiven indicator, or nothing
            let forgiveElement = '';
            
            // Check if there's a forgiveness request for this course
            const forgiveRequest = window.forgivenessStatus && window.forgivenessStatus[courseCode];
            
            if (isAlreadyForgiven) {
                // Show indicator that this course has been forgiven
                forgiveElement = `<span class="forgiven-indicator" 
                                       title="Grade forgiveness has been applied to this course">
                                    <i class="fas fa-check-circle"></i>
                                  </span>`;
            } else if (forgiveRequest) {
                // Show status based on the request status
                if (forgiveRequest.status === 'pending') {
                    forgiveElement = `<span class="forgiveness-pending" 
                                           title="Your forgiveness request for this course is pending approval">
                                        <i class="fas fa-clock"></i> Pending
                                      </span>`;
                } else if (forgiveRequest.status === 'approved') {
                    forgiveElement = `<span class="forgiveness-approved" 
                                           title="Your forgiveness request for this course has been approved">
                                        <i class="fas fa-check-circle"></i> Approved
                                      </span>`;
                }
                // If rejected, don't show anything special so they can reapply
            } else if (isEligibleForForgiveness) {
                // Show forgiveness request button
                forgiveElement = `<span class="forgiveness-icon" 
                                       onclick="showForgiveConfirmation('${courseCode}', '${course.course_name}', ${semester.year}, ${semester.semester}, ${course.coefficient})"
                                       title="${forgiveReason} Click to apply for grade forgiveness.">
                                    <i class="fas fa-heart"></i>
                                  </span>`;
            }
            
            html += `
                <tr>
                    <td>${courseCode}</td>
                    <td>${course.course_name}</td>
                    <td>${course.coefficient}</td>
                    <td class="status-${course.status}">${capitalizeFirstLetter(course.status)}</td>
                    <td>${course.letter_grade || '--'}</td>
                    <td>${course.grade_point !== null ? course.grade_point.toFixed(2) : '--'}</td>
                    <td>${forgiveElement}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
                
                <div class="term-stats-container">
                    <div class="stats-box">
                        <h4>Registered Credits</h4>
                        <div class="stats-value">${semester.registered_credits}</div>
                    </div>
                    <div class="stats-box">
                        <h4>Earned Credits</h4>
                        <div class="stats-value">${semester.earned_credits}</div>
                    </div>
                    <div class="stats-box">
                        <h4>Term GPA</h4>
                        <div class="stats-value">${semester.semester_gpa !== null ? semester.semester_gpa.toFixed(3) : '--'}</div>
                    </div>
                </div>
                
                <div class="cumulative-stats-container">
                    <div class="stats-box">
                        <h4>Cumulative Registered Credits</h4>
                        <div class="stats-value">${semester.cumulative_registered_credits}</div>
                    </div>
                    <div class="stats-box">
                        <h4>Cumulative Earned Credits</h4>
                        <div class="stats-value">${semester.cumulative_earned_credits}</div>
                    </div>
                    <div class="stats-box">
                        <h4>Cumulative GPA</h4>
                        <div class="stats-value">${semester.cumulative_gpa !== null ? semester.cumulative_gpa.toFixed(2) : '--'}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Add forgiveness confirmation modal
    html += `
        <div id="forgiveness-modal" class="forgiveness-modal">
            <div class="forgiveness-modal-content">
                <div class="forgiveness-modal-header">
                    <h3><i class="fas fa-heart"></i> Course Forgiveness Request</h3>
                </div>
                <div class="forgiveness-modal-body">
                    <p>You are requesting grade forgiveness for:</p>
                    <div class="course-details">
                        <div class="course-title" id="forgive-course-code"></div>
                        <div class="course-subtitle" id="forgive-course-name"></div>
                    </div>
                    
                    <div id="forgive-grade-info" class="forgive-grade-info">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <div id="forgive-credit-warning" class="forgive-credit-warning">
                        <!-- Will be populated dynamically if needed -->
                    </div>
                    
                    <!-- Display remaining forgiveness policies -->
                    <div id="forgiveness-uses-info" class="forgiveness-uses-info"></div>
                    
                    <div class="forgive-note">
                        <p>This request will be reviewed by the administration.</p>
                        <p><strong>Note:</strong> Only one forgiveness policy per course can be applied.</p>
                    </div>
                    
                    <input type="hidden" id="forgive-year">
                    <input type="hidden" id="forgive-semester">
                </div>
                <div class="forgiveness-modal-footer">
                    <button class="cancel-btn" onclick="hideForgiveModal()">Cancel</button>
                    <button class="confirm-btn" id="confirm-forgive-btn" onclick="submitForgiveRequest()">Submit Request</button>
                </div>
            </div>
        </div>
    `;
    
    html += '</div>'; // Close container
    document.getElementById('dynamic-content').innerHTML = html;
}

// Show forgiveness confirmation modal
function showForgiveConfirmation(courseCode, courseName, year, semester, coefficient) {
    const modal = document.getElementById('forgiveness-modal');
    document.getElementById('forgive-course-code').textContent = courseCode;
    document.getElementById('forgive-course-name').textContent = courseName;
    document.getElementById('forgive-year').value = year;
    document.getElementById('forgive-semester').value = semester;
    
    // Update remaining forgiveness info
    const usesInfoDiv = document.getElementById('forgiveness-uses-info');
    if (typeof window.remainingForgiveness !== 'undefined' && typeof window.maxForgivenessUses !== 'undefined' && window.maxForgivenessUses !== null) {
        usesInfoDiv.innerHTML = `<p><strong>Forgiveness Policies Left:</strong> ${window.remainingForgiveness} / ${window.maxForgivenessUses}</p>`;
        usesInfoDiv.style.display = 'block';
    } else {
        usesInfoDiv.style.display = 'none';
    }
    
    // Show loading state in the modal
    const forgiveGradeInfo = document.getElementById('forgive-grade-info');
    forgiveGradeInfo.innerHTML = `
        <div class="loading-grades">
            <i class="fas fa-spinner fa-spin"></i> Calculating impact on your CGPA...
        </div>
    `;
    
    // Show the modal immediately while we fetch data
    modal.classList.add('active');
    
    // Fetch the forgiveness impact from the backend
    fetch('/student/enrollment-history/forgiveness-impact', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            course_code: courseCode,
            year: parseInt(year),
            semester: parseInt(semester)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the modal with accurate CGPA information
            const currentCGPA = data.current_cgpa;
            const newCGPA = data.new_cgpa;
            const lowestGrade = data.lowest_grade;
            const currentGrade = data.current_grade;
            
            // Update the grade info display
            forgiveGradeInfo.innerHTML = `
                <div class="grade-comparison">
                    <div class="old-grade">
                        <span class="grade-label">Forgiven Grade</span>
                        <span class="grade-letter">${lowestGrade.letter}</span>
                    </div>
                    <div class="grade-arrow">
                        <i class="fas fa-long-arrow-alt-right"></i>
                    </div>
                    <div class="new-grade">
                        <span class="grade-label">New Grade</span>
                        <span class="grade-letter">${currentGrade.letter}</span>
                    </div>
                </div>
                
                <div class="cgpa-comparison">
                    <div class="cgpa-old">
                        <span class="cgpa-label">Current CGPA</span>
                        <span class="cgpa-value">${currentCGPA.toFixed(2)}</span>
                    </div>
                    <div class="cgpa-arrow">
                        <i class="fas fa-long-arrow-alt-right"></i>
                    </div>
                    <div class="cgpa-new">
                        <span class="cgpa-label">New CGPA</span>
                        <span class="cgpa-value">${newCGPA.toFixed(2)}</span>
                    </div>
                </div>
            `;
        } else {
            // Show error message
            forgiveGradeInfo.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Unable to calculate CGPA impact: ${data.message}</p>
                </div>
                
                <div class="cgpa-comparison">
                    <div class="cgpa-old">
                        <span class="cgpa-label">Current CGPA</span>
                        <span class="cgpa-value">--</span>
                    </div>
                    <div class="cgpa-arrow">
                        <i class="fas fa-long-arrow-alt-right"></i>
                    </div>
                    <div class="cgpa-new">
                        <span class="cgpa-label">Estimated New CGPA</span>
                        <span class="cgpa-value">--</span>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error fetching forgiveness impact:', error);
        forgiveGradeInfo.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error calculating CGPA impact. Please try again.</p>
            </div>
        `;
    });
    
    // Show credit warning if applicable
    const creditWarning = document.getElementById('forgive-credit-warning');
    if (coefficient < 3) {
        creditWarning.innerHTML = `
            <div class="forgive-warning">
                <i class="fas fa-exclamation-triangle"></i>
                For maximum utility, it is recommended to only apply forgiveness on courses with credit 3.
            </div>
        `;
        creditWarning.style.display = 'block';
    } else {
        creditWarning.style.display = 'none';
    }
}



// Hide forgiveness modal
function hideForgiveModal() {
    const modal = document.getElementById('forgiveness-modal');
    modal.classList.remove('active');
}

// Submit forgiveness request
function submitForgiveRequest() {
    const courseCode = document.getElementById('forgive-course-code').textContent;
    const year = document.getElementById('forgive-year').value;
    const semester = document.getElementById('forgive-semester').value;
    
    const confirmBtn = document.getElementById('confirm-forgive-btn');
    const originalText = confirmBtn.textContent;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    confirmBtn.disabled = true;
    
    fetch('/student/enrollment-history/forgiveness', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            course_code: courseCode,
            year: parseInt(year),
            semester: parseInt(semester)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage('Forgiveness request submitted successfully');
            hideForgiveModal();
            
            // Store the new request status in the global variable
            if (!window.forgivenessStatus) {
                window.forgivenessStatus = {};
            }
            window.forgivenessStatus[courseCode] = {
                status: data.status || 'pending',
                request_id: data.request_id,
                request_date: new Date().toISOString()
            };
            
            // Refresh enrollment history
            loadEnrollmentHistory();
        } else {
            // Check if this is a "already has request" error, which is not really an error
            if (data.status && (data.status === 'pending' || data.status === 'approved')) {
                showSuccessMessage(`This course already has a ${data.status} forgiveness request`);
                hideForgiveModal();
                
                // Refresh to show the current status
                loadEnrollmentHistory();
            } else {
                showErrorMessage(`Error: ${data.message}`);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            }
        }
    })
    .catch(error => {
        console.error('Error submitting forgiveness request:', error);
        showErrorMessage('Error: An error occurred while submitting your request');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalText;
    });
}
</script> 
        
    <!-- Schedule Section Script -->
    <script>
        // Preferences Modal HTML content
        const preferencesModalHTML = `
            <div id="preferences-modal" class="preferences-modal">
                <div class="preferences-modal-content">
                    <div class="preferences-modal-header">
                        <h3><i class="fas fa-cog"></i> Schedule Preferences</h3>
                        <span class="preferences-modal-close" onclick="hidePreferencesModal()">&times;</span>
                    </div>
                    <div class="preferences-modal-body">
                        <div class="preferences-tabs">
                            <button class="tab-button active" data-tab="professors-tab">Professors</button>
                            <button class="tab-button" data-tab="timeslots-tab">Time Slots</button>
                        </div>
                        
                        <div id="professors-tab" class="tab-content active">
                            <div class="professors-section">
                                <p class="section-info">Drag professors to rank your preferences. Higher ranked professors will be prioritized when generating your schedule.</p>
                                <div id="professors-container" class="professors-container">
                                    <div class="loading-professors">
                                        <i class="fas fa-spinner fa-spin"></i> Loading professors...
                            </div>
                        </div>
                                <div class="tab-save-button">
                                    <button id="save-professors-preferences" class="btn-primary">
                                        <i class="fas fa-save"></i> Save Professor Preferences
                                    </button>
                    </div>
                        </div>
                    </div>
                    
                        <div id="timeslots-tab" class="tab-content">
                            <div class="timeslots-section">
                                <p class="section-info">Select your preferred time slots. Selected slots will be prioritized when generating your schedule.</p>
                                <div class="timeslot-selection-info">
                                    <div class="timeslot-legend">
                                        <span class="timeslot-indicator preferred"></span> Preferred
                                        <span class="timeslot-indicator neutral"></span> Neutral
                            </div>
                                    <div class="selection-actions">
                                        <button id="select-all-slots" class="btn-secondary btn-small">Select All</button>
                                        <button id="clear-all-slots" class="btn-secondary btn-small">Clear All</button>
                        </div>
                                </div>
                                <div class="timeslot-grid-container">
                                    <table class="timeslot-grid">
                                        <thead>
                                            <tr>
                                                <th class="time-label"></th>
                                                                                <th class="day-column-header" data-day="Monday" onclick="toggleColumnPreference('Monday')">Monday</th>
                                <th class="day-column-header" data-day="Tuesday" onclick="toggleColumnPreference('Tuesday')">Tuesday</th>
                                <th class="day-column-header" data-day="Wednesday" onclick="toggleColumnPreference('Wednesday')">Wednesday</th>
                                <th class="day-column-header" data-day="Thursday" onclick="toggleColumnPreference('Thursday')">Thursday</th>
                                <th class="day-column-header" data-day="Friday" onclick="toggleColumnPreference('Friday')">Friday</th>
                                <th class="day-column-header" data-day="Saturday" onclick="toggleColumnPreference('Saturday')">Saturday</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="time-row-header" data-time="8:30-10:00" onclick="toggleRowPreference('8:30-10:00')">8:30-10:00</td>
                                                <td class="timeslot" data-day="Monday" data-time="8:30-10:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Tuesday" data-time="8:30-10:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Wednesday" data-time="8:30-10:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Thursday" data-time="8:30-10:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Friday" data-time="8:30-10:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Saturday" data-time="8:30-10:00" onclick="this.classList.toggle('preferred')"></td>
                                            </tr>
                                            <tr>
                                                <td class="time-row-header" data-time="10:00-11:30" onclick="toggleRowPreference('10:00-11:30')">10:00-11:30</td>
                                                <td class="timeslot" data-day="Monday" data-time="10:00-11:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Tuesday" data-time="10:00-11:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Wednesday" data-time="10:00-11:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Thursday" data-time="10:00-11:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Friday" data-time="10:00-11:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Saturday" data-time="10:00-11:30" onclick="this.classList.toggle('preferred')"></td>
                                            </tr>
                                            <tr>
                                                <td class="time-row-header" data-time="11:30-13:00" onclick="toggleRowPreference('11:30-13:00')">11:30-13:00</td>
                                                <td class="timeslot" data-day="Monday" data-time="11:30-13:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Tuesday" data-time="11:30-13:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Wednesday" data-time="11:30-13:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Thursday" data-time="11:30-13:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Friday" data-time="11:30-13:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Saturday" data-time="11:30-13:00" onclick="this.classList.toggle('preferred')"></td>
                                            </tr>
                                            <tr>
                                                <td class="time-row-header" data-time="13:30-15:00" onclick="toggleRowPreference('13:30-15:00')">13:30-15:00</td>
                                                <td class="timeslot" data-day="Monday" data-time="13:30-15:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Tuesday" data-time="13:30-15:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Wednesday" data-time="13:30-15:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Thursday" data-time="13:30-15:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Friday" data-time="13:30-15:00" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Saturday" data-time="13:30-15:00" onclick="this.classList.toggle('preferred')"></td>
                                            </tr>
                                            <tr>
                                                <td class="time-row-header" data-time="15:00-16:30" onclick="toggleRowPreference('15:00-16:30')">15:00-16:30</td>
                                                <td class="timeslot" data-day="Monday" data-time="15:00-16:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Tuesday" data-time="15:00-16:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Wednesday" data-time="15:00-16:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Thursday" data-time="15:00-16:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Friday" data-time="15:00-16:30" onclick="this.classList.toggle('preferred')"></td>
                                                <td class="timeslot" data-day="Saturday" data-time="15:00-16:30" onclick="this.classList.toggle('preferred')"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="tab-save-button">
                                    <button id="save-timeslots-preferences" class="btn-primary">
                                        <i class="fas fa-save"></i> Save Time Slots Preferences
                        </button>
                            </div>
                        </div>
                    </div>
                    </div>
                    </div>
                </div>
            `;
            
        // Function to check if all preferences are set and update button state
        function checkAllPreferences() {
            console.log('Checking all preferences...');
            const generateButton = document.getElementById('find-all-solutions-btn');
            if (!generateButton) {
                console.log('Generate button not found in DOM');
                return;
            }
            
            // Default to disabled
            generateButton.disabled = true;
            generateButton.classList.remove('active');
            generateButton.title = "Checking preferences...";
            
            // Make API call to check preferences
            fetch('/student/schedule/check-preferences')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Preferences check result:', data);
                    
                    if (data.success) {
                        if (data.has_all_preferences) {
                            // All preferences are set, enable the button
                            console.log('All preferences are set, enabling button');
                            generateButton.disabled = false;
                            generateButton.classList.add('active');
                            generateButton.title = "Generate optimized schedules";
                        } else {
                            // Missing some preferences
                            console.log('Missing some preferences, button remains disabled');
                            
                            // Create detailed tooltip message
                            let missingPreferences = [];
                            if (!data.preferences.priority) missingPreferences.push("Priority");
                            if (!data.preferences.professors) missingPreferences.push("Professor preferences");
                            if (!data.preferences.timeslots) missingPreferences.push("Time slot preferences");
                            
                            generateButton.title = `Missing preferences: ${missingPreferences.join(", ")}`;
                        }
                    } else {
                        console.error('Error checking preferences:', data.message);
                        generateButton.title = "Error checking preferences";
                    }
                })
                .catch(error => {
                    console.error('Error checking preferences:', error);
                    generateButton.title = "Error checking preferences";
                });
        }
            
        function saveProfessorPreferences() {
            console.log('saveProfessorPreferences function called');
            
            // Collect professor preferences
            const professorPreferences = {};
            
            document.querySelectorAll('.professors-ranking-list').forEach(list => {
                const courseCode = list.dataset.course;
                const sessionType = list.dataset.sessionType;
                const isDisabled = list.classList.contains('disabled');
                
                if (!professorPreferences[courseCode]) {
                    professorPreferences[courseCode] = {};
                }
                
                // If the list is disabled (no preference)
                if (isDisabled) {
                    // Get all professors for this list and set their rank to 0
                    professorPreferences[courseCode][sessionType] = Array.from(list.querySelectorAll('.professor-item')).map(item => ({
                        professor: item.dataset.professor,
                        rank: 0 // Use rank 0 for "no preference"
                    }));
                } else {
                    // Normal case - professors ranked by position
                    professorPreferences[courseCode][sessionType] = Array.from(list.querySelectorAll('.professor-item')).map(item => ({
                        professor: item.dataset.professor,
                        rank: parseInt(item.dataset.rank)
                    }));
                }
            });
            
            console.log('Professor preferences to save:', professorPreferences);
            
            // Save to server
            fetch('/student/schedule/professors/preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    preferences: professorPreferences
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Also save to localStorage for backup/client-side use
                    let localPreferences = JSON.parse(localStorage.getItem('schedule_preferences') || '{"professors":{}, "timeslots":[]}');
                    localPreferences.professors = professorPreferences;
                    localStorage.setItem('schedule_preferences', JSON.stringify(localPreferences));
                    
                    // Show prominent success message
                    const notificationHTML = `
                        <div class="schedule-notification success">
                            <span class="notification-message"><i class="fas fa-check-circle"></i> Professor preferences saved successfully!</span>
                            <span class="notification-close">&times;</span>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', notificationHTML);
                    
                    // Add close event
                    document.querySelector('.notification-close').addEventListener('click', function() {
                        this.parentElement.remove();
                    });
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        const notification = document.querySelector('.schedule-notification');
                        if (notification) notification.remove();
                    }, 5000);
                    
                    // Check if all preferences are set after saving professor preferences
                    checkAllPreferences();
                } else {
                    throw new Error(data.message || 'Failed to save professor preferences');
                }
            })
            .catch(error => {
                console.error('Error saving professor preferences:', error);
                // Create error notification
                const notificationHTML = `
                    <div class="schedule-notification error">
                        <span class="notification-message">Failed to save preferences: ${error.message}</span>
                        <span class="notification-close">&times;</span>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', notificationHTML);
                
                // Add close event
                document.querySelector('.notification-close').addEventListener('click', function() {
                    this.parentElement.remove();
                });
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    const notification = document.querySelector('.schedule-notification');
                    if (notification) notification.remove();
                }, 3000);
            });
        }
        
        function saveTimeslotPreferences() {
            console.log('saveTimeslotPreferences function called');
            
            // Collect timeslot preferences and map them to slot numbers (1-30)
            const preferredSlots = [];
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const times = ['8:30-10:00', '10:00-11:30', '11:30-13:00', '13:30-15:00', '15:00-16:30'];
            
            document.querySelectorAll('.timeslot.preferred').forEach(slot => {
                const day = slot.dataset.day;
                const time = slot.dataset.time;
                
                // Calculate slot number (1-30)
                const dayIndex = days.indexOf(day);
                const timeIndex = times.indexOf(time);
                
                if (dayIndex !== -1 && timeIndex !== -1) {
                    // Slot number = (dayIndex * 5) + timeIndex + 1
                    // This maps Monday 8:30-10:00 to 1, Monday 10:00-11:30 to 2, etc.
                    const slotNumber = (dayIndex * 5) + timeIndex + 1;
                    preferredSlots.push(slotNumber);
                }
            });
            
            console.log('Preferred slots to save:', preferredSlots);
            
            // Save to server
            fetch('/student/schedule/time_slots', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                body: JSON.stringify({
                    preferences: preferredSlots
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
                .then(data => {
                console.log('Response data:', data);
                    if (data.success) {
                    // Create notification directly
                    const notificationHTML = `
                        <div class="schedule-notification success">
                            <span class="notification-message">Time slot preferences saved successfully!</span>
                            <span class="notification-close">&times;</span>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', notificationHTML);
                    
                    // Add close event
                    document.querySelector('.notification-close').addEventListener('click', function() {
                        this.parentElement.remove();
                    });
                    
                    // Auto-remove after 3 seconds
                        setTimeout(() => {
                        const notification = document.querySelector('.schedule-notification');
                        if (notification) notification.remove();
                    }, 3000);
                    
                    // Check if all preferences are set after saving time slot preferences
                    checkAllPreferences();
                    } else {
                    throw new Error(data.message || 'Failed to save preferences');
                    }
                })
                .catch(error => {
                console.error('Error saving time slot preferences:', error);
                // Create error notification directly
                const notificationHTML = `
                    <div class="schedule-notification error">
                        <span class="notification-message">Failed to save preferences: ${error.message}</span>
                        <span class="notification-close">&times;</span>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', notificationHTML);
                
                // Add close event
                document.querySelector('.notification-close').addEventListener('click', function() {
                    this.parentElement.remove();
                });
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    const notification = document.querySelector('.schedule-notification');
                    if (notification) notification.remove();
                }, 3000);
            });
        }
        
        // Legacy function for backward compatibility
        function savePreferences() {
            saveProfessorPreferences();
            saveTimeslotPreferences();
            showNotification('All preferences saved successfully!', 'success');
        }
        
        function loadSchedule() {
            document.getElementById('content-title').textContent = 'Schedule';
            
            // Show loading state
            document.getElementById('dynamic-content').innerHTML = `
                <div class="content-card loading-message">
                    <h3><i class="fas fa-spinner fa-spin"></i> Loading Schedule</h3>
                    <p>Please wait while we retrieve your schedule</p>
                </div>
            `;

            fetch('/student/schedule')
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            // Handle specific error codes
                            if (errData.code === 'NO_COURSES') {
                                document.getElementById('dynamic-content').innerHTML = `
                                    <div class="content-card info-message">
                                        <div class="fun-message">
                                            <h3>No courses to schedule!</h3>
                                            <p>${errData.message}</p>
                                            <a href="#course-registration" class="btn-primary" onclick="loadCourseRegistration()">
                                                <i class="fas fa-plus-circle"></i> Enroll in Courses
                                            </a>
                                        </div>
                                    </div>
                                `;
                                throw new Error('HANDLED');
                            }
                            // Handle NO_SEMESTER error code
                            if (errData.code === 'NO_SEMESTER') {
                                document.getElementById('dynamic-content').innerHTML = `
                                    <div class="content-card info-message">
                                        <div class="fun-message">
                                            <h3>Awaiting new semester to begin</h3>
                                            <p>Schedule will be available once the new semester starts.</p>
                                        </div>
                                    </div>
                                `;
                                throw new Error('HANDLED');
                            }
                            throw new Error(errData.message || `Server error: ${response.status}`);
                        }).catch(e => {
                            if (e.message === 'HANDLED') return Promise.reject({handled: true});
                            throw e;
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to retrieve schedule information');
                    }
                    console.log("Schedule data received:", data);
                    renderSchedule(data);
                })
                .catch(error => {
                    if (error.handled) return; // Already handled specific error
                    
                    console.error('Failed to load schedule:', error);
                    
                    // Check if this is a 403 error (might be board decision restriction)
                    if (error.message && error.message.includes('403')) {
                        // Try to fetch the actual error message
                        fetch('/student/course-registration')
                .then(response => response.json())
                .then(data => {
                                if (data.code === 'AWAITING_BOARD_DECISION') {
                                    showError(data.message, data.code);
                    } else {
                                    showError('Access restricted. Please contact administration.', 'ACCESS_RESTRICTED');
                                }
                            })
                            .catch(() => {
                                // If that fails too, show a generic board decision message
                                showError('Awaiting Scientific Board decision whether to grant an extension semester or not', 'AWAITING_BOARD_DECISION');
                            });
                        return;
                    }
                    
                    document.getElementById('dynamic-content').innerHTML = `
                        <div class="content-card error-message">
                            <h3>Error Loading Schedule</h3>
                            <p>${error.message || 'Unknown error occurred'}</p>
                            <button onclick="loadSchedule()" class="btn-primary retry-button">
                                <i class="fas fa-sync-alt"></i> Try Again
                            </button>
                        </div>
                    `;
                });
        }

        // Show the preferences modal
        function showPreferencesModal() {
            // First check if registration is open
            fetch('/student/course-registration')
                .then(response => response.json())
                .then(regData => {
                    const isRegistrationOpen = regData.data && regData.data.registration_status === 'open';
                    
                    if (!isRegistrationOpen) {
                        showNotification('Course registration is currently closed. Preferences cannot be modified.', 'error');
                        return;
                    }
                    
                    // Continue with showing the modal if registration is open
                    showPreferencesModalContent();
                })
                .catch(error => {
                    console.error('Error checking registration status:', error);
                    // Default to showing the modal, but it may not save changes
                    showPreferencesModalContent();
                });
        }
        
        function showPreferencesModalContent() {
            // Check if modal already exists in DOM
            let modal = document.getElementById('preferences-modal');
            
            // If not, create it from template
            if (!modal) {
                const container = document.createElement('div');
                container.innerHTML = preferencesModalHTML;
                document.body.appendChild(container.firstElementChild);
                
                modal = document.getElementById('preferences-modal');
                
                // Add event listeners for tabs
                const tabs = document.querySelectorAll('.tab-button');
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        // Remove active class from all tabs
                        tabs.forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        // Hide all tab contents
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        // Show the corresponding tab content
                        const tabId = this.getAttribute('data-tab');
                        document.getElementById(tabId).classList.add('active');
                        
                        // If switching to time slots tab, ensure preferences are loaded
                        if (tabId === 'timeslots-tab' && !document.querySelector('.timeslot.loaded-preferences')) {
                            loadTimeSlotPreferences();
                        }
                    });
                });
                
                // Add event listeners for time slot selection buttons
                document.getElementById('select-all-slots').addEventListener('click', function() {
                    document.querySelectorAll('.timeslot').forEach(slot => {
                        slot.classList.add('preferred');
                    });
                });
                
                document.getElementById('clear-all-slots').addEventListener('click', function() {
                    document.querySelectorAll('.timeslot').forEach(slot => {
                        slot.classList.remove('preferred');
                    });
                });
                
                // Add event listener for save time slots preferences button
                document.getElementById('save-timeslots-preferences').addEventListener('click', function() {
                    console.log('Save Time Slots button clicked');
                    saveTimeslotPreferences();
                });
                
                // Add event listener for save professor preferences button
                document.getElementById('save-professors-preferences').addEventListener('click', function() {
                    console.log('Save Professor Preferences button clicked');
                    saveProfessorPreferences();
                });
            }
            
            // Show the modal
            modal.style.display = 'block';
            
            // Load professors data when showing the modal
            loadProfessorsData();
            
            // Load time slot preferences
            loadTimeSlotPreferences();
        }
        
        function loadTimeSlotPreferences() {
            // Fetch existing time slot preferences from server
            fetch('/student/schedule/time_slots')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to retrieve time slot preferences');
                    }
                    
                    // Clear all current preferences first
                    document.querySelectorAll('.timeslot').forEach(slot => {
                        slot.classList.remove('preferred');
                    });
                    
                    // Apply saved preferences
                    if (data.preferences && Object.keys(data.preferences).length > 0) {
                        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        const times = ['8:30-10:00', '10:00-11:30', '11:30-13:00', '13:30-15:00', '15:00-16:30'];
                        
                        // For each preference in the response
                        Object.keys(data.preferences).forEach(slotNumber => {
                            const isPreferred = data.preferences[slotNumber];
                            
                            if (isPreferred) {
                                // Convert slot number back to day and time
                                const slotNum = parseInt(slotNumber);
                                const dayIndex = Math.floor((slotNum - 1) / 5);
                                const timeIndex = (slotNum - 1) % 5;
                                
                                if (dayIndex >= 0 && dayIndex < days.length && timeIndex >= 0 && timeIndex < times.length) {
                                    const day = days[dayIndex];
                                    const time = times[timeIndex];
                                    
                                    // Find and mark the corresponding slot as preferred
                                    const slot = document.querySelector(`.timeslot[data-day="${day}"][data-time="${time}"]`);
                                    if (slot) {
                                        slot.classList.add('preferred');
                                        slot.classList.add('loaded-preferences'); // Mark as loaded from server
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading time slot preferences:', error);
                    // Don't show an error notification, just silently fail
                    // as this is not critical for the user experience
                });
        }
        
        function hidePreferencesModal() {
            document.getElementById('preferences-modal').style.display = 'none';
        }
        
        function loadProfessorsData() {
            const professorsContainer = document.getElementById('professors-container');
            
            // Get the enrolled courses
            fetch('/student/schedule')
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            // Handle 404 specifically which might be NO_SEMESTER
                            return response.json().then(errData => {
                                if (errData.code === 'NO_SEMESTER') {
                                    throw new Error('Awaiting new semester to begin');
                                }
                                throw new Error(errData.message || 'Server returned 404');
                            });
                        }
                        throw new Error(`Server returned ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success || !data.enrolled_courses || data.enrolled_courses.length === 0) {
                        professorsContainer.innerHTML = '<p class="no-courses-message">No enrolled courses found. Please enroll in courses first.</p>';
                        return;
                    }
                    
                    const courseCodes = data.enrolled_courses.map(course => course.course_code);
                    
                    // Fetch professors for these courses
                    return fetch('/student/schedule/professors', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ course_codes: courseCodes })
                    });
                })
                .then(response => {
                    if (!response || !response.json) {
                        return null; // Handle case where previous promise didn't return a response
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Skip if we have no data
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to retrieve professors data');
                    }
                    
                    if (Object.keys(data.professors_data).length === 0) {
                        throw new Error('Awaiting administration to update the schedules');
                    }
                    
                    renderProfessorsRanking(data.professors_data);
                })
                .catch(error => {
                    console.error('Error loading professors data:', error);
                    
                    // Customize the error message for specific cases
                    let errorMessage = error.message;
                    let iconClass = 'fa-exclamation-circle';
                    
                    if (errorMessage.includes('Awaiting')) {
                        iconClass = 'fa-clock';
                    }
                    
                    professorsContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas ${iconClass}"></i>
                            <p>${errorMessage}</p>
                        </div>
                    `;
                });
        }
        
        function renderProfessorsRanking(professorsData) {
            const professorsContainer = document.getElementById('professors-container');
            professorsContainer.innerHTML = '';
            
            if (!professorsData || Object.keys(professorsData).length === 0) {
                professorsContainer.innerHTML = '<p class="no-data-message">No professors data available for your enrolled courses.</p>';
                return;
            }
            
            // Group professors by course and session type
            Object.keys(professorsData).forEach(courseCode => {
                const courseData = professorsData[courseCode];
                const courseName = courseData.course_name;
                
                // Create course section
                const courseSection = document.createElement('div');
                courseSection.className = 'course-professors-section';
                courseSection.innerHTML = `
                    <h4>${courseCode} - ${courseName}</h4>
                `;
                
                // Process lecture professors if any
                if (courseData.lecture_professors && courseData.lecture_professors.length > 0) {
                    const lectureSection = createProfessorRankingSection(
                        courseCode, 
                        'lecture', 
                        courseData.lecture_professors
                    );
                    courseSection.appendChild(lectureSection);
                }
                
                // Process tutorial professors if any
                if (courseData.tutorial_professors && courseData.tutorial_professors.length > 0) {
                    const tutorialSection = createProfessorRankingSection(
                        courseCode, 
                        'tutorial', 
                        courseData.tutorial_professors
                    );
                    courseSection.appendChild(tutorialSection);
                }
                
                professorsContainer.appendChild(courseSection);
            });
            
            // Initialize drag and drop for professor ranking
            initializeDragAndDrop();
        }
        
        function createProfessorRankingSection(courseCode, sessionType, professors) {
            const sectionContainer = document.createElement('div');
            sectionContainer.className = 'session-professors-container';
            
            const sessionTypeDisplay = sessionType.charAt(0).toUpperCase() + sessionType.slice(1);
            const sectionId = `${courseCode}-${sessionType}`;
            
            sectionContainer.innerHTML = `
                <h5>
                    <span>${sessionTypeDisplay} Professors</span>
                    <label class="preference-toggle">
                        <input type="checkbox" id="no-pref-${sectionId}" onchange="togglePreferences('${sectionId}')"> 
                        No preferences
                    </label>
                </h5>
                <div id="ranking-${sectionId}" class="professors-ranking-list" data-course="${courseCode}" data-session-type="${sessionType}">
                    ${professors.map((professor, index) => `
                        <div class="professor-item" draggable="true" data-professor="${professor}" data-rank="${index + 1}">
                            <div class="rank-indicator">${index + 1}</div>
                            <div class="professor-name">${professor}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            return sectionContainer;
        }
        
        function togglePreferences(sectionId) {
            const checkbox = document.getElementById(`no-pref-${sectionId}`);
            const rankingList = document.getElementById(`ranking-${sectionId}`);
            
            if (checkbox.checked) {
                rankingList.classList.add('disabled');
            } else {
                rankingList.classList.remove('disabled');
            }
        }
        
        function initializeDragAndDrop() {
            const professorItems = document.querySelectorAll('.professor-item');
            let draggedItem = null;
            
            professorItems.forEach(item => {
                // Drag start event
                item.addEventListener('dragstart', function(e) {
                    // Check if the parent list is disabled
                    const container = this.closest('.professors-ranking-list');
                    if (container.classList.contains('disabled')) {
                        e.preventDefault();
                        return false;
                    }
                    
                    draggedItem = this;
                    setTimeout(() => this.classList.add('dragging'), 0);
                });
                
                // Drag end event
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    draggedItem = null;
                    
                    // Update ranks after drag
                    const container = this.closest('.professors-ranking-list');
                    updateRanks(container);
                });
                
                // Drag over event
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (!draggedItem || draggedItem === this) return;
                    
                    const container = this.closest('.professors-ranking-list');
                    // Don't allow drag over if container is disabled
                    if (container.classList.contains('disabled')) return;
                    
                    const items = Array.from(container.querySelectorAll('.professor-item'));
                    
                    // Get the position of this item
                    const thisRect = this.getBoundingClientRect();
                    const thisMiddle = thisRect.y + thisRect.height / 2;
                    
                    // Check if mouse is above or below the middle of this item
                    if (e.clientY < thisMiddle) {
                        container.insertBefore(draggedItem, this);
                    } else {
                        container.insertBefore(draggedItem, this.nextSibling);
                    }
                });
            });
        }
        
        function updateRanks(container) {
            const items = Array.from(container.querySelectorAll('.professor-item'));
            
            items.forEach((item, index) => {
                const rank = index + 1;
                item.dataset.rank = rank;
                item.querySelector('.rank-indicator').textContent = rank;
            });
        }
        
        function showNotification(message, type = 'info') {
            // Create notification if it doesn't exist
            if (!document.querySelector('.schedule-notification')) {
                const notificationHTML = `
                    <div class="schedule-notification ${type}">
                        <span class="notification-message">${message}</span>
                        <span class="notification-close">&times;</span>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', notificationHTML);
                
                // Add close event
                document.querySelector('.notification-close').addEventListener('click', function() {
                    this.parentElement.remove();
                });
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    const notification = document.querySelector('.schedule-notification');
                    if (notification) notification.remove();
                }, 3000);
            }
        }
        
        function toggleColumnPreference(day) {
            // Get all cells in the specified column
            const cells = document.querySelectorAll(`.timeslot[data-day="${day}"]`);
            
            // Check if all cells already have the 'preferred' class
            const allPreferred = Array.from(cells).every(cell => cell.classList.contains('preferred'));
            
            // Toggle the class based on current state
            cells.forEach(cell => {
                if (allPreferred) {
                    cell.classList.remove('preferred');
                } else {
                    cell.classList.add('preferred');
                }
            });
        }
        
        function toggleRowPreference(time) {
            // Get all cells in the specified row
            const cells = document.querySelectorAll(`.timeslot[data-time="${time}"]`);
            
            // Check if all cells already have the 'preferred' class
            const allPreferred = Array.from(cells).every(cell => cell.classList.contains('preferred'));
            
            // Toggle the class based on current state
            cells.forEach(cell => {
                if (allPreferred) {
                    cell.classList.remove('preferred');
                } else {
                    cell.classList.add('preferred');
                }
            });
        }
        
        // ---------------- SCHEDULE RENDERING HELPERS ----------------
        // Convert "HH:MM" to minutes since midnight
        function timeStrToMinutes(timeStr) {
            const [h, m] = timeStr.trim().split(':');
            return parseInt(h, 10) * 60 + parseInt(m, 10);
        }
        
        // Five fixed 90-minute time slots used by the university schedule
        const TIME_SLOTS = [
            { label: '8:30-10:00',  start: '08:30', end: '10:00' },
            { label: '10:00-11:30', start: '10:00', end: '11:30' },
            { label: '11:30-13:00', start: '11:30', end: '13:00' },
            { label: '13:30-15:00', start: '13:30', end: '15:00' },
            { label: '15:00-16:30', start: '15:00', end: '16:30' }
        ];
        
        // Returns HTML for a single day column, inserting a placeholder card
        // for every slot that does not contain a session.
        function generateDayColumnHTML(day, sessions, courseDetails) {
            // Map sessions by their starting minute for quick access
            const sessionLookup = {};
            sessions.forEach(s => {
                sessionLookup[timeStrToMinutes(s.start_time)] = s;
            });
            
            let html = `<div class="day-schedule">`;
            html += `<div class="day-header">${day}</div>`;
            html += `<div class="day-sessions">`;
            
            TIME_SLOTS.forEach(slot => {
                const startMin = timeStrToMinutes(slot.start);
                const sess = sessionLookup[startMin];
                if (sess) {
                    const sessionTypeClass = sess.session_type === 'lecture' ? 'lecture' : 'tutorial';
                    const courseInfo = courseDetails[sess.course_code] || {};
                    const courseName = sess.course_name || courseInfo.course_name || 'Unknown Course';
                    html += `
                        <div class="session-card ${sessionTypeClass}">
                            <div class="session-time">${sess.start_time} - ${sess.end_time}</div>
                            <div class="session-details">
                                <div class="session-course">${sess.course_code}</div>
                                <div class="session-name">${courseName}</div>
                                <div class="session-info"><span>${sess.session_type === 'tutorial' ? 'Tutorial' : 'Lecture ' + sess.session_number}</span></div>
                                <div class="session-professor">Prof: ${sess.professor || 'TBD'}</div>
                                <div class="session-location">Room: ${sess.classroom || 'TBD'}</div>
                                ${sess.group ? `<div class="session-group">Group: ${sess.group}</div>` : ''}
                            </div>
                        </div>`;
                } else {
                    // Placeholder
                    html += `
                        <div class="session-card placeholder-slot">
                            <div class="session-time"></div>
                            <div class="session-details">
                            </div>
                        </div>`;
                }
            });
            
            html += `</div></div>`;
            return html;
        }

        
        function displayGeneratedSchedule(result) {
            const schedule = result.schedule;
            const courseDetails = result.course_details || {};
            const semesterName = getSemesterName(result.semester);
            const academicYear = `${result.year}-${result.year + 1}`;
            
            // Create days of the week array
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Group sessions by day
            const sessionsByDay = {};
            days.forEach(day => {
                sessionsByDay[day] = [];
            });
            
            // Organize sessions by day
            if (schedule && schedule.length > 0) {
                schedule.forEach(session => {
                    if (sessionsByDay[session.day]) {
                        sessionsByDay[session.day].push(session);
                    }
                });
                
                // Sort sessions within each day by start time
                Object.keys(sessionsByDay).forEach(day => {
                    sessionsByDay[day].sort((a, b) => {
                        return a.start_time.localeCompare(b.start_time);
                    });
                });
            }
            
            // Calculate stats
            const totalSessions = schedule ? schedule.length : 0;
            const lectureCount = schedule ? schedule.filter(s => s.session_type === 'lecture').length : 0;
            const tutorialCount = schedule ? schedule.filter(s => s.session_type === 'tutorial').length : 0;
            
            // Calculate objective values
            const profPrefValue = result.objective_components ? result.objective_components.professor_preference_value : 0;
            const timePrefValue = result.objective_components ? result.objective_components.timeslot_preference_value : 0;
            const totalObjective = result.total_objective_value || 0;
            
            // Build HTML
            let html = `
                <div class="content-card schedule-container">
                    <div class="schedule-header">
                        <h3>Optimized Schedule for ${semesterName}</h3>
                        <div class="schedule-stats">
                            <div class="stat-item">Sessions: ${totalSessions}</div>
                            <div class="stat-item">Lectures: ${lectureCount}</div>
                            <div class="stat-item">Tutorials: ${tutorialCount}</div>
                        </div>
                    </div>
                    
                    <div class="schedule-actions-top">
                        <button class="btn-primary" onclick="showPreferencesModal()">
                            <i class="fas fa-cog"></i> Select Preferences
                        </button>
                        <button class="btn-primary" onclick="findAllOptimalSchedules()">
                            <i class="fas fa-list"></i> Generate My Schedules
                        </button>
                        <button class="btn-print" onclick="window.print()">
                            <i class="fas fa-download"></i> Download Schedule
                        </button>
                    </div>
                    
                    <div class="schedule-legend">
                        <div class="legend-item lecture">
                            <div class="legend-color"></div>
                            <span>Lecture</span>
                        </div>
                        <div class="legend-item tutorial">
                            <div class="legend-color"></div>
                            <span>Tutorial</span>
                        </div>
                    </div>
                    
                    <div class="course-summary-section">
                        <h4>Course Summary</h4>
                        <div class="course-summary-grid">
            `;
            
            // Add course summary cards
            const processedCourses = new Set();
            if (schedule && schedule.length > 0) {
                schedule.forEach(session => {
                    const courseCode = session.course_code;
                    if (!processedCourses.has(courseCode)) {
                        const courseDetail = courseDetails[courseCode] || {};
                        html += `
                            <div class="course-summary-card">
                                <div class="course-code">${courseCode}</div>
                                <div class="course-name">${courseDetail.course_name || 'Unknown Course'}</div>
                                <div class="course-credits">${courseDetail.coefficient || 0} credits</div>
                            </div>
                        `;
                        processedCourses.add(courseCode);
                    }
                });
            }
            
            html += `
                        </div>
                    </div>
                    
                    <div class="weekly-schedule">
            `;
            
            // Add day columns
            days.forEach(day => {
                const sessions = sessionsByDay[day] || [];
                
                html += generateDayColumnHTML(day, sessions, courseDetails);
            });
            
            html += `
                    </div>
                    
                    <div class="schedule-actions">
                        <button class="btn-primary" onclick="showPreferencesModal()">
                            <i class="fas fa-cog"></i> Select Preferences
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('dynamic-content').innerHTML = html;
        }
        
        function renderSchedule(data) {
            const semesterName = getSemesterName(data.semester);
            const academicYear = `${data.year}-${data.year + 1}`;
            
            // Check if registration is open
            let isRegistrationOpen = false;
            
            // First check if we need to get registration status
            fetch('/student/course-registration')
                .then(response => response.json())
                .then(regData => {
                    isRegistrationOpen = regData.data && regData.data.registration_status === 'open';
                    renderScheduleContent(data, isRegistrationOpen);
                })
                .catch(error => {
                    console.error('Error checking registration status:', error);
                    // Default to closed if error
                    renderScheduleContent(data, false);
                });
        }
        
        function renderScheduleContent(data, isRegistrationOpen) {
            const semesterName = getSemesterName(data.semester);
            const academicYear = `${data.year}-${data.year + 1}`;
            
            let html = `
                <div class="content-card schedule-container schedule-single-line-courses">
                    <h3>Your Courses for ${semesterName}</h3>
                    
                    ${!isRegistrationOpen ? `
                    <div class="registration-closed-notice">
                        <i class="fas fa-lock"></i>
                        <p>Course registration is currently closed. You can view your schedule, but preferences and schedule generation are disabled.</p>
                    </div>
                    ` : ''}
                    
                    <div class="enrolled-courses-container">
                        <div class="enrolled-courses-list">
            `;
            
            // Display enrolled courses
            if (data.enrolled_courses && data.enrolled_courses.length > 0) {
                data.enrolled_courses.forEach(course => {
                    html += `
                        <div class="enrolled-course-item">
                            <div class="course-info">
                                <span class="course-code">${course.course_code}</span>
                                <span class="course-name">${course.course_name}</span>
                                <span class="course-credits">${course.credits} credits</span>
                                ${course.lecture_study_group ? `<span class="course-group">Lecture Group: ${course.lecture_study_group}</span>` : ''}
                                ${course.tutorial_study_group ? `<span class="course-group">Tutorial Group: ${course.tutorial_study_group}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="no-courses-message">
                        <i class="fas fa-info-circle"></i>
                        <p>No enrolled courses for this semester yet.</p>
                    </div>
                `;
            }
            
            html += `
                        </div>
                    </div>
                    
                                <div class="schedule-actions">
                <button class="btn-primary" id="select-preferences-btn" ${!isRegistrationOpen ? 'disabled' : ''}>
                    <i class="fas fa-cog"></i> Select Preferences
                </button>
                
                <div class="priority-toggle-container">
                    <span>Give Priority To:</span>
                    <div class="priority-options">
                        <label class="priority-option" id="timeslots-option">
                            <input type="radio" name="priority" value="timeslots" id="priority-timeslots">
                            Time Slots
                        </label>
                        <label class="priority-option" id="professors-option">
                            <input type="radio" name="priority" value="professors" id="priority-professors">
                            Professors
                        </label>
                    </div>
                </div>
                
                <button class="btn-primary" id="find-all-solutions-btn" disabled title="Checking preferences...">
                    <i class="fas fa-list"></i> Generate My Schedules
                </button>
            </div>
                </div>
            `;
            
            document.getElementById('dynamic-content').innerHTML = html;
            
                // Add event listeners for buttons only if registration is open
    if (isRegistrationOpen) {
        document.getElementById('select-preferences-btn').addEventListener('click', showPreferencesModal);
        document.getElementById('find-all-solutions-btn').addEventListener('click', findAllOptimalSchedules);
        
        // Check if all preferences are set
        checkAllPreferences();
        
        // Add priority selection functionality
        const timeslotsOption = document.getElementById('timeslots-option');
        const professorsOption = document.getElementById('professors-option');
        const timeslotsRadio = document.getElementById('priority-timeslots');
        const professorsRadio = document.getElementById('priority-professors');
        
        // Check current priority mode from server
        checkCurrentPriorityMode();
        
        // Add event listeners for priority options
        timeslotsOption.addEventListener('click', function() {
            // Update visual state
            timeslotsOption.classList.add('selected');
            professorsOption.classList.remove('selected');
            
            // Set radio button state
            timeslotsRadio.checked = true;
            professorsRadio.checked = false;
            
            // Send the priority mode to the server
            updatePriorityMode('timeslots');
            
            console.log("Timeslots selected, radio checked:", timeslotsRadio.checked);
        });
        
        professorsOption.addEventListener('click', function() {
            // Update visual state
            professorsOption.classList.add('selected');
            timeslotsOption.classList.remove('selected');
            
            // Set radio button state
            professorsRadio.checked = true;
            timeslotsRadio.checked = false;
            
            // Send the priority mode to the server
            updatePriorityMode('professors');
            
            console.log("Professors selected, radio checked:", professorsRadio.checked);
        });
        
        // Function to update priority mode in the database
        // Function to check current priority mode from database
        function checkCurrentPriorityMode() {
            // Make a request to get the current mode directly from the database without generating a schedule
            fetch('/student/schedule/update-mode', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.mode) {
                    // Convert database mode (a/b) to UI mode (timeslots/professors)
                    const mode = data.mode === 'a' ? 'timeslots' : 'professors';
                    console.log('Current priority mode from database:', mode);
                    
                    // Update UI based on current mode
                    if (mode === 'timeslots') {
                        timeslotsOption.classList.add('selected');
                        professorsOption.classList.remove('selected');
                        timeslotsRadio.checked = true;
                        professorsRadio.checked = false;
                    } else if (mode === 'professors') {
                        professorsOption.classList.add('selected');
                        timeslotsOption.classList.remove('selected');
                        professorsRadio.checked = true;
                        timeslotsRadio.checked = false;
                    }
                } else {
                    console.error('Could not determine priority mode from response');
                }
                
                // Check if all preferences are set after updating the UI
                checkAllPreferences();
            })
            .catch(error => {
                console.error('Error retrieving priority mode from database:', error);
            });
        }
        
        // Function to check if all preferences are set and update button state
        function checkAllPreferences() {
            console.log('Checking all preferences...');
            const generateButton = document.getElementById('find-all-solutions-btn');
            if (!generateButton) {
                console.log('Generate button not found in DOM');
                return;
            }
            
            // Default to disabled
            generateButton.disabled = true;
            generateButton.classList.remove('active');
            generateButton.title = "Checking preferences...";
            
            // Make API call to check preferences
            fetch('/student/schedule/check-preferences')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Preferences check result:', data);
                    
                    if (data.success) {
                        if (data.has_all_preferences) {
                            // All preferences are set, enable the button
                            console.log('All preferences are set, enabling button');
                            generateButton.disabled = false;
                            generateButton.classList.add('active');
                            generateButton.title = "Generate optimized schedules";
                        } else {
                            // Missing some preferences
                            console.log('Missing some preferences, button remains disabled');
                            
                            // Create detailed tooltip message
                            let missingPreferences = [];
                            if (!data.preferences.priority) missingPreferences.push("Priority");
                            if (!data.preferences.professors) missingPreferences.push("Professor preferences");
                            if (!data.preferences.timeslots) missingPreferences.push("Time slot preferences");
                            
                            generateButton.title = `Missing preferences: ${missingPreferences.join(", ")}`;
                        }
                    } else {
                        console.error('Error checking preferences:', data.message);
                        generateButton.title = "Error checking preferences";
                    }
                })
                .catch(error => {
                    console.error('Error checking preferences:', error);
                    generateButton.title = "Error checking preferences";
                });
        }

        function updatePriorityMode(mode) {
            // Show loading indicator on the selected option
            const selectedOption = mode === 'timeslots' ? timeslotsOption : professorsOption;
            const originalText = selectedOption.innerHTML;
            selectedOption.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${mode === 'timeslots' ? 'Time Slots' : 'Professors'}`;
            
            // Update the mode directly in the database
            fetch('/student/schedule/update-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ mode: mode === 'timeslots' ? 'a' : 'b' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Priority mode updated successfully in database');
                    // Show success indicator briefly
                    selectedOption.innerHTML = `<i class="fas fa-check"></i> ${mode === 'timeslots' ? 'Time Slots' : 'Professors'}`;
                    setTimeout(() => {
                        selectedOption.innerHTML = originalText;
                    }, 1000);
                    
                    // Check if all preferences are set after updating priority
                    checkAllPreferences();
                } else {
                    console.error('Error updating priority mode in database:', data.message);
                    // Show error indicator briefly
                    selectedOption.innerHTML = `<i class="fas fa-times"></i> ${mode === 'timeslots' ? 'Time Slots' : 'Professors'}`;
                    setTimeout(() => {
                        selectedOption.innerHTML = originalText;
                    }, 1000);
                    
                    // Show error notification
                    showNotification('Failed to update priority mode: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error updating priority mode:', error);
                // Restore original text
                selectedOption.innerHTML = originalText;
                // Show error notification
                showNotification('Failed to update priority mode: Network error', 'error');
            });
        }
    }
            
            // Check for saved schedule
            checkForSavedSchedule(data);
        }
        
        function findAllOptimalSchedules() {
            // First check if registration is open
            fetch('/student/course-registration')
                .then(response => response.json())
                .then(regData => {
                    const isRegistrationOpen = regData.data && regData.data.registration_status === 'open';
                    
                    if (!isRegistrationOpen) {
                        showNotification('Course registration is currently closed. Schedule generation is disabled.', 'error');
                        return;
                    }
                    
                    // Continue with finding schedules if registration is open
                    findAllOptimalSchedulesContent();
                })
                .catch(error => {
                    console.error('Error checking registration status:', error);
                    // Default to allowing the operation, but it may fail
                    findAllOptimalSchedulesContent();
                });
        }
        
        function findAllOptimalSchedulesContent() {
            // Show loading state
            document.getElementById('dynamic-content').innerHTML = `
                <div class="content-card loading-message">
                    <h3><i class="fas fa-spinner fa-spin"></i> Generating Schedules</h3>
                    <p>Please wait while we find the best schedules for You</p>
                </div>
            `;
            
            // No need to check priority mode - it's already set in the database
            // Just call the API directly with empty preferences
            continueWithFindingSchedules();
        }
        
        // Function to continue with finding optimal schedules
        function continueWithFindingSchedules() {
            // No need to specify priority mode - it's already set in the database
            const preferences = {};
            
            console.log("Using priority mode from database");

            // Call the API to find all optimal schedules
            fetch('/student/schedule/all-optimal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ preferences: preferences })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to find optimal schedules');
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data);  // Debug log
                if (data.success && data.solutions && Array.isArray(data.solutions) && data.solutions.length > 0) {
                    displayAllOptimalSchedules(data);
                } else {
                    // Show error message
                    document.getElementById('dynamic-content').innerHTML = `
                        <div class="content-card error-message">
                            <h3><i class="fas fa-exclamation-circle"></i> No Optimal Schedules Found</h3>
                            <p>${data.message || 'Could not find any optimal schedules'}</p>
                            <button onclick="loadSchedule()" class="btn-primary retry-button">
                                <i class="fas fa-sync-alt"></i> Back to Preferences
                            </button>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error finding optimal schedules:', error);
                document.getElementById('dynamic-content').innerHTML = `
                    <div class="content-card error-message">
                        <h3><i class="fas fa-exclamation-circle"></i> Error</h3>
                        <p>${error.message || 'An error occurred while finding optimal schedules'}</p>
                        <button onclick="loadSchedule()" class="btn-primary retry-button">
                            <i class="fas fa-sync-alt"></i> Back to Preferences
                        </button>
                    </div>
                `;
            });
        }
        
        function displayAllOptimalSchedules(result) {
            const solutions = result.solutions;
            const objectiveValue = result.objective_value || 0;
            
            // Store solutions in global variable for navigation
            allOptimalSolutions = solutions;
            
            console.log("Displaying solutions:", solutions.length);
            
            // Build HTML
            let html = `
                <div class="content-card schedule-container">
                    <div class="schedule-header">
                        <h3>Your Schedules</h3>
                        ${solutions.length >= 10 ? `<div style="color: #856404; background-color: #fff3cd; padding: 8px 12px; margin-top: 10px; border-radius: 4px; font-size: 14px;">
                            <i class="fas fa-exclamation-triangle"></i> We can display only 10 solutions. Please add more preferences to narrow down the results.
                        </div>` : ''}
                    </div>
                    
                    <div class="schedule-actions-top" style="justify-content: flex-start;">
                        <button class="btn-primary" onclick="loadSchedule()">
                            <i class="fas fa-arrow-left"></i> Back to Preferences
                        </button>
                    </div>
                    
                    <div class="optimal-solutions-container">
            `;
            
            // Add each solution
            solutions.forEach((solution, index) => {
                html += `
                    <div class="optimal-solution-card">
                        <div class="solution-header">
                            <h4>Schedule #${index + 1}</h4>
                            <button class="btn-primary view-solution-btn" data-solution-index="${index}">
                                View Schedule
                            </button>
                        </div>
                        <div class="solution-stats">
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('dynamic-content').innerHTML = html;
            
            // Add event listeners for view buttons
            document.querySelectorAll('.view-solution-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const solutionIndex = parseInt(this.getAttribute('data-solution-index'));
                    displaySingleOptimalSchedule(solutions[solutionIndex], solutionIndex, solutions.length);
                });
            });
        }
        
        function displaySingleOptimalSchedule(solution, index, totalSolutions) {
            // This function displays a single optimal schedule from the list
            // It's similar to displayGeneratedSchedule but adds navigation between solutions
            
            const schedule = solution.schedule;
            const courseDetails = solution.course_details || {};
            
            // Create days of the week array
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Group sessions by day
            const sessionsByDay = {};
            days.forEach(day => {
                sessionsByDay[day] = [];
            });
            
            // Organize sessions by day
            if (schedule && schedule.length > 0) {
                schedule.forEach(session => {
                    if (sessionsByDay[session.day]) {
                        sessionsByDay[session.day].push(session);
                    }
                });
                
                // Sort sessions within each day by start time
                Object.keys(sessionsByDay).forEach(day => {
                    sessionsByDay[day].sort((a, b) => {
                        return a.start_time.localeCompare(b.start_time);
                    });
                });
            }
            
            // Build HTML
            let html = `
                <div class="content-card schedule-container">
                    <div class="schedule-header">
                        <h3>Schedule #${index + 1} of ${totalSolutions}</h3>
                    </div>
                    
                    <div class="schedule-actions-top" style="justify-content: space-between;">
                        <div>
                            <button class="btn-primary" onclick="displayAllOptimalSchedules({solutions: allOptimalSolutions})">
                                <i class="fas fa-list"></i> Back to All Solutions
                            </button>
                        </div>
                        <div>
                            <button class="btn-nav ${index === 0 ? 'disabled' : ''}" ${index === 0 ? 'disabled' : ''} onclick="navigateOptimalSolution(${index - 1})">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <button class="btn-nav ${index === totalSolutions - 1 ? 'disabled' : ''}" ${index === totalSolutions - 1 ? 'disabled' : ''} onclick="navigateOptimalSolution(${index + 1})">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="btn-print" onclick="window.print()">
                                <i class="fas fa-download"></i> Download Schedule
                            </button>
                            <div style="text-align: center; font-size: 12px; margin-top: 5px;">${schedule ? schedule.length : 0} sessions</div>
                        </div>
                    </div>
                    
                    <div class="enrolled-courses-container schedule-single-line-courses">
                        <h4>Enrolled Courses</h4>
                        <div class="enrolled-courses-list">
            `;
            
            // Extract unique courses from schedule
            const uniqueCourses = [];
            const processedCourses = new Set();
            
            if (schedule && schedule.length > 0) {
                schedule.forEach(session => {
                    if (!processedCourses.has(session.course_code)) {
                        processedCourses.add(session.course_code);
                        const courseDetail = courseDetails[session.course_code] || {};
                        uniqueCourses.push({
                            course_code: session.course_code,
                            course_name: courseDetail.course_name || session.course_code,
                            credits: courseDetail.coefficient || 3
                        });
                    }
                });
            }
            
            if (uniqueCourses.length > 0) {
                uniqueCourses.forEach(course => {
                    html += `
                        <div class="enrolled-course-item">
                            <div class="course-info">
                                <span class="course-code">${course.course_code}</span>
                                <span class="course-name">${course.course_name}</span>
                                <span class="course-credits">${course.credits} credits</span>
                                ${course.lecture_study_group ? `<span class="course-group">Lecture Group: ${course.lecture_study_group}</span>` : ''}
                                ${course.tutorial_study_group ? `<span class="course-group">Tutorial Group: ${course.tutorial_study_group}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="no-courses-message">
                        <i class="fas fa-info-circle"></i>
                        <p>No course information available.</p>
                    </div>
                `;
            }
            
            html += `
                        </div>
                    </div>
                    
                    <div class="schedule-legend">
                        <div class="legend-item lecture">
                            <div class="legend-color"></div>
                            <span>Lecture</span>
                        </div>
                        <div class="legend-item tutorial">
                            <div class="legend-color"></div>
                            <span>Tutorial</span>
                        </div>
                    </div>
                    
                    <div class="weekly-schedule">
            `;
            
            // Add day columns
            days.forEach(day => {
                const sessions = sessionsByDay[day] || [];
                html += generateDayColumnHTML(day, sessions, courseDetails);
            });
            
            html += `
                    </div>
                    
                    <div class="schedule-actions">
                        <button class="btn-primary save-solution-btn" onclick="saveOptimalSolution(${index})">
                            <i class="fas fa-save"></i> Save This Schedule
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('dynamic-content').innerHTML = html;
        }
        
        // Store all optimal solutions in memory for navigation
        let allOptimalSolutions = [];
        
        function navigateOptimalSolution(index) {
            if (index >= 0 && index < allOptimalSolutions.length) {
                displaySingleOptimalSchedule(allOptimalSolutions[index], index, allOptimalSolutions.length);
            }
        }
        
        function saveOptimalSolution(index) {
            const solution = allOptimalSolutions[index];

            // Loading spinner
            document.getElementById('dynamic-content').innerHTML = `
                <div class="content-card loading-message">
                    <h3><i class="fas fa-spinner fa-spin"></i> Saving Schedule</h3>
                    <p>Please wait while we save your selected schedule</p>
                </div>
            `;

            fetch('/student/schedule/confirm_choice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ schedule: solution.schedule })
            })
            .then(res => {
                if (!res.ok) {
                    if (res.status === 403) throw new Error('Course registration is currently closed.');
                    throw new Error('Failed to save schedule.');
                }
                return res.json();
            })
            .then(() => {
                loadSchedule();
            })
            .catch(err => {
                console.error('Error saving schedule:', err);
                document.getElementById('dynamic-content').innerHTML = `
                    <div class="content-card error-message">
                        <h3><i class="fas fa-exclamation-circle"></i> Error</h3>
                        <p>${err.message || 'An error occurred while saving the schedule'}</p>
                        <button onclick="findAllOptimalSchedules()" class="btn-primary retry-button">
                            <i class="fas fa-sync-alt"></i> Back to All Solutions
                        </button>
                    </div>
                `;
            });
        }
        

        
        function displayGeneratedSchedule(result) {
            const schedule = result.schedule;
            const courseDetails = result.course_details || {};
            // Check if semester and year exist, use safe defaults if not
            const semesterName = result.semester ? getSemesterName(result.semester) : "Current";
            const academicYear = result.year ? `${result.year}-${parseInt(result.year) + 1}` : "";
            
            // Create days of the week array
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Group sessions by day
            const sessionsByDay = {};
            days.forEach(day => {
                sessionsByDay[day] = [];
            });
            
            // Organize sessions by day
            if (schedule && schedule.length > 0) {
                schedule.forEach(session => {
                    if (sessionsByDay[session.day]) {
                        sessionsByDay[session.day].push(session);
                    }
                });
                
                // Sort sessions within each day by start time
                Object.keys(sessionsByDay).forEach(day => {
                    sessionsByDay[day].sort((a, b) => {
                        return a.start_time.localeCompare(b.start_time);
                    });
                });
            }
            
            // Calculate stats
            const totalSessions = schedule ? schedule.length : 0;
            const lectureCount = schedule ? schedule.filter(s => s.session_type === 'lecture').length : 0;
            const tutorialCount = schedule ? schedule.filter(s => s.session_type === 'tutorial').length : 0;
            
            // Calculate objective values
            const profPrefValue = result.objective_components ? result.objective_components.professor_preference_value : 0;
            const timePrefValue = result.objective_components ? result.objective_components.timeslot_preference_value : 0;
            const totalObjective = result.total_objective_value || 0;
            
            // Build HTML
            let html = `
                <div class="content-card schedule-container">
                    <div class="schedule-header">
                        <h3>Optimized Schedule for ${semesterName}</h3>
                        <div class="schedule-stats">
                            <div class="stat-item">Sessions: ${totalSessions}</div>
                            <div class="stat-item">Lectures: ${lectureCount}</div>
                            <div class="stat-item">Tutorials: ${tutorialCount}</div>
                        </div>
                    </div>
                    
                    <div class="schedule-actions-top" style="justify-content: space-between;">
                        <div>
                            <button class="btn-primary" onclick="loadSchedule()">
                                <i class="fas fa-arrow-left"></i> Back to Preferences
                            </button>
                            <button class="btn-primary" onclick="showPreferencesModal()">
                                <i class="fas fa-cog"></i> Select Preferences
                            </button>
                        </div>
                        <div>
                            <button class="btn-print" onclick="window.print()">
                                <i class="fas fa-download"></i> Download Schedule
                            </button>
                        </div>
                    </div>
                    
                    <div class="schedule-legend">
                        <div class="legend-item lecture">
                            <div class="legend-color"></div>
                            <span>Lecture</span>
                        </div>
                        <div class="legend-item tutorial">
                            <div class="legend-color"></div>
                            <span>Tutorial</span>
                        </div>
                    </div>
                    
                    <div class="course-summary-section">
                        <h4>Course Summary</h4>
                        <div class="course-summary-grid">
            `;
            
            // Add course summary cards
            const processedCourses = new Set();
            if (schedule && schedule.length > 0) {
                schedule.forEach(session => {
                    const courseCode = session.course_code;
                    if (!processedCourses.has(courseCode)) {
                        const courseDetail = courseDetails[courseCode] || {};
                        // Use session.course_name first if available, then courseDetail, then fallback
                        const courseName = session.course_name || courseDetail.course_name || `${courseCode} Course`;
                        const credits = courseDetail.coefficient || 3;
                        
                        html += `
                            <div class="course-summary-card">
                                <div class="course-code">${courseCode}</div>
                                <div class="course-name">${courseName}</div>
                                <div class="course-credits">${credits} credits</div>
                            </div>
                        `;
                        processedCourses.add(courseCode);
                    }
                });
            }
            
            html += `
                        </div>
                    </div>
                    

                    
                    ${!schedule || schedule.length === 0 ? `
                    <div class="preferences-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>No valid schedule could be generated. This could be due to several reasons:</p>
                        <ul>
                            <li>No schedule options exist in the database for your enrolled courses</li>
                            <li>The constraints cannot all be satisfied at once</li>
                            <li>Your preference settings are too restrictive</li>
                        </ul>
                        <p>Please try again with different preferences or contact support.</p>
                    </div>
                    ` : ''}
                    
                    <div class="weekly-schedule">
            `;
            
            // Add day columns
            days.forEach(day => {
                const sessions = sessionsByDay[day] || [];
                html += generateDayColumnHTML(day, sessions, courseDetails);
            });
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('dynamic-content').innerHTML = html;
        }
        
        // Helper function to convert semester number to name
        function getSemesterName(semesterNumber) {
            if (!semesterNumber) return 'Current';
            
            try {
            switch(parseInt(semesterNumber)) {
                case 1: return 'Fall';
                case 2: return 'Spring';
                    default: return 'Current';
                }
            } catch (e) {
                return 'Current';
            }
        }

// Function to check for and display saved schedule
function checkForSavedSchedule(data) {
    if (!(data && data.saved_schedule)) return;

    // Locate the main schedule container â€“ we will overlay inside it
    const scheduleContainer = document.querySelector('.schedule-container');
    if (!scheduleContainer) return;

    // Ensure parent is positioned so the overlay positions absolutely within it
    if (getComputedStyle(scheduleContainer).position === 'static') {
        scheduleContainer.style.position = 'relative';
    }

    // Build overlay element
    const overlay = document.createElement('div');
    overlay.className = 'saved-schedule-wrapper';
    overlay.id = 'saved-schedule-wrapper';

    // Prepare schedule data
    const schedule = data.saved_schedule.schedule || [];
    const courseDetails = {...(data.saved_schedule.course_details || {})};

    // Merge enrolled course info (already present when viewing schedule) for names/credits
    if (data.enrolled_courses && Array.isArray(data.enrolled_courses)) {
        data.enrolled_courses.forEach(ec => {
            if (!courseDetails[ec.course_code]) {
                courseDetails[ec.course_code] = {
                    course_name: ec.course_name,
                    coefficient: ec.credits
                };
            }
        });
    }

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const sessionsByDay = {};
    days.forEach(day => sessionsByDay[day] = []);
    schedule.forEach(session => {
        if (sessionsByDay[session.day]) {
            sessionsByDay[session.day].push(session);
        }
    });
    Object.keys(sessionsByDay).forEach(day => {
        sessionsByDay[day].sort((a, b) => a.start_time.localeCompare(b.start_time));
    });

    // Build inner HTML identical to the normal schedule view
    let html = `
        <div class="saved-schedule-container">
            <div class="saved-schedule-header">
                <h3><i class="fas fa-save"></i> Your Schedule</h3>
                <span class="saved-date">${data.saved_schedule.created_at ? 'Saved on ' + formatDateTime(data.saved_schedule.created_at) : ''}</span>
                <div style="margin-left:auto; display:flex; gap:8px;">
                    <button class="btn-print" onclick="window.print()"><i class="fas fa-download"></i> Download</button>
                    <button class="btn-secondary" onclick="document.getElementById('saved-schedule-wrapper').remove();"><i class="fas fa-times"></i> Close</button>
                </div>
            </div>
            <div class="schedule-legend">
                <div class="legend-item lecture"><div class="legend-color"></div><span>Lecture</span></div>
                <div class="legend-item tutorial"><div class="legend-color"></div><span>Tutorial</span></div>
            </div>
            <div class="weekly-schedule">
    `;

    // Add each day column using the same helper
    days.forEach(day => {
        html += generateDayColumnHTML(day, sessionsByDay[day], courseDetails);
    });

    html += `
            </div>
        </div>
    `;

    overlay.innerHTML = html;

    // Append overlay inside the schedule container so it covers only that area
    scheduleContainer.appendChild(overlay);
}

function renderMiniScheduleView(scheduleData) {
    // Group sessions by day
    const sessionsByDay = {
        'Monday': [],
          'Tuesday': [],
          'Wednesday': [],
          'Thursday': [],
          'Friday': [],
        'Saturday': []
    };
    
    // Count total sessions
    let totalSessions = 0;
    
    scheduleData.forEach(session => {
        if (sessionsByDay[session.day]) {
            sessionsByDay[session.day].push(session);
            totalSessions++;
        }
    });
    
    // Create mini schedule HTML
    let html = `
        <div class="mini-schedule">
            <div class="mini-schedule-stats">
                <div class="mini-stat-item">
                    <i class="fas fa-calendar-check"></i> ${totalSessions} total sessions
                </div>
            </div>
            <div class="mini-schedule-days">
    `;
    
    for (const [day, sessions] of Object.entries(sessionsByDay)) {
        html += `<div class="mini-day-column">`;
        html += `<div class="mini-day-header">${day}</div>`;
        
        if (sessions.length > 0) {
            sessions.sort((a, b) => a.start_time.localeCompare(b.start_time));
            
            sessions.forEach(session => {
                const isLecture = session.session_type === 'lecture';
                const sessionClass = isLecture ? 'mini-lecture' : 'mini-tutorial';
                
                html += `
                    <div class="mini-session ${sessionClass}">
                        <div class="mini-session-time">${formatTime(session.start_time)} - ${formatTime(session.end_time)}</div>
                        <div class="mini-session-course">${session.course_code}</div>
                    </div>
                `;
            });
        } else {
            html += `<div class="mini-no-sessions">No sessions</div>`;
        }
        
        html += `</div>`;
    }
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

function formatDateTime(dateTimeStr) {
    const date = new Date(dateTimeStr);
    return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatTime(timeStr) {
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const hour12 = hour % 12 || 12;
    return `${hour12}:${minutes} ${ampm}`;
}

    </script>

<script>
function showTooltip(event, courseCode) {
    event.stopPropagation();
    const tooltip = document.getElementById('course-tooltip');
    if (!tooltip) return;
    
    // Set data attribute for current course
    tooltip.setAttribute('data-current-course', courseCode);
    
    // Position the tooltip at the top right corner with a small margin
    tooltip.style.right = '20px';
    tooltip.style.left = 'auto';
    tooltip.style.top = '20px';
    
    // Check if we have the course info in cache
    if (courseInfoCache[courseCode]) {
        displayTooltipFromCache(tooltip, courseCode);
    } else {
        // Immediately show basic tooltip with what we have
        displayBasicTooltip(tooltip, courseCode, event.target);
        
        // Fetch in background (won't block UI)
        fetchAndCacheCourseInfo(courseCode, tooltip);
    }
}

function hideTooltip() {
    const tooltip = document.getElementById('course-tooltip');
    if (tooltip) {
        tooltip.style.display = 'none';
        tooltip.removeAttribute('data-current-course');
    }
}

// Initialize extra courses section
function initializeExtraCourses(courses) {
    const container = document.getElementById('extra-courses-container');
    const section = document.getElementById('extra-courses-section');
    
    if (container && courses && courses.length > 0) {
        // Populate the container
        container.innerHTML = '';
        
        courses.forEach(course => {
            const courseItem = document.createElement('div');
            courseItem.className = 'course-item';
            courseItem.innerHTML = `
                <label>
                    <input type="checkbox" data-course-code="${course.course_code}">
                    ${course.course_code} - ${course.course_name} (${course.coefficient} credits)
                </label>
            `;
            
            // Add event listeners directly to the element
            courseItem.addEventListener('mousemove', (e) => showTooltip(e, course.course_code));
            courseItem.addEventListener('mouseleave', hideTooltip);
            
            container.appendChild(courseItem);
        });
        
        // Display the section
        section.classList.remove('extra-courses-hidden');
    }
}

// Global event to hide tooltip when clicking elsewhere
document.addEventListener('click', hideTooltip);

// Create tooltip element when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Create tooltip container
    if (!document.getElementById('course-tooltip')) {
        const tooltip = document.createElement('div');
        tooltip.id = 'course-tooltip';
        tooltip.className = 'course-tooltip';
        document.body.appendChild(tooltip);
    }
    
    // Add mouseleave event to body to hide tooltip when mouse leaves page
    document.body.addEventListener('mouseleave', hideTooltip);
    
    // Hook into the main data loading function to initialize our extra courses
    const originalInitializeData = window.initializeData || function(){};
    window.initializeData = function(data) {
        // Call original function if it exists
        if (typeof originalInitializeData === 'function') {
            originalInitializeData(data);
        }
        
        // Initialize our extra courses
        if (data && data.extra_courses) {
            initializeExtraCourses(data.extra_courses);
        }
    };
});
</script>

<!-- Extra Courses Section - with wrapper for better size control -->
<div class="course-section extra-courses-hidden" id="extra-courses-section">
    <h3>Extra Courses</h3>
    <div class="extra-courses-wrapper">
        <div id="extra-courses-container" class="extra-courses-container"></div>
    </div>
</div>

<script>
function filterExtraCourses(searchTerm) {
    searchTerm = searchTerm.toLowerCase();
    const container = document.querySelector('.extra-courses-container');
    if (!container) return;

    const courseItems = container.querySelectorAll('.course-item');
    courseItems.forEach(item => {
        const courseCode = item.getAttribute('data-course-code');
        const courseName = item.getAttribute('data-course-name');
        const matches = courseCode.includes(searchTerm) || courseName.includes(searchTerm);
        item.style.display = matches ? '' : 'none';
    });
    
    // Update the selected courses count after filtering
    // This ensures hidden courses are not counted
    updateSelectedCount();
}

// Filter elective courses
function filterElectiveCourses(groupNumber, searchTerm) {
    searchTerm = searchTerm.toLowerCase();
    const courseItems = document.querySelectorAll(`.elective-group-container[data-group-number="${groupNumber}"] .elective-course-item`);
    
    courseItems.forEach(item => {
        const courseCode = item.querySelector('.elective-course-code').textContent.toLowerCase();
        const courseName = item.querySelector('.elective-course-name').textContent.toLowerCase();
        
        if (courseCode.includes(searchTerm) || courseName.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Update the selected courses count after filtering
    // This ensures hidden courses are not counted
    updateSelectedCount();
    
    // Also update the elective counter for this group
    const groupData = window.electiveGroups ? window.electiveGroups[groupNumber] : null;
    if (groupData && groupData.required_picks) {
        updateElectiveCounter(groupNumber, groupData.required_picks);
    }
}
</script>

<script>
    // Display major-specific indicator for elective courses
    function displayMajorSpecificIndicator(courseElement, forMajor) {
        if (forMajor && forMajor !== '') {
            const majorIndicator = document.createElement('div');
            majorIndicator.className = 'major-specific';
            majorIndicator.textContent = `For ${forMajor} major`;
            courseElement.querySelector('.course-name').appendChild(majorIndicator);
        }
    }
    
    // Add this to your existing code that displays elective courses
    document.addEventListener('DOMContentLoaded', function() {
        // Your existing code will run here
    });
</script>
<script></script>

<!-- Load the makeup session section -->
<script>
    // Check if makeup session should be available in the menu
    function checkMakeupSessionAvailability() {
        fetch('/student/makeup-session')
            .then(response => {
                if (!response.ok) {
                    // If error, don't show the menu item
                    document.getElementById('makeup-session-menu-item').style.display = 'none';
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (!data) return; // Handle case where response wasn't ok
                
                // Only show the menu item if ALL eligibility conditions are met
                if (data.success && data.eligible === true) {
                    // All eligibility conditions are met, show the menu item
                    document.getElementById('makeup-session-menu-item').style.display = 'block';
                } else {
                    // Any eligibility condition failed, don't show the menu item
                    document.getElementById('makeup-session-menu-item').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error checking makeup session availability:', error);
                document.getElementById('makeup-session-menu-item').style.display = 'none';
            });
    }

    function loadMakeupSession() {
        document.getElementById('content-title').textContent = 'Makeup Session';
        document.getElementById('dynamic-content').innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Checking makeup session eligibility...</p></div>';
        
        fetch('/student/makeup-session')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load makeup session data');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    renderMakeupSession(data);
                } else {
                    renderMakeupSessionIneligible(data.message || 'You are not eligible for makeup sessions');
                }
            })
            .catch(error => {
                showError(error.message);
            });
    }
    
    // Render the makeup session interface for eligible students
    function renderMakeupSession(data) {
        const container = document.createElement('div');
        container.className = 'makeup-session-container';
        
        // Session details section
        const detailsCard = document.createElement('div');
        detailsCard.className = 'session-details-card';
        
        // Format dates
        let formattedOpenDate = 'TBD';
        let formattedCloseDate = 'TBD';
        
        if (data.sessionDetails && data.sessionDetails.open_date) {
            const openDate = new Date(data.sessionDetails.open_date);
            formattedOpenDate = openDate.toLocaleDateString() + ' ' + openDate.toLocaleTimeString();
        }
        
        if (data.sessionDetails && data.sessionDetails.close_date) {
            const closeDate = new Date(data.sessionDetails.close_date);
            formattedCloseDate = closeDate.toLocaleDateString() + ' ' + closeDate.toLocaleTimeString();
        }
        
        detailsCard.innerHTML = `
            <div class="session-header">
                <h3><i class="fas fa-calendar-check"></i> Makeup Session</h3>
                <div class="session-status">Status: <strong>${data.sessionDetails ? data.sessionDetails.status.toUpperCase() : 'ACTIVE'}</strong></div>
            </div>
            <div class="session-dates">
                <div class="date-item">
                    <i class="fas fa-play-circle"></i>
                    <span>Opens: ${formattedOpenDate}</span>
                </div>
                <div class="date-item">
                    <i class="fas fa-stop-circle"></i>
                    <span>Closes: ${formattedCloseDate}</span>
                </div>
            </div>
            <div class="eligibility-info">
                <!-- Credit information removed as requested -->
            </div>
        `;
        
        // Courses section
        const coursesSection = document.createElement('div');
        coursesSection.className = 'makeup-courses-section';
        
        coursesSection.innerHTML = `
            <h3>Eligible Courses</h3>
            <p class="info-text">You can select up to 2 courses that you previously failed or did not enroll in. These courses will be registered for the makeup session.</p>
            <div class="makeup-courses-list">
                ${data.makeupCourses && data.makeupCourses.length > 0 ? data.makeupCourses.map(course => `
                    <div class="makeup-course-item ${course.registered ? 'registered' : ''}">
                        <div class="course-checkbox">
                            <input type="checkbox" id="course-${course.course_code}" value="${course.course_code}" 
                                data-name="${course.course_name}" 
                                data-credits="${course.coefficient}" 
                                ${course.registered ? 'checked disabled' : ''}>
                        </div>
                        <div class="course-info">
                            <strong>${course.course_code}</strong>
                            <span>${course.course_name} (${course.coefficient} credits)</span>
                        </div>
                        <div class="course-status status-${course.status.toLowerCase()}">
                            ${course.registered ? 'REGISTERED' : 
                              course.status === 'notenrolled' ? 'Skipped' : 
                              course.status === 'failed' ? 'Failed' : 
                              course.status}
                        </div>
                    </div>
                `).join('') : '<p>No eligible courses found.</p>'}
            </div>
            ${data.makeupCourses && data.makeupCourses.length > 0 ? 
                '<button id="register-makeup-btn" class="btn-primary">Register for Selected Courses</button>' :
                '<p class="info-text">You don\'t have any eligible courses for makeup.</p>'
            }
        `;
        
        // Confirmation modal
        const confirmationModal = document.createElement('div');
        confirmationModal.className = 'makeup-confirmation-modal';
        confirmationModal.innerHTML = `
            <div class="makeup-confirmation-content">
                <div class="confirmation-header">
                    <h3><i class="fas fa-check-circle"></i> Confirm Registration</h3>
                </div>
                <div class="confirmation-body">
                    <p>You are about to register for the following makeup courses:</p>
                    <div class="confirmation-courses" id="confirmation-courses-list"></div>
                    <div class="confirmation-actions">
                        <button id="cancel-makeup-btn" class="btn-secondary">Cancel</button>
                        <button id="confirm-makeup-btn" class="btn-primary">Confirm Registration</button>
                    </div>
                </div>
            </div>
        `;
        
        // Notification container
        const notificationContainer = document.createElement('div');
        notificationContainer.className = 'notification-container';
        notificationContainer.id = 'notification-container';
        
        // Append all elements
        container.appendChild(detailsCard);
        container.appendChild(coursesSection);
        container.appendChild(confirmationModal);
        container.appendChild(notificationContainer);
        
        document.getElementById('dynamic-content').innerHTML = '';
        document.getElementById('dynamic-content').appendChild(container);
        
        // Setup event listeners
        if (data.makeupCourses && data.makeupCourses.length > 0) {
            setupMakeupSessionEvents();
        }
    }
    
    // Render ineligible message for makeup session
    function renderMakeupSessionIneligible(message) {
        const container = document.createElement('div');
        container.className = 'makeup-session-container';
        
        const infoCard = document.createElement('div');
        infoCard.className = 'session-details-card';
        
        infoCard.innerHTML = `
            <div class="session-header">
                <h3><i class="fas fa-exclamation-circle"></i> Makeup Session</h3>
            </div>
            <div class="eligibility-info">
                <p>${message}</p>
            </div>
        `;
        
        container.appendChild(infoCard);
        document.getElementById('dynamic-content').innerHTML = '';
        document.getElementById('dynamic-content').appendChild(container);
    }
    
    // Setup event listeners for makeup session interactions
    function setupMakeupSessionEvents() {
        // Register button click
        const registerBtn = document.getElementById('register-makeup-btn');
        if (registerBtn) {
            registerBtn.addEventListener('click', () => {
                const selectedCourses = [];
                document.querySelectorAll('.makeup-course-item input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedCourses.push({
                        code: checkbox.value,
                        name: checkbox.dataset.name,
                        credits: checkbox.dataset.credits
                    });
                });
                
                if (selectedCourses.length === 0) {
                    showNotification('Please select at least one course to register', false);
                    return;
                }
                
                if (selectedCourses.length > 2) {
                    showNotification('You can select a maximum of 2 courses', false);
                    return;
                }
                
                // Show confirmation modal
                const confirmationList = document.getElementById('confirmation-courses-list');
                confirmationList.innerHTML = selectedCourses.map(course => `
                    <div class="confirmation-course-item">
                        <div class="confirmation-course-code">${course.code}</div>
                        <div class="confirmation-course-name">${course.name}</div>
                        <div class="confirmation-course-credits">${course.credits} credits</div>
                    </div>
                `).join('');
                
                const modal = document.querySelector('.makeup-confirmation-modal');
                modal.style.display = 'flex';
            });
        }
        
        // Cancel button in modal
        const cancelBtn = document.getElementById('cancel-makeup-btn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                const modal = document.querySelector('.makeup-confirmation-modal');
                modal.style.display = 'none';
            });
        }
        
        // Confirm registration button
        const confirmBtn = document.getElementById('confirm-makeup-btn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                const courseCodes = Array.from(
                    document.querySelectorAll('.makeup-course-item input[type="checkbox"]:checked')
                ).map(checkbox => checkbox.value);
                
                // Submit registration
                fetch('/student/makeup-session/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        courses: courseCodes
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const modal = document.querySelector('.makeup-confirmation-modal');
                    modal.style.display = 'none';
                    
                    if (data.success) {
                        showNotification(data.message, true);
                        // Disable registered course checkboxes
                        courseCodes.forEach(code => {
                            const checkbox = document.querySelector(`input[value="${code}"]`);
                            if (checkbox) {
                                checkbox.disabled = true;
                                checkbox.checked = true;
                                checkbox.closest('.makeup-course-item').classList.add('registered');
                            }
                        });
                    } else {
                        showNotification(data.message, false);
                    }
                })
                .catch(error => {
                    showNotification('An error occurred while registering', false);
                    const modal = document.querySelector('.makeup-confirmation-modal');
                    modal.style.display = 'none';
                });
            });
        }
    }
    
    // Show notification
    function showNotification(message, isSuccess) {
        const container = document.getElementById('notification-container');
        if (!container) return;
        
        const notification = document.createElement('div');
        notification.className = isSuccess ? 'notification success' : 'notification';
        notification.innerHTML = `<p>${message}</p>`;
        
        container.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
</script>

<!-- Add to the end of the body tag -->
<!-- Profile Modal -->
<div id="profile-modal" class="profile-modal">
    <div class="profile-modal-content">
        <div class="profile-modal-header">
            <h3><i class="fas fa-user-cog"></i> Personal Information</h3>
            <span class="profile-modal-close">&times;</span>
        </div>
        <div class="profile-modal-body">
            <div id="profile-success-message" class="profile-success-message"></div>
            <div id="profile-error-message" class="profile-error-message"></div>
            <div id="profile-form-container">
                <!-- Profile form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div id="password-modal" class="password-modal">
    <div class="password-modal-content">
        <div class="password-modal-header">
            <h3>Change Password</h3>
        </div>
        <div class="password-modal-body">
            <form id="password-form">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" required>
                    <div class="error-message">Current password is required</div>
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" required>
                    <div class="error-message">New password must be at least 8 characters</div>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" required>
                    <div class="error-message">Passwords do not match</div>
                </div>
            </form>
        </div>
        <div class="password-modal-footer">
            <button type="button" id="cancel-password-btn" class="cancel-btn">Cancel</button>
            <button type="button" id="save-password-btn" class="save-profile-btn">Change Password</button>
        </div>
    </div>
</div>

<!-- Profile Management Script -->
<script>
    // Add click event listener to profile picture
    document.addEventListener('DOMContentLoaded', function() {
        const profilePicture = document.querySelector('.profile-container .profile-picture');
        if (profilePicture) {
            profilePicture.addEventListener('click', function() {
                loadProfileInfo();
            });
        }
    });

    // Load profile information and show modal
    function loadProfileInfo() {
        const profileModal = document.getElementById('profile-modal');
        const formContainer = document.getElementById('profile-form-container');
        
        // Show loading state
        formContainer.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading profile information...</p></div>';
        profileModal.classList.add('active');
        
        // Close modal when clicking the close button
        document.querySelector('.profile-modal-close').addEventListener('click', function() {
            profileModal.classList.remove('active');
        });
        
        // Close modal when clicking outside the modal content
        window.addEventListener('click', function(event) {
            if (event.target === profileModal) {
                profileModal.classList.remove('active');
            }
        });
        
        // Fetch profile information
        fetch('/student/profile-info')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load profile data');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load profile data');
                }
                
                renderProfileForm(data.data);
            })
            .catch(error => {
                console.error('Error loading profile info:', error);
                formContainer.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h4>Error Loading Profile</h4>
                        <p>${error.message || 'An unexpected error occurred'}</p>
                        <button class="retry-btn" onclick="loadProfileInfo()">
                            <i class="fas fa-sync-alt"></i> Retry
                        </button>
                    </div>
                `;
            });
    }
    
    // Render profile form
    function renderProfileForm(profileData) {
        const formContainer = document.getElementById('profile-form-container');
        
        const html = `
            <form id="profile-form" class="profile-form">
                <div class="profile-picture-container">
                    <div class="profile-picture-preview" id="profile-picture-preview">
                        ${profileData.profile_picture ? 
                            `<img src="data:image/jpeg;base64,${profileData.profile_picture}" alt="Profile picture">` : 
                            `<img src="{{ url_for('static', filename='images/default-profile.jpg') }}" alt="Default profile picture">`}
                    </div>
                    <div class="profile-picture-upload">
                        <label for="profile-picture-input" ><i class="fas fa-camera"></i> Change Profile Picture</label>
                        <input type="file" id="profile-picture-input" accept="image/*">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="first-name">First Name</label>
                    <input type="text" id="first-name" value="${profileData.first_name || ''}">
                    <div class="error-message">First name is required</div>
                </div>
                
                <div class="form-group">
                    <label for="last-name">Last Name</label>
                    <input type="text" id="last-name" value="${profileData.last_name || ''}">
                    <div class="error-message">Last name is required</div>
                </div>
                
                <div class="form-group">
                    <label for="national-id">National ID</label>
                    <input type="text" id="national-id" value="${profileData.national_id || ''}" readonly>
                </div>
                
                <div class="form-group">
                    <label for="email">Primary Email</label>
                    <input type="email" id="email" value="${profileData.email_address || ''}" readonly>
                </div>
                
                <div class="form-group">
                    <label for="secondary-email">Secondary Email (Optional)</label>
                    <input type="email" id="secondary-email" value="${profileData.secondary_email_address || ''}">
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" value="${profileData.phone || ''}">
                </div>
                
                <div class="form-group">
                    <button type="button" id="change-password-btn" class="change-password-btn">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancel-profile-btn" class="cancel-btn">Cancel</button>
                    <button type="submit" id="save-profile-btn" class="save-profile-btn">Save Changes</button>
                </div>
            </form>
        `;
        
        formContainer.innerHTML = html;
        initProfileFormHandlers(profileData);
    }
    
    // Initialize profile form event handlers
    function initProfileFormHandlers(profileData) {
        // Handle profile picture upload
        const profilePictureInput = document.getElementById('profile-picture-input');
        const profilePicturePreview = document.getElementById('profile-picture-preview');
        
        profilePictureInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePicturePreview.innerHTML = `<img src="${e.target.result}" alt="Profile picture">`;
                };
                reader.readAsDataURL(this.files[0]);
            }
        });
        
        // Handle form submission
        const profileForm = document.getElementById('profile-form');
        profileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            let isValid = true;
            
            // Validate first name
            if (!firstName) {
                document.getElementById('first-name').parentElement.classList.add('error');
                isValid = false;
            } else {
                document.getElementById('first-name').parentElement.classList.remove('error');
            }
            
            // Validate last name
            if (!lastName) {
                document.getElementById('last-name').parentElement.classList.add('error');
                isValid = false;
            } else {
                document.getElementById('last-name').parentElement.classList.remove('error');
            }
            
            if (!isValid) return;
            
            // Get form data
            const formData = {
                first_name: firstName,
                last_name: lastName,
                phone: document.getElementById('phone').value.trim(),
                secondary_email_address: document.getElementById('secondary-email').value.trim()
            };
            
            // Check if profile picture has been changed
            const imgElement = profilePicturePreview.querySelector('img');
            if (imgElement && imgElement.src.includes('base64') && 
                (!profileData.profile_picture || 
                 imgElement.src !== `data:image/jpeg;base64,${profileData.profile_picture}`)) {
                formData.profile_picture = imgElement.src;
            }
            
            // Submit data
            fetch('/student/profile-info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showProfileSuccessMessage('Profile updated successfully');
                    
                    // Update stored profile data
                    profileData.first_name = formData.first_name;
                    profileData.last_name = formData.last_name;
                    profileData.phone = formData.phone;
                    profileData.secondary_email_address = formData.secondary_email_address;
                    if (formData.profile_picture) {
                        profileData.profile_picture = formData.profile_picture.split(',')[1];
                    }
                    
                    // Update the profile picture in the sidebar
                    if (formData.profile_picture) {
                        const sidebarProfilePic = document.querySelector('.profile-container .profile-picture');
                        if (sidebarProfilePic) {
                            sidebarProfilePic.src = formData.profile_picture;
                        }
                    }
                    
                    // Update name in sidebar
                    const studentName = document.querySelector('.student-info .student-name');
                    if (studentName) {
                        studentName.textContent = `${formData.first_name} ${formData.last_name}`;
                    }
                    
                } else {
                    showProfileErrorMessage(data.message || 'Failed to update profile');
                }
            })
            .catch(error => {
                console.error('Error updating profile:', error);
                showProfileErrorMessage('An error occurred while updating your profile');
            });
        });
        
        // Cancel button
        document.getElementById('cancel-profile-btn').addEventListener('click', function() {
            document.getElementById('profile-modal').classList.remove('active');
        });
        
        // Password change button
        const passwordModal = document.getElementById('password-modal');
        document.getElementById('change-password-btn').addEventListener('click', function() {
            passwordModal.classList.add('active');
        });
        
        // Cancel password change
        document.getElementById('cancel-password-btn').addEventListener('click', function() {
            passwordModal.classList.remove('active');
            document.getElementById('password-form').reset();
            document.querySelectorAll('#password-form .form-group').forEach(group => {
                group.classList.remove('error');
            });
        });
        
        // Save password
        document.getElementById('save-password-btn').addEventListener('click', function() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            let isValid = true;
            
            // Validate current password
            if (!currentPassword) {
                document.getElementById('current-password').parentElement.classList.add('error');
                isValid = false;
            } else {
                document.getElementById('current-password').parentElement.classList.remove('error');
            }
            
            // Validate new password
            if (!newPassword || newPassword.length < 8) {
                document.getElementById('new-password').parentElement.classList.add('error');
                isValid = false;
            } else {
                document.getElementById('new-password').parentElement.classList.remove('error');
            }
            
            // Validate password confirmation
            if (newPassword !== confirmPassword) {
                document.getElementById('confirm-password').parentElement.classList.add('error');
                isValid = false;
            } else {
                document.getElementById('confirm-password').parentElement.classList.remove('error');
            }
            
            if (!isValid) return;
            
            // Submit password change request
            fetch('/student/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    passwordModal.classList.remove('active');
                    document.getElementById('password-form').reset();
                    showProfileSuccessMessage('Password changed successfully');
                } else {
                    document.getElementById('current-password').parentElement.classList.add('error');
                    document.getElementById('current-password').parentElement.querySelector('.error-message').textContent = 
                        data.message || 'Failed to change password';
                }
            })
            .catch(error => {
                console.error('Error changing password:', error);
                passwordModal.classList.remove('active');
                showProfileErrorMessage('An error occurred while changing your password');
            });
        });
    }
    
    function showProfileSuccessMessage(message) {
        const messageElement = document.getElementById('profile-success-message');
        messageElement.textContent = message;
        messageElement.style.display = 'block';
        
        // Hide after 5 seconds
        setTimeout(() => {
            messageElement.style.display = 'none';
        }, 5000);
    }
    
    function showProfileErrorMessage(message) {
        const messageElement = document.getElementById('profile-error-message');
        messageElement.textContent = message;
        messageElement.style.display = 'block';
        
        // Hide after 5 seconds
        setTimeout(() => {
            messageElement.style.display = 'none';
        }, 5000);
    }
</script>


<!-- Graduation Celebration Overlay -->
<div id="graduation-overlay" class="graduation-overlay" style="display: none;">
    <div class="graduation-container">
        <div class="graduation-header">
            <div class="graduation-cap">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1 class="graduation-title">Congratulations Graduate!</h1>
            <h2 class="graduation-subtitle">You've Successfully Completed Your Degree</h2>
        </div>
        
        <div class="graduation-message">
            <p>We are proud to announce that you have successfully met all the requirements for graduation. Your hard work, dedication, and perseverance have paid off!</p>
            <p>Your academic records are now finalized, and your account has been updated to reflect your graduated status.</p>
        </div>
        
        <button id="graduation-acknowledge-btn" class="graduation-button">Thank You!</button>
        
        <!-- Confetti animation -->
        <div class="confetti-container">
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
            <div class="confetti-piece"></div>
        </div>
    </div>
</div>

<!-- Graduation Check Script -->
<script>
    // Check if student is graduated when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Check if the student is graduated from session data
        const studentData = JSON.parse(localStorage.getItem('studentData') || '{}');
        const isGraduated = studentData.is_graduated || false;
        
        // If the student is graduated, show the celebration overlay
        if (isGraduated) {
            showGraduationCelebration();
        }
        
        // Check with the server for the most up-to-date status
        fetch('/student/profile-info')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update local storage with latest data
                    localStorage.setItem('studentData', JSON.stringify({
                        ...studentData,
                        is_graduated: data.data.is_graduated
                    }));
                    
                    // If student is graduated and celebration not shown yet, show it
                    if (data.data.is_graduated && !isGraduated) {
                        showGraduationCelebration();
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching student profile data:', error);
            });
    });
    
    // Function to show graduation celebration
    function showGraduationCelebration() {
        const overlay = document.getElementById('graduation-overlay');
        overlay.style.display = 'flex';
        
        // Add event listener to the acknowledgment button
        document.getElementById('graduation-acknowledge-btn').addEventListener('click', function() {
            overlay.style.display = 'none';
        });
        
        // Disable all interactive elements except in the profile section
        const interactiveElements = document.querySelectorAll('button:not(#graduation-acknowledge-btn):not(#profile-btn), input, select, a.sidebar-menu-item:not([href="#profile"])');
        interactiveElements.forEach(element => {
            element.disabled = true;
            element.classList.add('disabled');
            
            // For anchor tags
            if (element.tagName === 'A') {
                element.addEventListener('click', function(e) {
                    if (!element.href.includes('#profile')) {
                        e.preventDefault();
                    }
                });
            }
        });
    }
</script>
</body>
</html>