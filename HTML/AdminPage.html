<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal</title>
    <link rel="icon" href="{{ url_for('static', filename='images/TBS_favicon.png') }}" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='myCSS/styles2.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    

    
    <!-- Statistics JavaScript -->
    <script>
        // Statistics Section Handler
        function loadStatisticsSection() {
            // Set the page title to Dashboard
            document.getElementById('content-title').textContent = 'Dashboard';
            
            // Reset dashboard state to prevent duplicates
            window.dashboardInitialized = false;
            
            const template = document.getElementById('statistics-template');
            const content = template.content.cloneNode(true);
            const container = document.getElementById('dynamic-content');
            container.innerHTML = '';
            container.appendChild(content);

            // Fetch statistics data with default filters (all years, all semesters)
            fetchStatistics('all', 'all');
            
            // Setup filter event listeners
            setupFilters();
            
            // Initialize additional statistics features with a slight delay
            // to ensure the DOM is fully updated
            setTimeout(initStatisticsFeatures, 100);
        }
        
        function setupFilters() {
            const yearFilter = document.getElementById('year-filter');
            const semesterFilter = document.getElementById('semester-filter');
            
            // Add change event listeners to automatically apply filters
            yearFilter.addEventListener('change', function() {
                const year = yearFilter.value;
                const semester = semesterFilter.value;
                fetchStatistics(year, semester);
            });
            
            semesterFilter.addEventListener('change', function() {
                const year = yearFilter.value;
                const semester = semesterFilter.value;
                fetchStatistics(year, semester);
            });
        }
        
        function fetchStatistics(year, semester) {
            const tableBody = document.getElementById('course-performance-table-body').querySelector('tbody');
            
            // Show loading indicator
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading course statistics...</p>
                    </td>
                </tr>
            `;
            
            // Construct URL with filters
            let url = '/admin/statistics';
            const params = new URLSearchParams();
            if (year !== 'all') params.append('year', year);
            if (semester !== 'all') params.append('semester', semester);
            if (params.toString()) url += '?' + params.toString();
            
            console.log("Fetching statistics from:", url);
            
            // Fetch data from API
            fetch(url)
                .then(response => {
                    console.log("Response status:", response.status);
                    if (!response.ok) {
                        throw new Error(`Network response error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received data:", data);
                    if (data.success) {
                        // Populate filter dropdowns
                        populateFilterDropdowns(data.years, data.semesters, year, semester);
                        
                        // Populate course performance table
                        populateCourseTable(data.course_statistics, tableBody);
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="4" class="no-data">
                                    Error: ${data.message || 'Could not load statistics'}
                                </td>
                            </tr>
                        `;
                        console.error('API Error:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching statistics:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="no-data">
                                An error occurred while loading statistics. Please try again.<br>
                                Error details: ${error.message}
                            </td>
                        </tr>
                    `;
                });
        }
        
        function populateFilterDropdowns(years, semesters, currentYear, currentSemester) {
            const yearFilter = document.getElementById('year-filter');
            const semesterFilter = document.getElementById('semester-filter');
            
            if (!yearFilter || !semesterFilter) {
                console.error('Filter elements not found');
                return;
            }
            
            // Save current selections
            currentYear = currentYear || yearFilter.value;
            currentSemester = currentSemester || semesterFilter.value;
            
            // Clear existing options except the "All" option
            while (yearFilter.options.length > 1) {
                yearFilter.remove(1);
            }
            
            while (semesterFilter.options.length > 1) {
                semesterFilter.remove(1);
            }
            
            console.log("Populating years:", years);
            console.log("Populating semesters:", semesters);
            
            // Add year options
            if (years && years.length > 0) {
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
            } else {
                console.warn('No years data available');
            }
            
            // Add semester options
            if (semesters && semesters.length > 0) {
                semesters.forEach(semester => {
                    const option = document.createElement('option');
                    option.value = semester;
                    option.textContent = getSemesterName(semester);
                    semesterFilter.appendChild(option);
                });
                    } else {
                console.warn('No semesters data available');
            }
            
            // Restore the selected values if they still exist
            try {
                // Try to set the year value
                if (currentYear && currentYear !== 'all') {
                    // Check if the option exists
                    const yearExists = Array.from(yearFilter.options).some(opt => opt.value === currentYear.toString());
                    yearFilter.value = yearExists ? currentYear : 'all';
                } else {
                    yearFilter.value = 'all';
                }
                
                // Try to set the semester value
                if (currentSemester && currentSemester !== 'all') {
                    // Check if the option exists
                    const semesterExists = Array.from(semesterFilter.options).some(opt => opt.value === currentSemester.toString());
                    semesterFilter.value = semesterExists ? currentSemester : 'all';
                } else {
                    semesterFilter.value = 'all';
                }
            } catch (e) {
                console.error('Error restoring filter values:', e);
                // Reset to 'all' if there's any error
                yearFilter.value = 'all';
                semesterFilter.value = 'all';
            }
        }
        
        function getSemesterName(semesterNum) {
            switch(parseInt(semesterNum)) {
                case 1: return 'Fall';
                case 2: return 'Spring';
            }
        }
        
        function populateCourseTable(courses, tableBody) {
            // Clear existing rows
            tableBody.innerHTML = '';
            
            if (!courses || courses.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="no-data">
                            No course data available for the selected filters.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Get header widths to match column widths
            const headerTable = document.getElementById('course-performance-table');
            const headerCells = headerTable.querySelectorAll('th');
            
            // Synchronize column widths with header
            const colWidths = [];
            headerCells.forEach((cell, index) => {
                colWidths[index] = cell.getBoundingClientRect().width;
            });
            
            // Add rows for each course
            courses.forEach(course => {
                const row = document.createElement('tr');
                
                // Course code cell
                const codeCell = document.createElement('td');
                codeCell.textContent = course.course_code;
                if (colWidths[0]) codeCell.style.width = `${colWidths[0]}px`;
                row.appendChild(codeCell);
                
                // First-time pass rate cell
                const passRateCell = document.createElement('td');
                const passRateValue = (course.first_time_pass_rate * 100).toFixed(1) + '%';
                passRateCell.textContent = passRateValue;
                if (colWidths[1]) passRateCell.style.width = `${colWidths[1]}px`;
                row.appendChild(passRateCell);
                
                // Forgiveness usage percentage cell
                const forgivenessCell = document.createElement('td');
                const forgivenessPercent = (course.forgiveness_percentage * 100).toFixed(1) + '%';
                forgivenessCell.textContent = forgivenessPercent;
                if (colWidths[2]) forgivenessCell.style.width = `${colWidths[2]}px`;
                row.appendChild(forgivenessCell);
                
                // Average grade cell
                const gradeCell = document.createElement('td');
                gradeCell.textContent = course.average_grade.toFixed(2);
                if (colWidths[3]) gradeCell.style.width = `${colWidths[3]}px`;
                row.appendChild(gradeCell);
                
                tableBody.appendChild(row);
            });
        }

        // Event listener will be added through the main navigation system
        // to avoid duplicate listeners that cause the dashboard to require two clicks
    </script>

</head>

<body>
    <!-- Notification Container -->
    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <!-- Add theme toggle button -->
    <button class="theme-toggle" id="theme-toggle" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i>
    </button>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Admin Portal</h2>
            <div class="admin-profile-vertical">
                <div class="profile-picture-wrapper">
                    {% if session.admin.profile_image %}
                        <img src="data:image/jpeg;base64,{{ session.admin.profile_image }}" class="profile-picture" alt="Profile Picture">
                    {% else %}
                        <img src="{{ url_for('static', filename='images/default-profile-admin.jpg') }}" class="profile-picture" alt="Profile Picture">
                    {% endif %}
                </div>
                <div class="admin-info">
                    <div class="admin-name">{{ session.admin.first_name }} {{ session.admin.last_name }}</div>
                    <div class="admin-title">Administrator</div>
                </div>
            </div>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#course-registration" data-section="course-registration">
                <i class="fas fa-book"></i> Mng. & Req. Handling
            </a></li>
            <li><a href="#major-minor-validation" data-section="major-minor-validation">
                <i class="fas fa-graduation-cap"></i> Major/Minor Validation
            </a></li>
            <li><a href="#system-adjustments" data-section="system-adjustments">
                <i class="fas fa-cogs"></i> Settings & Adjustments
            </a></li>
            <li><a href="#Statistics" data-section="statistics">
                <i class="fas fa-chart-bar"></i> Dashboard
            </a></li>
            <li class="logout-item">
                <a href="{{ url_for('login_bp.logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </div>
    
    <div class="main-content">
        <div class="content-header">
            <h1 id="content-title">Welcome to Admin Portal </h1>
        </div>
        
        <!-- Inline Message Container -->
        <div id="inline-message" style="margin: 10px 0; display: none;"></div>
        
        <div id="dynamic-content">
            <p>Please select an option from the sidebar to continue.</p>
        </div>

        <!-- Statistics Section Template -->
        <template id="statistics-template">
            <div class="statistics-container">
                <!-- Left side for charts -->
                <div class="charts-area">
                    <!-- Semester Info Box -->
                    <div class="semester-info-box">
                        <div class="info-box-accent"></div>
                        <div class="semester-info-content">
                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-calendar-alt"></i> Semester:</span>
                                <span class="info-value" id="current-semester-value">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-calendar-day"></i> Year:</span>
                                <span class="info-value" id="current-year-value">--</span>
                            </div>
                            <div class="info-divider"></div>
                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-user-graduate"></i> Enrolled Students:</span>
                                <span class="info-value" id="enrolled-students-count">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label"><i class="fas fa-book"></i> Courses in Curriculum:</span>
                                <span class="info-value" id="curriculum-courses-count">--</span>
                            </div>
                        </div>
                    </div>
                    <!-- More charts can be added here later -->
                </div>
                
                <!-- Table area -->
                <div class="table-area">
                    <div class="stat-card">
                        <h3>Course Performance Statistics</h3>
                        <div class="filters-container">
                            <div class="filter-group">
                                <label for="year-filter">Academic Year:</label>
                                <select id="year-filter" class="filter-select">
                                    <option value="all">All Years</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="semester-filter">Semester:</label>
                                <select id="semester-filter" class="filter-select">
                                    <option value="all">All Semesters</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="search-container">
                            <input type="text" id="course-search" class="course-search" placeholder="Search by course code">
                        </div>
                        
                        <table class="stat-table" id="course-performance-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="course_code">Course Code <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="first_time_pass_rate">First-Time Pass Rate <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="forgiveness_percentage">Forgiveness Usage <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="average_grade">Average Grade <i class="fas fa-sort"></i></th>
                                </tr>
                            </thead>
                        </table>
                        <div class="scrollable-table">
                            <table class="stat-table" id="course-performance-table-body">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Custom statistics charts row -->
                    <div class="stats-charts-container">
                        <!-- GPA by Major Spider Chart -->
                        <div class="stats-chart-box">
                            <div class="chart-header">
                                <h4>GPA by Major</h4>
                                <div class="chart-controls">
                                    <select id="student-type-filter">
                                        <option value="enrolled">Enrolled Students</option>
                                        <option value="graduated">Graduated Students</option>
                                        <option value="all">All Students</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-content">
                                <canvas id="gpa-by-major-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Course Enrollment Chart -->
                        <div class="stats-chart-box">
                            <div class="chart-header">
                                <h4>Course Enrollment Distribution</h4>
                            </div>
                            <div class="chart-content">
                                <canvas id="course-enrollment-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

 

<script>
// Add directly executable code for sorting and searching functionality
document.addEventListener('DOMContentLoaded', function() {
    // We'll initialize the statistics features directly in the loadStatisticsSection function
    // to ensure it only happens once
    
    // Initialize if we're already on the statistics page on load
    // but only if it's the first load of the page
    if (window.location.hash === '#statistics' && !window.dashboardInitialized) {
        window.dashboardInitialized = true;
        setTimeout(initStatisticsFeatures, 100);
    }
});

function initStatisticsFeatures() {
    console.log('Initializing statistics features');
    
    // Track initialization to prevent duplicates
    window.dashboardInitialized = true;
    window.courseData = [];
    
    // Save reference to student type preference
    window.lastStudentTypeFilter = window.lastStudentTypeFilter || 'enrolled';
    
    loadSemesterInfoData();
    createCharts();
    fetchStatisticsData().then(() => {
        setupSortingAndSearchHandlers();
    });
    
    // Load our custom charts - use the saved preference if available
    loadGpaByMajorChart(window.lastStudentTypeFilter);
    loadCourseEnrollmentChart();
    
    // Setup event listener for student type filter to save preference
    setTimeout(() => {
        const studentTypeFilter = document.getElementById('student-type-filter');
        if (studentTypeFilter && !studentTypeFilter.hasAttribute('data-listener-attached')) {
            studentTypeFilter.value = window.lastStudentTypeFilter;
            studentTypeFilter.setAttribute('data-listener-attached', 'true');
            
            studentTypeFilter.addEventListener('change', function() {
                window.lastStudentTypeFilter = this.value;
                loadGpaByMajorChart(this.value);
            });
        }
    }, 200);
}

function createCharts() {
    // Find charts area container
    const chartsArea = document.querySelector('.charts-area');
    if (!chartsArea) {
        console.error('Charts area not found');
        return;
    }
    
    // Check if charts already exist to avoid duplicates
    if (chartsArea.querySelector('.charts-row')) {
        console.log('Charts already exist, just loading data');
        
        // Just load the chart data without creating new containers
        loadStudentLevelsChart();
        loadMajorDistributionChart();
        loadGraduationTimeChart();
        return;
    }
    
    console.log('Creating new chart containers');
    
    // Create charts row
    const chartsRow = document.createElement('div');
    chartsRow.className = 'charts-row';
    
    // Create student levels chart container
    const levelsChartContainer = createChartContainer('Student Levels', 'chart-pie', 'student-levels-chart');
    
    // Create major distribution chart container
    const majorChartContainer = createChartContainer('Major Distribution', 'chart-pie', 'major-distribution-chart', true);
    
    // Add containers to the row
    chartsRow.appendChild(levelsChartContainer);
    chartsRow.appendChild(majorChartContainer);
    
    // Insert after the semester info box
    const semesterInfoBox = chartsArea.querySelector('.semester-info-box');
    if (semesterInfoBox) {
        semesterInfoBox.after(chartsRow);
    } else {
        chartsArea.appendChild(chartsRow);
    }
    
    // Create graduation time chart (full width)
    const graduationChartContainer = createChartContainer('Years to graduate', 'chart-bar', 'graduation-time-chart');
    graduationChartContainer.classList.add('full-width-chart');
    
    // Insert after the first row of charts
    chartsRow.after(graduationChartContainer);
    
    // Now load the chart data
    loadStudentLevelsChart();
    loadMajorDistributionChart();
    loadGraduationTimeChart();
}

function createChartContainer(title, iconName, canvasId, isDonut = false) {
    // Create container
    const container = document.createElement('div');
    container.className = 'chart-container';
    
    // Create title
    const titleElement = document.createElement('h4');
    titleElement.className = 'chart-title';
    titleElement.innerHTML = `<i class="fas fa-${iconName}"></i> ${title}`;
    
    // Create chart wrapper
    const chartWrapper = document.createElement('div');
    chartWrapper.className = isDonut ? 'chart-wrapper donut-wrapper' : 'chart-wrapper';
    
    // Create canvas
    const canvas = document.createElement('canvas');
    canvas.id = canvasId;
    
    // Add elements to container
    chartWrapper.appendChild(canvas);
    container.appendChild(titleElement);
    container.appendChild(chartWrapper);
    
    // Add donut center if needed
    if (isDonut) {
        const donutCenter = document.createElement('div');
        donutCenter.className = 'donut-center';
        
        const donutNumber = document.createElement('span');
        donutNumber.className = 'donut-number';
        donutNumber.id = 'total-majors-count';
        donutNumber.textContent = '--';
        
        const donutLabel = document.createElement('span');
        donutLabel.className = 'donut-label';
        donutLabel.textContent = 'Total';
        
        donutCenter.appendChild(donutNumber);
        donutCenter.appendChild(donutLabel);
        chartWrapper.appendChild(donutCenter);
    }
    
    return container;
}

function loadStudentLevelsChart() {
    // Fetch student levels data
    fetch('/admin/statistics?chart_type=student_levels')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createStudentLevelsChart(data.levels_data);
            } 
        })
        }

function createStudentLevelsChart(levelsData) {
    const canvas = document.getElementById('student-levels-chart');
    if (!canvas) {
        console.error('Student levels chart canvas not found');
        return;
    }
    
    // Destroy existing chart if it exists
    if (window.studentLevelsChart) {
        window.studentLevelsChart.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    
    // Extract labels and data
    const labels = levelsData.map(item => item.level);
    const data = levelsData.map(item => item.count);
    
    // Define colors with vibrant gradients
    const backgroundColors = [
        'rgba(56, 178, 255, 0.85)',  // vibrant blue
        'rgba(29, 209, 161, 0.85)',  // vibrant green
        'rgba(252, 92, 125, 0.85)',  // vibrant pink
        'rgba(254, 164, 27, 0.85)',  // vibrant orange
        'rgba(108, 92, 231, 0.85)'   // vibrant purple
    ];
    
    // Create chart
    // Set global shadow for all charts in this chart
    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 4;
    
    window.studentLevelsChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderColor: '#fff',
                borderWidth: 3,
                borderRadius: 6,
                hoverOffset: 15,
                hoverBorderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1500,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function loadMajorDistributionChart() {
    // Fetch major distribution data
    fetch('/admin/statistics?chart_type=major_distribution')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createMajorDistributionChart(data.major_data);
                updateTotalMajorsCount(data.total_majors);
            } else {
                console.error('Failed to load major distribution data:', data.message);

                createMajorDistributionChart(dummyData);
                updateTotalMajorsCount(dummyData.reduce((sum, item) => sum + item.count, 0));
            }
        })
        .catch(error => {
            console.error('Error fetching major distribution data:', error);
            
            createMajorDistributionChart(dummyData);
            updateTotalMajorsCount(dummyData.reduce((sum, item) => sum + item.count, 0));
        });
}

function createMajorDistributionChart(majorData) {
    const canvas = document.getElementById('major-distribution-chart');
    if (!canvas) {
        console.error('Major distribution chart canvas not found');
        return;
    }
    
    // Destroy existing chart if it exists
    if (window.majorDistributionChart) {
        window.majorDistributionChart.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    
    // Extract labels and data
    const labels = majorData.map(item => item.major_type);
    const data = majorData.map(item => item.count);
    
    // Define colors with modern gradient effect
    const backgroundColors = [
        'rgba(56, 178, 255, 0.9)',   // vibrant blue
        'rgba(29, 209, 161, 0.9)',   // vibrant green
        'rgba(252, 92, 125, 0.9)',   // vibrant pink
        'rgba(254, 164, 27, 0.9)',   // vibrant orange
        'rgba(108, 92, 231, 0.9)',   // vibrant purple
        'rgba(255, 94, 87, 0.9)'     // vibrant red
    ];
    
    // Create chart
    // Set global shadow for the donut chart
    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 4;
    
    window.majorDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderColor: '#fff',
                borderWidth: 3,
                borderRadius: 10,
                hoverOffset: 15,
                hoverBorderWidth: 0,
                cutout: '75%',
                spacing: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1800,
                easing: 'easeOutCirc'
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateTotalMajorsCount(total) {
    const totalMajorsElement = document.getElementById('total-majors-count');
    if (totalMajorsElement) {
        totalMajorsElement.textContent = total;
    }
}

function loadSemesterInfoData() {
    // Fetch current semester info
    fetch('/admin/course_registration?section=semester_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateSemesterInfo(data);
                
                // Now fetch students and courses count
                fetchEnrolledStudentsCount();
                fetchCurriculumCoursesCount();
            } else {
                console.error('Failed to load semester info:', data.message);
            }
        })
        .catch(error => {
            console.error('Error fetching semester info:', error);
        });
}

function updateSemesterInfo(data) {
    const currentSemesterElement = document.getElementById('current-semester-value');
    const currentYearElement = document.getElementById('current-year-value');
    
    if (data.current_semester && data.current_semester.is_current) {
        // Get semester name
        const semesterNumber = data.current_semester.semester;
        let semesterName;
        switch(semesterNumber) {
            case 1: semesterName = 'Fall'; break;
            case 2: semesterName = 'Spring'; break;
            default: semesterName = 'Semester ' + semesterNumber;
        }
        
        // Update semester and year
        if (currentSemesterElement) {
            currentSemesterElement.textContent = semesterName;
        }
        
        if (currentYearElement) {
            currentYearElement.textContent = data.current_semester.academic_year;
        }
    } else {
        // No active semester
        if (currentSemesterElement) {
            currentSemesterElement.textContent = '--';
        }
        
        // Set the current calendar year
        if (currentYearElement) {
            currentYearElement.textContent = new Date().getFullYear();
        }
    }
}

function fetchEnrolledStudentsCount() {
    // Create a custom endpoint or use an existing one
    fetch('/admin/statistics?count_type=enrolled_students')
        .then(response => response.json())
        .then(data => {
            const enrolledCountElement = document.getElementById('enrolled-students-count');
            if (enrolledCountElement) {
                if (data.success && data.enrolled_count !== undefined) {
                    enrolledCountElement.textContent = data.enrolled_count;
                } else {
                    // Make a direct database query instead
                    makeDirectStudentCountQuery();
                }
            }
        })
        .catch(error => {
            console.error('Error fetching enrolled students count:', error);
            // Try direct database query as fallback
            makeDirectStudentCountQuery();
        });
}

function makeDirectStudentCountQuery() {
    // Query the database directly for enrolled students count
    fetch('/admin/statistics?query=direct&type=students&status=enrolled')
        .then(response => response.json())
        .then(data => {
            const enrolledCountElement = document.getElementById('enrolled-students-count');
            if (enrolledCountElement && data.success && data.count !== undefined) {
                enrolledCountElement.textContent = data.count;
            } else {
                // If all else fails, just show a placeholder
                if (enrolledCountElement) enrolledCountElement.textContent = '--';
            }
        })
        .catch(error => {
            console.error('Error with direct student count query:', error);
            const enrolledCountElement = document.getElementById('enrolled-students-count');
            if (enrolledCountElement) enrolledCountElement.textContent = '--';
        });
}

function fetchCurriculumCoursesCount() {
    // Create a custom endpoint or use an existing one
    fetch('/admin/statistics?count_type=curriculum_courses')
        .then(response => response.json())
        .then(data => {
            const coursesCountElement = document.getElementById('curriculum-courses-count');
            if (coursesCountElement) {
                if (data.success && data.courses_count !== undefined) {
                    coursesCountElement.textContent = data.courses_count;
                } else {
                    // Make a direct database query instead
                    makeDirectCoursesCountQuery();
                }
            }
        })
        .catch(error => {
            console.error('Error fetching curriculum courses count:', error);
            // Try direct database query as fallback
            makeDirectCoursesCountQuery();
        });
}

function makeDirectCoursesCountQuery() {
    // Query the database directly for curriculum courses count
    fetch('/admin/statistics?query=direct&type=courses&in_curriculum=1')
        .then(response => response.json())
        .then(data => {
            const coursesCountElement = document.getElementById('curriculum-courses-count');
            if (coursesCountElement && data.success && data.count !== undefined) {
                coursesCountElement.textContent = data.count;
            } else {
                // If all else fails, just show a placeholder
                if (coursesCountElement) coursesCountElement.textContent = '--';
            }
        })
        .catch(error => {
            console.error('Error with direct courses count query:', error);
            const coursesCountElement = document.getElementById('curriculum-courses-count');
            if (coursesCountElement) coursesCountElement.textContent = '--';
        });
}

function fetchStatisticsData() {
    // Get current filters
    const yearFilter = document.getElementById('year-filter');
    const semesterFilter = document.getElementById('semester-filter');
    
    const year = yearFilter ? yearFilter.value : 'all';
    const semester = semesterFilter ? semesterFilter.value : 'all';
    
    // Construct URL with filters
    let url = '/admin/statistics';
    const params = new URLSearchParams();
    if (year !== 'all') params.append('year', year);
    if (semester !== 'all') params.append('semester', semester);
    if (params.toString()) url += '?' + params.toString();
    
    console.log("Directly fetching statistics from:", url);
    
    // Return promise for chaining
    return fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Received direct data:", data);
            if (data.success) {
                // Store the data globally
                window.courseData = data.course_statistics || [];
                console.log("Stored course data:", window.courseData.length, "items");
            }
        })
        .catch(error => {
            console.error('Error fetching statistics:', error);
        });
}

function setupSortingAndSearchHandlers() {
    // Add event listeners for sorting
    const headers = document.querySelectorAll('.sortable');
    headers.forEach(header => {
        // Remove any existing event listeners by cloning and replacing
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);
        
        // Add fresh click event listener
        newHeader.addEventListener('click', function() {
            console.log('Column header clicked:', this.getAttribute('data-sort'));
            const column = this.getAttribute('data-sort');
            const currentDirection = this.getAttribute('data-direction') || 'none';
            let newDirection = 'asc';
            
            // Reset all headers
            document.querySelectorAll('.sortable').forEach(h => {
                h.setAttribute('data-direction', 'none');
                const icon = h.querySelector('i');
                if (icon) icon.className = 'fas fa-sort';
            });
            
            // Set new direction
            if (currentDirection === 'asc') {
                newDirection = 'desc';
                const icon = this.querySelector('i');
                if (icon) icon.className = 'fas fa-sort-down';
            } else {
                const icon = this.querySelector('i');
                if (icon) icon.className = 'fas fa-sort-up';
            }
            
            this.setAttribute('data-direction', newDirection);
            
            // Sort the table
            sortTable(column, newDirection);
        });
    });
    
    // Add event listener for search
    const searchInput = document.getElementById('course-search');
    if (searchInput) {
        // Remove any existing event listeners by cloning and replacing
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        
        // Add fresh input event listener
        newSearchInput.addEventListener('input', function() {
            console.log('Search input:', this.value);
            filterTable(this.value.trim().toLowerCase());
        });
    } else {
        console.error('Search input not found');
    }
}

function sortTable(column, direction) {
    if (!window.courseData || !window.courseData.length) {
        console.error('No course data available for sorting');
        return;
    }
    
    console.log(`Sorting by ${column} in ${direction} order`, window.courseData);
    
    // Sort the data
    const sortedData = [...window.courseData].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];
        
        // For numerical values
        if (typeof valA === 'number' && typeof valB === 'number') {
            return direction === 'asc' ? valA - valB : valB - valA;
        }
        
        // Handle null/undefined values
        if (valA === null || valA === undefined) return direction === 'asc' ? -1 : 1;
        if (valB === null || valB === undefined) return direction === 'asc' ? 1 : -1;
        
        // For string values
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
        
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Update the table directly
    updateTableWithData(sortedData);
}

function filterTable(searchTerm) {
    if (!window.courseData) {
        console.error('No course data available for filtering');
        return;
    }
    
    console.log('Filtering table with search term:', searchTerm);
    
    if (!searchTerm) {
        // If empty search, show all data
        updateTableWithData(window.courseData);
        return;
    }
    
    // Filter data by course code
    const filteredData = window.courseData.filter(course => {
        if (!course.course_code) return false;
        return course.course_code.toLowerCase().includes(searchTerm);
    });
    
    console.log('Filtered results:', filteredData.length, 'items');
    
    // Update the table directly
    updateTableWithData(filteredData);
}

function updateTableWithData(courses) {
    const tableBody = document.querySelector('#course-performance-table-body tbody');
    if (!tableBody) {
        console.error('Table body not found');
        return;
    }
    
    // Clear existing rows
    tableBody.innerHTML = '';
    
    if (!courses || courses.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="4" class="no-data">
                    No matching courses found.
                </td>
            </tr>
        `;
        return;
    }
    
    // Add rows for each course
    courses.forEach(course => {
        const row = document.createElement('tr');
        
        // Course code cell
        const codeCell = document.createElement('td');
        codeCell.textContent = course.course_code || '';
        row.appendChild(codeCell);
        
        // First-time pass rate cell
        const passRateCell = document.createElement('td');
        const passRate = course.first_time_pass_rate;
        const passRateValue = (passRate !== null && passRate !== undefined) ? 
            (passRate * 100).toFixed(1) + '%' : 'N/A';
        passRateCell.textContent = passRateValue;
        row.appendChild(passRateCell);
        
        // Forgiveness usage percentage cell
        const forgivenessCell = document.createElement('td');
        const forgiveness = course.forgiveness_percentage;
        const forgivenessPercent = (forgiveness !== null && forgiveness !== undefined) ? 
            (forgiveness * 100).toFixed(1) + '%' : 'N/A';
        forgivenessCell.textContent = forgivenessPercent;
        row.appendChild(forgivenessCell);
        
        // Average grade cell
        const gradeCell = document.createElement('td');
        const avgGrade = course.average_grade;
        gradeCell.textContent = (avgGrade !== null && avgGrade !== undefined) ? 
            avgGrade.toFixed(2) : 'N/A';
        row.appendChild(gradeCell);
        
        tableBody.appendChild(row);
    });
}

// Move showStudentDetails function outside DOMContentLoaded
function showStudentDetails(studentId) {
    console.log('Showing details for student:', studentId);
    
    // Make sure the modal exists
    let modal = document.getElementById('student-modal');
    if (!modal) {
        console.log('Creating student modal');
        // Create the modal if it doesn't exist
        modal = document.createElement('div');
        modal.id = 'student-modal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div class="student-profile">
                    <div class="profile-header">
                        <img id="student-profile-pic" src="" alt="Profile Picture" class="profile-picture">
                        <h3 id="student-full-name"></h3>
                    </div>
                    <div class="profile-details">
                        <div class="detail-row">
                            <span class="detail-label">National ID:</span>
                            <span id="student-national-id"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span id="student-email"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Academic Year:</span>
                            <span id="student-year"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Level:</span>
                            <span id="student-level"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Group:</span>
                            <span id="student-group"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span id="student-phone"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Cumulative GPA:</span>
                            <span id="student-gpa"></span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Show the modal
    modal.style.display = 'block';
    
    // Update modal content to show loading
    const profilePic = document.getElementById('student-profile-pic');
    const fullName = document.getElementById('student-full-name');
    const nationalId = document.getElementById('student-national-id');
    const email = document.getElementById('student-email');
    const year = document.getElementById('student-year');
    const group = document.getElementById('student-group');
    const phone = document.getElementById('student-phone');
    const gpa = document.getElementById('student-gpa');
    const level = document.getElementById('student-level');
    
    if (profilePic) profilePic.src = '/static/images/default-profile.jpg';
    if (fullName) fullName.textContent = 'Loading...';
    if (nationalId) nationalId.textContent = '--';
    if (email) email.textContent = '--';
    if (year) year.textContent = '--';
    if (group) group.textContent = '--';
    if (phone) phone.textContent = '--';
    if (gpa) gpa.textContent = '--';
    if (level) level.textContent = '--';

    // Setup close button event listener
    const closeButton = modal.querySelector('.close-modal');
    if (closeButton) {
        // Remove existing event listeners to avoid duplicates
        const newCloseButton = closeButton.cloneNode(true);
        closeButton.parentNode.replaceChild(newCloseButton, closeButton);
        
        // Add new event listener
        newCloseButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });
    }
    
    // Setup click outside to close
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    };

    // Function to fetch student data
    function fetchStudentData() {
        // Use fetch API instead of jQuery to avoid dependency
        fetch(`/admin/major_minor_validation/${studentId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch student data');
                }
                return response.json();
            })
            .then(response => {
                console.log('Received student data:', response);
                
                if (response.success) {
                    const student = response.student;
                    const gpaValue = response.cumulative_gpa;
                    
                    // Update modal content
                    const profilePic = document.getElementById('student-profile-pic');
                    const fullName = document.getElementById('student-full-name');
                    const nationalId = document.getElementById('student-national-id');
                    const email = document.getElementById('student-email');
                    const year = document.getElementById('student-year');
                    const group = document.getElementById('student-group');
                    const phone = document.getElementById('student-phone');
                    const gpa = document.getElementById('student-gpa');
                    const level = document.getElementById('student-level');
                    
                    // Set profile picture based on whether student has one or use default
                    if (profilePic) {
                        if (student.has_profile_picture) {
                            profilePic.src = `/admin/student-profile-image/${student.national_id}`;
                        } else {
                            profilePic.src = '/static/images/default-profile.jpg';
                        }
                    }
                    if (fullName) fullName.textContent = `${student.first_name} ${student.last_name}`;
                    if (nationalId) nationalId.textContent = student.national_id || '--';
                    if (email) email.textContent = student.email_address || '--';
                    if (year) year.textContent = student.year_of_study || '--';
                    if (group) group.textContent = student.group || '--';
                    if (phone) phone.textContent = student.phone || '--';
                    if (gpa) gpa.textContent = gpaValue ? gpaValue.toFixed(2) : '--';
                    if (level) level.textContent = student.level || '--';
                } else {
                    showToast('Error loading student details: ' + (response.message || 'Unknown error'), 'error');
                    modal.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching student details:', error);
                showToast('Error loading student details: ' + error, 'error');
                modal.style.display = 'none';
            });
    }

    // Check if jQuery is available
    if (typeof jQuery !== 'undefined') {
        // Use jQuery AJAX if available
    $.ajax({
        url: `/admin/major_minor_validation/${studentId}`,
        method: 'GET',
        success: function(response) {
            console.log('Received student data:', response);
            
            if (response.success) {
                const student = response.student;
                const gpa = response.cumulative_gpa;
                
                // Update modal content
                // Set profile picture based on whether student has one or use default
                const profilePicElement = document.getElementById('student-profile-pic');
                if (student.has_profile_picture) {
                    profilePicElement.src = `/admin/student-profile-image/${student.national_id}`;
                } else {
                    profilePicElement.src = '/static/images/default-profile.jpg';
                }
                
                document.getElementById('student-full-name').textContent = `${student.first_name} ${student.last_name}`;
                document.getElementById('student-national-id').textContent = student.national_id || '--';
                document.getElementById('student-email').textContent = student.email_address || '--';
                document.getElementById('student-year').textContent = student.year_of_study || '--';
                document.getElementById('student-group').textContent = student.group || '--';
                document.getElementById('student-phone').textContent = student.phone || '--';
                document.getElementById('student-gpa').textContent = gpa ? gpa.toFixed(2) : '--';
                document.getElementById('student-level').textContent = student.level || '--';
            } else {
                showToast('Error loading student details: ' + (response.message || 'Unknown error'), 'error');
                modal.style.display = 'none';
            }
        },
        error: function(xhr, status, error) {
            console.error('Error fetching student details:', error);
            showToast('Error loading student details: ' + error, 'error');
            modal.style.display = 'none';
        }
    });
    } else {
        console.log('jQuery not available, using fetch API');
        fetchStudentData();
    }
}

// Global showToast function
function showToast(message, type = 'error') {
    const container = document.getElementById('notification-container');
    if (!container) {
        // Create container if it doesn't exist
        const newContainer = document.createElement('div');
        newContainer.id = 'notification-container';
        newContainer.style.position = 'fixed';
        newContainer.style.top = '20px';
        newContainer.style.right = '20px';
        newContainer.style.zIndex = '1000';
        document.body.appendChild(newContainer);
    }
    
    const notification = document.createElement('div');
    notification.className = `notification-${type}`;
    notification.textContent = message;
    notification.style.padding = '10px 15px';
    notification.style.marginBottom = '10px';
    notification.style.borderRadius = '4px';
    notification.style.color = 'white';
    notification.style.backgroundColor = type === 'error' ? '#e74c3c' : '#28a745';
    notification.style.animation = 'slideIn 0.5s, fadeOut 0.5s 4.5s';
    
    document.getElementById('notification-container').appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

    document.addEventListener('DOMContentLoaded', function() {
        // Add jQuery if not already present
        if (typeof jQuery === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
            script.onload = function() {
                console.log('jQuery loaded successfully');
                // After jQuery loads, make sure to setup the click handler
                setupSubmittedRequestsClick();
                setupModalEventListeners(); // Add this line to set up modal event listeners
                
                // Initialize major/minor validation if we're on that page
                if (window.location.hash === '#major_minor_validation') {
                    console.log('Initializing major/minor validation data');
                    window.updateMajorMinorValidation && window.updateMajorMinorValidation();
                }
            };
            document.head.appendChild(script);
        } else {
            // jQuery already loaded, setup the click handler
            setupSubmittedRequestsClick();
            setupModalEventListeners(); // Add this line to set up modal event listeners
            
            // Initialize major/minor validation if we're on that page
            if (window.location.hash === '#major_minor_validation') {
                console.log('Initializing major/minor validation data');
                window.updateMajorMinorValidation && window.updateMajorMinorValidation();
            }
        }
    
    // Function to setup modal event listeners
    function setupModalEventListeners() {
        // Set up student modal close functionality
        const studentModal = document.getElementById('student-modal');
        if (studentModal) {
            const closeButton = studentModal.querySelector('.close-modal');
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    studentModal.style.display = 'none';
                });
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === studentModal) {
                    studentModal.style.display = 'none';
                }
            });
        }
    }
    
    // Function to setup the submitted requests click handler
    function setupSubmittedRequestsClick() {
        console.log('Setting up submitted requests click handler');
        
        // Try multiple selectors to find the submitted requests box
        const selectors = [
            '.summary-card-counts:nth-child(3)',
            '.summary-card:nth-child(3)',
            '#submitted-requests',
            '.summary-card-counts h4:contains("Submitted Requests")'
        ];
        
        let submittedRequestsBox = null;
        
        // Try each selector
        for (const selector of selectors) {
            try {
                if (selector.includes('contains')) {
                    // Use jQuery for contains selector
                    const element = $(selector).closest('.summary-card-counts');
                    if (element.length) {
                        submittedRequestsBox = element[0];
                        console.log('Found submitted requests box using jQuery:', selector);
                        break;
                    }
                } else {
                    // Use querySelector for standard selectors
                    const element = document.querySelector(selector);
                    if (element) {
                        submittedRequestsBox = element;
                        console.log('Found submitted requests box:', selector);
                        break;
                    }
                }
            } catch (e) {
                console.warn(`Error with selector ${selector}:`, e);
            }
        }
        
        // If all else fails, get all summary cards and use the third one
        if (!submittedRequestsBox) {
            const allCards = document.querySelectorAll('.summary-card-counts, .summary-card');
            console.log('Found', allCards.length, 'summary cards');
            if (allCards.length >= 3) {
                submittedRequestsBox = allCards[2]; // third box
                console.log('Using third summary card as fallback');
            }
        }
        
        if (submittedRequestsBox) {
            console.log('Setting up click handler on:', submittedRequestsBox);
            submittedRequestsBox.style.cursor = 'pointer';
            
            // Add visual cue that it's clickable
            submittedRequestsBox.style.transition = 'transform 0.2s, box-shadow 0.2s';
            submittedRequestsBox.style.borderBottom = '3px solid #4682B4';
            
            submittedRequestsBox.addEventListener('click', function(e) {
                console.log('Submitted requests box clicked');
                showSubmittedRequestsModal();
            });
            
          
        } else {
            console.error('Could not find submitted requests box with any selector');
            
            // As a last resort, add a direct button
            const studentSummary = document.querySelector('.student-summary');
            if (studentSummary) {
                const viewButton = document.createElement('button');
                viewButton.className = 'btn btn-primary';
                viewButton.style.margin = '20px auto';
                viewButton.style.display = 'block';
                viewButton.innerHTML = '<i class="fas fa-eye"></i> View Students Without Submissions';
                viewButton.addEventListener('click', showSubmittedRequestsModal);
                
                studentSummary.parentNode.insertBefore(viewButton, studentSummary.nextSibling);
                console.log('Added direct button to view submitted requests');
            }
        }
    }
    
    const MAX_RETRIES = 3;
    let currentSection = window.location.hash ? window.location.hash.substring(1).replace('_', '-') : 'course-registration';
    let registrationEndTime = null;
    let registrationStartTime = null;
    let countdownInterval = null;
    let isRegistrationOpen = false;
    let isRegistrationScheduled = false;
    let savedStartDate = null;
    let savedEndDate = null;
    let currentSemesterStatus = null;

    // Initialize the page
    initPage();

    // Set initial active link
    setActiveLink(document.querySelector(`a[data-section="${currentSection}"]`));
    
    // Handle hash changes
    window.addEventListener('hashchange', function() {
        currentSection = window.location.hash ? window.location.hash.substring(1).replace('_', '-') : 'course-registration';
        loadSection(currentSection);
        setActiveLink(document.querySelector(`a[data-section="${currentSection}"]`));
        
        // Additionally refresh major/minor validation data if we navigate to that section
        if (currentSection === 'major-minor-validation' && window.updateMajorMinorValidation) {
            // Small delay to allow the page to render first
            setTimeout(() => {
                window.updateMajorMinorValidation();
            }, 500);
        }
    });

    // Initialize the page
    async function initPage() {
        if (currentSection === 'course-registration') {
            await checkRegistrationStatus();
            await checkSemesterStatus();
            await checkMakeupSessionStatus();
        } else if (currentSection === 'major-minor-validation') {
            await checkSelectionStatus();
        }
        
        // Always check selection status in background
        checkSelectionStatus().then(() => {
            console.log('Selection status checked on page load');
        }).catch(error => {
            console.error('Error checking selection status on page load:', error);
        });
        
        loadSection(currentSection);
        setupDateTimeInputs();
        
        // Set up periodic checks for registration and selection status
        setInterval(async () => {
            console.log('Performing periodic status check');
            await checkRegistrationStatus();
            await checkSelectionStatus();
            await checkMakeupSessionStatus();
        }, 60000); // Check every minute
    }

    // Check semester status
    async function checkSemesterStatus() {
        try {
            const response = await fetch("/admin/course_registration?section=semester_status");
            if (response.ok) {
                const data = await response.json();
                currentSemesterStatus = data;
            }
        } catch (error) {
            console.error("Error checking semester status:", error);
        }
    }

    // Check registration status on page load and periodically
    async function checkRegistrationStatus() {
        try {
            console.log("Checking registration status...");
            const response = await fetch("/admin/course_registration?section=course-registration");
            if (response.ok) {
                const data = await response.json();
                console.log("Registration status data:", data);
                
                if (data.is_scheduled && data.start_date && data.end_date) {
                    console.log("Registration is scheduled");
                    isRegistrationScheduled = true;
                    isRegistrationOpen = false;
                    registrationStartTime = new Date(data.start_date);
                    registrationEndTime = new Date(data.end_date);
                    savedStartDate = data.start_date;
                    savedEndDate = data.end_date;
                    
                    // Update UI for scheduled state
                    updateRegistrationUI('scheduled');
                    
                    // Start countdown to opening if not already running
                    if (!countdownInterval) {
                        startCountdownToOpening(registrationStartTime, registrationEndTime);
                    }
                } 
                else if (data.is_open && data.end_date) {
                    console.log("Registration is open");
                    isRegistrationOpen = true;
                    isRegistrationScheduled = false;
                    registrationEndTime = new Date(data.end_date);
                    savedEndDate = data.end_date;
                    
                    // Update UI for open state
                    updateRegistrationUI('open');
                    
                    // If registration is open but timer isn't running, start it
                    if (!countdownInterval) {
                        startCountdown(registrationEndTime);
                    }
                } 
                else {
                    console.log("Registration is closed");
                    isRegistrationOpen = false;
                    isRegistrationScheduled = false;
                    registrationEndTime = null;
                    registrationStartTime = null;
                    savedStartDate = null;
                    savedEndDate = null;
                    
                    // Update UI for closed state
                    updateRegistrationUI('closed');
                    
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                }
            }
        } catch (error) {
            console.error("Error checking registration status:", error);
        }
    }
    
    // Helper function to update UI based on registration state
    function updateRegistrationUI(state) {
        console.log(`Updating UI for registration state: ${state}`);
        const openDateInput = document.getElementById("open-date");
        const closeDateInput = document.getElementById("close-date");
        const openBtn = document.getElementById("open-registration-btn");
        const closeBtn = document.getElementById("close-registration-btn");
        const timerSection = document.getElementById("timer-section");
        
        if (!openDateInput || !closeDateInput || !openBtn || !closeBtn || !timerSection) {
            console.log("Registration UI elements not found, may be on a different page");
            return;
        }
        
        if (state === 'scheduled') {
            // Set input values if they exist
            if (savedStartDate) {
                const startDate = new Date(savedStartDate);
                const formattedStartDate = new Date(startDate.getTime() - (startDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                openDateInput.value = formattedStartDate;
            }
            
            if (savedEndDate) {
                const endDate = new Date(savedEndDate);
                const formattedEndDate = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                closeDateInput.value = formattedEndDate;
            }
            
            // Update UI state
            openDateInput.disabled = true;
            closeDateInput.disabled = true;
            timerSection.style.display = "block";
            openBtn.disabled = true;
            openBtn.textContent = "Registration is Scheduled";
            closeBtn.disabled = false;
            closeBtn.textContent = "Cancel Scheduled Registration";
            updateTimerMessage();
            
        } else if (state === 'open') {
            // Set input values if they exist
            if (savedEndDate) {
                const endDate = new Date(savedEndDate);
                const formattedEndDate = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                closeDateInput.value = formattedEndDate;
            }
            
            // Update UI state
            openDateInput.disabled = true;
            closeDateInput.disabled = true;
            timerSection.style.display = "block";
            openBtn.disabled = true;
            openBtn.textContent = "Registration is Open";
            closeBtn.disabled = false;
            closeBtn.textContent = "Close Registration";
            updateTimerMessage();
            
        } else { // closed
            // Reset input values
            openDateInput.value = '';
            closeDateInput.value = '';
            
            // Update UI state
            openDateInput.disabled = false;
            closeDateInput.disabled = false;
            timerSection.style.display = "none";
            openBtn.disabled = false;
            openBtn.textContent = "Open Registration";
            closeBtn.disabled = true;
            closeBtn.textContent = "Close Registration";
        }
    }

    // Setup datetime inputs with min values
    function setupDateTimeInputs() {
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
        
        document.addEventListener('input', function(e) {
            if (e.target.id === 'open-date' || e.target.id === 'close-date') {
                validateDateTimeInputs();
            }
        });
    }

    // Validate datetime inputs
    function validateDateTimeInputs() {
        const now = new Date();
        const openDateInput = document.getElementById('open-date');
        const closeDateInput = document.getElementById('close-date');
        
        if (openDateInput && openDateInput.value) {
            const openDate = new Date(openDateInput.value);
            if (openDate < now) {
                openDateInput.setCustomValidity('Open date cannot be in the past');
            } else {
                openDateInput.setCustomValidity('');
            }
        }
        
        if (closeDateInput && closeDateInput.value) {
            const closeDate = new Date(closeDateInput.value);
            if (closeDate < now) {
                closeDateInput.setCustomValidity('Close date cannot be in the past');
            } else {
                closeDateInput.setCustomValidity('');
            }
        }
    }

    // Handle sidebar menu clicks
    document.querySelector('.sidebar-menu').addEventListener('click', function(e) {
        const link = e.target.closest('a[data-section]');
        if (!link) return;

        e.preventDefault();
        currentSection = link.getAttribute('data-section');
        window.location.hash = currentSection.replace('-', '_');
    });

    // Set active menu item
    function setActiveLink(activeLink) {
        document.querySelectorAll('.sidebar-menu a').forEach(a => {
            a.classList.remove('active');
        });
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }

    // Show notification
    function showNotification(message, type = 'error') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification-${type}`;
        notification.textContent = message;
        notification.style.padding = '10px 15px';
        notification.style.marginBottom = '10px';
        notification.style.borderRadius = '4px';
        notification.style.color = 'white';
        notification.style.backgroundColor = type === 'error' ? '#e74c3c' : '#28a745';
        notification.style.animation = 'slideIn 0.5s, fadeOut 0.5s 4.5s';
        
        container.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Show inline message
    function showInlineMessage(message, type = 'error') {
        const messageEl = document.getElementById('inline-message');
        messageEl.textContent = message;
        messageEl.style.display = 'block';
        messageEl.style.padding = '10px 15px';
        messageEl.style.borderRadius = '4px';
        messageEl.style.color = type === 'error' ? '#721c24' : '#155724';
        messageEl.style.backgroundColor = type === 'error' ? '#f8d7da' : '#d4edda';
        messageEl.style.border = `1px solid ${type === 'error' ? '#f5c6cb' : '#c3e6cb'}`;
        
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 5000);
    }

    // Load section content
    async function loadSection(section, attempt = 1) {
        // Update current section to avoid conflicts between different sections
        window.currentSection = section;
        
        // Clear any previous content to avoid conflicts
        document.getElementById('dynamic-content').innerHTML = '';
        
        if (section === 'course-registration') {
            await loadCourseRegistration();
        } else if (section === 'major-minor-validation') {
            await loadMajorMinorValidation();
        } else if (section === 'system-adjustments') {
            await loadSystemAdjustments();
        } else if (section === 'statistics') {
            await loadStatisticsSection(); // Calling the correct function
        } else {
            // Default section display
            document.getElementById('content-title').textContent = 
                section.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            document.getElementById('dynamic-content').innerHTML = `
                <div class="content-card">
                    <h3>${section.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                    <p>This is placeholder content for ${section.replace('-', ' ')}.</p>
                </div>
            `;
        }
    }

    // Load course registration section
    async function loadCourseRegistration(attempt = 1) {
        showLoadingState('course-registration');

        try {
            // First check semester status if not already loaded
            if (!currentSemesterStatus) {
                await checkSemesterStatus();
            }
            
            // Then check registration status
            await checkRegistrationStatus();
            
            // Now render the content
            renderCourseRegistrationContent();
            
        } catch (error) {
            showError(error, 'course-registration');
            console.error('Load error:', error);
        }
    }

    // Render course registration content
    function renderCourseRegistrationContent() {
        document.getElementById('content-title').textContent = 'Management and Requests Handling';
        const contentDiv = document.getElementById('dynamic-content');
        
        const hasActiveSemester = currentSemesterStatus && currentSemesterStatus.current_semester && !currentSemesterStatus.current_semester.end_date;
        const showRegistrationControls = hasActiveSemester;
        
        contentDiv.innerHTML = `
            <div class="content-card">

                <div class="semester-management">
                    <div class="semester-header" id="semester-management-header">
                        <h4><i class="fas fa-calendar-alt"></i> Semester Management</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="semester-content" id="semester-management-content">
                        <div class="semester-info">
                            ${hasActiveSemester ? 
                                `<p><span class="highlight">Current Semester:</span> ${getSemesterName(currentSemesterStatus.current_semester.semester)}</p>
                                <p><span class="highlight">Started:</span> ${formatDisplayDate(currentSemesterStatus.current_semester.start_date)}</p>
                                ` : 
                                '<p class="highlight">No active semester</p>'}
                        </div>
                        <button id="semester-action-btn" class="btn-primary">
                            ${hasActiveSemester ? 
                                '<i class="fas fa-flag-checkered"></i> End Semester' : 
                                '<i class="fas fa-play"></i> Start Semester'}
                        </button>
                    </div>
                </div>

                <hr class="section-divider">

                <div class="registration-management">
                    <div class="registration-header" id="registration-period-header">
                        <h4><i class="fas fa-user-graduate"></i> Registration Period Management</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="registration-content" id="registration-period-content">
                        <!-- Add error message container inside the registration management box -->
                        <div id="registration-error-message" class="registration-error-message" style="display: none;"></div>
                        <div class="form-group">
                            <label for="open-date">Registration Open Date:</label>
                            <input type="datetime-local" id="open-date" ${isRegistrationOpen || isRegistrationScheduled || !showRegistrationControls ? 'disabled' : ''} required>
                        </div>

                        <div class="form-group">
                            <label for="close-date">Registration Close Date:</label>
                            <input type="datetime-local" id="close-date" ${isRegistrationOpen || isRegistrationScheduled || !showRegistrationControls ? 'disabled' : ''} required>
                        </div>

                        <div class="button-group">
                            <button id="open-registration-btn" class="btn-primary" ${isRegistrationOpen || isRegistrationScheduled || !showRegistrationControls ? 'disabled' : ''}>
                                ${isRegistrationOpen ? 'Registration is Open' : 
                                isRegistrationScheduled ? 'Registration is Scheduled' : 
                                showRegistrationControls ? 'Open Registration' : 'Open Registration'}
                            </button>
                            <button id="close-registration-btn" class="btn-danger" ${!isRegistrationOpen && !isRegistrationScheduled ? 'disabled' : ''}>
                                ${isRegistrationScheduled ? 'Cancel Scheduled Registration' : 
                                'Close Registration'}
                            </button>
                        </div>

                        <div id="timer-section" style="display: ${isRegistrationOpen || isRegistrationScheduled ? 'block' : 'none'};">
                            <h4 id="timer-message"></h4>
                            <div id="countdown-timer"></div>
                        </div>
                    </div>
                </div>
                                <hr class="section-divider">

                <div class="makeup-session-management">
                    <div class="registration-header" id="makeup-session-header">
                        <h4><i class="fas fa-history"></i> Makeup Session Period Management</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="registration-content" id="makeup-session-content">
                        <div id="makeup-session-error-message" class="registration-error-message" style="display: none;"></div>
                        <div class="form-group">
                            <label for="makeup-open-date">Open Date:</label>
                            <input type="datetime-local" id="makeup-open-date" required>
                        </div>

                        <div class="form-group">
                            <label for="makeup-close-date">Close Date:</label>
                            <input type="datetime-local" id="makeup-close-date" required>
                        </div>

                        <div class="button-group">
                            <button id="open-makeup-session-btn" class="btn-primary">Open Makeup Session</button>
                            <button id="close-makeup-session-btn" class="btn-danger" disabled>Close Makeup Session</button>
                        </div>

                        <div id="makeup-timer-section" style="display: none;">
                            <h4 id="makeup-timer-message"></h4>
                            <div id="makeup-countdown-timer"></div>
                        </div>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Drop Course Requests Section in its own container -->
                <div class="content-card">
                    <div class="drop-requests-section">
                        <div class="drop-requests-header" id="drop-requests-header">
                            <h4><i class="fas fa-exchange-alt"></i> Drop Course Requests Handling</h4>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <!-- Add separate error message container for drop requests -->
                        <div id="drop-requests-error-message" class="registration-error-message" style="display: none;"></div>
                        <div class="drop-requests-content" id="drop-requests-content">
                            <!-- Add search bar -->
                            <div class="drop-requests-search">
                                <input type="text" id="drop-requests-search" placeholder="Search by name or ID..." class="drop-search-input">
                            </div>
                            <div id="drop-requests-loading" class="drop-requests-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading drop course requests...
                            </div>
                            <div id="drop-requests-table-container"></div>
                        </div>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Forgiveness Policy Requests Section -->
                <div class="content-card">
                    <div class="forgiveness-section-header" id="forgiveness-header">
                        <h4>Forgiveness Policy Requests</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div id="forgiveness-error-message" class="registration-error-message" style="display: none;"></div>
                    <div class="forgiveness-content" id="forgiveness-content">
                        <div class="forgiveness-actions">
                            <div class="forgiveness-search">
                                <input type="text" id="forgiveness-search" placeholder="Search by name or ID..." class="forgiveness-search-input">
                            </div>
                            <div class="forgiveness-filters">
                                <button id="forgiveness-pending-btn" class="status-filter-btn active" data-status="pending">
                                    <i class="fas fa-clock"></i> Pending 
                                </button>
                                <button id="forgiveness-processed-btn" class="status-filter-btn" data-status="processed">
                                    <i class="fas fa-history"></i> History
                                </button>
                            </div>
                        </div>
                        <div id="forgiveness-loading" class="forgiveness-loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading forgiveness policy requests...
                        </div>
                        <div id="forgiveness-table-container"></div>
                    </div>
                </div>

                <hr class="section-divider">

                <!-- Probation Extension Requests Section -->
                <div class="content-card">
                    <div class="probation-extension-section">
                                                 <div class="probation-extension-header" id="probation-extension-header">
                            <h4>Probation Extension Handling</h4>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="probation-extension-error-message" class="registration-error-message" style="display: none;"></div>
                        <div class="probation-extension-content" id="probation-extension-content">
                            <div class="probation-extension-actions">
                                <div class="probation-extension-search">
                                    <input type="text" id="probation-extension-search" placeholder="Search by name or ID..." class="probation-extension-search-input">
                                </div>
                                <div class="probation-extension-filters">
                                    <button id="pending-requests-btn" class="status-filter-btn active" data-status="pending">
                                        <i class="fas fa-clock"></i> Pending 
                                    </button>
                                    <button id="processed-requests-btn" class="status-filter-btn" data-status="processed">
                                        <i class="fas fa-history"></i>  History
                                    </button>
                                </div>
                            </div>
                            <div id="probation-extension-loading" class="probation-extension-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading probation extension requests...
                            </div>
                            <div id="probation-extension-table-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Set values for date inputs if we have saved dates
        const openDateInput = document.getElementById('open-date');
        const closeDateInput = document.getElementById('close-date');
        
        if (openDateInput && savedStartDate) {
            const startDate = new Date(savedStartDate);
            // Fix for timezone issues - convert to local time string
            const formattedStartDate = new Date(startDate.getTime() - (startDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            openDateInput.value = formattedStartDate;
        }
        
        if (closeDateInput && savedEndDate) {
            const endDate = new Date(savedEndDate);
            // Fix for timezone issues - convert to local time string
            const formattedEndDate = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            closeDateInput.value = formattedEndDate;
        }

        // Set min datetime for inputs
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
        
        if (openDateInput) {
            openDateInput.min = localISOTime;
        }
        if (closeDateInput) {
            closeDateInput.min = localISOTime;
        }

        // Semester Action Button Handler
        document.getElementById("semester-action-btn").addEventListener("click", handleSemesterAction);

        // Open Registration Button Handler
        document.getElementById("open-registration-btn").addEventListener("click", handleOpenRegistration);

        // Close Registration Button Handler
        document.getElementById("close-registration-btn").addEventListener("click", handleCloseRegistration);
        
        // Open Makeup Session Button Handler
        document.getElementById("open-makeup-session-btn").addEventListener("click", handleOpenMakeupSession);

        // Close Makeup Session Button Handler
        document.getElementById("close-makeup-session-btn").addEventListener("click", handleCloseMakeupSession);
        
        // Collapsible section header click handlers
        document.getElementById("semester-management-header").addEventListener("click", function() {
            toggleSection('semester-management-content', this);
        });
        
        document.getElementById("registration-period-header").addEventListener("click", function() {
            toggleSection('registration-period-content', this);
        });
        
        document.getElementById("makeup-session-header").addEventListener("click", function() {
            toggleSection('makeup-session-content', this);
        });
        
        document.getElementById("drop-requests-header").addEventListener("click", function() {
            toggleSection('drop-requests-content', this);
            // Also load drop requests when expanded
            const content = document.getElementById('drop-requests-content');
            if (content.classList.contains('expanded')) {
                loadDropRequests();
            }
        });
        
        document.getElementById("forgiveness-header").addEventListener("click", function() {
            toggleSection('forgiveness-content', this);
            // Also load forgiveness requests when expanded
            const content = document.getElementById('forgiveness-content');
            if (content.classList.contains('expanded')) {
                loadForgivenessRequests();
            }
        });
        
        // Add event listeners for forgiveness filter buttons
        document.getElementById("forgiveness-pending-btn").addEventListener("click", function() {
            loadForgivenessRequests('pending');
        });
        
        document.getElementById("forgiveness-processed-btn").addEventListener("click", function() {
            loadForgivenessRequests('processed');
        });

        document.getElementById("probation-extension-header").addEventListener("click", function() {
            toggleSection('probation-extension-content', this);
            // Also load probation extension requests when expanded
            const content = document.getElementById('probation-extension-content');
            if (content.classList.contains('expanded')) {
                loadProbationExtensionRequests();
            }
        });
        
        // Add event listeners for probation extension filter buttons
        document.getElementById("pending-requests-btn").addEventListener("click", function() {
            loadProbationExtensionRequests('pending');
        });
        
        document.getElementById("processed-requests-btn").addEventListener("click", function() {
            loadProbationExtensionRequests('processed');
        });

        // Update timer message immediately
        updateTimerMessage();

        if (isRegistrationOpen && registrationEndTime) {
            startCountdown(registrationEndTime);
        } else if (isRegistrationScheduled && registrationStartTime && registrationEndTime) {
            startCountdownToOpening(registrationStartTime, registrationEndTime);
        }
        
        // Initialize all collapsible sections
        initCollapsibleSections();
    }
    
    // General function to toggle a collapsible section
    function toggleSection(contentId, headerElement) {
        const content = document.getElementById(contentId);
        const icon = headerElement.querySelector('i.fas.fa-chevron-down, i.fas.fa-chevron-up');
        
        if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            icon.className = 'fas fa-chevron-down';
        } else {
            content.classList.add('expanded');
            icon.className = 'fas fa-chevron-up';
        }
    }

    // Initialize all collapsible sections
    function initCollapsibleSections() {
        // Set initial state for all sections
        const sections = [
            { content: 'semester-management-content', header: 'semester-management-header', expanded: false },
            { content: 'registration-period-content', header: 'registration-period-header', expanded: false },
            { content: 'makeup-session-content', header: 'makeup-session-header', expanded: false },
            { content: 'drop-requests-content', header: 'drop-requests-header', expanded: false },
            { content: 'forgiveness-content', header: 'forgiveness-header', expanded: false },
            { content: 'probation-extension-content', header: 'probation-extension-header', expanded: false }
        ];
        
        sections.forEach(section => {
            const content = document.getElementById(section.content);
            const header = document.getElementById(section.header);
            const icon = header.querySelector('i.fas');
            
            if (section.expanded) {
                content.classList.add('expanded');
                icon.className = 'fas fa-chevron-up';
            } else {
                content.classList.remove('expanded');
                icon.className = 'fas fa-chevron-down';
            }
        });
    }

    // Define variables for makeup session
    let makeupSessionEndTime = null;
    let makeupSessionStartTime = null;
    let makeupSessionCountdownInterval = null;
    let isMakeupSessionOpen = false;
    let isMakeupSessionScheduled = false;
    let savedMakeupOpenDate = null;
    let savedMakeupCloseDate = null;

    // Check makeup session status
    async function checkMakeupSessionStatus() {
        try {
            console.log("Checking makeup session status...");
            const response = await fetch("/admin/course_registration/makeup_session");
            if (response.ok) {
                const data = await response.json();
                console.log("Makeup session status data:", data);
                
                if (data.is_scheduled && data.open_date && data.close_date) {
                    console.log("Makeup session is scheduled");
                    isMakeupSessionScheduled = true;
                    isMakeupSessionOpen = false;
                    makeupSessionStartTime = new Date(data.open_date);
                    makeupSessionEndTime = new Date(data.close_date);
                    savedMakeupOpenDate = data.open_date;
                    savedMakeupCloseDate = data.close_date;
                    
                    // Update UI for scheduled state
                    updateMakeupSessionUI('scheduled');
                    
                    // Start countdown to opening if not already running
                    if (!makeupSessionCountdownInterval) {
                        startMakeupSessionCountdownToOpening(makeupSessionStartTime, makeupSessionEndTime);
                    }
                } 
                else if (data.is_open && data.close_date) {
                    console.log("Makeup session is open");
                    isMakeupSessionOpen = true;
                    isMakeupSessionScheduled = false;
                    makeupSessionEndTime = new Date(data.close_date);
                    savedMakeupCloseDate = data.close_date;
                    
                    // Update UI for open state
                    updateMakeupSessionUI('open');
                    
                    // If session is open but timer isn't running, start it
                    if (!makeupSessionCountdownInterval) {
                        startMakeupSessionCountdown(makeupSessionEndTime);
                    }
                } 
                else {
                    console.log("Makeup session is closed");
                    isMakeupSessionOpen = false;
                    isMakeupSessionScheduled = false;
                    makeupSessionEndTime = null;
                    makeupSessionStartTime = null;
                    savedMakeupOpenDate = null;
                    savedMakeupCloseDate = null;
                    
                    // Update UI for closed state
                    updateMakeupSessionUI('closed');
                    
                    if (makeupSessionCountdownInterval) {
                        clearInterval(makeupSessionCountdownInterval);
                        makeupSessionCountdownInterval = null;
                    }
                }
            }
        } catch (error) {
            console.error("Error checking makeup session status:", error);
        }
    }

    // Update UI based on makeup session state
    function updateMakeupSessionUI(state) {
        console.log(`Updating UI for makeup session state: ${state}`);
        const openDateInput = document.getElementById("makeup-open-date");
        const closeDateInput = document.getElementById("makeup-close-date");
        const openBtn = document.getElementById("open-makeup-session-btn");
        const closeBtn = document.getElementById("close-makeup-session-btn");
        const timerSection = document.getElementById("makeup-timer-section");
        
        if (!openDateInput || !closeDateInput || !openBtn || !closeBtn || !timerSection) {
            console.log("Makeup session UI elements not found, may be on a different page");
            return;
        }
        
        if (state === 'scheduled') {
            // Set input values if they exist
            if (savedMakeupOpenDate) {
                const startDate = new Date(savedMakeupOpenDate);
                const formattedStartDate = new Date(startDate.getTime() - (startDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                openDateInput.value = formattedStartDate;
            }
            
            if (savedMakeupCloseDate) {
                const endDate = new Date(savedMakeupCloseDate);
                const formattedEndDate = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                closeDateInput.value = formattedEndDate;
            }
            
            // Update UI state
            openDateInput.disabled = true;
            closeDateInput.disabled = true;
            timerSection.style.display = "block";
            openBtn.disabled = true;
            openBtn.textContent = "Makeup Session is Scheduled";
            closeBtn.disabled = false;
            closeBtn.textContent = "Cancel Scheduled Session";
            updateMakeupTimerMessage();
            
        } else if (state === 'open') {
            // Set input values if they exist
            if (savedMakeupCloseDate) {
                const endDate = new Date(savedMakeupCloseDate);
                const formattedEndDate = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                closeDateInput.value = formattedEndDate;
            }
            
            // Update UI state
            openDateInput.disabled = true;
            closeDateInput.disabled = true;
            timerSection.style.display = "block";
            openBtn.disabled = true;
            openBtn.textContent = "Makeup Session is Open";
            closeBtn.disabled = false;
            closeBtn.textContent = "Close Makeup Session";
            updateMakeupTimerMessage();
            
        } else { // closed
            // Reset input values
            openDateInput.value = '';
            closeDateInput.value = '';
            
            // Update UI state
            openDateInput.disabled = false;
            closeDateInput.disabled = false;
            timerSection.style.display = "none";
            openBtn.disabled = false;
            openBtn.textContent = "Open Makeup Session";
            closeBtn.disabled = true;
            closeBtn.textContent = "Close Makeup Session";
        }
    }

    // Start countdown to makeup session end
    function startMakeupSessionCountdown(endTime) {
        if (makeupSessionCountdownInterval) {
            clearInterval(makeupSessionCountdownInterval);
        }
        
        updateMakeupCountdown(endTime);
        
        makeupSessionCountdownInterval = setInterval(() => {
            updateMakeupCountdown(endTime);
        }, 1000);
    }

    // Start countdown to makeup session opening
    function startMakeupSessionCountdownToOpening(startTime, endTime) {
        if (makeupSessionCountdownInterval) {
            clearInterval(makeupSessionCountdownInterval);
        }
        
        updateMakeupCountdownToOpening(startTime, endTime);
        
        makeupSessionCountdownInterval = setInterval(() => {
            updateMakeupCountdownToOpening(startTime, endTime);
        }, 1000);
    }

    // Update makeup timer message
    function updateMakeupTimerMessage() {
        const timerMessageElement = document.getElementById("makeup-timer-message");
        if (!timerMessageElement) return;
        
        if (isMakeupSessionOpen) {
            timerMessageElement.textContent = "Makeup session closes in:";
        } else if (isMakeupSessionScheduled) {
            timerMessageElement.textContent = "Makeup session starts in:";
        }
    }

    // Update makeup countdown
    function updateMakeupCountdown(endTime) {
        const timerElement = document.getElementById("makeup-countdown-timer");
        if (!timerElement) return;
        
        const now = new Date();
        const timeLeft = endTime - now;
        
        if (timeLeft <= 0) {
            // Time's up, refresh status
            clearInterval(makeupSessionCountdownInterval);
            makeupSessionCountdownInterval = null;
            timerElement.textContent = "00:00:00";
            checkMakeupSessionStatus();
            return;
        }
        
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Update makeup countdown to opening
    function updateMakeupCountdownToOpening(startTime, endTime) {
        const timerElement = document.getElementById("makeup-countdown-timer");
        if (!timerElement) return;
        
        const now = new Date();
        const timeToStart = startTime - now;
        
        if (timeToStart <= 0) {
            // Time to start the session
            clearInterval(makeupSessionCountdownInterval);
            makeupSessionCountdownInterval = null;
            
            // Update UI to open state
            isMakeupSessionOpen = true;
            isMakeupSessionScheduled = false;
            updateMakeupSessionUI('open');
            updateMakeupTimerMessage();
            
            // Start countdown to end
            startMakeupSessionCountdown(endTime);
            return;
        }
        
        const hours = Math.floor(timeToStart / (1000 * 60 * 60));
        const minutes = Math.floor((timeToStart % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeToStart % (1000 * 60)) / 1000);
        
        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Handle opening makeup session
    async function handleOpenMakeupSession() {
        // Show inline message to indicate that we're processing
        showMakeupSessionMessage("Processing request...", "error");
        
        const openDateInput = document.getElementById("makeup-open-date");
        const closeDateInput = document.getElementById("makeup-close-date");
        
        if (!openDateInput.value || !closeDateInput.value) {
            showMakeupSessionMessage("Please provide both open and close dates.", "error");
            return;
        }
        
        // Validate dates on client side
        const now = new Date();
        const openDate = new Date(openDateInput.value);
        const closeDate = new Date(closeDateInput.value);
        
        if (closeDate < now) {
            showMakeupSessionMessage("Close date cannot be in the past.", "error");
            return;
        }
        
        if (openDate >= closeDate) {
            showMakeupSessionMessage("Open date must be before close date.", "error");
            return;
        }
        
        // Format dates for API
        const formattedOpenDate = openDate.toISOString().slice(0, 19).replace('T', ' ');
        const formattedCloseDate = closeDate.toISOString().slice(0, 19).replace('T', ' ');
        
        try {
            const response = await fetch("/admin/course_registration/makeup_session", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    action: "start_session",
                    open_date: formattedOpenDate,
                    close_date: formattedCloseDate
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update UI
                isMakeupSessionScheduled = data.is_scheduled;
                isMakeupSessionOpen = !data.is_scheduled;
                savedMakeupOpenDate = data.open_date;
                savedMakeupCloseDate = data.close_date;
                makeupSessionStartTime = new Date(data.open_date);
                makeupSessionEndTime = new Date(data.close_date);
                
                // Update UI based on whether it's scheduled or open now
                if (data.is_scheduled) {
                    updateMakeupSessionUI('scheduled');
                    startMakeupSessionCountdownToOpening(makeupSessionStartTime, makeupSessionEndTime);
                } else {
                    updateMakeupSessionUI('open');
                    startMakeupSessionCountdown(makeupSessionEndTime);
                }
                
                showMakeupSessionMessage(data.message, "success");
            } else {
                // Display more detailed error message if available
                const errorMessage = data.message || "Failed to open makeup session";
                const detailsMessage = data.details ? `\n${data.details}` : "";
                showMakeupSessionMessage(errorMessage + detailsMessage, "error");
            }
        } catch (error) {
            console.error("Error opening makeup session:", error);
            showMakeupSessionMessage("An error occurred while opening the makeup session", "error");
        }
    }

    // Handle closing makeup session
    async function handleCloseMakeupSession() {
        // Show inline message to indicate that we're processing
        showMakeupSessionMessage("Processing request...", "error");
        
        const action = isMakeupSessionScheduled ? "cancel_session" : "close_session";
        
        try {
            const response = await fetch("/admin/course_registration/makeup_session", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    action: action
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update UI
                isMakeupSessionOpen = false;
                isMakeupSessionScheduled = false;
                makeupSessionEndTime = null;
                makeupSessionStartTime = null;
                savedMakeupOpenDate = null;
                savedMakeupCloseDate = null;
                
                // Clear countdown timer
                if (makeupSessionCountdownInterval) {
                    clearInterval(makeupSessionCountdownInterval);
                    makeupSessionCountdownInterval = null;
                }
                
                updateMakeupSessionUI('closed');
                showMakeupSessionMessage(data.message, "success");
            } else {
                // Display more detailed error message if available
                const errorMessage = data.message || "Failed to close makeup session";
                const detailsMessage = data.details ? `\n${data.details}` : "";
                showMakeupSessionMessage(errorMessage + detailsMessage, "error");
            }
        } catch (error) {
            console.error("Error closing makeup session:", error);
            showMakeupSessionMessage("An error occurred while closing the makeup session", "error");
        }
    }

    // Show makeup session message
    function showMakeupSessionMessage(message, type = 'error') {
        const messageEl = document.getElementById('makeup-session-error-message');
        if (!messageEl) return;
        
        // Handle multiline messages by replacing newlines with HTML breaks
        if (message.includes('\n')) {
            messageEl.innerHTML = message.replace(/\n/g, '<br>');
        } else {
            messageEl.textContent = message;
        }
        
        messageEl.style.display = 'block';
        
        if (type === 'success') {
            messageEl.classList.add('success');
        } else {
            messageEl.classList.remove('success');
        }
        
        // Auto-hide after 8 seconds for error messages, 5 seconds for success
        const hideDelay = type === 'error' ? 8000 : 5000;
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, hideDelay);
    }

    // Load drop course requests
    function loadDropRequests() {
        const tableContainer = document.getElementById('drop-requests-table-container');
        const loadingElement = document.getElementById('drop-requests-loading');
        
        // Show loading indicator
        loadingElement.style.display = 'block';
        tableContainer.innerHTML = '';
        
        // Fetch drop requests from API
        fetch('/admin/course_registration/drop_requests')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                loadingElement.style.display = 'none';
                
                if (data.success) {
                    renderDropRequestsTable(data.requests, tableContainer);
                } else {
                    tableContainer.innerHTML = `
                        <div class="drop-requests-empty">
                            Error: ${data.message || 'Failed to load drop requests'}
                        </div>
                    `;
                    showDropRequestsMessage(data.message || 'Failed to load drop requests', 'error');
                }
            })
            .catch(error => {
                // Hide loading indicator
                loadingElement.style.display = 'none';
                
                tableContainer.innerHTML = `
                    <div class="drop-requests-empty">
                        An error occurred while loading drop requests. Please try again.
                    </div>
                `;
                showDropRequestsMessage(`Error: ${error.message}`, 'error');
            });
    }

    // Render drop requests table
    function renderDropRequestsTable(requests, container) {
        if (!requests || requests.length === 0) {
            container.innerHTML = `
                <div class="drop-requests-empty">
                    No drop course requests found.
                </div>
            `;
            return;
        }
        
        // Filter to show only pending requests
        const pendingRequests = requests.filter(req => req.status === 'pending');
        
        if (pendingRequests.length === 0) {
            container.innerHTML = `
                <div class="drop-requests-empty">
                    No pending drop course requests found.
                </div>
            `;
            return;
        }
        
        // Store requests in a global variable for sorting/filtering
        window.allDropRequests = pendingRequests;
        
        // Create table
        let tableHtml = `
            <table class="drop-requests-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="student"><span>Student</span> <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="course"><span>Course</span> <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="type"><span>Type</span> <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="date"><span>Request Date</span> <i class="fas fa-sort"></i></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // Add rows for each request
        renderDropRequestRows(pendingRequests, tableHtml, container);
        
        // Add event listener for search
        const searchInput = document.getElementById('drop-requests-search');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                filterDropRequests(this.value.trim().toLowerCase());
            });
        }
    }
    
    // Render drop request rows
    function renderDropRequestRows(requests, tableHtml, container) {
        let rowsHtml = '';
        
        requests.forEach(request => {
            const requestDate = new Date(request.request_date);
            const formattedDate = requestDate.toLocaleString();
            
            // Determine type class
            let typeClass = '';
            switch (request.type?.toLowerCase()) {
                case 'retake':
                    typeClass = 'retake';
                    break;
                case 'extra':
                    typeClass = 'extra';
                    break;
                case 'skipped':
                    typeClass = 'skipped';
                    break;
                case 'current':
                default:
                    typeClass = 'current';
                    break;
            }
            
            rowsHtml += `
                <tr data-request-id="${request.id}" data-student-id="${request.student_id}">
                    <td>
                        <div>${request.student_name}</div>
                        <div style="font-size: 0.8em; color: #666;">ID: ${request.national_id}</div>
                    </td>
                    <td>
                        <div>${request.course_code}</div>
                    </td>
                    <td>
                        <span class="request-type ${typeClass}">${request.type || 'Current'}</span>
                    </td>
                    <td>${formattedDate}</td>
                    <td class="request-actions">
                        <button class="btn-approve" data-request-id="${request.id}" data-action="approve">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn-reject" data-request-id="${request.id}" data-action="reject">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </td>
                </tr>
            `;
        });
        
        container.innerHTML = tableHtml + rowsHtml + `
                </tbody>
            </table>
        `;
        
        // Add event listeners to buttons after the HTML is added to the DOM
        const approveButtons = container.querySelectorAll('.btn-approve');
        const rejectButtons = container.querySelectorAll('.btn-reject');
        
        approveButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                handleDropRequest(requestId, 'approve');
            });
        });
        
        rejectButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                handleDropRequest(requestId, 'reject');
            });
        });
        
        // Re-add event listeners for sorting
        const sortableHeaders = container.querySelectorAll('.sortable');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortField = this.getAttribute('data-sort');
                const currentIcon = this.querySelector('i');
                const isAscending = currentIcon.classList.contains('fa-sort') || currentIcon.classList.contains('fa-sort-down');
                
                // Reset all icons
                sortableHeaders.forEach(h => h.querySelector('i').className = 'fas fa-sort');
                
                // Set the current icon
                currentIcon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
                
                // Sort the requests
                sortDropRequests(sortField, isAscending);
            });
        });
    }
    
    // Sort drop requests
    function sortDropRequests(field, ascending) {
        const requests = window.allDropRequests;
        if (!requests) return;
        
        const sortedRequests = [...requests].sort((a, b) => {
            let valueA, valueB;
            
            switch (field) {
                case 'student':
                    valueA = a.student_name.toLowerCase();
                    valueB = b.student_name.toLowerCase();
                    break;
                case 'course':
                    valueA = a.course_code.toLowerCase();
                    valueB = b.course_code.toLowerCase();
                    break;
                case 'type':
                    valueA = (a.type || 'Current').toLowerCase();
                    valueB = (b.type || 'Current').toLowerCase();
                    break;
                case 'date':
                    valueA = new Date(a.request_date).getTime();
                    valueB = new Date(b.request_date).getTime();
                    break;
                default:
                    return 0;
            }
            
            if (valueA < valueB) return ascending ? -1 : 1;
            if (valueA > valueB) return ascending ? 1 : -1;
            return 0;
        });
        
        const container = document.getElementById('drop-requests-table-container');
        const tableStart = `
            <table class="drop-requests-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="student"><span>Student</span> <i class="fas fa-sort${field === 'student' ? (ascending ? '-up' : '-down') : ''}"></i></th>
                        <th class="sortable" data-sort="course"><span>Course</span> <i class="fas fa-sort${field === 'course' ? (ascending ? '-up' : '-down') : ''}"></i></th>
                        <th class="sortable" data-sort="type"><span>Type</span> <i class="fas fa-sort${field === 'type' ? (ascending ? '-up' : '-down') : ''}"></i></th>
                        <th class="sortable" data-sort="date"><span>Request Date</span> <i class="fas fa-sort${field === 'date' ? (ascending ? '-up' : '-down') : ''}"></i></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        renderDropRequestRows(sortedRequests, tableStart, container);
    }
    
    // Filter drop requests
    function filterDropRequests(searchTerm) {
        const requests = window.allDropRequests;
        if (!requests) return;
        
        const filteredRequests = searchTerm ? requests.filter(request => {
            return request.student_name.toLowerCase().includes(searchTerm) || 
                   request.national_id.toString().includes(searchTerm);
        }) : requests;
        
        const container = document.getElementById('drop-requests-table-container');
        
        if (filteredRequests.length === 0) {
            container.innerHTML = `
                <div class="drop-requests-empty">
                    No matching drop course requests found.
                </div>
            `;
            return;
        }
        
        const tableStart = `
            <table class="drop-requests-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="student"><span>Student</span> <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="course"><span>Course</span> <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="type"><span>Type</span> <i class="fas fa-sort"></i></th>
                        <th class="sortable" data-sort="date"><span>Request Date</span> <i class="fas fa-sort"></i></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        renderDropRequestRows(filteredRequests, tableStart, container);
    }

    // Handle drop request action (approve/reject)
    function handleDropRequest(requestId, action) {
        console.log(`Handling drop request ${requestId} with action: ${action}`);
        
        // Find the row and disable buttons
        const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
        if (row) {
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.classList.contains('btn-approve')) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
                } else if (btn.classList.contains('btn-reject')) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
                }
            });
        }
        
        // Send request to API
        const url = `/admin/course_registration/drop_requests/${requestId}`;
        const requestData = { action };
        
        console.log(`Sending request to ${url} with data:`, requestData);
        
        fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log(`Response status: ${response.status}`);
            if (!response.ok) {
                return response.json().then(errData => {
                    console.error('Error response data:', errData);
                    throw new Error(errData.message || `Server error: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success response data:', data);
            if (data.success) {
                // Show success message
                showDropRequestsMessage(data.message, 'success');
                
                // Remove the row with animation
                if (row) {
                    row.style.transition = 'opacity 0.5s';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        
                        // Check if there are any rows left
                        const remainingRows = document.querySelectorAll('.drop-requests-table tbody tr');
                        if (remainingRows.length === 0) {
                            // No more rows, show empty message
                            document.getElementById('drop-requests-table-container').innerHTML = `
                                <div class="drop-requests-empty">
                                    No pending drop course requests found.
                                </div>
                            `;
                        }
                    }, 500);
                }
            } else {
                // Show error message
                showDropRequestsMessage(data.message, 'error');
                
                // Re-enable buttons
                if (row) {
                    const buttons = row.querySelectorAll('button');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        if (btn.classList.contains('btn-approve')) {
                            btn.innerHTML = '<i class="fas fa-check"></i> Approve';
                        } else if (btn.classList.contains('btn-reject')) {
                            btn.innerHTML = '<i class="fas fa-times"></i> Reject';
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error in fetch operation:', error);
            // Show error message
            showDropRequestsMessage(`Error: ${error.message}`, 'error');
            
            // Re-enable buttons
            if (row) {
                const buttons = row.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.disabled = false;
                    if (btn.classList.contains('btn-approve')) {
                        btn.innerHTML = '<i class="fas fa-check"></i> Approve';
                    } else if (btn.classList.contains('btn-reject')) {
                        btn.innerHTML = '<i class="fas fa-times"></i> Reject';
                    }
                });
            }
        });
    }

    // Show drop requests message
    function showDropRequestsMessage(message, type = 'error') {
        const messageEl = document.getElementById('drop-requests-error-message');
        messageEl.textContent = message;
        messageEl.style.display = 'block';
        
        if (type === 'success') {
            messageEl.classList.add('success');
        } else {
            messageEl.classList.remove('success');
        }
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 5000);
    }
    
    // Load forgiveness policy requests with optional status filter
    function loadForgivenessRequests(statusFilter = 'pending') {
        const tableContainer = document.getElementById('forgiveness-table-container');
        const loadingElement = document.getElementById('forgiveness-loading');
        
        // Update active filter button
        document.querySelectorAll('.forgiveness-filters .status-filter-btn').forEach(btn => {
            if (btn.getAttribute('data-status') === statusFilter) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Show loading indicator
        loadingElement.style.display = 'block';
        tableContainer.innerHTML = '';
        
        // Fetch forgiveness requests from API with status filter
        fetch(`/admin/course_registration/forgiveness?status=${statusFilter}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                loadingElement.style.display = 'none';
                
                if (data.success) {
                    renderForgivenessRequestsTable(data.requests, tableContainer, statusFilter);
                    
                    // Setup search functionality
                    setupForgivenessSearchFilter();
                } else {
                    tableContainer.innerHTML = `
                        <div class="forgiveness-empty">
                            Error: ${data.message || 'Failed to load forgiveness policy requests'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                // Hide loading indicator
                loadingElement.style.display = 'none';
                
                tableContainer.innerHTML = `
                    <div class="forgiveness-empty">
                        An error occurred while loading forgiveness policy requests: ${error.message}
                    </div>
                `;
                console.error('Error fetching forgiveness policy requests:', error);
            });
    }
    
    // Setup search filter for forgiveness policy requests
    function setupForgivenessSearchFilter() {
        const searchInput = document.getElementById('forgiveness-search');
        if (!searchInput) return;
        
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('.forgiveness-table tbody tr');
            
            rows.forEach(row => {
                const studentName = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                const courseCode = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                
                if (studentName.includes(searchTerm) || courseCode.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // Render forgiveness policy requests table
    function renderForgivenessRequestsTable(requests, container, statusFilter) {
        if (!requests || requests.length === 0) {
            const emptyMessage = statusFilter === 'pending' ? 
                'No pending forgiveness policy requests found.' : 
                'No processed forgiveness policy requests found.';
                
            container.innerHTML = `
                <div class="forgiveness-empty">
                    ${emptyMessage}
                </div>
            `;
            return;
        }
        
        // Create table with different columns based on status filter
        let tableHtml = `
            <table class="forgiveness-table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Course</th>
                        <th>Grades</th>
                        <th>Request Date</th>
                        ${statusFilter === 'pending' ? '' : '<th>Status</th>'}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // Add rows for all requests
        requests.forEach(request => {
            // Format dates
            const requestDate = request.request_date ? 
                new Date(request.request_date).toLocaleString() : '-';
            const handlingDate = request.handling_date ? 
                new Date(request.handling_date).toLocaleString() : '-';
            
            // Only show action buttons for pending requests
            const actionButtons = request.status === 'pending' ? `
                <button class="btn-approve" data-request-id="${request.id}" data-action="approve">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn-reject" data-request-id="${request.id}" data-action="reject">
                    <i class="fas fa-times"></i> Reject
                </button>
            ` : `
                <div style="font-size: 0.8rem; color: #666;">
                    ${request.admin_first_name} ${request.admin_last_name}
                </div>
                <div style="font-size: 0.8rem; color: #666;">
                    Date: ${handlingDate}
                </div>
            `;
            
            tableHtml += `
                <tr data-request-id="${request.id}" data-student-id="${request.student_id}">
                    <td>
                        <div>${request.first_name} ${request.last_name}</div>
                        <div style="font-size: 0.8rem; color: #666;">ID: ${request.national_id}</div>
                    </td>
                    <td>
                        <div>${request.course_code}</div>
                    </td>
                    <td>
                        <div>Old: <strong>${request.forgiven_grade}</strong></div>
                        <div>New: <strong>${request.new_grade}</strong></div>
                    </td>
                    <td>${requestDate}</td>
                    ${statusFilter === 'pending' ? '' : `
                    <td>
                        <span class="forgiveness-status ${request.status}">
                            ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                        </span>
                    </td>
                    `}
                    <td class="request-actions">
                        ${actionButtons}
                    </td>
                </tr>
            `;
        });
        
        tableHtml += `
                </tbody>
            </table>
        `;
        
        container.innerHTML = tableHtml;
        
        // Add event listeners to buttons
        const approveButtons = container.querySelectorAll('.btn-approve');
        const rejectButtons = container.querySelectorAll('.btn-reject');
        
        approveButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                handleForgivenessRequest(requestId, 'approve');
            });
        });
        
        rejectButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                handleForgivenessRequest(requestId, 'reject');
            });
        });
    }
    
    // Handle forgiveness policy request (approve or reject)
    function handleForgivenessRequest(requestId, action) {
        // Disable buttons to prevent multiple clicks
        const row = document.querySelector(`.forgiveness-table tr[data-request-id="${requestId}"]`);
        if (row) {
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.classList.contains('btn-approve')) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
                } else if (btn.classList.contains('btn-reject')) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
                }
            });
        }
        
        // Send request to API
        fetch(`/admin/course_registration/forgiveness/${requestId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.message || `Server error: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success message
                showForgivenessMessage(data.message, 'success');
                
                // Reload the forgiveness requests to reflect the changes
                loadForgivenessRequests(document.querySelector('.forgiveness-filters .status-filter-btn.active').getAttribute('data-status') || 'pending');
            } else {
                // Show error message
                showForgivenessMessage(data.message, 'error');
                
                // Re-enable buttons
                if (row) {
                    const buttons = row.querySelectorAll('button');
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        if (btn.classList.contains('btn-approve')) {
                            btn.innerHTML = '<i class="fas fa-check"></i> Approve';
                        } else if (btn.classList.contains('btn-reject')) {
                            btn.innerHTML = '<i class="fas fa-times"></i> Reject';
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error(`Error ${action}ing forgiveness request:`, error);
            showForgivenessMessage(`Error: ${error.message}`, 'error');
            
            // Re-enable buttons
            if (row) {
                const buttons = row.querySelectorAll('button');
                buttons.forEach(btn => {
                    btn.disabled = false;
                    if (btn.classList.contains('btn-approve')) {
                        btn.innerHTML = '<i class="fas fa-check"></i> Approve';
                    } else if (btn.classList.contains('btn-reject')) {
                        btn.innerHTML = '<i class="fas fa-times"></i> Reject';
                    }
                });
            }
        });
    }
    
    // Show forgiveness message
    function showForgivenessMessage(message, type = 'error') {
        const messageEl = document.getElementById('forgiveness-error-message');
        messageEl.textContent = message;
        messageEl.style.display = 'block';
        
        if (type === 'success') {
            messageEl.classList.add('success');
        } else {
            messageEl.classList.remove('success');
        }
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 5000);
    }

    // Load major/minor validation section
    async function loadMajorMinorValidation() {
        console.log('Loading major/minor validation data');
        showLoadingState('major-minor-validation');
        
        // Check selection period status
        await checkSelectionStatus();
        
        // First create the HTML structure
        document.getElementById('content-title').textContent = 'Major/Minor Validation';
        document.getElementById('dynamic-content').innerHTML = `
            <div class="content-card" id="selection-period-management">
                <div class="registration-management">
                    <div class="registration-header" id="selection-period-header">
                        <h4><i class="fas fa-user-graduate"></i> Selection Period Management</h4>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="registration-content" id="selection-period-content">
                        <div id="selection-error-message" class="registration-error-message" style="display: none;"></div>
                        <div class="form-group">
                            <label for="selection-open-date">Start Date</label>
                            <input type="datetime-local" id="selection-open-date" class="form-control" 
                                ${isSelectionOpen || isSelectionScheduled ? 'disabled' : ''} 
                                min="${new Date().toISOString().slice(0, 16)}">
                        </div>
                        <div class="form-group">
                            <label for="selection-close-date">End Date</label>
                            <input type="datetime-local" id="selection-close-date" class="form-control" 
                                ${isSelectionOpen || isSelectionScheduled ? 'disabled' : ''} 
                                min="${new Date().toISOString().slice(0, 16)}">
                        </div>
                        <div class="button-group">
                            <button id="open-selection-btn" class="btn btn-primary" ${isSelectionOpen || isSelectionScheduled ? 'disabled' : ''}>
                                ${isSelectionOpen ? 'Selection is Open' : 
                                isSelectionScheduled ? 'Selection is Scheduled' : 
                                'Open Selection Period'}
                            </button>
                            <button id="close-selection-btn" class="btn btn-danger" ${!isSelectionOpen && !isSelectionScheduled ? 'disabled' : ''}>
                                ${isSelectionScheduled ? 'Cancel Scheduled Selection' : 
                                'Close Selection Period'}
                            </button>
                        </div>
                        <div id="selection-timer-section" class="timer-section" style="display: ${isSelectionOpen || isSelectionScheduled ? 'block' : 'none'};">
                            <div id="selection-timer-message" class="timer-message">
                                ${isSelectionOpen ? 'Selection period ends in:' : 
                                 isSelectionScheduled ? 'Selection will open in:' : 
                                 'Selection period ends in:'}
                            </div>
                            <div id="selection-countdown-timer" class="countdown-timer">
                                --:--:--
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-card">
                <div class="student-summary">
                    <div class="summary-card">
                        <h4>Major Counts</h4>
                        <div class="summary-value" id="major-counts">-</div>
                    </div>
                    <div class="summary-card-counts">
                        <h4>Pending requests</h4>
                        <div class="summary-value" id="pending-choices">-</div>
                    </div>
                    <div class="summary-card-counts">
                        <h4>Submitted Requests</h4>
                        <div class="summary-value">
                            <span id="submitted-requests">-</span>
                            <small>out of <span id="total-eligible">-</span> eligible students</small>
                        </div>
                    </div>
                    <div class="summary-card-list">
                        <h4>Accepted Combinations</h4>
                        <div class="summary-value accepted-combinations-list" id="accepted-combinations">
                            <!-- Accepted combinations will be listed here -->
                        </div>
                    </div>
                </div>

                <div class="specialty-requests-section">
                    <div class="specialty-requests-header" id="specialty-requests-header">
                        <h4><i class="fas fa-chevron-down"></i> Specialty Requests</h4>
                    </div>
                    <div class="specialty-requests-content" id="specialty-requests-content">
                        <div class="search-section">
                            <input type="text" id="combination-search" placeholder="Search combinations..." class="form-control">
                        </div>

                        <div class="combinations-section">
                            <h4>Major-Minor Combinations</h4>
                            <div id="major-minor" class="combination-list"></div>
                        </div>

                        <div class="combinations-section">
                            <h4>Major-Major Combinations</h4>
                            <div id="major-major" class="combination-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Major-Minor-Minor section removed as it's no longer supported -->
            </div>
        `;
        
        // Set values for date inputs if we have saved dates
        const openDateInput = document.getElementById('selection-open-date');
        const closeDateInput = document.getElementById('selection-close-date');
        
        if (openDateInput && savedSelectionStartDate) {
            const startDate = new Date(savedSelectionStartDate);
            // Fix for timezone issues - convert to local time string
            const formattedStartDate = new Date(startDate.getTime() - (startDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            openDateInput.value = formattedStartDate;
        }
        
        if (closeDateInput && savedSelectionEndDate) {
            const endDate = new Date(savedSelectionEndDate);
            // Fix for timezone issues - convert to local time string
            const formattedEndDate = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            closeDateInput.value = formattedEndDate;
        }

        // Set min datetime for inputs
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
        
        if (openDateInput) {
            openDateInput.min = localISOTime;
        }
        if (closeDateInput) {
            closeDateInput.min = localISOTime;
        }
        
        // Add event listeners for selection period management buttons
        console.log('Adding event listeners for selection period management buttons');
        document.getElementById("open-selection-btn").addEventListener("click", function() {
            console.log('Open selection button clicked');
            handleOpenSelection();
        });
        
        document.getElementById("close-selection-btn").addEventListener("click", function() {
            console.log('Close selection button clicked');
            handleCloseSelection();
        });
        
        console.log('Selection period management event listeners added');
        
        // Add collapsible functionality for Selection Period Management
        document.getElementById("selection-period-header").addEventListener("click", function() {
            toggleSection('selection-period-content', this);
        });
        
        // Add collapsible functionality for Specialty Requests
        document.getElementById("specialty-requests-header").addEventListener("click", function() {
            toggleSection('specialty-requests-content', this);
        });
        
        // Start countdown if needed
        updateSelectionTimerMessage();
        if (isSelectionOpen && selectionEndTime) {
            startSelectionCountdown(selectionEndTime);
        } else if (isSelectionScheduled && selectionStartTime && selectionEndTime) {
            startSelectionCountdownToOpening(selectionStartTime, selectionEndTime);
        }
        
        // Initialize the collapsible section
        const selectionPeriodContent = document.getElementById('selection-period-content');
        const selectionPeriodHeader = document.getElementById('selection-period-header');
        const icon = selectionPeriodHeader.querySelector('i.fas.fa-chevron-down');
        
        // Start collapsed by default
        selectionPeriodContent.classList.remove('expanded');
        icon.className = 'fas fa-chevron-down';
        
        try {
            const response = await fetch('/admin/major_minor_validation');
            console.log('Response received:', response);
            
            if (!response.ok) throw new Error('Failed to load data');
            
            const data = await response.json();
            console.log('Data received:', data);
            
            if (!data.success) throw new Error(data.message);

            // Update statistics
            document.getElementById('total-eligible').textContent = data.statistics?.total_eligible || 0;
            document.getElementById('pending-choices').textContent = data.statistics?.pending_choices || 0;
            document.getElementById('submitted-requests').textContent = data.statistics?.submitted_requests || 0;

            // Using the global getMajorColor function defined earlier
            
            // Display major counts with color styling
            if (data.success && data.statistics?.major_counts) {
                const counts = data.statistics.major_counts;
                const majorCountsElement = document.getElementById('major-counts');
                
                if (Object.keys(counts).length > 0) {
                    majorCountsElement.style.display = "block";
                    majorCountsElement.innerHTML = Object.entries(counts)
                        .sort((a, b) => b[1] - a[1])  // Sort by count descending
                        .map(([major, count]) => `
                            <div class="${major}">
                                <div>${major} :</div>
                                <div>${count}</div>
                            </div>
                        `)
                        .join('');
                } else {
                    majorCountsElement.textContent = 'No major selections found';
                }
            }

            // Clear existing content
            document.querySelectorAll('.combination-list').forEach(list => list.innerHTML = '');

            // Initialize accepted combinations list
            const acceptedCombinationsDiv = document.getElementById('accepted-combinations');
            acceptedCombinationsDiv.innerHTML = ''; // Clear existing content

            // Populate each category and track accepted combinations
            if (data.combinations) {
                // Process each category and collect accepted combinations
                Object.entries(data.combinations).forEach(([category, combinations]) => {
                    Object.entries(combinations).forEach(([combo, data]) => {
                        if (data.status === 'accepted') {
                            // Get the correct combination type from the category name
                            const combinationType = category === 'major_major' ? 'major-major' : 'major-minor';
                            // Create a temporary object with the needed properties
                            const tempCard = {
                                dataset: {
                                    combinationType: combinationType
                                }
                            };
                            // Pass the combination and the temp card to update function
                            updateAcceptedCombinationsList('add', combo, tempCard);
                        }
                    });
                });

                // Populate the combination lists
                populateCombinations('major-minor', data.combinations.major_minor || {});
                populateCombinations('major-major', data.combinations.major_major || {});
                // Major-Minor-Minor combinations no longer supported
            } else {
                console.warn('No combinations data received');
                document.querySelectorAll('.combination-list').forEach(list => {
                    list.innerHTML = '<div class="no-data">No combinations available</div>';
                });
            }

            // Initialize search functionality with improved matching
            const searchInput = document.getElementById('combination-search');
            if (searchInput) {
                // Update placeholder text
                searchInput.placeholder = 'Search combinations... e.g. "BA/IT"';
                
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('.combination-card').forEach(card => {
                        const searchText = card.dataset.searchText.toLowerCase();
                        const shouldShow = searchText.includes(searchTerm) || 
                                         searchText.replace(/\//g, '-').includes(searchTerm) ||
                                         searchText.replace(/-/g, '/').includes(searchTerm);
                        card.style.display = shouldShow ? 'block' : 'none';
                    });
                });
            }

            // Fix the Submitted Requests click handler - explicitly target the correct element
            function setupSubmittedRequestsClick() {
                console.log('Setting up submitted requests click handler');
                const submittedRequestsBox = document.querySelector('.summary-card-counts:nth-child(3)');
                if (submittedRequestsBox) {
                    console.log('Found submitted requests box:', submittedRequestsBox);
                    submittedRequestsBox.style.cursor = 'pointer';
                    submittedRequestsBox.addEventListener('click', function() {
                        console.log('Submitted requests box clicked');
                        showSubmittedRequestsModal();
                    });
                } else {
                    console.warn('Submitted requests box not found');
                    // Try alternative selector
                    const allSummaryCards = document.querySelectorAll('.summary-card-counts');
                    console.log('Found', allSummaryCards.length, 'summary cards');
                    if (allSummaryCards.length >= 3) {
                        const submittedBox = allSummaryCards[2]; // third box
                        console.log('Using alternative selector:', submittedBox);
                        submittedBox.style.cursor = 'pointer';
                        submittedBox.addEventListener('click', function() {
                            console.log('Alternative submitted requests box clicked');
                            showSubmittedRequestsModal();
                        });
                    }
                }
            }

            // Setup Submitted Requests box click handler after data is loaded
            setTimeout(setupSubmittedRequestsClick, 100);

        } catch (error) {
            console.error('Error loading major/minor validation:', error);
            showToast('Error loading major/minor validation data: ' + error.message, 'error');
            
            // Show error state in each container
            document.querySelectorAll('.combination-list').forEach(list => {
                list.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Failed to load data</h4>
                        <p>${error.message}</p>
                        <button class="retry-btn" onclick="window.updateMajorMinorValidation()">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
            });
        }
    }

    // Function to toggle collapsible sections
    function toggleSection(contentId, headerElement) {
        const content = document.getElementById(contentId);
        const icon = headerElement.querySelector('i.fas.fa-chevron-down');
        
        if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            if (icon) icon.className = 'fas fa-chevron-down';
        } else {
            content.classList.add('expanded');
            if (icon) icon.className = 'fas fa-chevron-up';
        }
    }
    
    // Global function for major color mapping
    function getMajorColor(major) {
        const colors = {
            'FIN': '#49b8fc',
            'ACCT': '#31d4a8',
            'MRK': '#fa6986',
            'BA': '#fcab30',
            'IT': '#796be8'
        };
        return colors[major] || '#ccc';
    }
    
    // Add function to update major/minor validation data
    async function updateMajorMinorValidation() {
        try {
            // Check if we're in the major/minor validation section by checking if required elements exist
            const totalEligibleElement = document.getElementById('total-eligible');
            if (!totalEligibleElement) {
                console.log('Not in major/minor validation section, skipping update');
                return; // Exit the function if we're not in the major/minor validation section
            }
            
            console.log('Updating major/minor validation data');
            const response = await fetch('/admin/major_minor_validation');
            
            if (!response.ok) throw new Error('Failed to load data');
            
            const data = await response.json();
            
            if (!data.success) throw new Error(data.message);
            
            // Update statistics - now safe to use these elements since we checked above
            totalEligibleElement.textContent = data.statistics?.total_eligible || 0;
            document.getElementById('pending-choices').textContent = data.statistics?.pending_choices || 0;
            document.getElementById('submitted-requests').textContent = data.statistics?.submitted_requests || 0;
            
            // Display major counts
            if (data.statistics?.major_counts) {
                const counts = data.statistics.major_counts;
                const majorCountsElement = document.getElementById('major-counts');
                
                if (majorCountsElement) {
                    if (Object.keys(counts).length > 0) {
                        majorCountsElement.innerHTML = Object.entries(counts)
                            .sort((a, b) => b[1] - a[1])
                            .map(([major, count]) => `
                                <div class="${major}">
                                    <div>${major} :</div>
                                    <div>${count}</div>
                                </div>
                            `)
                            .join('');
                    } else {
                        majorCountsElement.textContent = 'No major selections found';
                    }
                }
            }
            
            // Clear existing content
            document.querySelectorAll('.combination-list').forEach(list => list.innerHTML = '');
            
            // Clear accepted combinations list
            const acceptedCombinationsDiv = document.getElementById('accepted-combinations');
            if (acceptedCombinationsDiv) {
                acceptedCombinationsDiv.innerHTML = '';
            }
            
            // Populate each category and track accepted combinations
            if (data.combinations) {
                // Process each category and collect accepted combinations
                Object.entries(data.combinations).forEach(([category, combinations]) => {
                    Object.entries(combinations).forEach(([combo, data]) => {
                        if (data.status === 'accepted') {
                            // Get the correct combination type from the category name
                            const combinationType = category === 'major_major' ? 'major-major' : 'major-minor';
                            // Create a temporary object with the needed properties
                            const tempCard = {
                                dataset: {
                                    combinationType: combinationType
                                }
                            };
                            // Pass the combination and the temp card to update function
                            updateAcceptedCombinationsList('add', combo, tempCard);
                        }
                    });
                });
                
                // Populate the combination lists
                populateCombinations('major-minor', data.combinations.major_minor || {});
                populateCombinations('major-major', data.combinations.major_major || {});
            } else {
                console.warn('No combinations data received');
                document.querySelectorAll('.combination-list').forEach(list => {
                    list.innerHTML = '<div class="no-data">No combinations available</div>';
                });
            }
            
        } catch (error) {
            console.error('Error updating major/minor validation:', error);
            showToast('Error updating major/minor validation data: ' + error.message, 'error');
            
            // Show error state in each container
            document.querySelectorAll('.combination-list').forEach(list => {
                list.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Failed to load data</h4>
                        <p>${error.message}</p>
                        <button class="retry-btn" onclick="window.updateMajorMinorValidation()">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
            });
        }
    }

    // Make updateMajorMinorValidation available globally
    window.updateMajorMinorValidation = updateMajorMinorValidation;

    function populateCombinations(containerId, combinations) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Container not found for ${containerId}`);
            return;
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        // Check if combinations is undefined or null
        if (!combinations || typeof combinations !== 'object') {
            container.innerHTML = '<div class="no-data">No combinations available</div>';
            return;
        }
        
        // Check if there are any combinations
        const combinationEntries = Object.entries(combinations);
        if (combinationEntries.length === 0) {
            container.innerHTML = '<div class="no-data">No combinations available</div>';
            return;
        }
        
        combinationEntries.forEach(([combo, data]) => {
            const card = document.createElement('div');
            card.className = 'combination-card';
            card.dataset.combination = combo;
            card.dataset.status = data.status || 'pending';
            card.dataset.searchText = combo.replace(/-/g, '/');
            card.dataset.combinationType = containerId; // Add combination type based on containerId

            // Split the combination and format it with proper colors
            const parts = combo.split('-');
            let formattedCombo = '';
            if (parts.length === 2) {
                // Format differently based on combination type
                if (containerId === 'major-major') {
                    formattedCombo = `<span class="major">${parts[0]}</span><span class="separator">/</span><span class="major">${parts[1]}</span>`;
                } else {
                    formattedCombo = `<span class="major">${parts[0]}</span><span class="separator">/</span><span class="minor">${parts[1]}</span>`;
                }
            } else if (parts.length === 3) {
                if (['ACCT', 'BA', 'FIN', 'IT', 'MRK'].includes(parts[1])) {
                    formattedCombo = `<span class="major">${parts[0]}</span><span class="separator">/</span><span class="major">${parts[1]}</span>`;
                }
                // Major-Minor-Minor combinations are no longer supported
            }

            // Create student list HTML
            let studentsHtml = '';
            if (Array.isArray(data.students) && data.students.length > 0) {
                studentsHtml = data.students.map(student => `
                    <div class="student-item" data-student-id="${student.national_id}" onclick="showStudentDetails('${student.national_id}')">
                            <div class="student-info">
                                <div class="student-name">${student.first_name} ${student.last_name}</div>
                                <div class="student-id">ID: ${student.national_id}</div>
                            </div>
                        </div>
                `).join('');
            } else {
                studentsHtml = '<div class="no-data">No students in this combination</div>';
            }

            // Add status badge to the header
            const statusBadge = `<span class="status-badge ${data.status || 'pending'}">${(data.status || 'pending').toUpperCase()}</span>`;

            card.innerHTML = `
                <div class="combination-header">
                    <div style="display: flex; align-items: center;">
                    <h4>${formattedCombo}</h4>
                        ${statusBadge}
                    </div>
                    <span class="count-badge">${data.count || 0} students</span>
                </div>
                <div class="combination-actions">
                    <div class="search-box">
                        <input type="text" class="combination-search" placeholder="Search students...">
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success accept-btn" ${data.status === 'accepted' ? 'disabled' : ''}>
                            <i class="fas fa-check"></i> Accept All
                        </button>
                        <button class="btn btn-danger reject-btn" ${data.status === 'rejected' ? 'disabled' : ''}>
                            <i class="fas fa-times"></i> Reject All
                        </button>
                    </div>
                </div>
                <div class="students-list">
                    ${studentsHtml}
                </div>
                <div class="undo-overlay">
                    <div class="message">Combination has been ${data.status || 'pending'}</div>
                    <button class="undo-btn">
                        <i class="fas fa-undo"></i> Undo
                    </button>
                </div>
            `;

            container.appendChild(card);

            // Add click event listeners to the buttons
            const acceptBtn = card.querySelector('.accept-btn');
            const rejectBtn = card.querySelector('.reject-btn');
            const undoBtn = card.querySelector('.undo-btn');
            const overlay = card.querySelector('.undo-overlay');

            if (acceptBtn) {
                acceptBtn.addEventListener('click', async () => {
                    console.log('Accept clicked for combination:', combo);
                    const result = await handleRequest(combo, 'accept', card);
                    if (result.success) {
                        updateAcceptedCombinationsList('add', combo, card);
                    }
                });
            }

            if (rejectBtn) {
                rejectBtn.addEventListener('click', async () => {
                    console.log('Reject clicked for combination:', combo);
                    const result = await handleRequest(combo, 'reject', card);
                    if (result.success) {
                        updateAcceptedCombinationsList('remove', combo, card);
                    }
                });
            }

            if (undoBtn) {
                undoBtn.addEventListener('click', async () => {
                    console.log('Undo clicked for combination:', combo);
                    const result = await handleUndo(combo, card);
                    if (result.success) {
                        updateAcceptedCombinationsList('remove', combo, card);
                    }
                });
            }

            // Add search functionality for this combination
            const searchInput = card.querySelector('.combination-search');
            const studentItems = card.querySelectorAll('.student-item');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                studentItems.forEach(item => {
                    const studentName = item.querySelector('.student-name').textContent.toLowerCase();
                    item.style.display = studentName.includes(searchTerm) ? 'flex' : 'none';
                });
            });

            // Show overlay if status is not pending
            if (data.status && data.status !== 'pending') {
                overlay.classList.add('visible');
            }
        });
    }

    // Add this new wrapper function for state updates
    function updateCombinationState(card, newStatus) {
    // Get the number of students in this combination
    const studentCount = card.querySelectorAll('.student-item').length;
    
    // Update card status
    card.dataset.status = newStatus;
    
    // Update status badge
    const statusBadge = card.querySelector('.status-badge');
    statusBadge.className = `status-badge ${newStatus}`;
    statusBadge.textContent = newStatus.toUpperCase();
    
    // Update buttons state
    const acceptBtn = card.querySelector('.accept-btn');
    const rejectBtn = card.querySelector('.reject-btn');
    
    if (newStatus === 'accepted') {
        acceptBtn.disabled = true;
        rejectBtn.disabled = false;
    } else if (newStatus === 'rejected') {
        acceptBtn.disabled = false;
        rejectBtn.disabled = true;
    } else { // pending
        acceptBtn.disabled = false;
        rejectBtn.disabled = false;
    }
    
    // Update overlay
    const overlay = card.querySelector('.undo-overlay');
    const message = overlay.querySelector('.message');
    
    if (newStatus === 'pending') {
        overlay.classList.remove('visible');
    } else {
        message.textContent = `Combination has been ${newStatus}`;
        overlay.classList.add('visible');
    }
    
    // Update statistics - this is the key change
    const pendingChoices = document.getElementById('pending-choices');
    if (pendingChoices) {
        let currentCount = parseInt(pendingChoices.textContent);
        
        if (newStatus === 'pending') {
            // When undoing, add back the number of students in this combination
            currentCount += studentCount;
        } else if (['accepted', 'rejected'].includes(newStatus)) {
            // When accepting/rejecting, subtract the number of students
            currentCount = Math.max(0, currentCount - studentCount);
        }
        
        pendingChoices.textContent = currentCount;
    }
}

    // Update the handleRequest function
    async function handleRequest(combination, action, card) {
        try {
            // Show loading state
            const actionBtn = card.querySelector(`.${action}-btn`);
            const originalText = actionBtn.innerHTML;
            actionBtn.disabled = true;
            actionBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`;

            const response = await fetch('/admin/major_minor_validation/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    combination: combination,
                    action: action === 'accept' ? 'accepted' : 'rejected',
                    combination_type: card.dataset.combinationType
                })
            });

            const data = await response.json();
            if (data.success) {
                const newStatus = action === 'accept' ? 'accepted' : 'rejected';
                
                // Use the wrapper function to update all states
                updateCombinationState(card, newStatus);
                
                // Update accepted combinations list
                if (action === 'accept') {
                    updateAcceptedCombinationsList('add', combination, card);
                } else {
                    updateAcceptedCombinationsList('remove', combination, card);
                }
                
                showToast(`Combination ${action}ed successfully`, 'success');
                return { success: true };
            } else {
                showToast(data.message || 'Error processing request', 'error');
                return { success: false };
            }
        } catch (error) {
            console.error('Error processing request:', error);
            showToast('Error processing request: ' + error.message, 'error');
            return { success: false };
        } finally {
            // Reset button state
            const actionBtn = card.querySelector(`.${action}-btn`);
            actionBtn.disabled = false;
            actionBtn.innerHTML = `<i class="fas fa-${action === 'accept' ? 'check' : 'times'}"></i> ${action === 'accept' ? 'Accept' : 'Reject'} All`;
        }
    }

    // Update the handleUndo function
    async function handleUndo(combination, card) {
        try {
            // Check if this is undoing a rejection
            const isUndoingRejection = card.dataset.status === 'rejected';
            
            const response = await fetch('/admin/major_minor_validation/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    combination: combination,
                    action: 'pending',
                    remove_rejection: isUndoingRejection,
                    combination_type: card.dataset.combinationType
                })
            });

            const data = await response.json();
            if (data.success) {
                // Use the wrapper function to update all states
                updateCombinationState(card, 'pending');
                
                // Remove from accepted combinations list
                updateAcceptedCombinationsList('remove', combination, card);
                
                showToast('Changes undone successfully', 'success');
                return { success: true };
            } else {
                showToast(data.message || 'Error undoing changes', 'error');
                return { success: false };
            }
        } catch (error) {
            console.error('Error undoing changes:', error);
            showToast('Error undoing changes: ' + error.message, 'error');
            return { success: false };
        }
    }

    function updateAcceptedCombinationsList(action, combination, cardOrType) {
        const acceptedCombinationsDiv = document.getElementById('accepted-combinations');
        if (!acceptedCombinationsDiv) return;

        if (action === 'add') {
            // Get the combination type from the card or directly from argument
            let combinationType;
            
            if (typeof cardOrType === 'string') {
                // If directly provided as string
                combinationType = cardOrType;
            } else if (cardOrType && cardOrType.dataset) {
                // If provided as card element or object with dataset
                combinationType = cardOrType.dataset.combinationType;
            } else {
                // Try to get from DOM if not provided
                const combinationCard = document.querySelector(`.combination-card[data-combination="${combination}"]`);
                if (!combinationCard) return;
                combinationType = combinationCard.dataset.combinationType;
            }
            
            // Create a unique identifier that includes both the combination and its type
            const combinationId = `${combination}-${combinationType}`;
            
            // Check if this specific combination+type already exists
            if (acceptedCombinationsDiv.querySelector(`[data-combination-id="${combinationId}"]`)) {
                return;
            }

            // Create new combination element
            const newCombo = document.createElement('div');
            newCombo.className = 'accepted-combo';
            newCombo.dataset.combination = combination;
            newCombo.dataset.combinationType = combinationType;
            newCombo.dataset.combinationId = combinationId;

            // Split and format the combination
            const parts = combination.split('-');
            if (parts.length === 2) {
                if (combinationType === 'major-major') {
                    newCombo.innerHTML = `
                        <span class="major">${parts[0]}</span>
                        <span class="separator">/</span>
                        <span class="major">${parts[1]}</span>
                    `;
                } else {
                    newCombo.innerHTML = `
                        <span class="major">${parts[0]}</span>
                        <span class="separator">/</span>
                        <span class="minor">${parts[1]}</span>
                    `;
                }
            } else if (parts.length === 3) {
                if (['ACCT', 'BA', 'FIN', 'IT', 'MRK'].includes(parts[1])) {
                    newCombo.innerHTML = `
                        <span class="major">${parts[0]}</span>
                        <span class="separator">/</span>
                        <span class="major">${parts[1]}</span>
                    `;
                }
                // Major-Minor-Minor combinations are no longer supported
            }

            // Add with animation
            newCombo.style.opacity = '0';
            newCombo.style.transform = 'translateX(-20px)';
            acceptedCombinationsDiv.appendChild(newCombo);
            
            // Trigger animation
            requestAnimationFrame(() => {
                newCombo.style.transition = 'all 0.3s ease';
                newCombo.style.opacity = '1';
                newCombo.style.transform = 'translateX(0)';
            });

        } else if (action === 'remove') {
            // Find all accepted combinations with this combination string 
            // (could be both major-major and major-minor with same components)
            const combos = acceptedCombinationsDiv.querySelectorAll(`[data-combination="${combination}"]`);
            
            if (combos.length > 0) {
                combos.forEach(combo => {
                    // Remove with animation
                    combo.style.transition = 'all 0.3s ease';
                    combo.style.opacity = '0';
                    combo.style.transform = 'translateX(20px)';
                    
                    setTimeout(() => {
                        combo.remove();
                    }, 300);
                });
            }
        }
    }

    // Show loading spinner
    function showLoadingState(section) {
        document.getElementById('dynamic-content').innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading ${section.replace('-', ' ')}...</p>
            </div>
        `;
    }
    
    // Format date for backend
    function formatDateForBackend(datetimeLocal) {
        console.log('formatDateForBackend input:', datetimeLocal);
        if (!datetimeLocal) return null;
        
        try {
            const date = new Date(datetimeLocal);
            console.log('Parsed date object:', date);
            
            // Format as YYYY-MM-DD HH:MM:SS
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            const formattedDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            console.log('Formatted date result:', formattedDate);
            
            return formattedDate;
        } catch (error) {
            console.error('Error formatting date:', error);
            return null;
        }
    }

    // Format date for display
    function formatDisplayDate(dateString) {
        if (!dateString) return 'Not started yet';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }
    
    // Show inline message for selection period management
    function showInlineMessage(message, type) {
        const errorMessage = document.getElementById("selection-error-message");
        if (!errorMessage) return;
        
        errorMessage.textContent = message;
        errorMessage.className = "registration-error-message" + (type === 'success' ? ' success' : '');
        errorMessage.style.display = 'block';
        
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    // Get semester name
    function getSemesterName(semesterNumber) {
        return semesterNumber === 1 ? 'Fall' : 'Spring';
    }

    // Handle semester action (start/end)
    async function handleSemesterAction() {
        const btn = document.getElementById("semester-action-btn");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Processing...";

        try {
            const action = originalText.includes("Start") ? "start" : "end";
            const response = await fetch("/admin/course_registration", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: "manage_semester",
                    type: action
                })
            });
            
            const result = await response.json();

            if (result.success) {
                currentSemesterStatus = result.data;
                
                // Format success message with semester name
                const semesterName = getSemesterName(result.data.current_semester.semester);
                const year = result.data.current_semester.academic_year;
                const successMessage = action === 'start' 
                    ? `Semester: ${semesterName}, ${year} has started successfully`
                    : `Semester: ${semesterName}, ${year} has ended successfully`;
                
                showInlineMessage(successMessage, 'success');
                
                // If ending semester, check if there's an active registration and close it
                if (action === 'end' && (isRegistrationOpen || isRegistrationScheduled)) {
                    isRegistrationOpen = false;
                    isRegistrationScheduled = false;
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                    registrationEndTime = null;
                    registrationStartTime = null;
                    
                    // Update UI immediately
                    document.getElementById("timer-section").style.display = "none";
                    document.getElementById("open-registration-btn").disabled = false;
                    document.getElementById("close-registration-btn").disabled = true;
                    document.getElementById("close-registration-btn").textContent = "Close Registration";
                    document.getElementById("open-registration-btn").textContent = "Open Registration";
                    
                    // Enable inputs and clear values
                    const openDateInput = document.getElementById("open-date");
                    const closeDateInput = document.getElementById("close-date");
                    
                    if (openDateInput) {
                        openDateInput.disabled = false;
                        openDateInput.value = '';
                    }
                    if (closeDateInput) {
                        closeDateInput.disabled = false;
                        closeDateInput.value = '';
                    }
                    
                    // Check if there are graduates to show
                    if (result.data.graduates && result.data.graduates.length > 0) {
                        showGraduatesPopup(result.data.graduates);
                    }
                }
                
                // Update registration status
                await checkRegistrationStatus();
                
                // Reload the section to show updated info
                loadSection('course-registration');
            } else {
                // Check if this is an incomplete grades error
                if (result.error_type === 'incomplete_grades' && result.students) {
                    // Display the popup with student information
                    showIncompleteGradesPopup(result.students);
                } else {
                    // Show regular error message
                    showInlineMessage(result.message || "Failed to perform semester action", 'error');
                }
            }
        } catch (error) {
            showInlineMessage("Network error: " + error.message, 'error');
        } finally {
            btn.disabled = false;
        }
    }

    // Function to show the incomplete grades popup
    function showIncompleteGradesPopup(students) {
        // Get the popup elements
        const popup = document.getElementById('incomplete-grades-popup');
        const tbody = document.getElementById('incomplete-grades-students');
        const closeBtn = document.getElementById('close-incomplete-popup');
        const footerCloseBtn = document.getElementById('incomplete-grades-close-btn');
        const semesterBtn = document.getElementById('semester-action-btn');
        
        // Clear previous entries
        tbody.innerHTML = '';
        
        // Add entries for each student with issues
        students.forEach(student => {
            const row = document.createElement('tr');
            
            // National ID cell (instead of student_id)
            const idCell = document.createElement('td');
            idCell.textContent = student.national_id;
            row.appendChild(idCell);
            
            // Name cell
            const nameCell = document.createElement('td');
            nameCell.textContent = `${student.first_name} ${student.last_name}`;
            row.appendChild(nameCell);
            
            // Course cell
            const courseCell = document.createElement('td');
            courseCell.textContent = student.course_code;
            row.appendChild(courseCell);
            
            // Issue type cell - use the issue_type directly from the backend
            const issueCell = document.createElement('td');
            const issueSpan = document.createElement('span');
            // Convert the issue type from backend to a valid CSS class
            const issueClass = student.issue_type.replace(/\s+/g, '-');
            issueSpan.className = `issue-type issue-${issueClass}`;
            issueSpan.textContent = student.issue_type;
            issueCell.appendChild(issueSpan);
            row.appendChild(issueCell);
            
            tbody.appendChild(row);
        });
        
        // Show the popup
        popup.classList.add('active');
        
        // Set up close handlers - reset the button text when closing
        const closePopup = () => {
            popup.classList.remove('active');
            // Reset the semester button text
            if (semesterBtn) {
                semesterBtn.textContent = semesterBtn.textContent.includes("Start") ? 
                    "Start Semester" : 
                    "End Semester";
                semesterBtn.disabled = false;
            }
        };
        
        closeBtn.addEventListener('click', closePopup);
        footerCloseBtn.addEventListener('click', closePopup);
        
        // Close when clicking outside the content
        popup.addEventListener('click', (e) => {
            if (e.target === popup) {
                closePopup();
            }
        });
    }
    
    // Function to show the graduates popup
    function showGraduatesPopup(graduates) {
        // Get the popup elements
        const popup = document.getElementById('graduates-popup');
        const tbody = document.getElementById('graduates-students');
        const closeBtn = document.getElementById('close-graduates-popup');
        const footerCloseBtn = document.getElementById('graduates-close-btn');
        
        // Clear previous entries
        tbody.innerHTML = '';
        
        // Add entries for each graduate
        graduates.forEach(graduate => {
            const row = document.createElement('tr');
            
            // Student ID cell
            const idCell = document.createElement('td');
            idCell.textContent = graduate.student_id;
            row.appendChild(idCell);
            
            // Name cell
            const nameCell = document.createElement('td');
            nameCell.textContent = graduate.name;
            row.appendChild(nameCell);
            
            // Status cell
            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = 'graduate-badge';
            statusBadge.textContent = 'Graduated';
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);
            
            tbody.appendChild(row);
        });
        
        // Show the popup
        popup.classList.add('active');
        
        // Set up close handlers
        const closePopup = () => {
            popup.classList.remove('active');
        };
        
        closeBtn.addEventListener('click', closePopup);
        footerCloseBtn.addEventListener('click', closePopup);
        
        // Close when clicking outside the content
        popup.addEventListener('click', (e) => {
            if (e.target === popup) {
                closePopup();
            }
        });
    }

    // Update timer message based on current state
    function updateTimerMessage() {
        const timerMessage = document.getElementById('timer-message');
        if (!timerMessage) return;

        if (isRegistrationOpen) {
            timerMessage.textContent = 'Registration period automatically ends in:';
        } else if (isRegistrationScheduled) {
            timerMessage.textContent = 'Registration will open in:';
        }
    }

    // Handle open registration
    async function handleOpenRegistration() {
        const openBtn = document.getElementById("open-registration-btn");
        const startDateInput = document.getElementById("open-date").value;
        const endDateInput = document.getElementById("close-date").value;
        const errorMessage = document.getElementById("registration-error-message");

        // Clear previous messages
        errorMessage.style.display = 'none';
        errorMessage.textContent = '';

        // Client-side validation
        if (!startDateInput || !endDateInput) {
            errorMessage.textContent = "Please select both start and end dates";
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
            return;
        }

        // Convert datetime-local to backend format
        const startDate = formatDateForBackend(startDateInput);
        const endDate = formatDateForBackend(endDateInput);

        if (new Date(startDate) >= new Date(endDate)) {
            errorMessage.textContent = "End date must be after start date";
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
            return;
        }

        // Disable buttons during processing
        openBtn.disabled = true;
        const originalText = openBtn.textContent;
        openBtn.textContent = "Processing...";

        try {
            const response = await fetch("/admin/course_registration", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    action: "start_registration",
                    start_date: startDate,
                    end_date: endDate
                })
            });

            const result = await response.json();

            if (result.success) {
                savedStartDate = startDate;
                savedEndDate = endDate;
                
                if (new Date(startDate) > new Date()) {
                    isRegistrationScheduled = true;
                    registrationStartTime = new Date(startDate);
                    registrationEndTime = new Date(endDate);
                    
                    // Disable inputs but keep values visible
                    document.getElementById("open-date").disabled = true;
                    document.getElementById("close-date").disabled = true;
                    
                    document.getElementById("timer-section").style.display = "block";
                    document.getElementById("open-registration-btn").disabled = true;
                    document.getElementById("close-registration-btn").disabled = false;
                    document.getElementById("close-registration-btn").textContent = "Cancel Scheduled Registration";
                    openBtn.textContent = "Registration is Scheduled";
                    updateTimerMessage();
                    startCountdownToOpening(registrationStartTime, registrationEndTime);
                    showInlineMessage(result.message || "Registration scheduled successfully", 'success');
                } else {
                    isRegistrationOpen = true;
                    registrationEndTime = new Date(endDate);
                    
                    // Disable inputs but keep values visible
                    document.getElementById("open-date").disabled = true;
                    document.getElementById("close-date").disabled = true;
                    
                    document.getElementById("timer-section").style.display = "block";
                    document.getElementById("open-registration-btn").disabled = true;
                    document.getElementById("close-registration-btn").disabled = false;
                    document.getElementById("close-registration-btn").textContent = "Close Registration";
                    updateTimerMessage();
                    startCountdown(registrationEndTime);
                    showInlineMessage(result.message || "Registration opened successfully", 'success');
                }
            } else {
                showInlineMessage(result.message || "Failed to open registration", 'error');
            }
        } catch (error) {
            showInlineMessage("Network error: " + error.message, 'error');
        } finally {
            if (!isRegistrationOpen && !isRegistrationScheduled) {
                openBtn.textContent = originalText;
                openBtn.disabled = false;
            }
        }
    }

    // Handle close registration
    async function handleCloseRegistration() {
        const closeBtn = document.getElementById("close-registration-btn");
        const errorMessage = document.getElementById("registration-error-message");
        const originalText = closeBtn.textContent;
        closeBtn.disabled = true;
        closeBtn.textContent = "Processing...";

        // Clear previous messages
        errorMessage.style.display = 'none';
        errorMessage.textContent = '';

        try {
            const action = isRegistrationScheduled ? "cancel_registration" : "close_registration";
            const response = await fetch("/admin/course_registration", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: action })
            });

            const result = await response.json();

            if (result.success) {
                isRegistrationOpen = false;
                isRegistrationScheduled = false;
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                registrationEndTime = null;
                registrationStartTime = null;
                
                // Enable inputs and clear values
                const openDateInput = document.getElementById("open-date");
                const closeDateInput = document.getElementById("close-date");
                
                if (openDateInput) {
                    openDateInput.disabled = false;
                    openDateInput.value = '';
                }
                if (closeDateInput) {
                    closeDateInput.disabled = false;
                    closeDateInput.value = '';
                }
                
                document.getElementById("timer-section").style.display = "none";
                document.getElementById("open-registration-btn").disabled = false;
                document.getElementById("close-registration-btn").disabled = true;
                document.getElementById("close-registration-btn").textContent = "Close Registration"; // Force reset button text
                document.getElementById("open-registration-btn").textContent = "Open Registration";
                showInlineMessage(result.message || (isRegistrationScheduled ? "Scheduled registration cancelled successfully" : "Registration closed successfully"), 'success');
            } else {
                errorMessage.textContent = result.message || (isRegistrationScheduled ? "Failed to cancel scheduled registration" : "Failed to close registration");
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
            }
        } catch (error) {
            errorMessage.textContent = "Network error: " + error.message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
        } finally {
            closeBtn.textContent = originalText;
            closeBtn.disabled = false;
            
            // Force update button state immediately
            if (!isRegistrationOpen && !isRegistrationScheduled) {
                document.getElementById("close-registration-btn").textContent = "Close Registration";
                document.getElementById("close-registration-btn").disabled = true;
            }
        }
    }

    // Format date for backend (YYYY-MM-DD HH:MM:SS)
    function formatDateForBackend(datetimeLocal) {
        // Convert "YYYY-MM-DDTHH:MM" to "YYYY-MM-DD HH:MM:00"
        return datetimeLocal.replace("T", " ") + ":00";
    }

    // Show error message
    function showError(error, section) {
        const contentDiv = document.getElementById('dynamic-content');
        contentDiv.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Failed to load ${section.replace('-', ' ')}</h4>
                <p>${error.message}</p>
                <button class="retry-btn" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Try Again
                </button>
            </div>
        `;
    }

    // Countdown timer for when registration is open
    function startCountdown(endTime) {
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        const countdown = document.getElementById("countdown-timer");
        updateTimerMessage();
        document.getElementById("close-registration-btn").disabled = false;
        document.getElementById("close-registration-btn").textContent = "Close Registration";

        function updateTimer() {
            const now = new Date();
            const diff = endTime - now;

            if (diff <= 0) {
                countdown.textContent = "Registration is now closed.";
                document.getElementById("timer-section").style.display = "none";
                registrationEndTime = null;
                isRegistrationOpen = false;
                isRegistrationScheduled = false;
                
                // Enable inputs and clear values
                const openDateInput = document.getElementById("open-date");
                const closeDateInput = document.getElementById("close-date");
                
                if (openDateInput) {
                    openDateInput.disabled = false;
                    openDateInput.value = '';
                }
                if (closeDateInput) {
                    closeDateInput.disabled = false;
                    closeDateInput.value = '';
                }
                
                document.getElementById("open-registration-btn").disabled = false;
                document.getElementById("close-registration-btn").disabled = true;
                document.getElementById("close-registration-btn").textContent = "Close Registration";
                clearInterval(countdownInterval);
                countdownInterval = null;
                
                // Automatically close registration in database when timer expires
                fetch("/admin/course_registration", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "close_registration" })
                }).catch(error => {
                    console.error("Error auto-closing registration:", error);
                });
                
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((diff / (1000 * 60)) % 60);
            const seconds = Math.floor((diff / 1000) % 60);

            countdown.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        updateTimer();
        countdownInterval = setInterval(updateTimer, 1000);
    }

    // Countdown timer for when registration is scheduled but not yet open
    function startCountdownToOpening(startTime, endTime) {
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        const countdown = document.getElementById("countdown-timer");
        updateTimerMessage();
        document.getElementById("close-registration-btn").disabled = false;
        document.getElementById("close-registration-btn").textContent = "Cancel Scheduled Registration";

        function updateTimer() {
            const now = new Date();
            const diffToStart = startTime - now;

            if (diffToStart <= 0) {
                // Time to open registration has arrived
                isRegistrationOpen = true;
                isRegistrationScheduled = false;
                document.getElementById("open-registration-btn").textContent = "Registration is Open";
                document.getElementById("close-registration-btn").disabled = false;
                document.getElementById("close-registration-btn").textContent = "Close Registration";
                updateTimerMessage();
                startCountdown(endTime);
                
                // Update the status in the backend
                fetch("/admin/course_registration", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "activate_registration" })
                }).catch(error => {
                    console.error("Error activating scheduled registration:", error);
                });
                
                return;
            }

            const days = Math.floor(diffToStart / (1000  * 60 * 60 * 24));
            const hours = Math.floor((diffToStart / (1000 * 60 * 60)) % 24);
            const minutes = Math.floor((diffToStart / (1000 * 60)) % 60);
            const seconds = Math.floor((diffToStart / 1000) % 60);

            countdown.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        updateTimer();
        countdownInterval = setInterval(updateTimer, 1000);
    }

    // Theme toggle functionality
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('i');
    
    // Check for saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
    }

    themeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        
        // Update icon
        if (document.body.classList.contains('dark-mode')) {
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
            localStorage.setItem('theme', 'dark');
        } else {
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
            localStorage.setItem('theme', 'light');
        }
    });

    // Add the submitted requests modal functionality
    function showSubmittedRequestsModal() {
        console.log('Global showSubmittedRequestsModal called');
        // Create modal if it doesn't exist
        let modal = document.getElementById('submitted-requests-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'submitted-requests-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>Students who did not submit a Request</h3>
                    <div class="students-list" id="submitted-students-list">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add close button functionality
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // Close when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Show modal and fetch data
        modal.style.display = 'block';
        
        // Use fetch API as a backup in case jQuery is not loaded
        const fetchData = function() {
            const studentsList = document.getElementById('submitted-students-list');
            studentsList.innerHTML = '<div class="loading">Loading students data...</div>';
            
            fetch('/admin/major_minor_validation/submitted_requests')
                .then(response => response.json())
                .then(data => {
                    console.log('Received submitted requests data:', data);
                    if (data.success) {
                        if (data.students.length > 0) {
                            studentsList.innerHTML = data.students.map(student => `
                                <div class="student-item" data-student-id="${student.national_id}" onclick="showStudentDetails('${student.national_id}')">
                                    <div class="student-info">
                                        <div class="student-name">${student.first_name} ${student.last_name}</div>
                                        <div class="student-id">ID: ${student.national_id}</div>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            studentsList.innerHTML = '<div class="no-data">All eligible students have submitted their requests</div>';
                        }
                    } else {
                        throw new Error(data.message || 'Failed to fetch data');
                    }
                })
                .catch(error => {
                    console.error('Error loading submitted requests:', error);
                    studentsList.innerHTML = `<div class="error-message">Error loading data: ${error}</div>`;
                });
        };
        
        // Try jQuery first, fall back to fetch
        if (typeof jQuery !== 'undefined') {
        $.ajax({
            url: '/admin/major_minor_validation/submitted_requests',
            method: 'GET',
            success: function(data) {
                    console.log('Received submitted requests data via jQuery:', data);
                    const studentsList = document.getElementById('submitted-students-list');
                    if (data.success) {
                    if (data.students.length > 0) {
                        studentsList.innerHTML = data.students.map(student => `
                            <div class="student-item" data-student-id="${student.national_id}" onclick="showStudentDetails('${student.national_id}')">
                                <div class="student-info">
                                    <div class="student-name">${student.first_name} ${student.last_name}</div>
                                    <div class="student-id">ID: ${student.national_id}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        studentsList.innerHTML = '<div class="no-data">All eligible students have submitted their requests</div>';
                    }
                } else {
                    throw new Error(data.message || 'Failed to fetch data');
                }
            },
            error: function(xhr, status, error) {
                    console.error('jQuery error, falling back to fetch:', error);
                    fetchData();
                }
            });
        } else {
            console.log('jQuery not available, using fetch');
            fetchData();
        }
    };

    // System Adjustments functionality
    async function loadSystemAdjustments() {
        // Make sure to do proper cleanup when switching to system adjustments
        // to avoid conflicts with other sections like major/minor validation
        window.currentSection = 'system-adjustments';
        
        showLoadingState('system-adjustments');
        
        try {
            const response = await fetch('/admin/system_adjustments');
            if (!response.ok) throw new Error('Failed to load system adjustments');
            
            const data = await response.json();
            
            document.getElementById('content-title').textContent = 'Settings and Adjustments';
            
            // Build the main content with subsections
            const contentDiv = document.getElementById('dynamic-content');
            contentDiv.innerHTML = `
                <div class="content-card system-adjustments-card">
                    
                    <div class="system-tabs">
                        ${data.subsections.map(subsection => `
                            <div class="system-tab" data-section="${subsection.id}">
                                <i class="fas fa-${getIconForSection(subsection.id)}"></i> ${subsection.name}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div id="system-content-container">
                        <div class="system-welcome">
                            <i class="fas fa-cogs fa-4x"></i>
                            <h3>System Adjustments</h3>
                            <p>Select a category from above to manage system settings.</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click handlers for tabs
            document.querySelectorAll('.system-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    
                    // Update active tab
                    document.querySelectorAll('.system-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Load the appropriate section
                    loadSystemSubsection(section);
                });
            });
            
            // If a specific section was requested in the URL, load it
            const urlParams = new URLSearchParams(window.location.search);
            const sectionParam = urlParams.get('section');
            
            if (sectionParam) {
                const tabElement = document.querySelector(`.system-tab[data-section="${sectionParam}"]`);
                if (tabElement) {
                    tabElement.click();
                }
            }
            
        } catch (error) {
            console.error('Error loading system adjustments:', error);
            showError(error, 'system-adjustments');
        }
    }

    // Function to get appropriate icon for each section
    function getIconForSection(section) {
        const icons = {
            'courses': 'book',
            'major-minor': 'graduation-cap',
            'registration': 'calendar-alt',
            'general': 'sliders-h',
            'schedule': 'clock', // Added mapping for new Schedule Settings section
            'system': 'cogs',
            'special-cases': 'tools'
        };
        
        return icons[section] || 'cog';
    }
    
    // Function to show in-page confirmation modal for removing overrides
    function showRemoveConfirmation(studentId, firstName, lastName) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('remove-override-confirmation');
        if (modal) {
            document.body.removeChild(modal);
        }
        
        modal = document.createElement('div');
        modal.id = 'remove-override-confirmation';
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <span class="close-modal">&times;</span>
                <h3>Remove Overrides</h3>
                <p>Are you sure you want to remove all custom parameter overrides for <strong>${firstName} ${lastName}</strong>?</p>
                <p>This will reset all parameters to system defaults.</p>
                <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button class="btn btn-secondary" id="cancel-remove-btn">Cancel</button>
                    <button class="btn btn-danger" id="confirm-remove-btn">
                        <i class="fas fa-trash"></i> Remove Overrides
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add event listeners
        document.querySelector('#remove-override-confirmation .close-modal').addEventListener('click', function() {
            modal.style.display = 'none';
            setTimeout(() => {
                document.body.removeChild(modal);
            }, 300);
        });
        
        document.getElementById('cancel-remove-btn').addEventListener('click', function() {
            modal.style.display = 'none';
            setTimeout(() => {
                document.body.removeChild(modal);
            }, 300);
        });
        
        document.getElementById('confirm-remove-btn').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
            await removeStudentOverrides(studentId);
            modal.style.display = 'none';
            setTimeout(() => {
                document.body.removeChild(modal);
            }, 300);
        });
        
        // Close when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        });
    }

    // Load course settings 
    async function loadCourseSettings() {
        const contentContainer = document.getElementById('system-content-container');
        
        try {
            const response = await fetch('/admin/system_adjustments/courses');
            if (!response.ok) {
                throw new Error('Failed to load course settings');
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Failed to load course data');
            }
            
            // Create course settings UI
            let html = `
                <div class="course-settings-container">
                    <div class="settings-header" style="margin-bottom: 10px;">
                        <h3>Course Settings</h3>
                    </div>
                    
                    <div class="course-selector-container">
                        <div class="course-groups-container">
                            <div class="course-group-selector">
                                <select id="course-select" class="form-control">
                                    <option value="">-- Select a course or add new --</option>
                                    <option value="new" class="add-new-option">+ Add New Course</option>
                                    ${(() => {
                                        let options = '';
                                        if (data.grouped_courses) {
                                            // Using grouped_courses from API
                                            const groups = Object.keys(data.grouped_courses).sort();
                                            for (const group of groups) {
                                                const courses = data.grouped_courses[group];
                                                options += `<optgroup label="${group}">`;
                                                for (const course of courses) {
                                                    options += `<option value="${course.course_code}" ${course.in_curriculum ? '' : 'class="inactive-course"'}>${course.course_code} - ${course.course_name}</option>`;
                                                }
                                                options += '</optgroup>';
                                            }
                                        } else if (data.courses) {
                                            // Fallback to using courses if present
                                            options = data.courses.map(course => 
                                                `<option value="${course.course_code}" ${course.in_curriculum ? '' : 'class="inactive-course"'}>${course.course_code} - ${course.course_name}</option>`
                                            ).join('');
                                        }
                                        return options;
                                    })()}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="course-edit-container" class="course-edit-container">
                        <div class="course-edit-placeholder">
                            <i class="fas fa-book"></i>
                            <h3>Select a course to edit or add a new one</h3>
                        </div>
                    </div>
                </div>
            `;
            
            contentContainer.innerHTML = html;
            
            // Add event listener for course selection
            document.getElementById('course-select').addEventListener('change', function() {
                const courseCode = this.value;
                if (!courseCode) {
                    // Show placeholder
                    document.getElementById('course-edit-container').innerHTML = `
                        <div class="course-edit-placeholder">
                            <i class="fas fa-book"></i>
                            <h3>Select a course to edit or add a new one</h3>
                        </div>
                    `;
                } else if (courseCode === 'new') {
                    // Show empty form for new course
                    showCourseForm();
                } else {
                    // Load existing course details
                    loadCourseDetails(courseCode);
                }
            });
            
        } catch (error) {
            console.error('Error loading course settings:', error);
        contentContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Failed to load course settings</h4>
                    <p>${error.message}</p>
                    <button class="retry-btn" onclick="loadCourseSettings()">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
            </div>
        `;
        }
    }

    // ---------- Schedule Settings (new) ----------
    async function loadScheduleSettings() {
        const contentContainer = document.getElementById('system-content-container');
        try {
            const response = await fetch('/admin/system_adjustments/schedule');
            if (!response.ok) throw new Error('Failed to load schedule settings');
            const data = await response.json();
            if (!data.success) throw new Error(data.message || 'Failed to load data');
            const p = data.parameters || {};
            contentContainer.innerHTML = `
                <div class="schedule-settings-container">
                    <div class="settings-header">
                        <h3>Schedule Settings</h3>
                    </div>
                    <form id="schedule-settings-form">
                        <div class="settings-section">
                            <h4>Weight Parameters</h4>
                            <p class="settings-description">Configure Time Slots weights used by the model.</p>
                            <div class="other-settings-grid">
                                <div class="form-group">
                                    <label for="weight-mode-a">For Time Slots Priority:</label>
                                    <input type="number" step="0.01" min="0" id="weight-mode-a" class="form-control" value="${p.weight_mode_a ?? ''}" placeholder="e.g. 1.25">
                                </div>
                                <div class="form-group">
                                    <label for="weight-mode-b">For Professors Priority:</label>
                                    <input type="number" step="1" min="0" id="weight-mode-b" class="form-control" value="${p.weight_mode_b ?? ''}" placeholder="e.g. 5">
                                </div>
                            </div>
                        </div>
                        <div class="settings-section">
                            <h4>Solver Limits</h4>
                            <p class="settings-description">Define limits for the scheduling solver.</p>
                            <div class="other-settings-grid">
                                <div class="form-group">
                                    <label for="maximum-solutions">Maximum Solutions</label>
                                    <input type="number" step="1" min="1" id="maximum-solutions" class="form-control" value="${p.maximum_solutions ?? ''}" placeholder="e.g. 1000">
                                </div>
                                <div class="form-group">
                                    <label for="time-limit">Time Limit (seconds)</label>
                                    <input type="number" step="1" min="1" id="time-limit" class="form-control" value="${p.time_limit ?? ''}" placeholder="e.g. 60">
                                </div>
                            </div>
                        </div>
                        <div class="settings-section">
                            <h4>Penalty</h4>
                            <p class="settings-description">Configure penalties applied for gaps in schedule.</p>
                            <div class="other-settings-grid">
                                <div class="form-group">
                                    <label for="penalty-gap">Gap Penalty</label>
                                    <input type="number" step="1" min="0" id="penalty-gap" class="form-control" value="${p.penalty_gap ?? ''}" placeholder="e.g. 2">
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="save-schedule-settings-btn">
                                <i class="fas fa-save"></i> Save Schedule Settings
                            </button>
                        </div>
                    </form>
                </div>`;
            document.getElementById('schedule-settings-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveScheduleSettings();
            });
        } catch (error) {
            console.error('Error loading schedule settings:', error);
            contentContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Failed to load schedule settings</h4>
                    <p>${error.message}</p>
                    <button class="retry-btn" onclick="loadScheduleSettings()">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>`;
        }
    }

    async function saveScheduleSettings() {
        const btn = document.getElementById('save-schedule-settings-btn');
        if (!btn) return;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        const payload = {
            weight_mode_a: parseFloatOrNull(document.getElementById('weight-mode-a').value),
            weight_mode_b: parseIntOrNull(document.getElementById('weight-mode-b').value),
            penalty_gap: parseIntOrNull(document.getElementById('penalty-gap').value),
            maximum_solutions: parseIntOrNull(document.getElementById('maximum-solutions').value),
            time_limit: parseIntOrNull(document.getElementById('time-limit').value)
        };
        try {
            const response = await fetch('/admin/system_adjustments/schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const res = await response.json();
            if (!res.success) throw new Error(res.message || 'Save failed');
            btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
            showToast('Schedule settings saved successfully', 'success');
            setTimeout(() => { btn.innerHTML = originalHtml; btn.disabled = false; }, 1500);
        } catch (error) {
            console.error('Error saving schedule settings:', error);
            showToast(`Error: ${error.message}`, 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

    // Load specific subsection of system adjustments
    async function loadSystemSubsection(section) {
        console.log('Loading system subsection:', section);
        
        // Clear existing content
        document.getElementById('system-content-container').innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
        
        try {
            if (section === 'courses') {
                await loadCourseSettings();
            } else if (section === 'major-minor') {
                await loadMajorSettings();
            } else if (section === 'general') {
                await loadGeneralSettings();
            } else if (section === 'schedule') {
                await loadScheduleSettings();
            } else if (section === 'special-cases') {
                await loadSpecialCasesSettings();
            } else {
                // Default section display
                document.getElementById('system-content-container').innerHTML = `
                    <div class="system-section-placeholder">
                        <i class="fas fa-cog"></i>
                        <h3>Select a section</h3>
                        <p>Please select one of the tabs above to manage system settings.</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading system subsection:', error);
            document.getElementById('system-content-container').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Error loading section</h4>
                    <p>${error.message}</p>
                    <button class="retry-btn" onclick="loadSystemSubsection('${section}')">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>
            `;
        }
    }

    // Load special cases settings
    async function loadSpecialCasesSettings() {
        const contentContainer = document.getElementById('system-content-container');
        
        // Create the basic structure for the special cases section
        let html = `
            <div class="special-cases-container">
                <div class="special-cases-header">
                    <h3>Special Cases Management</h3>
                </div>
                
                <div class="special-cases-tabs">
                    <div class="special-cases-tab active" data-tab="gaps-section">Gaps</div>
                    <div class="special-cases-tab" data-tab="transfers-section">Transfers</div>
                </div>
                
                <div id="gaps-section" class="tab-content active">
                    <div class="special-case-section">
                        <h4>Gaps Management</h4>
                        
                        <div class="student-search-section">
                            <div class="search-container" style="max-width: 500px;">
                                <input type="text" id="student-gaps-search" class="student-search-box" placeholder="Search by National ID...">
                                <button id="student-gaps-search-btn" class="student-search-btn"></button>
                    </div>
                    
                            <div id="student-gaps-results" class="student-search-results" style="display: none;">
                                <ul id="gaps-results-list" class="results-list"></ul>
                            </div>
                        </div>
                        
                        <div id="student-gaps-info" class="student-info-display" style="display: none;">
                            <div class="student-details">
                                <h4 id="gaps-student-name"></h4>
                                <p><span class="student-id-display" id="gaps-student-id"></span></p>
                            </div>
                            
                            <div id="gaps-courses-container" class="course-list">
                                <h5>Current Semester Courses</h5>
                                <p class="gaps-instructions">Courses will be added as <span class="notenrolled-text">Not enrolled</span></p>
                                <div id="gaps-courses-list"></div>
                            </div>
                            
                            <div class="action-buttons">
                                <button id="add-gaps-btn" class="action-btn add-gaps-btn">
                                    <i class="fas fa-plus-circle"></i> Add as Gaps
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="transfers-section" class="tab-content">
                    <div class="special-case-section">
                        <h4>Transfers Management</h4>
                        
                        <div class="student-search-section">
                            <div class="search-container" style="max-width: 500px;">
                                <input type="text" id="student-transfers-search" class="student-search-box" placeholder="Search by National ID...">
                                <button id="student-transfers-search-btn" class="student-search-btn"></button>
                            </div>
                            
                            <div id="student-transfers-results" class="student-search-results" style="display: none;">
                                <ul id="transfers-results-list" class="results-list"></ul>
                            </div>
                        </div>
                        
                        <div id="student-transfers-info" class="student-info-display" style="display: none;">
                            <div class="student-details">
                                <h4 id="transfers-student-name"></h4>
                                <p><span class="student-id-display" id="transfers-student-id"></span></p>
                            </div>
                            
                            <div id="transfers-courses-container" class="course-list">
                                <h5>Current Semester Courses</h5>
                                <p class="transfers-instructions">Selected courses  <span class="transferred-text">Transferred</span><br>
                                Unselected courses  <span class="notenrolled-text">Not enrolled</span></p>
                                <div class="select-all-container">
                                    <input type="checkbox" id="select-all-transfers" class="select-all-checkbox">
                                    <label for="select-all-transfers">Select All Courses</label>
                                </div>
                                <div id="transfers-courses-list"></div>
                            </div>
                            
                            <div class="action-buttons">
                                <button id="process-transfers-btn" class="action-btn add-transfers-btn">
                                    <i class="fas fa-exchange-alt"></i> Process Transfers
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            contentContainer.innerHTML = html;
            
        // Add event listeners for tabs
        document.querySelectorAll('.special-cases-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                document.querySelectorAll('.special-cases-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding content
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(this.getAttribute('data-tab')).classList.add('active');
            });
        });
        
        // Add event listeners for student search
        const searchBtn = document.getElementById('student-gaps-search-btn');
        const searchInput = document.getElementById('student-gaps-search');
        
        searchBtn.addEventListener('click', function() {
            searchStudentForGaps(searchInput.value);
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudentForGaps(this.value);
            }
        });
        
        // Add event listener for adding gaps
        const addGapsBtn = document.getElementById('add-gaps-btn');
        addGapsBtn.addEventListener('click', function() {
            addGapsForStudent();
        });
        
        // Add event listeners for transfers
        const transfersSearchBtn = document.getElementById('student-transfers-search-btn');
        const transfersSearchInput = document.getElementById('student-transfers-search');
        
        transfersSearchBtn.addEventListener('click', function() {
            searchStudentForTransfers(transfersSearchInput.value);
        });
        
        transfersSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudentForTransfers(this.value);
            }
        });
        
        const processTransfersBtn = document.getElementById('process-transfers-btn');
        processTransfersBtn.addEventListener('click', function() {
            processTransfers();
        });
    }
    
    // Search student for gaps management
    async function searchStudentForGaps(nationalId) {
        const searchInput = document.getElementById('student-gaps-search');
        const errorMsg = document.getElementById('student-gaps-search-error') || document.createElement('div');
        
        // Setup error message element if it doesn't exist
        if (!errorMsg.id) {
            errorMsg.id = 'student-gaps-search-error';
            errorMsg.style.color = '#000000';
            errorMsg.style.fontSize = '0.85rem';
            errorMsg.style.marginTop = '5px';
            errorMsg.style.textAlign = 'left';
            errorMsg.style.paddingLeft = '5px';
            // Add the error message UNDER the search container, not inside it
            const searchContainer = document.querySelector('.search-container');
            searchContainer.parentNode.insertBefore(errorMsg, searchContainer.nextSibling);
        }
        
        if (!nationalId) {
            errorMsg.textContent = 'Please enter a National ID';
            errorMsg.style.display = 'block';
            return;
        } else {
            errorMsg.style.display = 'none';
        }
        
        console.log(`Searching for student with National ID: ${nationalId}`);
        
        // Hide any existing student info display
        const infoContainer = document.getElementById('student-gaps-info');
        if (infoContainer) {
            infoContainer.style.display = 'none';
        }
        
        const resultsContainer = document.getElementById('student-gaps-results');
        const resultsList = document.getElementById('gaps-results-list');
        
        // Show loading
        resultsList.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
        resultsContainer.style.display = 'block';
        
        try {
            // Check if student exists by national ID
            console.log(`Fetching from /admin/system_adjustments/special_cases/gaps/${nationalId}`);
            const response = await fetch(`/admin/system_adjustments/special_cases/gaps/${nationalId}`);
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`Failed to fetch student data (Status: ${response.status})`);
            }
            
            const data = await response.json();
            console.log('API Response data:', data);
            
            if (data.success) {
                // Student found, display in results
                console.log(`Student found: ${data.student.first_name} ${data.student.last_name}, ID: ${data.student.id}`);
                resultsList.innerHTML = `
                    <li class="student-result" data-student-id="${data.student.id}" data-national-id="${data.student.national_id}" onclick="selectStudentForGaps(${data.student.id}, '${data.student.first_name} ${data.student.last_name}')">
                        <div class="student-name">${data.student.first_name} ${data.student.last_name}</div>
                        <div class="student-id">National ID: ${data.student.national_id}</div>
                    </li>
                `;
                } else {
                console.log('No student found with that National ID');
                resultsList.innerHTML = '<div class="no-results">No student found with that National ID</div>';
            }
        } catch (error) {
            console.error('Error searching for student:', error);
            resultsList.innerHTML = `<div class="no-results">Error: ${error.message}</div>`;
        }
    }
    
    // Make searchStudentForGaps available in global scope
    window.searchStudentForGaps = searchStudentForGaps;
    
    // Select student for gaps management
    async function selectStudentForGaps(studentId, studentName) {
        console.log(`Selecting student for gaps: ${studentName} (ID: ${studentId})`);
        
        const infoContainer = document.getElementById('student-gaps-info');
        const coursesContainer = document.getElementById('gaps-courses-list');
        const studentNameElement = document.getElementById('gaps-student-name');
        const studentIdElement = document.getElementById('gaps-student-id');
        const addGapsBtn = document.getElementById('add-gaps-btn');
        
        // Clear search input
        document.getElementById('student-gaps-search').value = '';
        
        // Hide search results
        document.getElementById('student-gaps-results').style.display = 'none';
        
        // Show student info container
        infoContainer.style.display = 'block';
        
        // Update student details
        studentNameElement.textContent = studentName;
        
        // Get the national ID from the search result (it's stored in the data attribute)
        const nationalId = document.querySelector(`.student-result[data-student-id="${studentId}"]`).getAttribute('data-national-id');
        studentIdElement.textContent = `National ID: ${nationalId}`;
        
        // Set student ID as data attribute for later use
        infoContainer.setAttribute('data-student-id', studentId);
        
        // Show loading state for courses
        coursesContainer.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading courses...</div>';
        
        try {
            // Get current courses data from the server
            console.log(`Fetching current courses for student ID: ${studentId}`);
            const response = await fetch(`/admin/system_adjustments/special_cases/gaps/${studentId}/current_courses`);
            
            console.log('Current courses response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Current courses API Error:', errorText);
                throw new Error(`Failed to fetch current courses (Status: ${response.status})`);
            }
            
            const data = await response.json();
            console.log('Current courses API response:', data);
            
            if (data.success && data.courses && data.courses.length > 0) {
                console.log(`Found ${data.courses.length} current courses for student`);
                // Create HTML for courses list
                let coursesHtml = '<ul class="courses-list">';
                
                data.courses.forEach(course => {
                    console.log(`Course: ${course.course_code} - ${course.course_name}`);
                    coursesHtml += `
                        <li class="course-item">
                            <span class="course-code">${course.course_code}</span> - 
                            <span class="course-name">${course.course_name}</span>
                        </li>
                    `;
                });
                
                coursesHtml += '</ul>';
                coursesContainer.innerHTML = coursesHtml;
                
                // Enable add gaps button
                addGapsBtn.disabled = false;
            } else {
                console.log('No current semester courses found for this student');
                coursesContainer.innerHTML = '<div class="no-results">No current semester courses found for this student</div>';
                // Disable add gaps button
                addGapsBtn.disabled = true;
            }
        } catch (error) {
            console.error('Error loading current courses:', error);
            coursesContainer.innerHTML = `<div class="no-results">Error: ${error.message}</div>`;
            // Disable add gaps button
            addGapsBtn.disabled = true;
        }
    }
    
    // Make selectStudentForGaps available in global scope
    window.selectStudentForGaps = selectStudentForGaps;
    
    // Add gaps for selected student
    async function addGapsForStudent() {
        const infoContainer = document.getElementById('student-gaps-info');
        const studentId = infoContainer.getAttribute('data-student-id');
        const addGapsBtn = document.getElementById('add-gaps-btn');
        
        if (!studentId) {
            showNotification('No student selected', 'error');
            return;
        }
        
        // Disable button and show loading state
        addGapsBtn.disabled = true;
        addGapsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        try {
            // Send request to add gaps
            const response = await fetch('/admin/system_adjustments/special_cases/gaps', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ student_id: studentId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Create a modified message without student ID
                const messageWithoutId = data.message.replace(/for student \d+$/, '');
                showNotification(messageWithoutId, 'success');
                
                // Add status indicators to courses
                if (data.added_courses && data.added_courses.length > 0) {
                    updateCoursesWithAddedGaps(data.added_courses);
                }
            } else {
                // Check if it's a "no courses added" message which we'll treat as a success
                if (data.message && data.message.includes('No new courses were added')) {
                    showNotification('All courses already processed as gaps', 'success');
                } else {
                    showNotification(`Error: ${data.message}`, 'error');
                }
            }
        } catch (error) {
            console.error('Error adding gaps:', error);
            showNotification(`Error: ${error.message}`, 'error');
        } finally {
            // Reset button state
            addGapsBtn.disabled = false;
            addGapsBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add as Gaps';
        }
    }
    
    // Update the courses list to show which courses were added or updated as gaps
    function updateCoursesWithAddedGaps(processedCourses) {
        const courseItems = document.querySelectorAll('#gaps-courses-list .course-item');
        
        courseItems.forEach(item => {
            const courseCode = item.querySelector('.course-code').textContent.trim();
            
            if (processedCourses.includes(courseCode)) {
                const statusSpan = document.createElement('span');
                statusSpan.className = 'status-indicator';
                statusSpan.textContent = '';
                statusSpan.style.marginLeft = '10px';
                statusSpan.style.fontWeight = 'bold';
                statusSpan.style.color = '#4CAF50'; // Green for processed gaps
                
                // Remove any existing status span before adding a new one
                const existingStatus = item.querySelector('.status-indicator');
                if (existingStatus) {
                    existingStatus.remove();
                }
                
                item.appendChild(statusSpan);
            }
        });
    }
    
    // Make addGapsForStudent available in global scope
    window.addGapsForStudent = addGapsForStudent;
    
    // Search student for transfers management
    async function searchStudentForTransfers(nationalId) {
        const searchInput = document.getElementById('student-transfers-search');
        const errorMsg = document.getElementById('student-transfers-search-error') || document.createElement('div');
        
        // Setup error message element if it doesn't exist
        if (!errorMsg.id) {
            errorMsg.id = 'student-transfers-search-error';
            errorMsg.style.color = '#000000';
            errorMsg.style.fontSize = '0.85rem';
            errorMsg.style.marginTop = '5px';
            errorMsg.style.textAlign = 'left';
            errorMsg.style.paddingLeft = '5px';
            // Add the error message UNDER the search container, not inside it
            const searchContainer = document.querySelector('.search-container');
            searchContainer.parentNode.insertBefore(errorMsg, searchContainer.nextSibling);
        }
        
        if (!nationalId) {
            errorMsg.textContent = 'Please enter a National ID';
            errorMsg.style.display = 'block';
            return;
        } else {
            errorMsg.style.display = 'none';
        }
        
        console.log(`Searching for student with National ID: ${nationalId}`);
        
        // Hide any existing student info display
        const infoContainer = document.getElementById('student-transfers-info');
        if (infoContainer) {
            infoContainer.style.display = 'none';
        }
        
        const resultsContainer = document.getElementById('student-transfers-results');
        const resultsList = document.getElementById('transfers-results-list');
        
        // Show loading
        resultsList.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
        resultsContainer.style.display = 'block';
        
        try {
            // Check if student exists by national ID
            console.log(`Fetching from /admin/system_adjustments/special_cases/transfers/${nationalId}`);
            const response = await fetch(`/admin/system_adjustments/special_cases/transfers/${nationalId}`);
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error(`Failed to fetch student data (Status: ${response.status})`);
            }
            
            const data = await response.json();
            console.log('API Response data:', data);
            
            if (data.success) {
                // Student found, display in results
                console.log(`Student found: ${data.student.first_name} ${data.student.last_name}, ID: ${data.student.id}`);
                resultsList.innerHTML = `
                    <li class="student-result" data-student-id="${data.student.id}" data-national-id="${data.student.national_id}" onclick="selectStudentForTransfers(${data.student.id}, '${data.student.first_name} ${data.student.last_name}')">
                        <div class="student-name">${data.student.first_name} ${data.student.last_name}</div>
                        <div class="student-id">National ID: ${data.student.national_id}</div>
                    </li>
                `;
                } else {
                console.log('No student found with that National ID');
                resultsList.innerHTML = '<div class="no-results">No student found with that National ID</div>';
            }
        } catch (error) {
            console.error('Error searching for student:', error);
            resultsList.innerHTML = `<div class="no-results">Error: ${error.message}</div>`;
        }
    }
    
    // Make searchStudentForTransfers available in global scope
    window.searchStudentForTransfers = searchStudentForTransfers;
    
    // Select student for transfers management
    async function selectStudentForTransfers(studentId, studentName) {
        console.log(`Selecting student for transfers: ${studentName} (ID: ${studentId})`);
        
        const infoContainer = document.getElementById('student-transfers-info');
        const coursesContainer = document.getElementById('transfers-courses-list');
        const studentNameElement = document.getElementById('transfers-student-name');
        const studentIdElement = document.getElementById('transfers-student-id');
        const processTransfersBtn = document.getElementById('process-transfers-btn');
        
        // Clear search input
        document.getElementById('student-transfers-search').value = '';
        
        // Hide search results
        document.getElementById('student-transfers-results').style.display = 'none';
        
        // Show student info container
        infoContainer.style.display = 'block';
        
        // Update student details
        studentNameElement.textContent = studentName;
        
        // Get the national ID from the search result (it's stored in the data attribute)
        const nationalId = document.querySelector(`.student-result[data-student-id="${studentId}"]`).getAttribute('data-national-id');
        studentIdElement.textContent = `National ID: ${nationalId}`;
        
        // Set student ID as data attribute for later use
        infoContainer.setAttribute('data-student-id', studentId);
        
        // Show loading state for courses
        coursesContainer.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading courses...</div>';
        
        try {
            // Get current courses data from the server
            console.log(`Fetching current courses for student ID: ${studentId}`);
            const response = await fetch(`/admin/system_adjustments/special_cases/transfers/${studentId}/current_courses`);
            
            console.log('Current courses response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Current courses API Error:', errorText);
                throw new Error(`Failed to fetch current courses (Status: ${response.status})`);
            }
            
            const data = await response.json();
            console.log('Current courses API response:', data);
            
            if (data.success && data.courses && data.courses.length > 0) {
                console.log(`Found ${data.courses.length} current courses for student`);
                // Create HTML for courses list
                let coursesHtml = '<ul class="courses-list">';
                
                data.courses.forEach(course => {
                    console.log(`Course: ${course.course_code} - ${course.course_name}`);
                    coursesHtml += `
                        <li class="course-item">
                            <input type="checkbox" class="course-checkbox" data-course-code="${course.course_code}">
                            <span class="course-code">${course.course_code}</span> - 
                            <span class="course-name">${course.course_name}</span>
                        </li>
                    `;
                });
                
                                 coursesHtml += '</ul>';
                 coursesContainer.innerHTML = coursesHtml;
                 
                 // Add event listener for select all checkbox
                 const selectAllCheckbox = document.getElementById('select-all-transfers');
                 selectAllCheckbox.checked = false;
                 selectAllCheckbox.addEventListener('change', function() {
                     const checkboxes = document.querySelectorAll('#transfers-courses-list .course-checkbox');
                     checkboxes.forEach(checkbox => {
                         checkbox.checked = this.checked;
                     });
                 });
                 
                 // Enable process transfers button
                 processTransfersBtn.disabled = false;
            } else {
                console.log('No current semester courses found for this student');
                coursesContainer.innerHTML = '<div class="no-results">No current semester courses found for this student</div>';
                // Disable process transfers button
                processTransfersBtn.disabled = true;
            }
        } catch (error) {
            console.error('Error loading current courses:', error);
            coursesContainer.innerHTML = `<div class="no-results">Error: ${error.message}</div>`;
            // Disable process transfers button
            processTransfersBtn.disabled = true;
        }
    }
    
    // Make selectStudentForTransfers available in global scope
    window.selectStudentForTransfers = selectStudentForTransfers;
    
         // Process transfers for selected student
     async function processTransfers() {
         const infoContainer = document.getElementById('student-transfers-info');
         const studentId = infoContainer.getAttribute('data-student-id');
         const processTransfersBtn = document.getElementById('process-transfers-btn');
         
         if (!studentId) {
             showNotification('No student selected', 'error');
             return;
         }
         
         // Disable button and show loading state
         processTransfersBtn.disabled = true;
         processTransfersBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
         
         try {
             // Get all checkboxes
             const allCheckboxes = document.querySelectorAll('#transfers-courses-list .course-checkbox');
             
             // Get selected courses
             const selectedCourses = Array.from(allCheckboxes).filter(checkbox => checkbox.checked).map(checkbox => checkbox.getAttribute('data-course-code'));
             
             // Get unselected courses
             const unselectedCourses = Array.from(allCheckboxes).filter(checkbox => !checkbox.checked).map(checkbox => checkbox.getAttribute('data-course-code'));
             
             // Send request to process transfers
             const response = await fetch('/admin/system_adjustments/special_cases/transfers', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify({ 
                     student_id: studentId, 
                     selected_courses: selectedCourses,
                     unselected_courses: unselectedCourses 
                 })
             });
             
             const data = await response.json();
             
             if (data.success) {
                 // Show notification instead of alert
                 // Create a modified message without student ID
                 const messageWithoutId = data.message.replace(/for student \d+$/, '');
                 showNotification(messageWithoutId, 'success');
                 
                 // No need to reset form, keep the student info visible
                 // Update the course list to show which courses have been processed
                 updateCourseListAfterProcessing(data.inserted_transferred_courses, data.updated_transferred_courses, 
                                               data.inserted_notenrolled_courses, data.updated_notenrolled_courses);
             } else {
                 showNotification(`Error: ${data.message}`, 'error');
             }
         } catch (error) {
             console.error('Error processing transfers:', error);
             showNotification(`Error: ${error.message}`, 'error');
         } finally {
             // Reset button state
             processTransfersBtn.disabled = false;
             processTransfersBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Process Transfers';
         }
     }
     
     // Show in-game notification
     function showNotification(message, type = 'info', duration = 5000) {
         // Create notification container if it doesn't exist
         let notificationContainer = document.getElementById('notification-container');
         if (!notificationContainer) {
             notificationContainer = document.createElement('div');
             notificationContainer.id = 'notification-container';
             document.body.appendChild(notificationContainer);
         }
         
         // Create notification element
         const notification = document.createElement('div');
         notification.className = `notification notification-${type}`;
         
         // Add icon based on notification type
         const icon = document.createElement('i');
         icon.className = `fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}`;
         
         // Add message
         const messageSpan = document.createElement('span');
         messageSpan.textContent = message;
         
         // Create flex container for icon and message
         const contentDiv = document.createElement('div');
         contentDiv.className = 'content-container';
         
         // Add icon and message to flex container
         contentDiv.appendChild(icon);
         messageSpan.className = 'message';
         contentDiv.appendChild(messageSpan);
         
         // Add content to notification
         notification.appendChild(contentDiv);
         
         // Add notification to container
         notificationContainer.appendChild(notification);
         
         // Auto remove after specified duration
         setTimeout(() => {
             notification.style.opacity = '0';
             setTimeout(() => {
                 notification.remove();
             }, 500);
         }, duration);
     }
     
     // Update course list after processing to show visual feedback
     function updateCourseListAfterProcessing(insertedTransferred, updatedTransferred, insertedNotenrolled, updatedNotenrolled) {
         const courseItems = document.querySelectorAll('#transfers-courses-list .course-item');
         
         courseItems.forEach(item => {
             const courseCode = item.querySelector('.course-checkbox').getAttribute('data-course-code');
             const checkbox = item.querySelector('.course-checkbox');
             const statusSpan = document.createElement('span');
             statusSpan.style.marginLeft = '10px';
             statusSpan.style.fontWeight = 'bold';
             statusSpan.textContent = '';
             
             if (checkbox.checked) {
                 // This is a transferred course
                 if (insertedTransferred.includes(courseCode) || updatedTransferred.includes(courseCode)) {
                     statusSpan.style.color = '#4CAF50'; // Green for transferred
                 }
             } else {
                 // This is a notenrolled course
                 if (insertedNotenrolled.includes(courseCode) || updatedNotenrolled.includes(courseCode)) {
                     statusSpan.style.color = '#FF9800'; // Orange for notenrolled
                 }
             }
             
             // Remove any existing status span before adding a new one
             const existingStatus = item.querySelector('.status-indicator');
             if (existingStatus) {
                 existingStatus.remove();
             }
             
             statusSpan.className = 'status-indicator';
             item.appendChild(statusSpan);
         });
     }
    
    // Make processTransfers available in global scope
    window.processTransfers = processTransfers;

    // Load course settings

    // Show empty course form for adding a new course
    function showCourseForm(courseData = null) {
        const isNewCourse = !courseData;
        const editContainer = document.getElementById('course-edit-container');
        
        // Get available majors and minors
        fetch('/admin/system_adjustments/courses')
            .then(response => response.json())
            .then(data => {
                const majors = data.majors;
                const minors = data.minors;
                
                editContainer.innerHTML = `
                    <div class="course-form">
                        <h4>${isNewCourse ? 'Add New Course' : 'Edit Course'}</h4>
                        
                        <form id="course-edit-form">
                            <div class="basic-settings">
                                <h5>Course Information</h5>
                                <div class="form-row two-column-row">
                                    <div class="form-group">
                                        <label for="course-code">Course Code</label>
                                        <input type="text" id="course-code" class="form-control" value="${courseData?.course_code || ''}" ${!isNewCourse ? 'readonly' : ''} required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="course-name">Course Name</label>
                                        <input type="text" id="course-name" class="form-control" value="${courseData?.course_name || ''}" required>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="coefficient">Coefficient</label>
                                        <input type="number" id="coefficient" class="form-control" min="0" max="5" value="${courseData?.coefficient || 0}" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="year">Year</label>
                                        <select id="year" class="form-control" required>
                                            <option value="1" ${courseData?.year === 1 ? 'selected' : ''}>1st Year</option>
                                            <option value="2" ${courseData?.year === 2 ? 'selected' : ''}>2nd Year</option>
                                            <option value="3" ${courseData?.year === 3 ? 'selected' : ''}>3rd Year</option>
                                            <option value="4" ${courseData?.year === 4 ? 'selected' : ''}>4th Year</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="semester">Semester</label>
                                        <select id="semester" class="form-control" required>
                                            <option value="1" ${courseData?.semester === 1 ? 'selected' : ''}>Fall</option>
                                            <option value="2" ${courseData?.semester === 2 ? 'selected' : ''}>Spring</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="checkbox-options">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="in-curriculum" ${courseData?.in_curriculum ? 'checked' : ''}>
                                        <label for="in-curriculum">Currently in Curriculum</label>
                                    </div>
                                    
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="has-lecture" ${courseData?.has_lecture ? 'checked' : ''}>
                                        <label for="has-lecture">Has Lecture</label>
                                    </div>
                                    
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="has-tutorial" ${courseData?.has_tutorial ? 'checked' : ''}>
                                        <label for="has-tutorial">Has Tutorial</label>
                                    </div>
                                    
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="requires-french" ${courseData?.requires_french ? 'checked' : ''}>
                                        <label for="requires-french">Requires French</label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <textarea id="description" class="form-control" rows="3">${courseData?.description || ''}</textarea>
                                </div>
                            </div>
                            
                            <div class="advanced-settings-toggle">
                                <div class="toggle-header">
                                    <h5>Advanced Settings</h5>
                                    <button type="button" class="toggle-btn">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                
                                <div class="advanced-settings-content">
                                    <div class="form-group">
                                        <label>For Major</label>
                                        <div class="tag-selection-container">
                                            ${majors.map(major => `
                                                <label class="tag-checkbox">
                                                    <input type="checkbox" name="for-major" value="${major.code}" 
                                                        ${courseData?.for_major.includes(major.code) ? 'checked' : ''}>
                                                    <span class="tag-label major-tag">${major.code}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>For Minor</label>
                                        <div class="tag-selection-container">
                                            ${minors.map(minor => `
                                                <label class="tag-checkbox">
                                                    <input type="checkbox" name="for-minor" value="${minor.code}" 
                                                        ${courseData?.for_minor.includes(minor.code) ? 'checked' : ''}>
                                                    <span class="tag-label minor-tag">${minor.code}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>For Minor If Major Is</label>
                                        <div class="tag-selection-container">
                                            ${majors.map(major => `
                                                <label class="tag-checkbox">
                                                    <input type="checkbox" name="for-minor-if-major-is" value="${major.code}" 
                                                        ${courseData?.for_minor_if_major_is.includes(major.code) ? 'checked' : ''}>
                                                    <span class="tag-label conditional-tag">${major.code}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="minor-study-year">Minor Study Year</label>
                                        <input type="number" id="minor-study-year" class="form-control" min="1" value="${courseData?.minor_study_year || ''}">
                                    </div>
                                    
                                    ${!isNewCourse ? `
                                    <div class="delete-course-section">
                                        <hr class="section-divider">
                                        <button type="button" class="btn btn-danger delete-course-btn" id="delete-course-btn">
                                            <i class="fas fa-trash"></i> Delete Course
                                        </button>
                                        <p class="danger-zone-note">This action cannot be undone. This will permanently delete the course from the database.</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary" id="save-course-btn">
                                    <i class="fas fa-save"></i> ${isNewCourse ? 'Add Course' : 'Save Changes'}
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                // Enable/disable coefficient field to only accept numbers >= 0
                const coefficientField = document.getElementById('coefficient');
                coefficientField.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    if (isNaN(value) || value < 0) {
                        this.value = 0;
                    }
                });

                // Validate minor study year field to only accept numbers >= 1
                const minorStudyYearField = document.getElementById('minor-study-year');
                minorStudyYearField.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    if (!isNaN(value) && value < 1) {
                        this.value = 1;
                    }
                });
                
                // Toggle advanced settings
                const toggleBtn = document.querySelector('.toggle-btn');
                const advancedContent = document.querySelector('.advanced-settings-content');
                
                toggleBtn.addEventListener('click', function() {
                    const icon = this.querySelector('i');
                    if (advancedContent.style.display === 'none' || !advancedContent.style.display) {
                        advancedContent.style.display = 'block';
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                        sectionStates.courses.expanded = true;
                    } else {
                        advancedContent.style.display = 'none';
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                        sectionStates.courses.expanded = false;
                    }
                });
                
                // Hide advanced settings by default
                advancedContent.style.display = 'none';
                
                // Handle form submission
                document.getElementById('course-edit-form').addEventListener('submit', function(e) {
                e.preventDefault();
                    saveCourseData(isNewCourse);
                });
                
                // Handle delete course button if it exists
                if (!isNewCourse) {
                    document.getElementById('delete-course-btn').addEventListener('click', function() {
                        showDeleteConfirmation(courseData.course_code);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching form data:', error);
                editContainer.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Failed to load form data</h4>
                        <p>${error.message}</p>
                        <button class="retry-btn" onclick="showCourseForm(${JSON.stringify(courseData)})">
                            <i class="fas fa-sync-alt"></i> Try Again
                        </button>
                    </div>
                `;
            });
    }

    // Show delete confirmation modal
    function showDeleteConfirmation(courseCode) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('delete-confirmation-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'delete-confirmation-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content delete-confirmation-content">
                    <span class="close-modal">&times;</span>
                    <h3>Delete Course Confirmation</h3>
                    <p>Are you sure you want to delete the course <strong id="delete-course-code"></strong>?</p>
                    <p class="warning-text">This action cannot be undone. The course will be permanently removed from the database.</p>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancel-delete-btn">Cancel</button>
                        <button class="btn btn-danger" id="confirm-delete-btn">
                            <i class="fas fa-trash"></i> Delete Course
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Set course code in modal
        document.getElementById('delete-course-code').textContent = courseCode;
        
        // Show modal
        modal.style.display = 'block';
        
        // Add event listeners
        document.querySelector('#delete-confirmation-modal .close-modal').addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        document.getElementById('cancel-delete-btn').addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        document.getElementById('confirm-delete-btn').addEventListener('click', function() {
            deleteCourse(courseCode);
            modal.style.display = 'none';
        });
        
        // Close when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // Delete course
    function deleteCourse(courseCode) {
        // Disable the form
        const form = document.getElementById('course-edit-form');
        Array.from(form.elements).forEach(el => el.disabled = true);
        
        // Show loading state
        document.getElementById('confirm-delete-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        
        // Make the delete request
        fetch(`/admin/system_adjustments/courses?course_code=${courseCode}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Course ${courseCode} deleted successfully`, 'success');
                
                // Reset the form and reload course list
                document.getElementById('course-select').value = '';
                loadCourseSettings();
            } else {
                throw new Error(data.message || 'Failed to delete course');
            }
        })
        .catch(error => {
            console.error('Error deleting course:', error);
            showToast(`Error: ${error.message}`, 'error');
            
            // Re-enable the form
            Array.from(form.elements).forEach(el => el.disabled = false);
        });
    }

    // Load course details
    async function loadCourseDetails(courseCode) {
        const editContainer = document.getElementById('course-edit-container');
        editContainer.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading course details...</p>
            </div>
        `;
        
        try {
            const response = await fetch(`/admin/system_adjustments/courses?course_code=${courseCode}`);
            if (!response.ok) throw new Error('Failed to load course details');
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Course not found');
            }
            
            // Show the course form with the loaded data
            showCourseForm(data.course);
            
        } catch (error) {
            console.error('Error loading course details:', error);
            editContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Failed to load course details</h4>
                    <p>${error.message}</p>
                    <button class="retry-btn" onclick="loadCourseDetails('${courseCode}')">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>
            `;
        }
    }

    // Save course data
    function saveCourseData(isNewCourse) {
        // Get form values
        const courseCode = document.getElementById('course-code').value.trim();
        const courseName = document.getElementById('course-name').value.trim();
        
        // Handle empty fields as null
        const coefficientInput = document.getElementById('coefficient').value.trim();
        const coefficient = coefficientInput !== '' ? parseInt(coefficientInput) : null;
        
        const year = parseInt(document.getElementById('year').value);
        const semester = parseInt(document.getElementById('semester').value);
        const inCurriculum = document.getElementById('in-curriculum').checked;
        const hasLecture = document.getElementById('has-lecture').checked;
        const hasTutorial = document.getElementById('has-tutorial').checked;
        const requiresFrench = document.getElementById('requires-french').checked;
        
        // Handle empty description as null
        const descriptionInput = document.getElementById('description').value.trim();
        const description = descriptionInput !== '' ? descriptionInput : null;
        
        // Handle empty minor study year as null
        const minorStudyYearInput = document.getElementById('minor-study-year').value.trim();
        const minorStudyYear = minorStudyYearInput !== '' ? parseInt(minorStudyYearInput) : null;
        
        // Get multi-select values
        const forMajor = Array.from(document.querySelectorAll('input[name="for-major"]:checked')).map(el => el.value);
        const forMinor = Array.from(document.querySelectorAll('input[name="for-minor"]:checked')).map(el => el.value);
        const forMinorIfMajorIs = Array.from(document.querySelectorAll('input[name="for-minor-if-major-is"]:checked')).map(el => el.value);
        
        // Validation for required fields
        if (!courseCode) {
            showToast('Course code is required', 'error');
            return;
        }
        
        if (!courseName) {
            showToast('Course name is required', 'error');
            return;
        }
        
        // Create course data object
        const courseData = {
            course_code: courseCode,
            course_name: courseName,
            coefficient: coefficient,
            year: year,
            semester: semester,
            in_curriculum: inCurriculum,
            has_lecture: hasLecture,
            has_tutorial: hasTutorial,
            requires_french: requiresFrench,
            description: description,
            minor_study_year: minorStudyYear,
            for_major: forMajor,
            for_minor: forMinor,
            for_minor_if_major_is: forMinorIfMajorIs
        };
        
        // Disable form
        const form = document.getElementById('course-edit-form');
        Array.from(form.elements).forEach(el => el.disabled = true);
        
        // Change submit button to loading state
        const saveBtn = document.getElementById('save-course-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        // Make API request
        const method = isNewCourse ? 'POST' : 'PUT';
        fetch('/admin/system_adjustments/courses', {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(courseData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                
                // Reset form and reload course list
                document.getElementById('course-select').value = '';
                loadCourseSettings().then(() => {
                    // Select the newly added/edited course
                    const courseSelect = document.getElementById('course-select');
                    if (courseSelect) {
                        setTimeout(() => {
                            courseSelect.value = courseCode;
                            courseSelect.dispatchEvent(new Event('change'));
                        }, 100);
                    }
                });
            } else {
                throw new Error(data.message || 'Failed to save course');
            }
        })
        .catch(error => {
            console.error('Error saving course:', error);
            showToast(`Error: ${error.message}`, 'error');
            
            // Re-enable form
            Array.from(form.elements).forEach(el => el.disabled = false);
            saveBtn.innerHTML = originalText;
        });
    }

    // Show toast notification
    function showToast(message, type = 'error') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification-${type}`;
        notification.textContent = message;
        
        container.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => {
                notification.remove();
            }, 500);
        }, 4500);
    }

    // Load major settings
    async function loadMajorSettings() {
        const contentContainer = document.getElementById('system-content-container');
        
        try {
            const response = await fetch('/admin/system_adjustments/major');
            if (!response.ok) throw new Error('Failed to load major settings');
            
            const data = await response.json();
            
            // Create HTML for the major settings section
            let html = `
                <div class="major-settings-container">
                    <div class="settings-header">
                        <h3>Major Requirements Settings</h3>
                        <div class="header-actions">
                            <p class="last-updated">Last updated: ${data.parameters.last_updated || 'Never'}</p>
                            <button class="logs-btn" id="system-logs-btn" title="View Change Logs">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-tabs">
                        <div class="settings-tab active" data-tab="system-settings">System Settings</div>
                        <div class="settings-tab" data-tab="student-overrides">Student Overrides</div>
                    </div>
                    
                    <div class="settings-content">
                        <div id="system-settings" class="tab-content active">
                            <form id="system-gpa-form">
                                <div class="settings-section">
                                    <h4>Minimum Specialized GPA for Major</h4>
                                    <p class="settings-description">Set the minimum specialized GPA requirements for each major.</p>
                                    
                                    <div class="gpa-settings-grid">
                                        <div class="form-group">
                                            <label for="min-gpa-acct">ACCT Major</label>
                                            <input type="number" id="min-gpa-acct" class="form-control" min="0" max="4" step="0.01" value="${data.parameters.min_gpa_acct || ''}" placeholder="e.g. 2.50">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="min-gpa-ba">BA Major</label>
                                            <input type="number" id="min-gpa-ba" class="form-control" min="0" max="4" step="0.01" value="${data.parameters.min_gpa_ba || ''}" placeholder="e.g. 2.50">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="min-gpa-fin">FIN Major</label>
                                            <input type="number" id="min-gpa-fin" class="form-control" min="0" max="4" step="0.01" value="${data.parameters.min_gpa_fin || ''}" placeholder="e.g. 2.50">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="min-gpa-it">IT Major</label>
                                            <input type="number" id="min-gpa-it" class="form-control" min="0" max="4" step="0.01" value="${data.parameters.min_gpa_it || ''}" placeholder="e.g. 2.50">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="min-gpa-mrk">MRK Major</label>
                                            <input type="number" id="min-gpa-mrk" class="form-control" min="0" max="4" step="0.01" value="${data.parameters.min_gpa_mrk || ''}" placeholder="e.g. 2.50">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="settings-section">
                                    <h4>Other Requirements</h4>
                                    
                                    <div class="other-settings-grid">
                                        <div class="form-group">
                                            <label for="min-cumulative-gpa">Minimum Cumulative GPA</label>
                                            <input type="number" id="min-cumulative-gpa" class="form-control" min="0" max="4" step="0.01" value="${data.parameters.min_cumulative_gpa || ''}" placeholder="e.g. 2.00">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="min-credit-percentage-major">Min. Earned Credits % for Junior/Senior Courses</label>
                                            <input type="number" id="min-credit-percentage-major" class="form-control" min="0" max="100" step="1" value="${data.parameters.min_credit_percentage_major || ''}" placeholder="e.g. 70">
                                            <small class="form-text">required earned credit of Freshman & Sophomore levels</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary" id="save-system-settings-btn">
                                        <i class="fas fa-save"></i> Save System Settings
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div id="student-overrides" class="tab-content">
                            <div class="student-search-section">
                                <h4>Student Parameter Overrides</h4>
                                <p class="settings-description">Search for a student to set individual parameter overrides.</p>
                                
                                <div class="search-container">
                                    <div class="search-box">
                                        <input type="text" id="student-search" class="form-control" placeholder="Search by National ID or Name">
                                        <button id="search-btn" class="search-btn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="search-results" class="search-results"></div>
                            </div>
                            
                            <div id="student-override-form-container" class="student-override-form-container">
                                <!-- Student override form will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            contentContainer.innerHTML = html;
            
            // Add event listeners for tab switching
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.getAttribute('data-tab')).classList.add('active');
                });
            });
            
            // Add event listener for system settings form submission
            document.getElementById('system-gpa-form').addEventListener('submit', async function(e) {
            e.preventDefault();
                await saveSystemSettings();
            });
            
            // Add event listener for student search
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('student-search');
            
            searchBtn.addEventListener('click', function() {
                searchStudents(searchInput.value);
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStudents(this.value);
                }
            });
            
            // Add event listener for system logs button
            const systemLogsBtn = document.getElementById('system-logs-btn');
            systemLogsBtn.addEventListener('click', function() {
                showParameterLogs('system');
            });
            
        } catch (error) {
            console.error('Error loading major settings:', error);
            contentContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Failed to load major settings</h4>
                    <p>${error.message}</p>
                    <button class="retry-btn" onclick="loadMajorSettings()">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>
            `;
        }
    }

    // Save system-wide GPA settings
    async function saveSystemSettings() {
        const saveBtn = document.getElementById('save-system-settings-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
            const data = {
                min_gpa_acct: parseFloatOrNull(document.getElementById('min-gpa-acct').value),
                min_gpa_ba: parseFloatOrNull(document.getElementById('min-gpa-ba').value),
                min_gpa_fin: parseFloatOrNull(document.getElementById('min-gpa-fin').value),
                min_gpa_it: parseFloatOrNull(document.getElementById('min-gpa-it').value),
                min_gpa_mrk: parseFloatOrNull(document.getElementById('min-gpa-mrk').value),
                min_cumulative_gpa: parseFloatOrNull(document.getElementById('min-cumulative-gpa').value),
                min_credit_percentage_major: parseFloatOrNull(document.getElementById('min-credit-percentage-major').value)
            };
            
            const response = await fetch('/admin/system_adjustments/major', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('System settings saved successfully', 'success');
                // Update the last updated time by reloading the section
                loadMajorSettings();
            } else {
                throw new Error(result.message || 'Failed to save system settings');
            }
        } catch (error) {
            console.error('Error saving system settings:', error);
            showToast(`Error: ${error.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    // Search for students by ID or name
    async function searchStudents(query) {
        if (!query || query.trim() === '') {
            showToast('Please enter a search term', 'error');
            return;
        }
        
        const resultsContainer = document.getElementById('search-results');
        if (!resultsContainer) {
            console.error('Search results container not found');
            showToast('Error: Search results container not found', 'error');
            return;
        }
        
        resultsContainer.innerHTML = '<div class="loading">Searching...</div>';
        
        try {
            const response = await fetch(`/admin/system_adjustments/major?student_search=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Search failed');
            }
            
            if (data.students.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No students found</div>';
                return;
            }
            
            // Display search results
            resultsContainer.innerHTML = `
                <div class="results-list">
                    ${data.students.map(student => `
                        <div class="student-result" data-student-id="${student.student_id}">
                            <div class="student-info">
                                <div class="student-name">${student.first_name} ${student.last_name}</div>
                                <div class="student-id">ID: ${student.national_id}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Wait for DOM to be updated
            setTimeout(() => {
                // Add click event to each student result
                const studentResults = document.querySelectorAll('.student-result');
                if (studentResults && studentResults.length > 0) {
                    studentResults.forEach(element => {
                        if (element) {
                            element.addEventListener('click', function() {
                                const studentId = this.getAttribute('data-student-id');
                                if (studentId) {
                                    loadStudentOverrides(studentId);
                                } else {
                                    console.error('No student ID found on clicked element');
                                }
                            });
                        }
                    });
                } else {
                    console.error('No student results found after rendering');
                }
            }, 50); // Small delay to ensure DOM is updated
            
        } catch (error) {
            console.error('Error searching students:', error);
            resultsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Load student override form
    async function loadStudentOverrides(studentId) {
        const formContainer = document.getElementById('student-override-form-container');
        if (!formContainer) {
            console.error('Form container not found');
            showToast('Error: Form container not found', 'error');
            return;
        }
        
        formContainer.innerHTML = '<div class="loading">Loading student data...</div>';
        
        try {
            const response = await fetch(`/admin/system_adjustments/major?student_id=${studentId}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Failed to load student data');
            }
            
            const student = data.student;
            const overrides = data.overrides;
            const hasOverrides = data.has_overrides;
            
            formContainer.innerHTML = `
                <div class="student-override-form">
                    <div class="selected-student-info">
                        <div>
                            <h4>${student.first_name} ${student.last_name}</h4>
                            <p>National ID: ${student.national_id}</p>
                            <p>Level: ${student.level || 'Not set'}</p>
                        </div>
                        <div class="student-info-actions">
                            ${hasOverrides ? '<div class="has-overrides-badge">Has Custom Settings</div>' : ''}
                            <button class="logs-btn" id="student-logs-btn" title="View Change Logs" data-student-id="${student.student_id}">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </div>
                    
                    <form id="student-override-form">
                        <input type="hidden" id="override-student-id" value="${student.student_id}">
                        
                        <div class="settings-section">
                            <h5>Minimum Specialized GPA Overrides</h5>
                            
                            <div class="gpa-settings-grid">
                                <div class="form-group">
                                    <label for="override-min-gpa-acct">ACCT Major</label>
                                    <input type="number" id="override-min-gpa-acct" class="form-control" min="0" max="4" step="0.01" value="${overrides.min_gpa_acct || ''}" placeholder="System default">
                                </div>
                                
                                <div class="form-group">
                                    <label for="override-min-gpa-ba">BA Major</label>
                                    <input type="number" id="override-min-gpa-ba" class="form-control" min="0" max="4" step="0.01" value="${overrides.min_gpa_ba || ''}" placeholder="System default">
                                </div>
                                
                                <div class="form-group">
                                    <label for="override-min-gpa-fin">FIN Major</label>
                                    <input type="number" id="override-min-gpa-fin" class="form-control" min="0" max="4" step="0.01" value="${overrides.min_gpa_fin || ''}" placeholder="System default">
                                </div>
                                
                                <div class="form-group">
                                    <label for="override-min-gpa-it">IT Major</label>
                                    <input type="number" id="override-min-gpa-it" class="form-control" min="0" max="4" step="0.01" value="${overrides.min_gpa_it || ''}" placeholder="System default">
                                </div>
                                
                                <div class="form-group">
                                    <label for="override-min-gpa-mrk">MRK Major</label>
                                    <input type="number" id="override-min-gpa-mrk" class="form-control" min="0" max="4" step="0.01" value="${overrides.min_gpa_mrk || ''}" placeholder="System default">
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h5>Other Requirement Overrides</h5>
                            
                            <div class="form-group">
                                <label for="override-min-credit-percentage-major">Min. Credit % for Junior/Senior Courses</label>
                                <input type="number" id="override-min-credit-percentage-major" class="form-control" min="0" max="100" step="1" value="${overrides.min_credit_percentage_major || ''}" placeholder="System default">
                                <small class="form-text">Leave empty to use system default</small>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="save-overrides-btn">
                                <i class="fas fa-save"></i> Save Overrides
                            </button>
                            ${hasOverrides ? `
                            <button type="button" class="btn btn-danger" id="remove-overrides-btn">
                                <i class="fas fa-trash"></i> Remove Overrides
                            </button>
                            ` : ''}
                        </div>
                    </form>
                </div>
            `;
            
            // Wait for DOM to be updated
            setTimeout(() => {
                // Add event listener for override form submission
                const form = document.getElementById('student-override-form');
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        await saveStudentOverrides();
                    });
                } else {
                    console.error('Student override form not found after rendering');
                }
                
                // Add event listener for remove overrides button if it exists
                const removeBtn = document.getElementById('remove-overrides-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        // Show in-page confirmation instead of browser confirm
                        showRemoveConfirmation(student.student_id, student.first_name, student.last_name);
                    });
                }
                
                // Add event listener for student logs button
                const studentLogsBtn = document.getElementById('student-logs-btn');
                if (studentLogsBtn) {
                    studentLogsBtn.addEventListener('click', function() {
                        const studentId = this.getAttribute('data-student-id');
                        showParameterLogs('student', studentId);
                    });
                }
            }, 50); // Small delay to ensure DOM is updated
            
        } catch (error) {
            console.error('Error loading student overrides:', error);
            formContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Save student override settings
    async function saveStudentOverrides() {
        const saveBtn = document.getElementById('save-overrides-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
            const studentId = document.getElementById('override-student-id').value;
            
            // Get values from form
            const min_gpa_acct = parseFloatOrNull(document.getElementById('override-min-gpa-acct').value);
            const min_gpa_ba = parseFloatOrNull(document.getElementById('override-min-gpa-ba').value);
            const min_gpa_fin = parseFloatOrNull(document.getElementById('override-min-gpa-fin').value);
            const min_gpa_it = parseFloatOrNull(document.getElementById('override-min-gpa-it').value);
            const min_gpa_mrk = parseFloatOrNull(document.getElementById('override-min-gpa-mrk').value);
            const min_credit_percentage_major = parseFloatOrNull(document.getElementById('override-min-credit-percentage-major').value);
            
            // Check if all values are null (no overrides)
            const hasAnyOverride = min_gpa_acct !== null || 
                                   min_gpa_ba !== null || 
                                   min_gpa_fin !== null || 
                                   min_gpa_it !== null || 
                                   min_gpa_mrk !== null || 
                                   min_credit_percentage_major !== null;
            
            // If no overrides, show message and don't send request
            if (!hasAnyOverride) {
                showToast('No overrides to save. Set at least one value different from system default.', 'info');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
                return;
            }
            
            const data = {
                student_id: studentId,
                min_gpa_acct,
                min_gpa_ba,
                min_gpa_fin,
                min_gpa_it,
                min_gpa_mrk,
                min_credit_percentage_major
            };
            
            const response = await fetch('/admin/system_adjustments/major', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Student overrides saved successfully', 'success');
                // Reload the student overrides to show updated information
                loadStudentOverrides(studentId);
            } else {
                throw new Error(result.message || 'Failed to save student overrides');
            }
        } catch (error) {
            console.error('Error saving student overrides:', error);
            showToast(`Error: ${error.message}`, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    // Remove student overrides
    async function removeStudentOverrides(studentId) {
        try {
            const response = await fetch(`/admin/system_adjustments/major?student_id=${studentId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Student overrides removed successfully', 'success');
                // Reload the student overrides to show updated information (now with no overrides)
                loadStudentOverrides(studentId);
            } else {
                throw new Error(result.message || 'Failed to remove student overrides');
            }
        } catch (error) {
            console.error('Error removing student overrides:', error);
            showToast(`Error: ${error.message}`, 'error');
        }
    }

    // Helper function to parse float or return null if empty
    function parseFloatOrNull(value) {
        if (!value || value.trim() === '') {
            return null;
        }
        return parseFloat(value);
    }
    // Function to show parameter logs modal
    async function showParameterLogs(changeType, studentId = null) {
        // Create or get the modal
        let modal = document.getElementById('parameter-logs-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'parameter-logs-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content logs-modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>Parameter Change Logs</h3>
                    
                    <div class="logs-filter-section">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="log-start-date">Start Date:</label>
                                <input type="date" id="log-start-date" class="form-control">
                            </div>
                            <div class="filter-group">
                                <label for="log-end-date">End Date:</label>
                                <input type="date" id="log-end-date" class="form-control">
                            </div>
                            <div class="filter-group">
                                <label for="log-type">Change Type:</label>
                                <select id="log-type" class="form-control">
                                    <option value="">All</option>
                                    <option value="system">System</option>
                                    <option value="student">Student</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button id="apply-filters-btn" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                    
                    <div class="logs-outer-container" style="width: 100%; box-sizing: border-box; padding-right: 5px;">
                        <div class="logs-container" id="logs-container">
                            <div class="loading">Loading logs...</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add close button functionality
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            // Close when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Show modal
        modal.style.display = 'block';
        
        // Set initial filter values
        const logTypeSelect = document.getElementById('log-type');
        if (logTypeSelect) {
            logTypeSelect.value = changeType || '';
        }
        
        // Add event listener for filter button
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                const startDate = document.getElementById('log-start-date').value;
                const endDate = document.getElementById('log-end-date').value;
                const changeType = document.getElementById('log-type').value;
                
                // Fetch logs with filters
                fetchParameterLogs(startDate, endDate, changeType, studentId, null);
            });
        }
        
        // Initial fetch of logs
        fetchParameterLogs(null, null, changeType, studentId, null);
    }

    // Function to fetch parameter logs
    async function fetchParameterLogs(startDate, endDate, changeType, studentId, columnName) {
        const logsContainer = document.getElementById('logs-container');
        if (!logsContainer) return;
        
        logsContainer.innerHTML = '<div class="loading">Loading logs...</div>';
        
        try {
            // Build query parameters
            let queryParams = [];
            if (startDate) queryParams.push(`start_date=${encodeURIComponent(startDate)}`);
            if (endDate) queryParams.push(`end_date=${encodeURIComponent(endDate)}`);
            if (changeType) queryParams.push(`change_type=${encodeURIComponent(changeType)}`);
            if (studentId) queryParams.push(`student_id=${encodeURIComponent(studentId)}`);
            
            // Add column name filter for general settings
            if (changeType === 'general') {
                queryParams.push(`column_name=${encodeURIComponent('max_courses_per_semester,max_forgiveness_uses,max_probation_board,max_probation_total')}`);
            }
            
            const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
            
            const response = await fetch(`/admin/system_adjustments/logs${queryString}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Failed to fetch logs');
            }
            
            if (data.logs.length === 0) {
                logsContainer.innerHTML = '<div class="no-data">No logs found for the selected filters</div>';
                return;
            }
            
            // Format the logs as a table with info
            let html = `
                <div class="logs-info">
                    <p>Showing ${data.logs.length} log entries</p>
                </div>
                <div class="logs-table-wrapper">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Admin</th>
                                <th>Type</th>
                                <th>Student</th>
                                <th>Parameter</th>
                                <th>Old Value</th>
                                <th>New Value</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.logs.forEach(log => {
                html += `
                    <tr>
                        <td>${log.changed_at}</td>
                        <td>${log.admin_name}</td>
                        <td>${log.change_type === 'system' ? 'System' : 'Student'}</td>
                        <td>${log.student_name || '-'}</td>
                        <td>${formatColumnName(log.column_name)}</td>
                        <td>${log.old_value || '-'}</td>
                        <td>${log.new_value || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                </div>
            `;
            
            logsContainer.innerHTML = html;
            
        } catch (error) {
            console.error('Error fetching parameter logs:', error);
            logsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Helper function to format column names for display
    function formatColumnName(columnName) {
        if (!columnName) return '-';
        
        // Replace underscores with spaces and capitalize each word
        return columnName
            .split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    // Add sorting and searching functionality
    document.addEventListener('DOMContentLoaded', function() {
        let sortConfig = {
            column: null,
            direction: 'asc'
        };
        
        // Global variable to store the current course data
        let currentCourseData = [];
        
        // Original fetchStatistics function
        window.originalFetchStatistics = window.fetchStatistics;
        
        // Override fetchStatistics to store data and enable sorting
        window.fetchStatistics = function(year, semester) {
            const tableBody = document.getElementById('course-performance-table')?.querySelector('tbody');
            if (!tableBody) return window.originalFetchStatistics(year, semester);
            
            // Show loading indicator
            tableBody.innerHTML = `
                <tr>
                    <td colspan="4" class="loading-indicator">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading course statistics...</p>
                    </td>
                </tr>
            `;
            
            // Construct URL with filters
            let url = '/admin/statistics';
            const params = new URLSearchParams();
            if (year !== 'all') params.append('year', year);
            if (semester !== 'all') params.append('semester', semester);
            if (params.toString()) url += '?' + params.toString();
            
            console.log("Fetching statistics from:", url);
            
            // Fetch data from API
            fetch(url)
                .then(response => {
                    console.log("Response status:", response.status);
                    if (!response.ok) {
                        throw new Error(`Network response error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received data:", data);
                    if (data.success) {
                        // Store the data for sorting and filtering
                        currentCourseData = data.course_statistics;
                        
                        // Populate filter dropdowns
                        populateFilterDropdowns(data.years, data.semesters, year, semester);
                        
                        // Apply current sort if exists
                        if (sortConfig.column) {
                            sortData(sortConfig.column, sortConfig.direction);
                        } else {
                            // Populate course performance table with original data
                            populateCourseTable(currentCourseData, tableBody);
                        }
                        
                        // Setup sorting and search functionality
                        setupSortingAndSearch();
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="4" class="no-data">
                                    Error: ${data.message || 'Could not load statistics'}
                                </td>
                            </tr>
                        `;
                        console.error('API Error:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching statistics:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="no-data">
                                An error occurred while loading statistics. Please try again.<br>
                                Error details: ${error.message}
                            </td>
                        </tr>
                    `;
                });
        };
        
        function setupSortingAndSearch() {
            // Setup column sorting
            const headers = document.querySelectorAll('#course-performance-table th[data-sort]');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    const direction = sortConfig.column === column && sortConfig.direction === 'asc' ? 'desc' : 'asc';
                    
                    // Reset all icons
                    headers.forEach(h => {
                        h.querySelector('i').className = 'fas fa-sort';
                    });
                    
                    // Set the right icon
                    this.querySelector('i').className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    
                    // Sort the data
                    sortData(column, direction);
                });
            });
            
            // Setup search functionality
            const searchInput = document.getElementById('course-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterData(this.value.trim().toLowerCase());
                });
            }
        }
        
        function sortData(column, direction) {
            sortConfig.column = column;
            sortConfig.direction = direction;
            
            const tableBody = document.getElementById('course-performance-table-body').querySelector('tbody');
            
            // Create a copy of the data to sort
            const sortedData = [...currentCourseData];
            
            // Sort the data
            sortedData.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // Handle numeric values
                if (typeof valueA === 'number' && typeof valueB === 'number') {
                    return direction === 'asc' ? valueA - valueB : valueB - valueA;
                }
                
                // Handle string values
                valueA = String(valueA).toLowerCase();
                valueB = String(valueB).toLowerCase();
                
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Update the table with sorted data
            populateCourseTable(sortedData, tableBody);
        }
        
        function filterData(searchTerm) {
            const tableBody = document.getElementById('course-performance-table-body').querySelector('tbody');
            
            if (!searchTerm) {
                // If search is empty, just apply current sorting
                if (sortConfig.column) {
                    sortData(sortConfig.column, sortConfig.direction);
                } else {
                    populateCourseTable(currentCourseData, tableBody);
                }
                return;
            }
            
            // Filter the data
            const filteredData = currentCourseData.filter(course => {
                return course.course_code.toLowerCase().includes(searchTerm);
            });
            
            // Apply current sorting to filtered data
            let dataToDisplay = filteredData;
            if (sortConfig.column) {
                dataToDisplay = [...filteredData].sort((a, b) => {
                    let valueA = a[sortConfig.column];
                    let valueB = b[sortConfig.column];
                    
                    if (typeof valueA === 'number' && typeof valueB === 'number') {
                        return sortConfig.direction === 'asc' ? valueA - valueB : valueB - valueA;
                    }
                    
                    valueA = String(valueA).toLowerCase();
                    valueB = String(valueB).toLowerCase();
                    
                    if (valueA < valueB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valueA > valueB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            // Update the table with filtered data
            populateCourseTable(dataToDisplay, tableBody);
        }
    });
});

// Add this at the top of your script to ensure it runs first
window.addEventListener('load', function() {
    console.log('Window loaded - setting up submitted requests click handler');
    
    // Force submitted requests box to be clickable with multiple approaches
    // 1. Direct ID selector
    const submittedElement = document.getElementById('submitted-requests');
    if (submittedElement) {
        const parentBox = submittedElement.closest('.summary-card-counts') || 
                          submittedElement.closest('.summary-card');
        
        if (parentBox) {
            console.log('Found submitted requests box by ID');
            makeClickable(parentBox);
        } else {
            console.log('Found submitted element but no parent box');
            makeClickable(submittedElement);
        }
    }
    
    // 2. Try with header text
    document.querySelectorAll('h4').forEach(header => {
        if (header.textContent.includes('Submitted Requests')) {
            const parentBox = header.closest('.summary-card-counts') || 
                              header.closest('.summary-card');
            if (parentBox) {
                console.log('Found submitted requests box by header text');
                makeClickable(parentBox);
            }
        }
    });
    
    // 3. Try the third box regardless of content
    const allBoxes = document.querySelectorAll('.summary-card-counts, .summary-card');
    if (allBoxes.length >= 3) {
        console.log('Using third box as fallback for submitted requests');
        makeClickable(allBoxes[2]);
    }
    
    
    
    function makeClickable(element) {
        if (!element) return;
        
        // Add styles
        element.style.cursor = 'pointer';
        element.style.position = 'relative';
        element.style.transition = 'all 0.2s ease';
        element.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';
        
        // Add hover effects
        element.addEventListener('mouseover', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        });
        
        element.addEventListener('mouseout', function() {
            this.style.transform = '';
            this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.05)';
        });
        
        // Add click handler with debugging
        element.addEventListener('click', function(e) {
            console.log('Submitted requests element clicked', this);
            e.stopPropagation();
            try {
                showSubmittedRequestsModal();
            } catch (err) {
                console.error('Error showing modal:', err);
                alert('Could not show students list. Please try again.');
            }
        });
    }
});

// NOTE: The showSubmittedRequestsModal function is already defined earlier in the file (around line 4850)
// This duplicate definition has been removed to avoid conflicts

// Store section state
let sectionStates = {
    'courses': { expanded: false },
    'major-minor': { expanded: false },
    'general': { expanded: false }
};

    // Search for students by ID or name
    async function searchStudents(query) {
        if (!query || query.trim() === '') {
            showToast('Please enter a search term', 'error');
            return;
        }
        
        const resultsContainer = document.getElementById('search-results');
        if (!resultsContainer) {
            console.error('Search results container not found');
            showToast('Error: Search results container not found', 'error');
            return;
        }
        
        resultsContainer.innerHTML = '<div class="loading">Searching...</div>';
        
        try {
            const response = await fetch(`/admin/system_adjustments/major?student_search=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Search failed');
            }
            
            if (data.students.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No students found</div>';
                return;
            }
            
            // Display search results
            resultsContainer.innerHTML = `
                <div class="results-list">
                    ${data.students.map(student => `
                        <div class="student-result" data-student-id="${student.student_id}">
                            <div class="student-info">
                                <div class="student-name">${student.first_name} ${student.last_name}</div>
                                <div class="student-id">ID: ${student.national_id}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Wait for DOM to be updated
            setTimeout(() => {
                // Add click event to each student result
                const studentResults = document.querySelectorAll('.student-result');
                if (studentResults && studentResults.length > 0) {
                    studentResults.forEach(element => {
                        if (element) {
                            element.addEventListener('click', function() {
                                const studentId = this.getAttribute('data-student-id');
                                if (studentId) {
                                    loadStudentOverrides(studentId);
                                } else {
                                    console.error('No student ID found on clicked element');
                                }
                            });
                        }
                    });
                } else {
                    console.error('No student results found after rendering');
                }
            }, 50); // Small delay to ensure DOM is updated
            
        } catch (error) {
            console.error('Error searching students:', error);
            resultsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Load general settings
    async function loadGeneralSettings() {
        const contentContainer = document.getElementById('system-content-container');
        
        try {
            const response = await fetch('/admin/system_adjustments/general');
            if (!response.ok) throw new Error('Failed to load general settings');
            
            const data = await response.json();
            
            // Create HTML for the general settings section
            let html = `
                <div class="general-settings-container">
                    <div class="settings-header">
                        <h3>General System Settings</h3>
                        <div class="header-actions">
                            <p class="last-updated">Last updated: ${data.parameters.last_updated || 'Never'}</p>
                            <button class="logs-btn" id="general-logs-btn" title="View Change Logs">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-tabs">
                        <div class="settings-tab active" data-tab="system-settings">System Settings</div>
                        <div class="settings-tab" data-tab="student-overrides">Student Overrides</div>
                    </div>
                    
                    <div class="settings-content">
                        <div id="system-settings" class="tab-content active">
                            <form id="general-system-form">
                                <div class="settings-section">
                                    <h4>Course Registration Limits</h4>
                                    <p class="settings-description">Set the maximum number of courses a student can register for in a semester.</p>
                                    
                                    <div class="form-group">
                                        <label for="max-courses-per-semester">Maximum Courses Per Semester</label>
                                        <input type="number" id="max-courses-per-semester" class="form-control" min="1" max="10" step="1" value="${data.parameters.max_courses_per_semester || ''}" placeholder="e.g. 6">
                                    </div>
                                </div>
                                
                                <div class="settings-section">
                                    <h4>Academic Forgiveness Settings</h4>
                                    <p class="settings-description">Configure the academic forgiveness policy parameters.</p>
                                    
                                    <div class="other-settings-grid">
                                        <div class="form-group">
                                            <label for="max-forgiveness-uses">Maximum Forgiveness Uses</label>
                                            <input type="number" id="max-forgiveness-uses" class="form-control" min="0" max="10" step="1" value="${data.parameters.max_forgiveness_uses || ''}" placeholder="e.g. 3">
                                            <small class="form-text">Maximum number of times a student can use academic forgiveness</small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="minimum-forgive-grade">Maximum Grade for Forgiveness</label>
                                            <input type="number" id="minimum-forgive-grade" class="form-control" min="0" max="4" step="0.1" value="${data.parameters.maximum_forgive_grade || ''}" placeholder="e.g. 1.0">
                                            <small class="form-text">Maximum grade to use forgiveness policy</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="settings-section">
                                    <h4>Academic Probation Settings</h4>
                                    <p class="settings-description">Configure the academic probation policy parameters.</p>
                                    
                                    <div class="other-settings-grid">
                                        <div class="form-group">
                                            <label for="max-probation-board">Max Board Probations</label>
                                            <input type="number" id="max-probation-board" class="form-control" min="0" max="5" step="1" value="${data.parameters.max_probation_board || ''}" placeholder="e.g. 2">
                                            <small class="form-text">Maximum number of consecutive probations before board review</small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="max-probation-total">Max Total Probations</label>
                                            <input type="number" id="max-probation-total" class="form-control" min="0" max="10" step="1" value="${data.parameters.max_probation_total || ''}" placeholder="e.g. 3">
                                            <small class="form-text">Maximum number of consecutive probations before dismissal</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="settings-section">
                                    <h4>Graduation Requirements</h4>
                                    <p class="settings-description">Configure the minimum requirements for graduation.</p>
                                    
                                    <div class="other-settings-grid">
                                        <div class="form-group">
                                            <label for="minimum-grad-credit">Minimum Earned Credits for Graduation</label>
                                            <input type="number" id="minimum-grad-credit" class="form-control" min="0" max="200" step="1" value="${data.parameters.minimum_grad_credit || ''}" placeholder="e.g. 140">
                                            <small class="form-text">Minimum earned credits required for graduation</small>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="minimum-grad-cgpa">Minimum CGPA for Graduation</label>
                                            <input type="number" id="minimum-grad-cgpa" class="form-control" min="0" max="4" step="0.01" value="${data.parameters.minimum_grad_cgpa || ''}" placeholder="e.g. 2.0">
                                            <small class="form-text">Minimum cumulative GPA required for graduation</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary" id="save-general-settings-btn">
                                        <i class="fas fa-save"></i> Save System Settings
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div id="student-overrides" class="tab-content">
                            <div class="student-search-section">
                                <h4>Student Parameter Overrides</h4>
                                <p class="settings-description">Search for a student to set individual parameter overrides.</p>
                                
                                <div class="search-container">
                                    <div class="search-box">
                                        <input type="text" id="general-student-search" class="form-control" placeholder="Search by National ID or Name">
                                        <button id="general-search-btn" class="search-btn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="general-search-results" class="search-results"></div>
                            </div>
                            
                            <div id="general-student-override-form-container" class="student-override-form-container">
                                <!-- Student override form will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            contentContainer.innerHTML = html;
            
            // Add event listeners for tab switching
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.getAttribute('data-tab')).classList.add('active');
                });
            });
            
            // Add event listener for system settings form submission
            document.getElementById('general-system-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveGeneralSystemSettings();
            });
            
            // Add event listener for student search
            const searchBtn = document.getElementById('general-search-btn');
            const searchInput = document.getElementById('general-student-search');
            
            searchBtn.addEventListener('click', function() {
                searchGeneralStudents(searchInput.value);
            });
            
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchGeneralStudents(this.value);
                }
            });
            
            // Add event listener for system logs button
            const systemLogsBtn = document.getElementById('general-logs-btn');
            systemLogsBtn.addEventListener('click', function() {
                showGeneralLogs('general');
            });
            
        } catch (error) {
            console.error('Error loading general settings:', error);
            contentContainer.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>Failed to load general settings</h4>
                    <p>${error.message}</p>
                    <button class="retry-btn" onclick="loadGeneralSettings()">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>
            `;
        }
    }

    // Save general system settings
    async function saveGeneralSystemSettings() {
        const saveBtn = document.getElementById('save-general-settings-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
                            const data = {
                max_courses_per_semester: parseIntOrNull(document.getElementById('max-courses-per-semester').value),
                max_forgiveness_uses: parseIntOrNull(document.getElementById('max-forgiveness-uses').value),
                max_probation_board: parseIntOrNull(document.getElementById('max-probation-board').value),
                max_probation_total: parseIntOrNull(document.getElementById('max-probation-total').value),
                minimum_grad_credit: parseIntOrNull(document.getElementById('minimum-grad-credit').value),
                minimum_grad_cgpa: parseFloatOrNull(document.getElementById('minimum-grad-cgpa').value),
                maximum_forgive_grade: parseFloatOrNull(document.getElementById('minimum-forgive-grade').value)
            };
            
            const response = await fetch('/admin/system_adjustments/general', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('System settings saved successfully', 'success');
                // Update the last updated time by reloading the section
                loadGeneralSettings();
            } else {
                throw new Error(result.message || 'Failed to save system settings');
            }
        } catch (error) {
            console.error('Error saving system settings:', error);
            showToast(`Error: ${error.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    // Search for students for general settings
    async function searchGeneralStudents(query) {
        if (!query || query.trim() === '') {
            showToast('Please enter a search term', 'error');
            return;
        }
        
        const resultsContainer = document.getElementById('general-search-results');
        if (!resultsContainer) {
            console.error('Search results container not found');
            showToast('Error: Search results container not found', 'error');
            return;
        }
        
        resultsContainer.innerHTML = '<div class="loading">Searching...</div>';
        
        try {
            const response = await fetch(`/admin/system_adjustments/general?student_search=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Search failed');
            }
            
            if (data.students.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No students found</div>';
                return;
            }
            
            // Display search results
            resultsContainer.innerHTML = `
                <div class="results-list">
                    ${data.students.map(student => `
                        <div class="student-result" data-student-id="${student.student_id}">
                            <div class="student-info">
                                <div class="student-name">${student.first_name} ${student.last_name}</div>
                                <div class="student-id">ID: ${student.national_id}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Wait for DOM to be updated
            setTimeout(() => {
                // Add click event to each student result
                const studentResults = document.querySelectorAll('.student-result');
                if (studentResults && studentResults.length > 0) {
                    studentResults.forEach(element => {
                        if (element) {
                            element.addEventListener('click', function() {
                                const studentId = this.getAttribute('data-student-id');
                                if (studentId) {
                                    loadGeneralStudentOverrides(studentId);
                                } else {
                                    console.error('No student ID found on clicked element');
                                }
                            });
                        }
                    });
                } else {
                    console.error('No student results found after rendering');
                }
            }, 50); // Small delay to ensure DOM is updated
            
        } catch (error) {
            console.error('Error searching students:', error);
            resultsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Load general student override form
    async function loadGeneralStudentOverrides(studentId) {
        const formContainer = document.getElementById('general-student-override-form-container');
        if (!formContainer) {
            console.error('Form container not found');
            showToast('Error: Form container not found', 'error');
            return;
        }
        
        formContainer.innerHTML = '<div class="loading">Loading student data...</div>';
        
        try {
            const response = await fetch(`/admin/system_adjustments/general?student_id=${studentId}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Failed to load student data');
            }
            
            const student = data.student;
            const overrides = data.overrides;
            
            // Verify overrides actually exist in the database by checking that at least one override value is set
            const hasAnyOverride = Object.values(overrides).some(value => value !== null && value !== undefined && value !== '');
            
            // Set has_overrides based on our check
            const hasOverrides = hasAnyOverride;
            
            formContainer.innerHTML = `
                <div class="student-override-form">
                    <div class="selected-student-info">
                        <div>
                            <h4>${student.first_name} ${student.last_name}</h4>
                            <p>National ID: ${student.national_id}</p>
                            <p>Level: ${student.level || 'Not set'}</p>
                        </div>
                        <div class="student-info-actions">
                            ${hasOverrides ? '<div class="has-overrides-badge">Has Custom Settings</div>' : ''}
                        </div>
                    </div>
                    
                    <form id="general-student-override-form">
                        <input type="hidden" id="general-override-student-id" value="${student.student_id}">
                        
                        <div class="settings-section">
                            <h5>Course Registration Limits</h5>
                            
                            <div class="form-group">
                                <label for="override-max-courses">Maximum Courses Per Semester</label>
                                <input type="number" id="override-max-courses" class="form-control" min="1" max="10" step="1" value="${overrides.max_courses_per_semester || ''}" placeholder="System default">
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h5>Academic Forgiveness Override</h5>
                            
                            <div class="form-group">
                                <label for="override-max-forgiveness">Maximum Forgiveness Uses</label>
                                <input type="number" id="override-max-forgiveness" class="form-control" min="0" max="10" step="1" value="${overrides.max_forgiveness_uses || ''}" placeholder="System default">
                                <small class="form-text">Leave empty to use system default</small>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h5>Academic Probation Overrides</h5>
                            
                            <div class="other-settings-grid">
                                <div class="form-group">
                                    <label for="override-max-probation-board">Max Board Probations</label>
                                    <input type="number" id="override-max-probation-board" class="form-control" min="0" max="5" step="1" value="${overrides.max_probation_board || ''}" placeholder="System default">
                                </div>
                                
                                <div class="form-group">
                                    <label for="override-max-probation-total">Max Total Probations</label>
                                    <input type="number" id="override-max-probation-total" class="form-control" min="0" max="10" step="1" value="${overrides.max_probation_total || ''}" placeholder="System default">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="save-general-overrides-btn">
                                <i class="fas fa-save"></i> Save Overrides
                            </button>
                            ${hasOverrides ? `
                            <button type="button" class="btn btn-danger" id="remove-general-overrides-btn">
                                <i class="fas fa-trash"></i> Remove Overrides
                            </button>
                            ` : ''}
                        </div>
                    </form>
                </div>
            `;
            
            // Wait for DOM to be updated
            setTimeout(() => {
                // Add event listener for override form submission
                const form = document.getElementById('general-student-override-form');
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        await saveGeneralStudentOverrides();
                    });
                } else {
                    console.error('Student override form not found after rendering');
                }
                
                // Add event listener for remove overrides button if it exists
                const removeBtn = document.getElementById('remove-general-overrides-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        // Show in-page confirmation instead of browser confirm
                        showGeneralRemoveConfirmation(student.student_id, student.first_name, student.last_name);
                    });
                }
                

            }, 50);
            
        } catch (error) {
            console.error('Error loading student overrides:', error);
            formContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Save general student overrides
    async function saveGeneralStudentOverrides() {
        const saveBtn = document.getElementById('save-general-overrides-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
            const studentId = document.getElementById('general-override-student-id').value;
            
            const data = {
                student_id: studentId,
                max_courses_per_semester: parseIntOrNull(document.getElementById('override-max-courses').value),
                max_forgiveness_uses: parseIntOrNull(document.getElementById('override-max-forgiveness').value),
                max_probation_board: parseIntOrNull(document.getElementById('override-max-probation-board').value),
                max_probation_total: parseIntOrNull(document.getElementById('override-max-probation-total').value)
            };
            
            const response = await fetch('/admin/system_adjustments/general', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Student overrides saved successfully', 'success');
                // Reload the student overrides to show updated data
                loadGeneralStudentOverrides(studentId);
            } else {
                throw new Error(result.message || 'Failed to save student overrides');
            }
        } catch (error) {
            console.error('Error saving student overrides:', error);
            showToast(`Error: ${error.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    // Show confirmation before removing general overrides
    function showGeneralRemoveConfirmation(studentId, firstName, lastName) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('remove-general-override-confirmation');
        if (modal) {
            document.body.removeChild(modal);
        }
        
        modal = document.createElement('div');
        modal.id = 'remove-general-override-confirmation';
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <span class="close-modal">&times;</span>
                <h3>Remove General Overrides</h3>
                <p>Are you sure you want to remove all general parameter overrides for <strong>${firstName} ${lastName}</strong>?</p>
                <p>This will reset all parameters to system defaults.</p>
                <div class="modal-actions" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button class="btn btn-secondary" id="cancel-general-remove-btn">Cancel</button>
                    <button class="btn btn-danger" id="confirm-general-remove-btn">
                        <i class="fas fa-trash"></i> Remove Overrides
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add event listeners
        document.querySelector('#remove-general-override-confirmation .close-modal').addEventListener('click', function() {
            modal.style.display = 'none';
            setTimeout(() => {
                document.body.removeChild(modal);
            }, 300);
        });
        
        document.getElementById('cancel-general-remove-btn').addEventListener('click', function() {
            modal.style.display = 'none';
            setTimeout(() => {
                document.body.removeChild(modal);
            }, 300);
        });
        
        document.getElementById('confirm-general-remove-btn').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
            await removeGeneralStudentOverrides(studentId);
            modal.style.display = 'none';
            setTimeout(() => {
                document.body.removeChild(modal);
            }, 300);
        });
        
        // Close when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        });
    }

    // Remove general student overrides
    async function removeGeneralStudentOverrides(studentId) {
        try {
            const response = await fetch(`/admin/system_adjustments/general?student_id=${studentId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Student overrides removed successfully', 'success');
                // Force the has_overrides value to be updated by fetching fresh data from the server
                const formContainer = document.getElementById('general-student-override-form-container');
                formContainer.innerHTML = '<div class="loading">Loading student data...</div>';
                try {
                    const freshResponse = await fetch(`/admin/system_adjustments/general?student_id=${studentId}`);
                    const freshData = await freshResponse.json();
                    
                    if (freshData.success) {
                        // Manually update the form with the fresh data that should now have has_overrides=false
                        loadGeneralStudentOverrides(studentId);
                    } else {
                        throw new Error(freshData.message || 'Failed to refresh student data');
                    }
                } catch (refreshError) {
                    console.error('Error refreshing student data:', refreshError);
                    loadGeneralStudentOverrides(studentId);
                }
            } else {
                throw new Error(result.message || 'Failed to remove student overrides');
            }
        } catch (error) {
            console.error('Error removing student overrides:', error);
            showToast(`Error: ${error.message}`, 'error');
        }
    }

    // Helper function to parse integer or return null if empty
    function parseIntOrNull(value) {
        if (value === '' || value === null || value === undefined) return null;
        const parsed = parseInt(value, 10);
        return isNaN(parsed) ? null : parsed;
    }
    
    // Helper function to parse float or return null if empty
    function parseFloatOrNull(value) {
        if (!value || value.trim() === '') {
            return null;
        }
        const parsed = parseFloat(value);
        return isNaN(parsed) ? null : parsed;
    }

    // Helper function to format column names for display
    function formatColumnName(columnName) {
        // Dictionary of parameter names and their display values
        const parameterNames = {
            'min_gpa_acct': 'Min GPA (ACCT)',
            'min_gpa_ba': 'Min GPA (BA)',
            'min_gpa_fin': 'Min GPA (FIN)',
            'min_gpa_it': 'Min GPA (IT)',
            'min_gpa_mrk': 'Min GPA (MRK)',
            'min_cumulative_gpa': 'Min Cumulative GPA',
            'min_credit_percentage_major': 'Min Credit % for Major',
            'max_courses_per_semester': 'Max Courses Per Semester',
            'max_forgiveness_uses': 'Max Forgiveness Uses',
            'max_probation_board': 'Max Board Probations',
            'max_probation_total': 'Max Total Probations',
            'minimum_grad_credit': 'Min Credits for Graduation',
            'minimum_grad_cgpa': 'Min CGPA for Graduation',
            'maximum_forgive_grade': 'Max Grade for Forgiveness'
        };
        
        return parameterNames[columnName] || columnName;
    }

    // Function to show general settings logs modal
    async function showGeneralLogs(changeType, studentId = null) {
        // Create or get the modal
        let modal = document.getElementById('general-logs-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'general-logs-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content logs-modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>General Settings Change Logs</h3>
                    
                    <div class="logs-filter-section">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="general-log-start-date">Start Date:</label>
                                <input type="date" id="general-log-start-date" class="form-control">
                            </div>
                            <div class="filter-group">
                                <label for="general-log-end-date">End Date:</label>
                                <input type="date" id="general-log-end-date" class="form-control">
                            </div>
                            <div class="filter-group">
                                <label for="general-log-type">Change Type:</label>
                                <select id="general-log-type" class="form-control">
                                    <option value="">All</option>
                                    <option value="system">System</option>
                                    <option value="student">Student</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button id="general-apply-filters-btn" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button id="general-reset-filters-btn" class="btn btn-secondary">
                                <i class="fas fa-undo"></i> Reset Filters
                            </button>
                        </div>
                    </div>
                    
                    <div class="general-logs-outer-container" style="width: 100%; box-sizing: border-box; padding-right: 5px;">
                        <div class="general-logs-container" id="general-logs-container">
                            <div class="loading">Loading logs...</div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add close button functionality
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            // Close when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
        }
        
        // Show modal
        modal.style.display = 'block';
        
        // Set initial filter values
        const logTypeSelect = document.getElementById('general-log-type');
        if (logTypeSelect) {
            logTypeSelect.value = changeType === 'general' ? '' : changeType || '';
        }
        
        // Add event listener for filter button
        const applyFiltersBtn = document.getElementById('general-apply-filters-btn');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', () => {
                const startDate = document.getElementById('general-log-start-date').value;
                const endDate = document.getElementById('general-log-end-date').value;
                const filterChangeType = document.getElementById('general-log-type').value;
                
                // Fetch logs with filters
                fetchGeneralLogs(startDate, endDate, filterChangeType || changeType, studentId);
            });
        }
        
        // Add event listener for reset filters button
        const resetFiltersBtn = document.getElementById('general-reset-filters-btn');
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', () => {
                document.getElementById('general-log-start-date').value = '';
                document.getElementById('general-log-end-date').value = '';
                document.getElementById('general-log-type').value = '';
                
                // Fetch logs with reset filters
                fetchGeneralLogs(null, null, changeType, studentId);
            });
        }
        
        // Initial fetch of logs
        fetchGeneralLogs(null, null, changeType, studentId);
    }

    // Function to fetch general settings logs
    async function fetchGeneralLogs(startDate, endDate, changeType, studentId) {
        const logsContainer = document.getElementById('general-logs-container');
        if (!logsContainer) return;
        
        logsContainer.innerHTML = '<div class="loading">Loading logs...</div>';
        
        try {
            // Build query parameters
            let queryParams = [];
            if (startDate) queryParams.push(`start_date=${encodeURIComponent(startDate)}`);
            if (endDate) queryParams.push(`end_date=${encodeURIComponent(endDate)}`);
            if (changeType && changeType !== 'general') queryParams.push(`change_type=${encodeURIComponent(changeType)}`);
            if (studentId) queryParams.push(`student_id=${encodeURIComponent(studentId)}`);
            
            // Add column name filter for general settings parameters
            queryParams.push(`column_name=${encodeURIComponent('max_courses_per_semester,max_forgiveness_uses,max_probation_board,max_probation_total')}`);
            
            const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
            
            const response = await fetch(`/admin/system_adjustments/logs${queryString}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Failed to fetch logs');
            }
            
            if (data.logs.length === 0) {
                logsContainer.innerHTML = '<div class="no-data">No logs found for the selected filters</div>';
                return;
            }
            
            // Format the logs as a table with pagination info
            let html = `
                <div class="general-logs-info">
                    <p>Showing ${data.logs.length} log entries</p>
                </div>
                <div class="general-logs-table-wrapper">
                    <table class="general-logs-table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Admin</th>
                                <th>Type</th>
                                <th>Student</th>
                                <th>Parameter</th>
                                <th>Old Value</th>
                                <th>New Value</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.logs.forEach(log => {
                // Highlight rows for general settings parameters
                const isGeneralParam = ['max_courses_per_semester', 'max_forgiveness_uses', 'max_probation_board', 'max_probation_total'].includes(log.column_name);
                const rowClass = isGeneralParam ? 'general-param-row' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td>${log.changed_at}</td>
                        <td>${log.admin_name}</td>
                        <td>${log.change_type === 'system' ? 'System' : 'Student'}</td>
                        <td>${log.student_name || '-'}</td>
                        <td>${formatColumnName(log.column_name)}</td>
                        <td>${log.old_value || '-'}</td>
                        <td>${log.new_value || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            logsContainer.innerHTML = html;
            
        } catch (error) {
            console.error('Error fetching general logs:', error);
            logsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error: ${error.message}
                </div>
            `;
        }
    }

    // Check major/minor selection period status
    let isSelectionOpen = false;
    let isSelectionScheduled = false;
    let selectionStartTime = null;
    let selectionEndTime = null;
    let selectionCountdownInterval = null;
    let savedSelectionStartDate = null;
    let savedSelectionEndDate = null;

    async function checkSelectionStatus() {
        console.log('Checking selection status...');
        try {
            const response = await fetch("/admin/major_minor_selection");
            if (response.ok) {
                const data = await response.json();
                console.log('Selection status data:', data);
                
                if (data.is_scheduled && data.start_date && data.end_date) {
                    isSelectionScheduled = true;
                    isSelectionOpen = false;
                    selectionStartTime = new Date(data.start_date);
                    selectionEndTime = new Date(data.end_date);
                    savedSelectionStartDate = data.start_date;
                    savedSelectionEndDate = data.end_date;
                    
                    // Update UI for scheduled state
                    updateSelectionUI('scheduled');
                    
                    // Start countdown to opening if not already running
                    if (!selectionCountdownInterval) {
                        startSelectionCountdownToOpening(selectionStartTime, selectionEndTime);
                    }
                } 
                else if (data.is_open && data.end_date) {
                    isSelectionOpen = true;
                    isSelectionScheduled = false;
                    selectionEndTime = new Date(data.end_date);
                    savedSelectionEndDate = data.end_date;
                    
                    // Update UI for open state
                    updateSelectionUI('open');
                    
                    // If selection is open but timer isn't running, start it
                    if (!selectionCountdownInterval) {
                        startSelectionCountdown(selectionEndTime);
                    }
                } 
                else {
                    isSelectionOpen = false;
                    isSelectionScheduled = false;
                    selectionEndTime = null;
                    selectionStartTime = null;
                    savedSelectionStartDate = null;
                    savedSelectionEndDate = null;
                    
                    // Update UI for closed state
                    updateSelectionUI('closed');
                    
                    if (selectionCountdownInterval) {
                        clearInterval(selectionCountdownInterval);
                        selectionCountdownInterval = null;
                    }
                }
                console.log('Selection status updated:', { isSelectionOpen, isSelectionScheduled, selectionStartTime, selectionEndTime });
            }
        } catch (error) {
            console.error("Error checking selection status:", error);
        }
    }
    
    // Helper function to update UI based on selection state
    function updateSelectionUI(state) {
        console.log(`Updating UI for selection state: ${state}`);
        const openDateInput = document.getElementById("selection-open-date");
        const closeDateInput = document.getElementById("selection-close-date");
        const openBtn = document.getElementById("open-selection-btn");
        const closeBtn = document.getElementById("close-selection-btn");
        const timerSection = document.getElementById("selection-timer-section");
        
        if (!openDateInput || !closeDateInput || !openBtn || !closeBtn || !timerSection) {
            console.log("Selection UI elements not found, may be on a different page");
            return;
        }
        
        if (state === 'scheduled') {
            // Set input values if they exist
            if (savedSelectionStartDate) {
                const startDate = new Date(savedSelectionStartDate);
                const formattedStartDate = new Date(startDate.getTime() - (startDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                openDateInput.value = formattedStartDate;
            }
            
            if (savedSelectionEndDate) {
                const endDate = new Date(savedSelectionEndDate);
                const formattedEndDate = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                closeDateInput.value = formattedEndDate;
            }
            
            // Update UI state
            openDateInput.disabled = true;
            closeDateInput.disabled = true;
            timerSection.style.display = "block";
            openBtn.disabled = true;
            openBtn.textContent = "Selection is Scheduled";
            closeBtn.disabled = false;
            closeBtn.textContent = "Cancel Scheduled Selection";
            updateSelectionTimerMessage();
            
        } else if (state === 'open') {
            // Set input values if they exist
            if (savedSelectionEndDate) {
                const endDate = new Date(savedSelectionEndDate);
                const formattedEndDate = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                closeDateInput.value = formattedEndDate;
            }
            
            // Update UI state
            openDateInput.disabled = true;
            closeDateInput.disabled = true;
            timerSection.style.display = "block";
            openBtn.disabled = true;
            openBtn.textContent = "Selection is Open";
            closeBtn.disabled = false;
            closeBtn.textContent = "Close Selection Period";
            updateSelectionTimerMessage();
            
        } else { // closed
            // Reset input values
            openDateInput.value = '';
            closeDateInput.value = '';
            
            // Update UI state
            openDateInput.disabled = false;
            closeDateInput.disabled = false;
            timerSection.style.display = "none";
            openBtn.disabled = false;
            openBtn.textContent = "Open Selection Period";
            closeBtn.disabled = true;
            closeBtn.textContent = "Close Selection Period";
        }
    }

    // Update selection timer message
    function updateSelectionTimerMessage() {
        const timerMessage = document.getElementById('selection-timer-message');
        if (!timerMessage) return;

        if (isSelectionOpen) {
            timerMessage.textContent = 'Selection period automatically ends in:';
        } else if (isSelectionScheduled) {
            timerMessage.textContent = 'Selection will open in:';
        }
    }

    // Start countdown for selection period
    function startSelectionCountdown(endTime) {
        console.log('Starting countdown to end time:', endTime);
        
        // Clear existing interval if any
        if (selectionCountdownInterval) {
            clearInterval(selectionCountdownInterval);
            selectionCountdownInterval = null;
        }
        
        function updateTimer() {
            const now = new Date();
            const timeLeft = endTime - now;
            console.log('Time left:', timeLeft);
            
            if (timeLeft <= 0) {
                clearInterval(selectionCountdownInterval);
                selectionCountdownInterval = null;
                document.getElementById('selection-countdown-timer').textContent = "ENDED";
                console.log('Selection period ended');
                
                // Refresh status after timer ends
                setTimeout(() => {
                    console.log('Refreshing selection status after end');
                    checkSelectionStatus();
                    loadMajorMinorValidation();
                }, 2000);
                return;
            }
            
            // Format the time
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('selection-countdown-timer').textContent = formattedTime;
        }
        
        // Run immediately then start interval
        updateTimer();
        selectionCountdownInterval = setInterval(updateTimer, 1000);
        console.log('Countdown interval started:', selectionCountdownInterval);
    }

    // Start countdown to opening for scheduled selection
    function startSelectionCountdownToOpening(startTime, endTime) {
        console.log('Starting countdown to opening time:', startTime);
        
        // Clear existing interval if any
        if (selectionCountdownInterval) {
            clearInterval(selectionCountdownInterval);
            selectionCountdownInterval = null;
        }
        
        function updateTimer() {
            const now = new Date();
            const timeToStart = startTime - now;
            console.log('Time to start:', timeToStart);
            
            if (timeToStart <= 0) {
                clearInterval(selectionCountdownInterval);
                selectionCountdownInterval = null;
                
                // Update state
                isSelectionScheduled = false;
                isSelectionOpen = true;
                
                console.log('Selection period now open');
                
                // Update UI for open status
                document.getElementById("selection-timer-message").textContent = "Selection period automatically ends in:";
                document.getElementById("close-selection-btn").textContent = "Close Selection Period";
                document.getElementById("open-selection-btn").textContent = "Selection is Open";
                
                // Start the end countdown
                startSelectionCountdown(endTime);
                return;
            }
            
            // Format the time
            const hours = Math.floor(timeToStart / (1000 * 60 * 60));
            const minutes = Math.floor((timeToStart % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeToStart % (1000 * 60)) / 1000);
            
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('selection-countdown-timer').textContent = formattedTime;
        }
        
        // Run immediately then start interval
        updateTimer();
        selectionCountdownInterval = setInterval(updateTimer, 1000);
        console.log('Countdown to opening interval started:', selectionCountdownInterval);
    }

    // Handle opening selection period
    async function handleOpenSelection() {
        console.log('handleOpenSelection called');
        const openBtn = document.getElementById("open-selection-btn");
        const startDateInput = document.getElementById("selection-open-date").value;
        const endDateInput = document.getElementById("selection-close-date").value;
        const errorMessage = document.getElementById("selection-error-message");

        // Show error message function
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
        }

        // Clear previous messages
        errorMessage.style.display = 'none';
        errorMessage.textContent = '';

        // Client-side validation
        if (!startDateInput || !endDateInput) {
            showError("Please select both start and end dates");
            return;
        }

        // Convert datetime-local to backend format (simple YYYY-MM-DD HH:MM:SS format)
        const startDateObj = new Date(startDateInput);
        const endDateObj = new Date(endDateInput);
        
        const formatDate = (date) => {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0') + ' ' + 
                   String(date.getHours()).padStart(2, '0') + ':' + 
                   String(date.getMinutes()).padStart(2, '0') + ':' + 
                   String(date.getSeconds()).padStart(2, '0');
        };
        
        const startDate = formatDate(startDateObj);
        const endDate = formatDate(endDateObj);
        
        console.log('Formatted dates:', { startDate, endDate });

        if (startDateObj >= endDateObj) {
            showError("End date must be after start date");
            return;
        }

        // Disable button during processing
        openBtn.disabled = true;
        openBtn.textContent = "Processing...";

        try {
            // Simple direct request
            const response = await fetch("/admin/major_minor_selection", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    action: "start_selection",
                    start_date: startDate,
                    end_date: endDate
                })
            });
            
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();

            if (result.success) {
                console.log('Selection period started successfully');
                
                // Save dates for form repopulation
                savedSelectionStartDate = startDate;
                savedSelectionEndDate = endDate;
                
                if (startDateObj > new Date()) {
                    // Scheduled for future
                    isSelectionScheduled = true;
                    isSelectionOpen = false;
                    selectionStartTime = startDateObj;
                    selectionEndTime = endDateObj;
                    
                    // Update UI
                    document.getElementById("selection-open-date").disabled = true;
                    document.getElementById("selection-close-date").disabled = true;
                    document.getElementById("selection-timer-section").style.display = "block";
                    document.getElementById("open-selection-btn").disabled = true;
                    document.getElementById("close-selection-btn").disabled = false;
                    document.getElementById("close-selection-btn").textContent = "Cancel Scheduled Selection";
                    openBtn.textContent = "Selection is Scheduled";
                    
                    // Update timer
                    document.getElementById("selection-timer-message").textContent = "Selection will open in:";
                    startSelectionCountdownToOpening(selectionStartTime, selectionEndTime);
                    
                    // Show success message
                    showError(result.message || "Selection period scheduled successfully");
                } else {
                    // Open immediately
                    isSelectionOpen = true;
                    isSelectionScheduled = false;
                    selectionEndTime = endDateObj;
                    
                    // Update UI
                    document.getElementById("selection-open-date").disabled = true;
                    document.getElementById("selection-close-date").disabled = true;
                    document.getElementById("selection-timer-section").style.display = "block";
                    document.getElementById("open-selection-btn").disabled = true;
                    document.getElementById("close-selection-btn").disabled = false;
                    document.getElementById("close-selection-btn").textContent = "Close Selection Period";
                    openBtn.textContent = "Selection is Open";
                    
                    // Update timer
                    document.getElementById("selection-timer-message").textContent = "Selection period ends in:";
                    startSelectionCountdown(selectionEndTime);
                    
                    // Show success message
                    showError(result.message || "Selection period opened successfully");
                }
                
                // Reload the section to refresh data
                setTimeout(() => {
                    loadMajorMinorValidation();
                }, 1000);
            } else {
                showError(result.message || "Failed to open selection period");
                openBtn.disabled = false;
                openBtn.textContent = "Open Selection Period";
            }
        } catch (error) {
            console.error("Error in handleOpenSelection:", error);
            showError("Error: " + error.message);
            openBtn.disabled = false;
            openBtn.textContent = "Open Selection Period";
        }
    }

    // Handle close selection period
    async function handleCloseSelection() {
        const closeBtn = document.getElementById("close-selection-btn");
        const errorMessage = document.getElementById("selection-error-message");
        
        // Show error message function
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
        }
        
        // Disable button during processing
        closeBtn.disabled = true;
        closeBtn.textContent = "Processing...";

        try {
            // Determine action based on current state
            const action = isSelectionScheduled ? "cancel_selection" : "close_selection";
            console.log(`Closing selection period with action: ${action}`);
            
            // Send request
            const response = await fetch("/admin/major_minor_selection", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: action })
            });
            
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            console.log('Close selection response:', result);

            if (result.success) {
                // Reset state variables
                isSelectionOpen = false;
                isSelectionScheduled = false;
                savedSelectionStartDate = null;
                savedSelectionEndDate = null;
                
                // Clear countdown timer
                if (selectionCountdownInterval) {
                    clearInterval(selectionCountdownInterval);
                    selectionCountdownInterval = null;
                }
                selectionEndTime = null;
                selectionStartTime = null;
                
                // Reset UI
                const openDateInput = document.getElementById("selection-open-date");
                const closeDateInput = document.getElementById("selection-close-date");
                
                if (openDateInput) {
                    openDateInput.disabled = false;
                    openDateInput.value = '';
                }
                if (closeDateInput) {
                    closeDateInput.disabled = false;
                    closeDateInput.value = '';
                }
                
                document.getElementById("selection-timer-section").style.display = "none";
                document.getElementById("open-selection-btn").disabled = false;
                document.getElementById("close-selection-btn").disabled = true;
                document.getElementById("close-selection-btn").textContent = "Close Selection Period";
                document.getElementById("open-selection-btn").textContent = "Open Selection Period";
                
                // Show success message
                showError(result.message || "Selection period closed successfully");
                
                // Reload the section to refresh data
                setTimeout(() => {
                    loadMajorMinorValidation();
                }, 1000);
            } else {
                showError(result.message || "Failed to close selection period");
                closeBtn.disabled = false;
                closeBtn.textContent = isSelectionScheduled ? "Cancel Scheduled Selection" : "Close Selection Period";
            }
        } catch (error) {
            console.error("Error in handleCloseSelection:", error);
            showError("Error: " + error.message);
            closeBtn.disabled = false;
            closeBtn.textContent = isSelectionScheduled ? "Cancel Scheduled Selection" : "Close Selection Period";
        }
    }

    // Add event listeners for selection period management buttons
    document.getElementById("open-selection-btn").addEventListener("click", handleOpenSelection);
    document.getElementById("close-selection-btn").addEventListener("click", handleCloseSelection);

    // Add this function to load graduation time data
    function loadGraduationTimeChart() {
        // Fetch graduation time data
        fetch('/admin/statistics?chart_type=graduation_time')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createGraduationTimeChart(data.graduation_data);
                } 
            })

    }

    // Add this function to create the graduation time chart
    function createGraduationTimeChart(graduationData) {
        const canvas = document.getElementById('graduation-time-chart');
        if (!canvas) {
            console.error('Graduation time chart canvas not found');
            return;
        }
        
        // Destroy existing chart if it exists
        if (window.graduationTimeChart) {
            window.graduationTimeChart.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        
        // Extract labels and data
        const labels = graduationData.map(item => `${item.years} ${item.years === 1 ? 'Year' : 'Years'}`);
        const data = graduationData.map(item => item.count);
        
        // Create gradient colors for bars
        const gradients = [];
        for (let i = 0; i < data.length; i++) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            
            // Different colors based on position in data array
            const hue = 210 + (i * 15) % 150; // Cycle through blue-green hues
            gradient.addColorStop(0, `hsla(${hue}, 80%, 55%, 0.9)`);
            gradient.addColorStop(1, `hsla(${hue}, 80%, 65%, 0.5)`);
            gradients.push(gradient);
        }
        
        // If only one data point, add a dummy point to make the bars look better
        let chartData = data;
        let chartLabels = labels;
        let chartGradients = gradients;
        
        if (data.length === 1) {
            // Add padding with empty data points
            chartLabels = ['', ...labels, ''];
            chartData = [null, ...data, null];
            chartGradients = [null, ...gradients, null];
        }
        
        // Create chart
        window.graduationTimeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Number of Graduates',
                    data: chartData,
                    backgroundColor: chartGradients,
                    borderColor: chartGradients.map(g => g ? g : 'transparent'),
                    borderWidth: 1,
                    borderRadius: 6,
                    barPercentage: 0.6,
                    categoryPercentage: 0.7,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        title: {
                            display: true,
                            text: 'Number of Graduates',
                            font: {
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            precision: 0,
                            font: {
                                size: 11
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Years to Graduate',
                            font: {
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleFont: {
                            weight: 'bold'
                        },
                        padding: 10,
                        cornerRadius: 6,
                        callbacks: {
                            title: function(context) {
                                // Only show tooltip for actual data points
                                if (context[0].dataIndex === 0 && data.length === 1) return null;
                                if (context[0].dataIndex === chartLabels.length - 1 && data.length === 1) return null;
                                return context[0].label;
                            },
                            label: function(context) {
                                // Only show tooltip for actual data points
                                if (context.dataIndex === 0 && data.length === 1) return null;
                                if (context.dataIndex === chartLabels.length - 1 && data.length === 1) return null;
                                return `${context.raw} ${context.raw === 1 ? 'Graduate' : 'Graduates'}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Load GPA by Major Spider Chart
    function loadGpaByMajorChart(studentType = 'enrolled') {
        const canvas = document.getElementById('gpa-by-major-chart');
        if (!canvas) {
            console.error('GPA by major chart canvas not found');
            return;
        }
        
        // Show loading state
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = '14px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('Loading data...', canvas.width / 2, canvas.height / 2);
        
        // Save preference and update the student type filter UI
        window.lastStudentTypeFilter = studentType;
        const studentTypeFilter = document.getElementById('student-type-filter');
        if (studentTypeFilter) {
            studentTypeFilter.value = studentType;
        }
        
        // Fetch GPA by major data
        fetch(`/admin/statistics/gpa_by_major?student_type=${studentType}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    createGpaByMajorChart(data.data, studentType);
                } else {
                    console.error('No GPA data available', data);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillText('No GPA data available', canvas.width / 2, canvas.height / 2);
                }
            })
            .catch(error => {
                console.error('Error loading GPA by major data:', error);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillText('Error loading data', canvas.width / 2, canvas.height / 2);
            });
    }
    
    function createGpaByMajorChart(data, studentType) {
        const canvas = document.getElementById('gpa-by-major-chart');
        if (!canvas) return;
        
        // Destroy existing chart if it exists
        if (window.gpaByMajorChart) {
            window.gpaByMajorChart.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        
        // Extract labels and data, and separate majors with data from those without
        const labels = data.map(item => item.major);
        const gpaValues = data.map(item => item.gpa);
        
        // Create datasets with different colors for data vs no data
        const datasets = [];
        
        // Main dataset for actual GPA values
        datasets.push({
            label: 'Average GPA',
            data: gpaValues,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            pointBackgroundColor: gpaValues.map(val => val === 0 ? 'rgba(200, 200, 200, 0.8)' : 'rgba(75, 192, 192, 1)'),
            pointBorderColor: gpaValues.map(val => val === 0 ? 'rgba(150, 150, 150, 1)' : '#fff'),
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
        });
        
        // Create radar/spider chart
        window.gpaByMajorChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        angleLines: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        pointLabels: {
                            font: {
                                size: 12,
                                weight: function(context) {
                                    const index = context.index;
                                    return gpaValues[index] === 0 ? '400' : '600';
                                }
                            },
                            color: function(context) {
                                const index = context.index;
                                return gpaValues[index] === 0 ? 'rgba(150, 150, 150, 0.8)' : 'rgba(0, 0, 0, 0.8)';
                            }
                        },
                        suggestedMin: 0,
                        suggestedMax: 4,
                        ticks: {
                            stepSize: 1,
                            backdropColor: 'transparent'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.formattedValue;
                                // If the value is 0, it was likely a NULL GPA in the database
                                return parseFloat(value) === 0 ? 
                                    `GPA: No data available` : 
                                    `GPA: ${value} / 4.0`;
                            }
                        }
                    }
                }
            }
        });
        
        // Store the current student type for persistence across page loads
        window.lastStudentTypeFilter = studentType;
    }
    
    // Load Course Enrollment Chart
    function loadCourseEnrollmentChart() {
        const canvas = document.getElementById('course-enrollment-chart');
        if (!canvas) {
            console.error('Course enrollment chart canvas not found');
            return;
        }
        
        // Show loading state
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = '14px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('Loading data...', canvas.width / 2, canvas.height / 2);
        
        // Fetch course enrollment distribution data
        fetch('/admin/statistics/course_enrollment_count')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && data.data.length > 0) {
                    createCourseEnrollmentChart(data.data);
                } else {
                    console.error('No enrollment data available', data);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillText('No enrollment data available', canvas.width / 2, canvas.height / 2);
                }
            })
            .catch(error => {
                console.error('Error loading course enrollment data:', error);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillText('Error loading data', canvas.width / 2, canvas.height / 2);
            });
    }
    
    function createCourseEnrollmentChart(data) {
        const canvas = document.getElementById('course-enrollment-chart');
        if (!canvas) return;
        
        // Destroy existing chart if it exists
        if (window.courseEnrollmentChart) {
            window.courseEnrollmentChart.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        
        // Extract labels and data
        const labels = data.map(item => item.courseCount); // Just the number
        const counts = data.map(item => item.studentCount);
        
        // Create a horizontal bar chart (sidebar)
        window.courseEnrollmentChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Students',
                    data: counts,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(201, 203, 207, 0.8)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(255, 159, 64, 0.6)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 205, 86, 1)',
                        'rgba(201, 203, 207, 1)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ],
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.8,
                    categoryPercentage: 0.8,
                    // Make this a horizontal bar chart (sidebar)
                    indexAxis: 'y' 
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // This makes it horizontal
                scales: {
                    x: { // This was previously y
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            precision: 0,
                            font: {
                                size: 11
                            }
                        },
                        title: {
                            display: true,
                            text: 'Number of Students',
                            font: {
                                size: 12
                            }
                        }
                    },
                    y: { // This was previously x
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Number of Courses',
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const courseCount = context[0].label;
                                return `${courseCount} Course${courseCount !== '1' ? 's' : ''}`;
                            },
                            label: function(context) {
                                const value = context.raw;
                                return `${value} student${value !== 1 ? 's' : ''}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Show registration message
    function showRegistrationMessage(message, type = 'error') {
        const messageEl = document.getElementById('registration-error-message');
        messageEl.textContent = message;
        messageEl.style.display = 'block';
        
        if (type === 'success') {
            messageEl.classList.add('success');
        } else {
            messageEl.classList.remove('success');
        }
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 5000);
    }
    
    // Load probation extension requests with optional status filter
    function loadProbationExtensionRequests(statusFilter = 'pending') {
        const tableContainer = document.getElementById('probation-extension-table-container');
        const loadingElement = document.getElementById('probation-extension-loading');
        
        // Update active filter button
        document.querySelectorAll('.status-filter-btn').forEach(btn => {
            if (btn.getAttribute('data-status') === statusFilter) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Show loading indicator
        loadingElement.style.display = 'block';
        tableContainer.innerHTML = '';
        
        // Fetch probation extension requests from API with status filter
        fetch(`/admin/course_registration/probation_extension?status=${statusFilter}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                loadingElement.style.display = 'none';
                
                if (data.success) {
                    renderProbationExtensionTable(data.requests, tableContainer, statusFilter);
                    
                    // Setup search functionality
                    setupProbationSearchFilter();
                } else {
                    tableContainer.innerHTML = `
                        <div class="probation-extension-empty">
                            Error: ${data.message || 'Failed to load probation extension requests'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                // Hide loading indicator
                loadingElement.style.display = 'none';
                
                tableContainer.innerHTML = `
                    <div class="probation-extension-empty">
                        An error occurred while loading probation extension requests: ${error.message}
                    </div>
                `;
                console.error('Error fetching probation extension requests:', error);
            });
    }
    
    // Setup search filter for probation extension requests
    function setupProbationSearchFilter() {
        const searchInput = document.getElementById('probation-extension-search');
        if (!searchInput) return;
        
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('.probation-extension-table tbody tr');
            
            rows.forEach(row => {
                const nationalId = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                const studentName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                
                if (nationalId.includes(searchTerm) || studentName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // Render probation extension requests table
    function renderProbationExtensionTable(requests, container, statusFilter) {
        if (!requests || requests.length === 0) {
            const emptyMessage = statusFilter === 'pending' ? 
                'No pending probation extension requests found.' : 
                'No processed probation extension requests found.';
                
            container.innerHTML = `
                <div class="probation-extension-empty">
                    ${emptyMessage}
                </div>
            `;
            return;
        }
        
        // Create table with different columns based on status filter
        let tableHtml = `
            <table class="probation-extension-table">
                <thead>
                    <tr>
                        <th>National ID</th>
                        <th>Student Name</th>
                        <th>Cumulative GPA</th>
                        ${statusFilter === 'pending' ? '' : '<th>Status</th>'}
                        ${statusFilter === 'pending' ? '' : '<th>Decision Date</th>'}
                        ${statusFilter === 'pending' ? '<th>Actions</th>' : ''}
                    </tr>
                </thead>
                <tbody>
        `;
        
        // Add rows for all requests
        requests.forEach(request => {
            // Only show action buttons for pending requests
            const actionButtons = request.status === 'pending' ? `
                <button class="btn-approve" data-request-id="${request.id}" data-action="approve">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn-reject" data-request-id="${request.id}" data-action="reject">
                    <i class="fas fa-times"></i> Reject
                </button>
            ` : '';
            
            // Format decision date if available
            const formattedDate = request.decision_date ? 
                new Date(request.decision_date).toLocaleString() : '-';
            
            tableHtml += `
                <tr data-request-id="${request.id}" data-student-id="${request.student_id}">
                    <td>${request.national_id}</td>
                    <td>${request.first_name} ${request.last_name}</td>
                    <td>${request.cumulative_gpa !== null ? request.cumulative_gpa.toFixed(2) : '-'}</td>
                    ${statusFilter === 'pending' ? '' : `
                    <td>
                        <span class="probation-status ${request.status}">
                            ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                        </span>
                    </td>
                    `}
                    ${statusFilter === 'pending' ? '' : `<td>${formattedDate}</td>`}
                    ${statusFilter === 'pending' ? `
                    <td class="request-actions">
                        ${actionButtons}
                    </td>
                    ` : ''}
                </tr>
            `;
        });
        
        tableHtml += `
                </tbody>
            </table>
        `;
        
        container.innerHTML = tableHtml;
        
        // Add event listeners to buttons
        const approveButtons = container.querySelectorAll('.btn-approve');
        const rejectButtons = container.querySelectorAll('.btn-reject');
        
        approveButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                handleProbationExtensionRequest(requestId, 'approve');
            });
        });
        
        rejectButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-request-id');
                handleProbationExtensionRequest(requestId, 'reject');
            });
        });
        
        // Add double-click event listener to all rows for viewing history
        const rows = container.querySelectorAll('.probation-extension-table tbody tr');
        rows.forEach(row => {
            row.addEventListener('dblclick', function() {
                const requestId = this.getAttribute('data-request-id');
                showProbationHistoryModal(requestId);
            });
        });
    }
    
    // Handle probation extension request - Show decision modal
    function handleProbationExtensionRequest(requestId, action) {
        // Find the request in the table
        const row = document.querySelector(`.probation-extension-table tr[data-request-id="${requestId}"]`);
        if (!row) return;
        
        // Get student info from the row
        const nationalId = row.querySelector('td:nth-child(1)').textContent;
        const studentName = row.querySelector('td:nth-child(2)').textContent;
        const studentGpa = row.querySelector('td:nth-child(3)').textContent;
        
        // Set modal title based on action
        const modalTitle = document.getElementById('decision-modal-title');
        modalTitle.textContent = `${action === 'approve' ? 'Approve' : 'Reject'} Probation Extension`;
        
        // Set student info in the modal
        const studentInfoEl = document.getElementById('decision-student-info');
        studentInfoEl.innerHTML = `
            <p class="student-name">${studentName}</p>
            <p class="student-id">National ID: ${nationalId}</p>
            <p class="student-gpa">GPA: ${studentGpa}</p>
        `;
        
        // Clear previous comments
        document.getElementById('board-comments').value = '';
        
        // Style confirm button based on action
        const confirmBtn = document.getElementById('confirm-decision-btn');
        confirmBtn.textContent = `Confirm ${action === 'approve' ? 'Approval' : 'Rejection'}`;
        confirmBtn.className = `confirm-decision-btn ${action}`;
        
        // Set up confirm button event
        confirmBtn.onclick = function() {
            confirmProbationDecision(requestId, action);
        };
        
        // Show the modal
        document.getElementById('probation-decision-modal').style.display = 'block';
    }
    
    // Confirm probation extension decision
    function confirmProbationDecision(requestId, action) {
        // Get comments from the textarea
        const comments = document.getElementById('board-comments').value;
        
        // For debugging - log the data that will be sent
        console.log('Sending probation extension request data:', {
            requestId: requestId,
            action: action,
            comments: comments
        });
        
        // Disable the confirm button
        const confirmBtn = document.getElementById('confirm-decision-btn');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${action === 'approve' ? 'Approving...' : 'Rejecting...'}`;
        
        // Disable buttons in the table as well
        const row = document.querySelector(`.probation-extension-table tr[data-request-id="${requestId}"]`);
        if (row) {
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = true;
            });
        }
        
        // Create the request data object
        const requestData = {
            action: action,
            comments: comments || ''
        };
        
        // Send the request to the API
        fetch(`/admin/course_registration/probation_extension/${requestId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Close the modal
            closeProbationDecisionModal();
            
            if (data.success) {
                // Reload the table to show updated data
                loadProbationExtensionRequests();
                
                // Show success message
                const errorMsg = document.getElementById('probation-extension-error-message');
                if (errorMsg) {
                    errorMsg.textContent = data.message;
                    errorMsg.style.display = 'block';
                    errorMsg.classList.add('success');
                    
                    // Hide message after 5 seconds
                    setTimeout(() => {
                        errorMsg.style.display = 'none';
                        errorMsg.classList.remove('success');
                    }, 5000);
                }
            } else {
                console.error('Error data:', data);
                alert(`Error: ${data.message || 'Failed to process request'}`);
                // Re-enable buttons in the table
                reEnableTableButtons(row);
            }
        })
        .catch(error => {
            // Close the modal
            closeProbationDecisionModal();
            
            console.error('Error handling probation extension request:', error);
            alert(`Error: ${error.message || 'An unknown error occurred'}`);
            
            // Re-enable buttons in the table
            reEnableTableButtons(row);
        });
    }
    
    // Helper function to re-enable table buttons
    function reEnableTableButtons(row) {
        if (row) {
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.disabled = false;
                if (btn.classList.contains('btn-approve')) {
                    btn.innerHTML = '<i class="fas fa-check"></i> Approve';
                } else if (btn.classList.contains('btn-reject')) {
                    btn.innerHTML = '<i class="fas fa-times"></i> Reject';
                }
            });
        }
    }
    
    // Close probation decision modal
    function closeProbationDecisionModal() {
        const modal = document.getElementById('probation-decision-modal');
        modal.style.display = 'none';
        
        // Reset confirm button
        const confirmBtn = document.getElementById('confirm-decision-btn');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = 'Confirm Decision';
    }
    
    // Show probation history modal
    function showProbationHistoryModal(requestId) {
        const modal = document.getElementById('probation-history-modal');
        const modalBody = document.getElementById('probation-history-body');
        
        // Show the modal
        modal.style.display = 'block';
        
        // Load request history
        modalBody.innerHTML = `<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading request history...</div>`;
        
        // Fetch the history data
        fetch(`/admin/course_registration/probation_extension/${requestId}/history`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    renderProbationHistoryModal(data.history, modalBody);
                } else {
                    modalBody.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Error: ${data.message || 'Failed to load request history'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                modalBody.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>An error occurred while loading request history: ${error.message}</p>
                    </div>
                `;
                console.error('Error fetching probation extension request history:', error);
            });
    }
    
    // Close probation history modal
    function closeProbationHistoryModal() {
        const modal = document.getElementById('probation-history-modal');
        modal.style.display = 'none';
    }
    
    // Render probation history modal content
    function renderProbationHistoryModal(history, container) {
        if (!history || history.length === 0) {
            container.innerHTML = `
                <div class="no-data">
                    No history found for this request.
                </div>
            `;
            return;
        }
        
        let historyHtml = `
            <ul class="history-list">
        `;
        
        history.forEach(item => {
            historyHtml += `
                <li class="history-item">
                    <span class="history-status ${item.status}">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span>
                    <div class="history-details">
                        <p><strong>Student:</strong> ${item.student_name} (ID: ${item.student_id})</p>
                        <p><strong>Cumulative GPA:</strong> ${item.cumulative_gpa !== undefined ? item.cumulative_gpa.toFixed(2) : '-'}</p>
                        <p><strong>Handled by:</strong> ${item.admin_name || '-'}</p>
                    </div>
                    ${item.board_comments ? `
                        <div class="history-comments">
                            <h4>Comments:</h4>
                            <p>${item.board_comments}</p>
                        </div>
                    ` : ''}
                </li>
            `;
        });
        
        historyHtml += `
            </ul>
        `;
        
        container.innerHTML = historyHtml;
    }
</script>


<!-- Add this HTML for the incomplete grades popup right before the closing </body> tag -->
<div class="incomplete-grades-popup" id="incomplete-grades-popup">
    <div class="incomplete-grades-content">
        <div class="incomplete-grades-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Cannot End Semester</h3>
            <button class="close-popup" id="close-incomplete-popup">&times;</button>
        </div>
        <div class="incomplete-grades-body">
            <div class="incomplete-grades-message">
                You cannot end the semester until these issues are resolved.
            </div>
            <div class="incomplete-grades-list">
                <table class="incomplete-grades-table">
                    <thead>
                        <tr>
                            <th>National ID</th>
                            <th>Name</th>
                            <th>Course</th>
                            <th>Issue</th>
                        </tr>
                    </thead>
                    <tbody id="incomplete-grades-students">
                        <!-- Student entries will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="incomplete-grades-footer">
            <button id="incomplete-grades-close-btn">Close</button>
        </div>
          </div>
  </div>

<!-- Graduates Popup -->
<div id="graduates-popup" class="graduates-popup">
    <div class="graduates-content">
        <div class="graduates-header">
            <h3>Congratulations to Our Graduates!</h3>
            <button id="close-graduates-popup" class="close-graduates-popup"><i class="fas fa-times"></i></button>
        </div>
        <div class="graduates-body">
            <div class="graduates-message">
                <p>The following students have met all graduation requirements and have been updated to graduate status.</p>
            </div>
            <div class="graduates-list">
                <table class="graduates-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="graduates-students">
                        <!-- Graduate entries will be added dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="graduates-footer">
            <button id="graduates-close-btn">Close</button>
        </div>
    </div>
</div>

<!-- History Modal for Probation Extension Requests -->
<div id="probation-history-modal" class="probation-history-modal">
    <div class="probation-history-content">
        <div class="probation-history-header">
            <h3>Probation Extension Request History</h3>
            <button class="close-history-modal" onclick="closeProbationHistoryModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="probation-history-body" class="probation-history-body">
            <!-- Modal content will be dynamically loaded here -->
        </div>
    </div>
</div>

<!-- Decision Modal for Probation Extension Requests -->
<div id="probation-decision-modal" class="probation-decision-modal">
    <div class="probation-decision-content">
        <div class="probation-decision-header">
            <h3 id="decision-modal-title">Probation Extension Decision</h3>
            <button class="close-decision-modal" onclick="closeProbationDecisionModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="probation-decision-body">
            <div class="decision-student-info" id="decision-student-info">
                <!-- Student info will be shown here -->
            </div>
            <div class="decision-form">
                <label for="board-comments">Board Comments:</label>
                <textarea id="board-comments" class="board-comments-textarea" placeholder="Enter comments regarding this decision..."></textarea>
                <div class="decision-actions">
                    <button id="confirm-decision-btn" class="confirm-decision-btn">Confirm Decision</button>
                    <button onclick="closeProbationDecisionModal()" class="cancel-decision-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

  <!-- Empty Modal Containers (Will be populated by JavaScript) -->
  <div id="profile-modal" class="profile-modal"></div>
  <div id="password-modal" class="password-modal"></div>
  <div id="new-admin-modal" class="new-admin-modal"></div>
  <div id="reset-student-pwd-modal" class="reset-student-pwd-modal"></div>

  <!-- Admin Profile JavaScript -->
  <script>
    // Create the modals when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      createProfileModal();
      createPasswordModal();
      createNewAdminModal();
      createResetStudentPwdModal();
      
      // Add click event listener to profile picture only
      const profilePicture = document.querySelector('.profile-picture-wrapper');
      if (profilePicture) {
        profilePicture.addEventListener('click', function() {
          openProfileModal();
        });
      }
      
      // Initialize password modal handlers
      initPasswordHandlers();
    });
    
    // Create profile modal structure
    function createProfileModal() {
      const profileModal = document.getElementById('profile-modal');
      profileModal.innerHTML = `
        <div class="profile-modal-content">
          <div class="profile-modal-header">
            <h3><i class="fas fa-user-cog"></i> Personal Information</h3>
            <span class="profile-modal-close"><i class="fas fa-times"></i></span>
          </div>
          <div class="profile-modal-body">
            <!-- Profile form will be loaded dynamically -->
          </div>
        </div>
      `;
    }
    
    // Create password modal structure
    function createPasswordModal() {
      const passwordModal = document.getElementById('password-modal');
      passwordModal.innerHTML = `
        <div class="password-modal-content">
          <div class="password-modal-header">
            <h3>Change Password</h3>
            <span class="profile-modal-close">&times;</span>
          </div>
          <div class="password-modal-body">
            <form id="password-form">
              <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" name="current_password">
                <div class="error-message">Current password is required</div>
              </div>
              <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" name="new_password">
                <div class="error-message">New password must be at least 8 characters</div>
              </div>
              <div class="form-group">
                <label for="confirm-password">Confirm New Password</label>
                <input type="password" id="confirm-password" name="confirm_password">
                <div class="error-message">Passwords do not match</div>
              </div>
            </form>
          </div>
          <div class="password-modal-footer">
            <button type="button" id="cancel-password-btn" class="cancel-btn">Cancel</button>
            <button type="button" id="save-password-btn" class="save-profile-btn">Save Password</button>
          </div>
        </div>
      `;
    }
    
    // Create new admin modal structure
    function createNewAdminModal() {
      const newAdminModal = document.getElementById('new-admin-modal');
      newAdminModal.innerHTML = `
        <div class="new-admin-modal-content">
          <div class="new-admin-modal-header">
            <h3><i class="fas fa-user-plus"></i> Create New Admin Account</h3>
            <span class="new-admin-modal-close"><i class="fas fa-times"></i></span>
          </div>
                     <div class="new-admin-modal-body">
             <form id="new-admin-form">
               <div class="form-group">
                 <label for="new-admin-first-name">First Name</label>
                 <input type="text" id="new-admin-first-name" name="first_name">
                <div class="error-message">First name is required</div>
              </div>
                             <div class="form-group">
                 <label for="new-admin-last-name">Last Name</label>
                 <input type="text" id="new-admin-last-name" name="last_name">
                 <div class="error-message">Last name is required</div>
               </div>
               <div class="form-group">
                 <label for="new-admin-email">Email Address</label>
                 <input type="email" id="new-admin-email" name="email_address">
                 <div class="error-message">Invalid email address</div>
               </div>
               <div class="form-group">
                 <label for="new-admin-national-id">National ID</label>
                 <input type="text" id="new-admin-national-id" name="national_id">
                 <div class="error-message">National ID is required</div>
               </div>
               <div class="form-group">
                 <label for="new-admin-phone">Phone Number</label>
                 <input type="tel" id="new-admin-phone" name="phone">
               </div>
               <div class="form-group">
                 <label for="new-admin-password">Password</label>
                 <input type="password" id="new-admin-password" name="password">
                 <div class="error-message">Password must be at least 8 characters</div>
               </div>
               <div class="form-group">
                 <label for="new-admin-confirm-password">Confirm Password</label>
                 <input type="password" id="new-admin-confirm-password" name="confirm_password">
                <div class="error-message">Passwords do not match</div>
              </div>
            </form>
          </div>
          <div class="new-admin-modal-footer">
            <button type="button" id="cancel-new-admin-btn" class="cancel-btn">Cancel</button>
            <button type="button" id="save-new-admin-btn" class="save-profile-btn">Create Account</button>
          </div>
        </div>
      `;
    }
    
    // Create reset student password modal structure
    function createResetStudentPwdModal() {
      const resetStudentPwdModal = document.getElementById('reset-student-pwd-modal');
      resetStudentPwdModal.innerHTML = `
        <div class="reset-student-pwd-modal-content">
          <div class="reset-student-pwd-modal-header">
            <h3><i class="fas fa-key"></i> Reset Student Password</h3>
            <span class="reset-student-pwd-modal-close"><i class="fas fa-times"></i></span>
          </div>
          <div class="reset-student-pwd-modal-body">
            <form id="reset-student-pwd-form">
              <div class="form-group">
                <label for="student-national-id">Student National ID</label>
                <input type="text" id="student-national-id" name="student_national_id">
                <div class="error-message">Student National ID is required</div>
              </div>
            </form>
          </div>
          <div class="reset-student-pwd-modal-footer">
            <button type="button" id="cancel-reset-student-pwd-btn" class="cancel-btn">Cancel</button>
            <button type="button" id="submit-reset-student-pwd-btn" class="save-profile-btn">Reset Password</button>
          </div>
        </div>
      `;
    }
    
    // Profile picture preview
    function previewProfileImage(input) {
      if (input.files && input.files[0]) {
        const profilePreview = document.getElementById('profile-picture-preview');
        
        // Remove any existing icon if present
        const icon = profilePreview.querySelector('i');
        if (icon) {
          profilePreview.removeChild(icon);
        }
        
        // Create or update image element
        let imgElement = profilePreview.querySelector('img');
        if (!imgElement) {
          imgElement = document.createElement('img');
          imgElement.alt = "Profile Picture";
          profilePreview.appendChild(imgElement);
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          imgElement.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
    
    // Load profile data
    function loadProfileData() {
      fetch('/admin/profile-info')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderProfileForm(data.data);
          } else {
            showMessage(data.message || 'Failed to load profile information', 'error');
          }
        })
        .catch(error => {
          console.error('Error loading profile data:', error);
          showMessage('An error occurred while loading your profile information', 'error');
        });
    }
    
    // Render profile form
    function renderProfileForm(profileData) {
      const formContainer = document.querySelector('.profile-modal-body');
      
      let html = `
        <form id="profile-form" class="profile-form">
          <div class="profile-picture-container">
            <div id="profile-picture-preview" class="profile-picture-preview">
              ${profileData.profile_image 
                ? `<img src="data:image/jpeg;base64,${profileData.profile_image}" alt="Profile Picture">` 
                : `<img src="${window.location.origin}/static/images/default-profile-admin.jpg" alt="Profile Picture">`}
            </div>
            <div class="profile-picture-upload">
              <label for="profile-picture-input">
                <i class="fas fa-camera"></i> Change Profile Picture
              </label>
              <input type="file" id="profile-picture-input" accept="image/*" onchange="previewProfileImage(this)">
            </div>
          </div>
          
          <div class="form-group">
            <label for="first-name">First Name</label>
            <input type="text" id="first-name" name="first_name" value="${profileData.first_name || ''}">
            <div class="error-message">First name is required</div>
          </div>
          
          <div class="form-group">
            <label for="last-name">Last Name</label>
            <input type="text" id="last-name" name="last_name" value="${profileData.last_name || ''}">
            <div class="error-message">Last name is required</div>
          </div>
          
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" name="email_address" value="${profileData.email_address || ''}" readonly>
          </div>
          
          <div class="form-group">
            <label for="national-id">National ID</label>
            <input type="text" id="national-id" name="national_id" value="${profileData.national_id || ''}" readonly>
          </div>
          
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" name="phone" value="${profileData.phone || ''}">
          </div>
          
          <div class="form-actions">
            <div class="profile-action-buttons">
              <button type="button" id="change-password-btn" class="change-password-btn">
                <i class="fas fa-key"></i> Change Password
              </button>
              <button type="button" id="reset-student-pwd-btn" class="reset-student-pwd-btn" title="Reset Student Password">
                <i class="fas fa-key"></i> Reset Student Password
              </button>
              <button type="button" id="create-admin-btn" class="create-admin-btn" title="Create New Admin Account">
                <i class="fas fa-user-plus"></i> New Admin
              </button>
            </div>
            <div class="form-buttons">
              <button type="button" id="cancel-profile-btn" class="cancel-btn">Cancel</button>
              <button type="submit" id="save-profile-btn" class="save-profile-btn">Save Changes</button>
            </div>
          </div>
        </form>
      `;
      
      formContainer.innerHTML = html;
      initProfileFormHandlers(profileData);
    }
    
    // Initialize profile form event handlers
    function initProfileFormHandlers(profileData) {
      // Profile form submit
      const profileForm = document.getElementById('profile-form');
      profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        const firstName = document.getElementById('first-name').value.trim();
        const lastName = document.getElementById('last-name').value.trim();
        let isValid = true;
        
        // Validate first name
        if (!firstName) {
          document.getElementById('first-name').parentElement.classList.add('error');
          isValid = false;
        } else {
          document.getElementById('first-name').parentElement.classList.remove('error');
        }
        
        // Validate last name
        if (!lastName) {
          document.getElementById('last-name').parentElement.classList.add('error');
          isValid = false;
        } else {
          document.getElementById('last-name').parentElement.classList.remove('error');
        }
        
        if (!isValid) return;
        
        // Get form data
        const formData = new FormData();
        formData.append('first_name', firstName);
        formData.append('last_name', lastName);
        formData.append('phone', document.getElementById('phone').value.trim());
        
        // Check if profile picture has been changed
        const profilePictureInput = document.getElementById('profile-picture-input');
        if (profilePictureInput.files && profilePictureInput.files[0]) {
          formData.append('profile_image', profilePictureInput.files[0]);
        }
        
        // Show loading state
        const saveBtn = document.getElementById('save-profile-btn');
        const originalBtnText = saveBtn.textContent;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;
        
        // Submit data
        fetch('/admin/profile-info', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          // Reset button state
          saveBtn.innerHTML = originalBtnText;
          saveBtn.disabled = false;
          
          if (data.success) {
            showMessage('Profile updated successfully', 'success');
            
            // Update stored profile data
            profileData.first_name = firstName;
            profileData.last_name = lastName;
            profileData.phone = document.getElementById('phone').value.trim();
            
            // Update the profile in the sidebar
            const adminName = document.querySelector('.admin-name');
            if (adminName) {
              adminName.textContent = `${firstName} ${lastName}`;
            }
            
            // Update profile picture in sidebar if changed
            if (profilePictureInput.files && profilePictureInput.files[0]) {
              const reader = new FileReader();
              reader.onload = function(e) {
                const sidebarProfilePic = document.querySelector('.sidebar .profile-picture');
                if (sidebarProfilePic) {
                  sidebarProfilePic.src = e.target.result;
                }
              };
              reader.readAsDataURL(profilePictureInput.files[0]);
            }
          } else {
            showMessage(data.message || 'Failed to update profile', 'error');
          }
        })
        .catch(error => {
          console.error('Error updating profile:', error);
          saveBtn.innerHTML = originalBtnText;
          saveBtn.disabled = false;
          showMessage('An error occurred while updating your profile', 'error');
        });
      });
      
      // Cancel button
      document.getElementById('cancel-profile-btn').addEventListener('click', function() {
        closeProfileModal();
      });
      
      // Change password button
      document.getElementById('change-password-btn').addEventListener('click', function() {
        openPasswordModal();
      });
      
      // Close modal buttons
      document.querySelector('.profile-modal-close').addEventListener('click', function() {
        closeProfileModal();
      });
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const profileModal = document.getElementById('profile-modal');
        if (event.target === profileModal) {
          closeProfileModal();
        }
      });
      
      // Create new admin button
      document.getElementById('create-admin-btn').addEventListener('click', function() {
        openNewAdminModal();
      });
      
      // Reset student password button
      document.getElementById('reset-student-pwd-btn').addEventListener('click', function() {
        openResetStudentPwdModal();
      });
    }
    
    // Initialize new admin modal handlers
    function initNewAdminHandlers() {
      // Close button
      const closeBtn = document.querySelector('.new-admin-modal-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          closeNewAdminModal();
        });
      }
      
      // Cancel button
      const cancelBtn = document.getElementById('cancel-new-admin-btn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          closeNewAdminModal();
        });
      }
      
      // Save button
      const saveBtn = document.getElementById('save-new-admin-btn');
      if (saveBtn) {
        saveBtn.addEventListener('click', function() {
          createNewAdmin();
        });
      }
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const newAdminModal = document.getElementById('new-admin-modal');
        if (event.target === newAdminModal) {
          closeNewAdminModal();
        }
      });
    }
    
    // Open new admin modal
    function openNewAdminModal() {
      const modal = document.getElementById('new-admin-modal');
      if (modal) {
        modal.classList.add('active');
        
        // Reset form if it exists
        const form = document.getElementById('new-admin-form');
        if (form) {
          form.reset();
        }
        
        // Remove any error classes
        const errorGroups = document.querySelectorAll('#new-admin-form .form-group');
        errorGroups.forEach(group => {
          group.classList.remove('error');
        });
        
        // Initialize handlers if they haven't been set up yet
        if (!modal.hasAttribute('data-initialized')) {
          initNewAdminHandlers();
          modal.setAttribute('data-initialized', 'true');
        }
      }
    }
    
    // Close new admin modal
    function closeNewAdminModal() {
      const modal = document.getElementById('new-admin-modal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    // Create new admin account
    function createNewAdmin() {
             // Get form data
       const firstName = document.getElementById('new-admin-first-name').value.trim();
       const lastName = document.getElementById('new-admin-last-name').value.trim();
       const email = document.getElementById('new-admin-email').value.trim();
       const nationalId = document.getElementById('new-admin-national-id').value.trim();
       const phone = document.getElementById('new-admin-phone').value.trim();
       const password = document.getElementById('new-admin-password').value;
       const confirmPassword = document.getElementById('new-admin-confirm-password').value;
      
      // Simple validation
      let isValid = true;
      
      // Validate first name
      if (!firstName) {
        document.getElementById('new-admin-first-name').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('new-admin-first-name').parentElement.classList.remove('error');
      }
      
      // Validate last name
      if (!lastName) {
        document.getElementById('new-admin-last-name').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('new-admin-last-name').parentElement.classList.remove('error');
      }
      
      // Validate email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        document.getElementById('new-admin-email').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('new-admin-email').parentElement.classList.remove('error');
      }
      
      // Validate national ID
      if (!nationalId) {
        document.getElementById('new-admin-national-id').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('new-admin-national-id').parentElement.classList.remove('error');
      }
      
      // Validate password
      if (!password || password.length < 8) {
        document.getElementById('new-admin-password').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('new-admin-password').parentElement.classList.remove('error');
      }
      
      // Validate password confirmation
      if (password !== confirmPassword) {
        document.getElementById('new-admin-confirm-password').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('new-admin-confirm-password').parentElement.classList.remove('error');
      }
      
      if (!isValid) return;
      
      // Show loading state
      const saveBtn = document.getElementById('save-new-admin-btn');
      const originalBtnText = saveBtn.textContent;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
      saveBtn.disabled = true;
      
      // Submit data
      fetch('/admin/create-admin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          first_name: firstName,
          last_name: lastName,
          email_address: email,
          national_id: nationalId,
          phone: phone,
          password: password
        })
      })
      .then(response => response.json())
      .then(data => {
        // Reset button state
        saveBtn.innerHTML = originalBtnText;
        saveBtn.disabled = false;
        
        if (data.success) {
          // Close the modal
          closeNewAdminModal();
          
          // Check if email failed but account was created
          if (data.code === 'EMAIL_FAILED') {
            // Show success message with the account details
            showMessage(`Admin account created but email failed. Please communicate these credentials: Email: ${email}, Password: ${password}`, 'success', 15000);
          } else {
            // Show regular success message
            showMessage('New admin account created successfully', 'success');
          }
          
          // Reset the form
          document.getElementById('new-admin-form').reset();
        } else {
          // Show error message
          showMessage(data.message || 'Failed to create admin account', 'error');
        }
      })
      .catch(error => {
        console.error('Error creating admin account:', error);
        saveBtn.innerHTML = originalBtnText;
        saveBtn.disabled = false;
        showMessage('An error occurred while creating the admin account', 'error');
      });
    }
    
    // Initialize reset student password modal handlers
    function initResetStudentPwdHandlers() {
      // Close button
      const closeBtn = document.querySelector('.reset-student-pwd-modal-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          closeResetStudentPwdModal();
        });
      }
      
      // Cancel button
      const cancelBtn = document.getElementById('cancel-reset-student-pwd-btn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          closeResetStudentPwdModal();
        });
      }
      
      // Reset button
      const resetBtn = document.getElementById('submit-reset-student-pwd-btn');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          resetStudentPassword();
        });
      }
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const resetStudentPwdModal = document.getElementById('reset-student-pwd-modal');
        if (event.target === resetStudentPwdModal) {
          closeResetStudentPwdModal();
        }
      });
    }
    
    // Open reset student password modal
    function openResetStudentPwdModal() {
      const modal = document.getElementById('reset-student-pwd-modal');
      if (modal) {
        modal.classList.add('active');
        
        // Reset form if it exists
        const form = document.getElementById('reset-student-pwd-form');
        if (form) {
          form.reset();
        }
        
        // Remove any error classes
        const errorGroups = document.querySelectorAll('#reset-student-pwd-form .form-group');
        errorGroups.forEach(group => {
          group.classList.remove('error');
        });
        
        // Initialize handlers if they haven't been set up yet
        if (!modal.hasAttribute('data-initialized')) {
          initResetStudentPwdHandlers();
          modal.setAttribute('data-initialized', 'true');
        }
      }
    }
    
    // Close reset student password modal
    function closeResetStudentPwdModal() {
      const modal = document.getElementById('reset-student-pwd-modal');
      if (modal) {
        modal.classList.remove('active');
      }
    }
    
    // Reset student password
    function resetStudentPassword() {
      // Get form data
      const nationalId = document.getElementById('student-national-id').value.trim();
      
      // Simple validation
      let isValid = true;
      
      // Validate national ID
      if (!nationalId) {
        document.getElementById('student-national-id').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('student-national-id').parentElement.classList.remove('error');
      }
      
      if (!isValid) return;
      
      // Show loading state
      const resetBtn = document.getElementById('submit-reset-student-pwd-btn');
      const originalBtnText = resetBtn.textContent;
      resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
      resetBtn.disabled = true;
      
      // Submit data
      fetch('/admin/reset-student-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          national_id: nationalId
        })
      })
      .then(response => response.json())
      .then(data => {
        // Reset button state
        resetBtn.innerHTML = originalBtnText;
        resetBtn.disabled = false;
        
        if (data.success) {
          // Close the modal
          closeResetStudentPwdModal();
          
          // Check if email failed but password was reset
          if (data.code === 'EMAIL_FAILED' && data.new_password) {
            // Show success message with the new password
            showMessage(`Password reset successful but email failed. New password: ${data.new_password}`, 'success', 15000);
          } else {
            // Show regular success message
            showMessage('Student password reset successfully', 'success');
          }
          
          // Reset the form
          document.getElementById('reset-student-pwd-form').reset();
        } else {
          // Show error message
          showMessage(data.message || 'Failed to reset student password', 'error');
        }
      })
      .catch(error => {
        console.error('Error resetting student password:', error);
        resetBtn.innerHTML = originalBtnText;
        resetBtn.disabled = false;
        showMessage('An error occurred while resetting the student password', 'error');
      });
    }
    
    // Open profile modal
    function openProfileModal() {
      const modal = document.getElementById('profile-modal');
      modal.classList.add('active');
      loadProfileData();
    }
    
    // Close profile modal
    function closeProfileModal() {
      const modal = document.getElementById('profile-modal');
      modal.classList.remove('active');
    }
    
    // Open password modal
    function openPasswordModal() {
      const modal = document.getElementById('password-modal');
      modal.classList.add('active');
      document.getElementById('password-form').reset();
      
      // Remove any error classes
      document.querySelectorAll('#password-form .form-group').forEach(group => {
        group.classList.remove('error');
      });
    }
    
    // Close password modal
    function closePasswordModal() {
      const modal = document.getElementById('password-modal');
      modal.classList.remove('active');
    }
    
    // Initialize password modal handlers
    function initPasswordHandlers() {
      // Close button
      const closeBtn = document.querySelector('.password-modal .profile-modal-close');
      closeBtn.addEventListener('click', function() {
        closePasswordModal();
      });
      
      // Cancel button
      document.getElementById('cancel-password-btn').addEventListener('click', function() {
        closePasswordModal();
      });
      
      // Save button
      document.getElementById('save-password-btn').addEventListener('click', function() {
        changePassword();
      });
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const passwordModal = document.getElementById('password-modal');
        if (event.target === passwordModal) {
          closePasswordModal();
        }
      });
    }
    
    // Change password
    function changePassword() {
      // Get form data
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      // Simple validation
      let isValid = true;
      
      // Validate current password
      if (!currentPassword) {
        document.getElementById('current-password').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('current-password').parentElement.classList.remove('error');
      }
      
      // Validate new password
      if (!newPassword || newPassword.length < 8) {
        document.getElementById('new-password').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('new-password').parentElement.classList.remove('error');
      }
      
      // Validate password confirmation
      if (newPassword !== confirmPassword) {
        document.getElementById('confirm-password').parentElement.classList.add('error');
        isValid = false;
      } else {
        document.getElementById('confirm-password').parentElement.classList.remove('error');
      }
      
      if (!isValid) return;
      
      // Show loading state
      const saveBtn = document.getElementById('save-password-btn');
      const originalBtnText = saveBtn.textContent;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      saveBtn.disabled = true;
      
      // Submit password change request
      fetch('/admin/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          current_password: currentPassword,
          new_password: newPassword
        })
      })
      .then(response => response.json())
      .then(data => {
        // Reset button state
        saveBtn.innerHTML = originalBtnText;
        saveBtn.disabled = false;
        
        if (data.success) {
          closePasswordModal();
          document.getElementById('password-form').reset();
          showMessage('Password changed successfully', 'success');
        } else {
          document.getElementById('current-password').parentElement.classList.add('error');
          document.getElementById('current-password').parentElement.querySelector('.error-message').textContent = 
            data.message || 'Failed to change password';
        }
      })
      .catch(error => {
        console.error('Error changing password:', error);
        saveBtn.innerHTML = originalBtnText;
        saveBtn.disabled = false;
        showMessage('An error occurred while changing your password', 'error');
      });
    }
    
    // Show message
    function showMessage(message, type, duration = 3000) {
      // Remove any existing messages
      const existingMessages = document.querySelectorAll('.profile-success-message, .profile-error-message');
      existingMessages.forEach(msg => msg.remove());
      
      // Create message element
      const messageElement = document.createElement('div');
      messageElement.textContent = message;
      messageElement.className = type === 'success' ? 'profile-success-message' : 'profile-error-message';
      messageElement.style.display = 'block';
      
      // Add to document
      const container = document.querySelector('.profile-modal-body');
      if (container) {
        container.insertBefore(messageElement, container.firstChild);
      } else {
        document.body.appendChild(messageElement);
      }
      
      // Remove after animation
      setTimeout(() => {
        messageElement.style.display = 'none';
        setTimeout(() => {
          if (messageElement.parentNode) {
            messageElement.parentNode.removeChild(messageElement);
          }
        }, 300);
      }, duration);
    }
    
    // Initialize handlers on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Modals are created in their respective functions called at the beginning
      // Allow some time for DOM to update before initializing handlers
      setTimeout(function() {
        initPasswordHandlers();
      }, 100);
    });
  </script>
  </body>
</html>
